(()=>{var e,t={84936:(e,t,n)=>{"use strict";var a=n(29087),s=n(16716),i=n(34902);n(89907);self.jasmine;var r=n(39045),o=n(82227),c=n(90864),l=n(82786);var d=n(56371),u=n(78347),h=n(84321),f=n(47513),p=n.n(f),g=n(48868),m=n(88212),w=n(21285),_=n(10048),b=n(71320),y=n(10671),v=n(68906),I=n(95095),k=n(97823);const E={byIds:async function(e){await g.Z.buffer.bulkDelete(e)},byUids:async function(e,t,n){await g.Z.buffer.where("[accountId+path]").equals([e,t]).filter((e=>void 0!==e.uids)).modify((function(e){const t=new Set(e.uids);n.forEach((e=>{t.delete(e)})),0===t.size?delete this.value:e.uids=[...t]}))}};var x=n(9112),A=n(35489),S=n(57357),M=n(24651),O=n(11430),N=n(68247),Z=n(7064),T=n(87155),L=n(89175);function R(e,t){const n=a.Z.get(L.kMailAccounts).slice(),s=n.findIndex((t=>t.MAIL_EMAIL===e));if(-1===s)throw new Error(`Account to be removed, ${e}, was not found in settings`);const i=n.splice(s,1);N.Z.set(L.kMailAccounts,n);const r=i[0];t&&(Z.Z.savedpasswords.delete(!0,(0,T.B)(r)),Z.Z.savedpasswords.delete(!0,(0,T.Y)(r)))}var P=n(99895),C=n(5863),U=n(25051),F=n(16152),D=n(16504),z=n(61839);const B={call:async function(e,t){let n=[];const a=Date.now(),s=await g.Z.transaction("rw",w.E.concat([g.Z.pop,g.Z.filters]),(async()=>{const s=await h.Z.findMatchingSles(t),{newMessageGroups:i,duplicates:r}=h.Z.findDuplicates(s),o=[];for(const t of r){const{message:n,searchListEntry:s}=t,i={accountId:e,uidl:n.uidl||"",createdTimestamp:a,searchListId:s.id};o.push(i)}const c=i.map((e=>e[0])),l=await(0,w.Z)(e,C.Gf,C.e9,c),d=l.addedSles;return n=l.forSearchDb,d.forEach(((t,n)=>{i[n].forEach((n=>{o.push({accountId:e,uidl:n.uidl,createdTimestamp:a,searchListId:t.id})}))})),g.Z.pop.bulkPut(o),r.length>0&&await h.Z.addSourceFilters(e,C.Gf,C.e9,r,!1),d}));return(0,z.Z)(n),s}};var $=n(51501),j=n(75401),V=n(84283),q=n(89165),Q=n(95752),H=n(49168),K=n(34198);function W(e,t,n,a){return n.some((n=>0!==n.length&&n.every((n=>function(e,t,n,a){if(n.accountId||n.path||n.hasOwnProperty("folder")){const t=b.Z.getByIds(e.sourceFilterIds);let s;if(n.accountId?s=t.some((e=>e.accountId===n.accountId)):n.path&&(s=t.some((e=>e.path===n.path))),n.hasOwnProperty("folder"))if(n.folder===C.uT){const t=!1;s=V.Z.isMessageDeleted(e.sources,a,t)}else s=n.folder===C.Hd?(0,q.Z)(e.sources,e.flags):n.folder===C.hn?(0,j.Z)(e.sources):n.folder===C.Z3?!t.some((t=>{if(y.Z.getFolderType(t.accountId,t.path)===C.Nz){return e.sources.get(t.id)?.internal}return!1})):t.some((e=>{const t=y.Z.getFolderType(e.accountId,e.path);return n.folder&&n.folder===t}));if(!s)return!1}if(n.listId&&n.listId!==(0,K.P7)(t.listId))return!1;if(n.flag){let t;if((0,H.R7)(n.flag))if(n.flag===C.T4.DELETED)t=V.Z.isMessageDeleted(e.sources,a);else{if(n.flag!==C.T4.SEEN)throw new Error("Unhandled source flag "+n.flag);t=Q.Z.call(e.sources,a)}else t=e.flags.includes(n.flag);if(!t)return!1}if(n.senderIsMailingList&&(!e.from[0]||n.senderIsMailingList!==e.from[0].address))return!1;return!0}(e,t,n,a)))))}const G={searchAddresses:function(e,t){const n=t.map((e=>e.address)),a=e.address;return n.some((e=>e.toLowerCase()===a))},filterMessage:function(e,t,n){let a=!1;const{filterValue:s}=e,{include:i,exclude:r,attachments:o,sentDate:c,sentDateEnd:l}=s;if("number"==typeof o){if(0===o&&t.attachment>0)return!1;if(o>0&&0===t.attachment)return!1}if(c&&c>t.sentDate)return!1;if(l&&l<t.sentDate)return!1;if(r||i)if(r&&i){const s=W(t,n,r,e),o=W(t,n,i,e);!s&&o&&(a=!0)}else i?a=W(t,n,i,e):r&&(a=!W(t,n,r,e));else a=!0;return a}},X={mergeFilteringQueueItems:function(e){const t=new Map,n=new Set;if(e.length<=1)return{updatedItems:t,deletedItemIds:n};let a,s,i=0;for(;i<e.length;){let r=1;if(a){const s=e[i],r=a.id;a=X.mergeItems(a,s),a&&(a.id===r?n.add(s.id):(n.add(r),t.delete(r)),t.set(a.id,a))}if(!a&&i<e.length-1){if(s){const a=[e[i],e[i+1]],o=s.map((({id:e})=>e));if(s=X.mergeItemPairs(s,a),s){for(let e=0;e<2;e++){const i=s[e],r=o[e],c=a[e];i.id===r?n.add(c.id):(n.add(r),t.delete(r)),t.set(i.id,i)}r=2}}if(!s){const o=e[i],c=e[i+1];if(a=X.mergeItems(o,c),a){const e=a.id===o.id?c.id:o.id;n.add(e),t.set(a.id,a),r=2}else if(i<e.length-3){const a=[o,c],l=[e[i+2],e[i+3]];if(s=X.mergeItemPairs(a,l),s){for(let e=0;e<2;e++){const i=s[e],r=a[e],o=l[e];n.add(i.id===r.id?o.id:r.id),t.set(i.id,i)}r=4}}}}i+=r}return{updatedItems:t,deletedItemIds:n}},mergeItems:function(e,t){if(e.priority!==t.priority)return;if("FILTERS_SLES"===e.type&&"FILTERS_SLES"===t.type)return X.mergeFiltersSles(e,t);if("UPDATE_SLE"===e.type&&"UPDATE_SLE"===t.type)return X.mergeUpdateSle(e,t)},mergeItemPairs:function(e,t){if(X.numberArraysMatch(t[0].searchListIds||void 0,t[1].searchListIds||void 0)){const n=X.mergeItems(e[0],t[0]);if(n){const a=X.mergeItems(e[1],t[1]);if(a)return[n,a]}}},mergeFiltersSles:function(e,t){if(!X.numberArraysMatch(e.filterIds,t.filterIds))return;if(!X.folderIdsMatch(e.folderIds,t.folderIds))return;if(e.runAllMessages!==t.runAllMessages)return;if(e.runMailingLists!==t.runMailingLists)return;if(e.runCustomFolders!==t.runCustomFolders)return;if(e.runFlagFolders!==t.runFlagFolders)return;if(e.runLabels!==t.runLabels)return;if(e.runQueries!==t.runQueries)return;if(e.runSingleThread!==t.runSingleThread)return;const n=new Set([...e.searchListIds,...t.searchListIds]);return{...e,searchListIds:[...n]}},mergeUpdateSle:function(e,t){if(void 0!==e.currentSearchListId||void 0!==t.currentSearchListId)return;if(e.unread!==t.unread)return;if(e.unseen!==t.unseen)return;if(!X.viewIdSetsMatch(e.removeViewIds,t.removeViewIds))return;if(!X.sourcesMatch(e.sources,t.sources))return;if(e.reRunUpdated!==t.reRunUpdated)return;if(e.searchListIds&&t.searchListIds){const n=new Set([...e.searchListIds,...t.searchListIds]);return{...e,searchListIds:[...n]}}return t.searchListIds?{...e}:e.searchListIds?{...t}:{...e}},numberArraysMatch:function(e,t){return X.arraysMatch(e,t,(function(e,t){const n=new Set(t);return!e.some((e=>!n.has(e)))}))},folderIdsMatch:function(e,t){return X.arraysMatch(e,t,(function(e,t){return!e.some((e=>!t.find((t=>e[0]===t[0]&&e[1]===t[1]))))}))},viewIdSetsMatch:function(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;if(e.size!==t.size)return!1;return![...e].some((e=>!t.has(e)))},sourcesMatch:function(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;if(e.size!==t.size)return!1;return![...e.keys()].some((n=>{const a=e.get(n),s=t.get(n);if(!a&&!s)return!1;if(!a||!s)return!0;const i=Object.keys(a),r=Object.keys(s);if(i.length!==r.length)return!0;for(const e of i)if(a[e]!==s[e])return!0;return!1}))},arraysMatch:function(e,t,n){if(void 0===e&&void 0===t)return!0;if(void 0===e||void 0===t)return!1;if(e.length!==t.length)return!1;return n(e,t)}};const Y=X;var J=n(5204),ee=n(95538),te=n(81830),ne=n(1407),ae=n(51733);const se=function(e,t){return[...e.entries()].some((([e,n])=>{if(n.deleted)return!1;const a=b.Z.get(e);if(!a)throw new Error("Source filter not found "+e);const{accountId:s,path:i}=a;return y.Z.getFolderType(s,i)===t}))},ie={filter:de,filterUpdateSle:async function(e){const{priority:t,searchListIds:n,currentSearchListId:a=0,unread:s,unseen:i,sources:r,removeViewIds:o=new Set,batchSize:c=ce,reRunUpdated:l}=e,d=[],u=Date.now();let h,f;if(n){const e=n.splice(0,c);[h,f]=await g.Z.transaction("rw",[g.Z.searchList,g.Z.viewIds],(()=>Promise.all([g.Z.searchList.where("id").anyOf(e).toArray(),g.Z.viewIds.where("searchListId").anyOf(e).toArray()])))}else{if([h,f]=await g.Z.transaction("rw",[g.Z.searchList,g.Z.viewIds],(()=>Promise.all([g.Z.searchList.where("id").above(a).limit(c).toArray(),g.Z.viewIds.where("searchListId").above(a).limit(c).toArray()]))),0===h.length)return!0;e.currentSearchListId=h[h.length-1].id}const p=new Map(f.map((({searchListId:e,viewIds:t})=>[e,t])));for(const e of h){const t=new Set,n=new Set([...o]),{id:a}=e,c=p.get(a);if(!c)throw new Error("viewIds not found "+a);const l=new Set;if(c.forEach((e=>{const t=Math.floor(e/C.XN);l.add(t)})),l.forEach((a=>{if(void 0!==s){const e=a*C.XN+C.aD;s?t.add(e):n.add(e)}if(void 0!==i){const e=a*C.XN+C.ZC;i?t.add(e):n.add(e)}if(void 0!==r){const s=a*C.XN+C.IK,i=a*C.XN+C.aD;r.forEach(((r,o)=>{a===o?r?(void 0!==r.deleted&&(r.deleted?(0,q.Z)(e.sources,e.flags)||n.add(s):t.add(s)),void 0!==r.read&&(r.read?n.add(i):t.add(i))):$.Z.getAllViewTypes().forEach((e=>{n.add(a*C.XN+e)})):e.sources.has(a)||(V.Z.isMessageDeleted(e.sources)?n.add(s):t.add(s),Q.Z.call(e.sources)?n.add(i):t.add(i))}))}})),c.forEach((e=>{t.delete(e)})),[...n].forEach((e=>{c.includes(e)||n.delete(e)})),t.size>0||n.size>0){const e={id:a,updates:{}};t.size>0&&(e.updates.addedViewIds=[...t],t.forEach((e=>{c.push(e)}))),n.size>0&&(e.updates.removedViewIds=[...n],n.forEach((e=>{const t=c.indexOf(e);t>=0&&c.splice(t,1)}))),d.push(e)}else p.delete(a)}if(p.size>0&&(await g.Z.viewIds.where("searchListId").anyOf([...p.keys()]).modify((e=>{const t=p.get(e.searchListId);t&&(e.viewIds=t)})),l)){const e=[...p.keys()];await v.Z.call({type:"RE_RUN_SLES",priority:t,searchListIds:e})}d.length>0&&U.QO.updateIndex({sleUpdates:d});if(n&&0===n.length)return!0;{const t=Date.now();return e.batchSize=le(c,t-u),!1}},filterSles:async function(e,t,n,a,s){const i=[],r=[],o=[],c=[],l=[],d=new Set,h=new Map,f=new Map,p=new Map,m=function(e){const t=new Set,n=[];for(const{accountId:a,path:s}of e)u.Z.isMailAccount(a)&&(s===C.ym?n.push(a):t.add(a));for(const e of n)t.delete(e);if(0===t.size)return[];const a=[...t].map((e=>[e,C.ym]));return b.Z.getByFolderIds(a)}(a),w=[...a,...m];for(let a=0;a<e.length;a++){const i=e[a],r=t[a],o=new Map;for(const e of w){if(G.filterMessage(e,i,r)){const{query:t}=e.filterValue;if(!n.get(i.id))throw new Error("viewIds not found in viewIdsBySleId for "+i.id);if(t&&!s?.skipQueries){const t=p.get(e);t?t.push(i):p.set(e,[i])}else o.set(e,!0)}else o.set(e,!1)}f.set(i,o)}if(p.size>0)for(const[e,t]of p){const{query:n}=e.filterValue;if(n){const a=await(0,te.Z)(n),s=new Set(a);for(const n of t){let t=f.get(n);t||(t=new Map,f.set(n,t)),s.has(n.id)?t.set(e,!0):t.set(e,!1)}}}for(const e of w){const t=$.Z.getViewIdsByFilterId(e.id);for(const e of t)d.add(e)}for(let a=0;a<e.length;a++){const u=e[a],p=t[a],g=f.get(u);if(!g)continue;const m=ie.getMatchResults(u,p,g,s?.triggerFilterIdCandidates),{id:w}=u,{addedViewIds:_,removedViewIds:b,runTriggerFilterIds:y,isOnMailingList:v}=m,I=n.get(w);if(!I)throw new Error("viewIds not found in viewIdsBySleId for "+w);if(v){[...I,..._].filter((e=>(e-C.EO)%C.XN==0)).forEach((e=>{_.delete(e),b.add(e)}))}const k=I.filter((e=>d.has(e))),E=k.filter((e=>!b.has(e))).concat([..._]);let x;if(!(E.length===k.length&&E.every((e=>k.includes(e))))){const e=I.filter((e=>!b.has(e))).concat([..._]);h.set(w,e),x={addedViewIds:[..._].filter((e=>!I.includes(e))),removedViewIds:I.filter((e=>b.has(e)&&!_.has(e)))},n.set(w,e)}y.size>0&&(x={...x||{},runTriggerFilterIds:[...y]}),x&&i.push({id:w,updates:x}),(0,K.P7)(p.listId)&&(r.push(u),o.push(p)),(0,H.OK)(u.flags)&&(c.push(u),l.push(p))}h.size>0&&await g.Z.viewIds.where("searchListId").anyOf([...h.keys()]).modify((e=>{const t=h.get(e.searchListId);t&&(e.viewIds=t)}));return{sleUpdates:i,mailingListCandidateSles:r,mailingListCandidateMessages:o,labelsCandidateSles:c,labelsCandidateMessages:l}},getMatchResults:function(e,t,n,a){const s=new Set,i=new Set,r=new Set,o=b.Z.getByIds(e.sourceFilterIds);let c=!1;for(const[l,d]of n){const n=$.Z.getViewIdsByFilterId(l.id);for(const e of n)i.add(e);d&&(a?.includes(l.id)&&r.add(l.id),n.forEach((n=>{switch($.Z.getViewType(n)){case C.xE:s.add(n);break;case C.ZC:e.unseen&&s.add(n);break;case C.aD:Q.Z.call(e.sources,l)||s.add(n);break;case C.EO:const a=(0,K.P7)(t.listId);if(a){const e=ee.Z.getMailingListGroup(a);e&&e.isIgnored?s.add(n):c=!0}else me(e.from)?c=!0:s.add(n);break;case C.IK:const i=y.Z.getFolderType(l.accountId,l.path)===C.Nz;V.Z.isMessageDeleted(e.sources,l,i)||s.add(n);break;case C.Fz:o.some((e=>e.accountId!==C.u4))&&s.add(n);break;case C.Jq:(0,q.Z)(e.sources,e.flags)||s.add(n);break;case C.js:const r=se(e.sources,C.Oi),d=se(e.sources,C.e9);r&&!d||s.add(n);break;case C.pF:(0,j.Z)(e.sources)||s.add(n)}})))}return{addedViewIds:s,removedViewIds:i,runTriggerFilterIds:r,isOnMailingList:c}},updateFilteringQueue:async function(){return g.Z.transaction("rw",[g.Z.filteringQueue],(async()=>{const e=ue.reduce(((e,{id:t})=>Math.max(e,t)),0),t=await g.Z.filteringQueue.where("id").above(e).toArray();ue.push(...t),ue.sort(ae.Hc);const{updatedItems:n,deletedItemIds:a}=Y.mergeFilteringQueueItems(ue);if(0===n.size&&0===a.size)return ue;const s=[];for(const e of ue){const t=n.get(e.id);t?s.push(t):a.has(e.id)||s.push(e)}return ue=s,g.Z.filteringQueue.bulkPut([...n.values()]),g.Z.filteringQueue.bulkDelete([...a]),s}))},clearQueue:function(){ue=[]},deleteFilteringItem:async function(e){await g.Z.filteringQueue.delete(e.id);const t=ue.indexOf(e);t>=0&&ue.splice(t,1)}};let re=!1;const oe=100,ce=2e3,le=I.Z.adjustBatchSize.bind(void 0,oe,2e4,1e3);async function de(){if(re)return m.Z.log("Mail",["filtering"],"Already filtering."),Promise.resolve();re=!0;try{U.U.setPersistentStatus(ne.A4,"MAIL_FILTERING",(0,d.Z)("Running mail filters..."));let e=await ie.updateFilteringQueue();for(;e.length>0;){const t=e[0];let n=!0;try{switch(t.type){case"FILTERS_SLES":n=await he(t);break;case"UPDATE_SLE":n=await ie.filterUpdateSle(t);break;case"MOVE_SLE":await fe(t);break;case"RUN_FILTERS":n=await pe(t);break;case"RE_RUN_SLES":n=await ge(t);break;default:m.Z.warn("Mail",["filtering"],"Invalid filtering queue item type",t.type)}n&&await ie.deleteFilteringItem(t)}catch(e){m.Z.error("Mail",["filtering"],"Filtering failed",JSON.stringify(t),e),await ie.deleteFilteringItem(t)}e=await ie.updateFilteringQueue()}}catch(e){m.Z.error("Mail",["filtering"],e)}finally{re=!1,U.U.clearPersistentStatus(ne.A4,"MAIL_FILTERING")}}let ue=[];async function he(e){const{filterIds:t,folderIds:n=[],searchListIds:a,runAllMessages:s=!1,runMailingLists:i=!1,runCustomFolders:r=!1,runLabels:o=!1,runFlagFolders:c=!1,runQueries:l=!1,runSingleThread:d=!1,batchSize:u=ce}=e,h=b.Z.getAll().filter((e=>{const{id:a,accountId:u,path:h}=e;if(!!n.find((e=>{const[t,n]=e;return t===u&&n===h})))return!0;if(t&&t.includes(a))return!0;switch(u){case C.of:return s&&[C.ym,C.tB,C.ik,C.rp,C.N1,C.cm,C.$T].includes(h);case C.wC:return i;case C.MN:return c;case C.Ry:return r;case C.ut:return o;case C.Kz:return l;case C.tQ:return d}}));if(0===h.length)return!0;const f=Date.now(),p=a.splice(0,u),[m,w,_]=await g.Z.transaction("rw",[g.Z.searchList,g.Z.messages,g.Z.viewIds],(()=>Promise.all([g.Z.searchList.where("id").anyOf(p).toArray(),g.Z.messages.where("id").anyOf(p).toArray(),g.Z.viewIds.where("searchListId").anyOf(p).toArray()])));if(0===m.length)return!0;const y=new Map(_.map((e=>[e.searchListId,e.viewIds]))),v=await ie.filterSles(m,w,y,h),{sleUpdates:I,mailingListCandidateSles:k,mailingListCandidateMessages:E,labelsCandidateSles:x,labelsCandidateMessages:A}=v;if(I.length>0&&U.QO.updateIndex({sleUpdates:I}),k.length>0){const e=await K.ZP.createMailingListFilters(E);if(e.length>0){await b.Z.updateFilters(e.map((({id:e})=>e)));const t=await ie.filterSles(k,E,y,e),{sleUpdates:n}=t;n.length>0&&U.QO.updateIndex({sleUpdates:n})}}if(x.length>0){const e=await(0,H.uR)(x);await b.Z.updateFilters(e);const t=b.Z.getByIds(e),n=await ie.filterSles(x,A,y,t),{sleUpdates:a}=n;a.length>0&&U.QO.updateIndex({sleUpdates:a})}if(a.length>0){const t=Date.now();e.batchSize=le(u,t-f)}return 0===a.length}async function fe(e){const{searchListIds:t,fromFolderId:n,toFolderId:a}=e,s=b.Z.getByFolderId(n),i=b.Z.getByFolderId(a);if(!s||!i)throw new Error("Either from- or to-filter not found");const r=[],[o,c]=await g.Z.transaction("rw",[g.Z.searchList,g.Z.viewIds],(()=>Promise.all([g.Z.searchList.where("id").anyOf(t).toArray(),g.Z.viewIds.where("searchListId").anyOf(t).toArray()]))),l=new Map(c.map((e=>[e.searchListId,e.viewIds]))),d=new Set,u=new Set;for(const e of o){const{id:t}=e,n=l.get(t);if(!n)throw new Error("viewIds not found "+t);const a={id:t,updates:{}};for(const e of $.Z.getAllViewTypes()){const t=s.id*C.XN+e;if(n.includes(t)){const n=i.id*C.XN+e;u.add(t),d.add(n)}}a.updates.addedViewIds=[...d],a.updates.removedViewIds=[...u],r.push(a),u.forEach((e=>{const t=n.indexOf(e);t>=0&&n.splice(t,1)})),d.forEach((e=>{n.push(e)}))}await g.Z.viewIds.where("searchListId").anyOf([...l.keys()]).modify((e=>{const t=l.get(e.searchListId);t&&(e.viewIds=t)})),U.QO.updateIndex({sleUpdates:r})}async function pe(e){const t=[],{filterIds:n,folderIds:a,currentSearchListId:s=0,batchSize:i=ce,triggerFilterIdCandidates:r}=e;if(n){const e=b.Z.getByIds(n);t.push(...e)}if(a){const e=b.Z.getByFolderIds(a);t.push(...e)}if(0===t.length)throw new Error("No valid filters in filtering request");const o=Date.now(),[c,l,d]=await g.Z.transaction("rw",[g.Z.searchList,g.Z.messages,g.Z.viewIds],(()=>Promise.all([g.Z.searchList.where("id").above(s).limit(i).toArray(),g.Z.viewIds.where("searchListId").above(s).limit(i).toArray(),g.Z.messages.where("id").above(s).limit(i).toArray()])));if(0===c.length)return!0;const u=new Map(l.map((e=>[e.searchListId,e.viewIds])));e.currentSearchListId=c[c.length-1].id;const h=await ie.filterSles(c,d,u,t,{triggerFilterIdCandidates:r}),{sleUpdates:f}=h;f.length>0&&U.QO.updateIndex({sleUpdates:f});const p=Date.now();return e.batchSize=le(i,p-o),!1}async function ge(e){const{filterIds:t,folderIds:n,batchSize:a=oe,currentSearchListId:s=0,runMailingLists:i=!1}=e,r=[];if(t&&r.push(...t),n){const e=b.Z.getByFolderIds(n);r.push(...e.map((e=>e.id)))}const o=Date.now(),c=[],l=[],[d,u,h]=e.searchListIds?await async function(e,t){const n=e.splice(0,t);return await g.Z.transaction("rw",[g.Z.searchList,g.Z.messages,g.Z.viewIds],(()=>Promise.all([g.Z.searchList.where("id").anyOf(n).toArray(),g.Z.messages.where("id").anyOf(n).toArray(),g.Z.viewIds.where("searchListId").anyOf(n).toArray()])))}(e.searchListIds,a):await async function(e,t){return g.Z.transaction("rw",[g.Z.searchList,g.Z.messages,g.Z.viewIds],(()=>Promise.all([g.Z.searchList.where("id").above(e).limit(t).toArray(),g.Z.messages.where("id").above(e).limit(t).toArray(),g.Z.viewIds.where("searchListId").above(e).limit(t).toArray()])))}(s,a);if(0===d.length)return!0;void 0===e.searchListIds&&(e.currentSearchListId=d[d.length-1].id);const f=b.Z.getAll(),p=new Map(h.map((e=>[e.searchListId,e.viewIds]))),m=[];for(let e=0;e<d.length;e++){const t=d[e],n=p.get(t.id),a=m.find((e=>{const[t]=e;if(n.length!==t.length)return!1;for(let e=0;e<t.length;e++)if(n[e]!==t[e])return!1;return!0})),s=u[e];if(a){const[,[e,n]]=a;e.push(t),n.push(s)}else m.push([n,[[t],[s]]])}const w=[];for(const t of m){const[n,[a,s]]=t,o=new Set([...r,...w]);n.forEach((e=>{const t=Math.floor(e/C.XN);o.add(t)}));const d=f.filter((e=>o.has(e.id)));if(0===d.length)continue;const{skipQueries:u}=e,h=await ie.filterSles(a,s,p,d,{skipQueries:u}),{mailingListCandidateSles:g,mailingListCandidateMessages:m}=h;if(c.push(...h.sleUpdates),i&&g.length>0){const t=await K.ZP.createMailingListFilters(m);if(t.length>0){const n=t.map((({id:e})=>e));await b.Z.updateFilters(n);const{filterIds:a=[]}=e;e.filterIds=[...a,...n],w.push(...n);const s=await ie.filterSles(g,m,p,t,{skipQueries:u}),{sleUpdates:i}=s;l.push(...i)}}}c.length>0&&U.QO.updateIndex({sleUpdates:c}),l.length>0&&U.QO.updateIndex({sleUpdates:l});const _=Date.now();return e.batchSize=le(a,_-o),!1}function me(e){const t=e[0]?.address;return!!t&&!!b.Z.getByAddress(t)}J.Z.addListener((async function(e){if("filter"===e.func)await de()}));const we=ie;var _e=n(77150),be=n.n(_e),ye=n(16445),ve=n(16888);let Ie={level:0,children:new Map};const ke={data:new Map,add:e=>{void 0!==e.id&&ke.data.set(e.id,e)},async get(e){const t=ke.data.get(e);if(t)return t;{const t=await g.Z.threading.get(e);if(!t)return;const n={id:t.id,messageId:t.messageId};return ke.add(n),n}},clear:()=>{ke.data.clear()}};function Ee(){ke.clear()}function xe(e){e.forEach((e=>{const{id:t,messageId:n}=e,a={id:t,messageId:n};ke.add(a)}))}async function Ae(){const e=await g.Z.threading.toArray();for(const t of e){const{id:e,messageId:n}=t,a={id:e,messageId:n};ke.add(a),await Se(t)}Ee()}function Se(e){const{inReplyTo:t,references:n}=e,a=[...n];return t&&!a.includes(t)&&a.push(t),a.reduce(((e,t)=>e.then((e=>Ne(t).then((n=>{if(n)return n;{const n={messageId:t},a=Oe(void 0,e);return Me(n,a).then((()=>a))}}))))),Promise.resolve()).then((t=>{const{id:n,sentDate:a,messageId:s,outbound:i}=e,r={id:n,messageId:s};return Ne(s).then((e=>{if(e)return e.sentDateById.has(n)?(e.sentDateById.set(n,a),e):(e.sentDateById.set(n,a),Me(r,e).then((()=>e)));{const e=Oe({id:n,sentDate:a,outbound:i},t);return Me(r,e).then((()=>e))}}))}))}function Me(e,t,n=Ie){if(n.threadNode)return Promise.resolve().then((()=>{if(void 0!==n.id)return ke.get(n.id).then((t=>{if(t&&t.messageId!==e.messageId)return{id:t.id,messageId:t.messageId}}));if(void 0!==n.messageId){if(n.messageId!==e.messageId)return{messageId:n.messageId};void 0!==e.id&&(n.id=e.id,delete n.messageId)}})).then((s=>{if(!s)return;const i=n.parent,r={children:new Map,level:i.level+1},o=e.messageId.substr(2*i.level,2);i.children.set(o,r);const c=n.threadNode,l=s.messageId.substr(2*r.level,2),d=e.messageId.substr(2*r.level,2);if(l!==d)return a(s,r,c),a(e,r,t),Promise.resolve();{const n={level:r.level+1,children:new Map};return r.children.set(d,n),Promise.all([Me(s,c,n),Me(e,t,n)])}}));{const s=e.messageId.substr(2*n.level,2),i=n.children.get(s);return i?Me(e,t,i):(a(e,n,t),Promise.resolve())}function a(e,t,n){const a={parent:t,threadNode:n},{id:s,messageId:i}=e;void 0!==s?a.id=s:a.messageId=i;const r=e.messageId.substr(2*t.level,2);t.children.set(r,a)}}function Oe(e,t){const n={sentDateById:new Map,children:[],outbound:!1};if(e){const{id:t,sentDate:a}=e;n.sentDateById.set(t,a),n.outbound=e.outbound}return t&&(t.children.push(n),n.parent=t),n}function Ne(e,t=Ie){if(!e)return Promise.resolve();if(t.threadNode){if(void 0!==t.messageId)return t.messageId===e?Promise.resolve(t.threadNode):Promise.resolve();if(void 0!==t.id)return ke.get(t.id).then((n=>n&&n.messageId===e?t.threadNode:Promise.resolve()));throw new Error("Missing messageId and id: "+JSON.stringify(t))}{const n=e.substr(2*t.level,2),a=t.children.get(n);return a?Ne(e,a):Promise.resolve()}}function Ze(e){const t=new Map,n=[...e.keys()];return g.Z.searchList.where("id").anyOf(n).modify((n=>{const{id:a}=n,s=e.get(a);s&&(t.set(a,s),n.threadKey=s)})).then((()=>t))}var Te=n(13617);let Le=!1;function Re(e){return Se(e).then((e=>{if(!e.parent&&0===e.children.length)return[];let n=e;for(;n.parent;)n=n.parent;return t(n)}));function t(e,s){const{sentDateById:i,children:r}=e;let o,c=[];if(void 0===s){let t=n(e);t||(t=n(e,!1));let s=e.sentDateById.keys().next().value;s||(s=a(e,[0,Number.MAX_SAFE_INTEGER])[0]),o=(0,Te._)(t,s),i.forEach(((e,t)=>{c.push({id:t,newThreadKey:o})}))}else i.size>0?i.forEach(((e,t)=>{o=[...s,e],c.push({id:t,newThreadKey:o})})):o=s;return r.forEach((e=>{const n=t(e,o);c=[...c,...n]})),c}function n(e,t=!0){const a=t&&e.outbound;let s=[...e.sentDateById.values()].reduce(((e,t)=>Math.max(e,a?0:t)),0);return e.children.forEach((e=>{s=Math.max(s,n(e,t))})),s}function a(e,t){return t=[...e.sentDateById.entries()].reduce(((e,t)=>e[1]<t[1]?e:t),t),e.children.forEach((e=>{t=a(e,t)})),t}}const Pe={updateThreads:async function(){if(!Le)for(Le=!0;Le;)try{const e=await g.Z.threadingQueue.toCollection().first();if(!e)return Ee(),void(Le=!1);const{threadingIds:t}=e;let n=2e3;const a=new I.Z.BatchSizeOptimizer(n,2e3);for(;t.length>0;){const s=t.splice(0,n);await g.Z.transaction("rw",[g.Z.threadingQueue,g.Z.threading,g.Z.searchList],(async()=>{const i=Date.now(),r=await g.Z.threading.where("id").anyOf(s).toArray(),o=new Map;xe(r);for(const e of r){(await Re(e)).forEach((e=>{const{id:t,newThreadKey:n}=e;o.set(t,n)}))}if(o.size>0){const e=await Ze(o);U.QO.updateThreadKeys(e)}if(t.length>0){await g.Z.threadingQueue.put(e);const t=Date.now();n=a.optimize(n,t-i)}else await g.Z.threadingQueue.delete(e.id)}))}}catch(e){throw Le=!1,m.Z.error("Mail",["Threading"],e),U.U.setStatus(ne.A4,(0,d.Z)("Error during threading"),5e3),e}}};var Ce=n(3664),Ue=n(76257),Fe=n(13519),De=n(27950);const ze=1048576;class Be extends Error{constructor(e,t,n){super(t),this.code=e,this.socket=n}}function $e(e){return(0,Ce.vi)(e,[43,79,75])}function je(e){return 0===e.indexOf("PASS")?"PASS":0===e.indexOf("APOP")?e.replace(/\w+\s*$/,"the_md5_hash"):e}async function Ve(e,t,n){const a=[];return new Promise(((s,i)=>{let r=setTimeout((function(){i(new Be("SOCKET_TIMEOUT",(0,d.Z)("Failed to connect to POP server after $1 ms",[n]),o))}),n);const o=D.default.open(e,t,{useSecureTransport:110!==t});if("connecting"!==o.readyState)return clearTimeout(r),void i(new Be("NO_SOCKET",(0,d.Z)('POP socket did not switch to "connecting" when trying to connect to $1:$2',[e,t]),o));o.onerror=e=>{clearTimeout(r),i(new Be("NO_SOCKET",(0,d.Z)("POP socket generated unknown error when connecting. Response message: $1",[e.data?.message||e.message||""]),o))},o.ondata=e=>{clearTimeout(r);const t=new Uint8Array(e.data);a.push(...t),(0,Ce.MF)(a,[13,10])?s({socket:o,response:new Uint8Array(a)}):r=setTimeout((function(){i(new Be("SOCKET_TIMEOUT",(0,d.Z)("POP server failed to send connection chunk after $1 ms",[n]),o))}),n)}}))}async function qe(e,t,n=!1,a=3e4){if(!e)throw new Be("NO_SOCKET",(0,d.Z)('No POP socket when sending "$1"',[je(t)]),e);if(await!He(e))throw new Be("SOCKET_CLOSED",(0,d.Z)('POP socket unexpectedly closed before "$1" command could be sent',[je(t)]),e);const s=[];return new Promise(((i,r)=>{let o=setTimeout((function(){clearTimeout(o),r(new Be("SOCKET_TIMEOUT",(0,d.Z)('POP server did not reply to command "$1" after $2 ms',[je(t),a]),e))}),a);e.onerror=n=>{clearTimeout(o),r(new Be("SEND_ERROR",(0,d.Z)('POP socket generated unknown error when sending command "$1"',[je(t)]),e))};let c=Date.now();e.ondata=l=>{clearTimeout(o);const u=new Uint8Array(l.data);if(s.push(...u),Date.now()-c>1e3){const e=Math.round(s.length/ze*10)/10;U.U.setStatus(ne.A4,(0,d.Z)("Fetching message: $1 MB",[e])),c=Date.now()}(0,Ce.MF)(s,[13,10,46,13,10])||!n&&(0,Ce.MF)(s,[13,10])?(n?s.splice(-5):s.splice(-2),(0,Ce.Xh)(s,[13,10,46],[13,10]),i(new Uint8Array(s))):o=setTimeout((function(){r(new Be("SOCKET_TIMEOUT",(0,d.Z)('POP server failed to send additional chunk for command "$1" after $2 ms',[je(t),a]),e))}),a)};const l=`${t}\r\n`,u=(0,Ce.sy)(l);e.send(u)}))}async function Qe(e,t,n){const a=await qe(e,`USER ${t}`);if(!$e(a))throw new Be("AUTH_FAIL",(0,d.Z)("Invalid username for POP, server responded with: $1",[(0,Ce.DA)(a)]),e);const s=(0,Ce.DA)((new TextEncoder).encode(n)),i=await qe(e,`PASS ${s}`);if(!$e(i))throw new Be("AUTH_FAIL",(0,d.Z)("Login to POP server failed, server responded with: $1",[(0,Ce.DA)(i)]),e)}function He(e){return new Promise((t=>{setTimeout((()=>{t("open"===e.readyState)}),0)}))}async function Ke(e,t,n,a,s=6e4,i=!1){const{socket:r,response:o}=await Ve(e,t,s);if(!$e(o))throw new Be("CONNECT_ERROR",(0,d.Z)("POP server $1:$2 responded with an error after connection",[e,t]),r);const c=We(o);if(!c||i)return await Qe(r,n,a),r;try{return await async function(e,t,n,a){const s=(0,Ce.DA)((new TextEncoder).encode(n)),i=be()(`${a}${s}`),r=await qe(e,`APOP ${t} ${i}`);if(!$e(r))throw new Be("AUTH_FAIL",(0,d.Z)("APOP authentication failed: $1",[(0,Ce.DA)(r)]),e)}(r,n,a,c),r}catch(i){if("AUTH_FAIL"===i.message){return await He(r)?(await Qe(r,n,a),r):Ke(e,t,n,a,s,!0)}throw i}}function We(e){const t=e.lastIndexOf(60);if(-1!==t){const n=e.indexOf(62,t);if(-1!==n){const a=e.subarray(t,n+1);return(0,Ce.DA)(a)}}}async function Ge(e,t){const n=await qe(e,`TOP ${t.index} 0`,!0);if($e(n))return{...t,headersOnly:!0,message:et(n)};throw new Be("TOP_ERROR",(0,d.Z)("POP server did not respond correctly to TOP command. Response: $1",[(0,Ce.DA)(n)]))}async function Xe(e,t){const n=await qe(e,`RETR ${t.index}`,!0);if($e(n))return{...t,headersOnly:!1,message:et(n)};throw new Be("RETR_ERROR",(0,d.Z)("POP server did not respond correctly to RETR command. Response: $1",[(0,Ce.DA)(n)]),e)}function Ye(e){const t=[...e],n=new Map;let a=(0,Ce.L2)(t,[13,10]);for(;-1!==a;){const e=(0,Ce.L2)(t,[13,10],a+1),s=-1!==e?t.slice(a+2,e):t.slice(a+2),i=s.indexOf(32);if(-1===i){a=e;continue}const r=s.slice(0,i),o=s.slice(i+1),c=Number(String.fromCharCode(...r)),l=String.fromCharCode(...o);n.set(l,c),a=e}return n}function Je(e){const t=[...e],n=new Map;let a=(0,Ce.L2)(t,[13,10]);for(;-1!==a;){const e=(0,Ce.L2)(t,[13,10],a+1),s=-1!==e?t.slice(a+2,e):t.slice(a+2),i=s.indexOf(32);if(-1===i){a=e;continue}const r=s.slice(0,i),o=s.slice(i+1),c=Number(String.fromCharCode(...r)),l=parseInt(String.fromCharCode(...o));n.set(c,l),a=e}return n}function et(e){const t=(0,Ce.L2)(e,[13,10]);if(-1===t)throw new Error("parseRetrResponse: Expected end of line");return e.subarray(t+2)}async function tt(e,t,n){const a=[];for(const e of n){const t=ye.Z.call(e.message),n=(0,Ue.Zp)(e.message),s=(0,Ue.Dc)(n),i={to:t.to,from:t.from,cc:t.cc,inReplyTo:t.inReplyTo,replyTo:t.replyTo,subject:t.subject,sentDate:t.sentDate,messageId:t.messageId,listId:t.listId,listPost:t.listPost,references:t.references,flags:[],uidl:e.uidl||"",attachment:s.length,size:e.size};i.messageId||(i.messageId=""),a.push(i)}const s=await B.call(t,a).catch((n=>{throw new Be("STORE_ERROR",(0,d.Z)("Unable to store POP message in mail store.",[t]),e)}));if(s.length>0){const i=[];for(const r of s){const s=a.findIndex((e=>h.Z.messageEqualsSle(e,r))),o=a[s],c=n[s];if(!c.headersOnly){const{sentDate:n,id:a}=r;try{const s=await(0,ve.Z)(a,o,c.message);s&&(c.message=s.raw,r.preview=(0,Fe.Q)(s.bodyParts),await(0,S.Z)(a,r.preview)),await nt(e,t,c,n,a),i.push(a)}catch(e){m.Z.error("Mail",["pop",t,a],"Failed to process mail: ",e)}}}i.length>0&&await M.Z.setHasRaws(t,i)}return s}async function nt(e,t,n,a,s){try{await P.Z.call(t,a,s,n.message)}catch(n){throw new Be("STORE_ERROR",(0,d.Z)("Unable to store POP message as writing to disk failed.",[t]),e)}}async function at(e,t){switch(e.message){case"SOCKET_TIMEOUT":case"SEND_ERROR":case"CONNECT_ERROR":case"DELETE_ERROR":case"NO_UIDL":case"NO_SOCKET":e.socket&&e.socket.close();break;case"MISCONFIGURED_ACCOUNT":case"SOCKET_CLOSED":break;default:if(e.socket){const{socket:t}=e;st(t,!1)}}throw e.socket&&(e.socket.onerror=null),U.KU.set(t,"POP",e,e.code),e}async function st(e,t=!0){try{await qe(e,"QUIT"),e.close()}catch(e){if(t)throw e;m.Z.error("Mail",["pop-client"],e)}}async function it(e,t){const n=await qe(e,"UIDL",!0);if(!$e(n))throw new Be("NO_UIDL",(0,d.Z)("POP server $1 does not support UIDL",[t]),e);const a=Ye(n);U.U.setStatus(ne.A4,(0,d.Z)("$1 message exists on POP account $2","$1 messages exist on POP account $2",[a.size,t]));const s=await qe(e,"LIST",!0);if(!$e(s))throw new Be("NO_LIST",(0,d.Z)("POP server $1 does not support LIST",[t]),e);return{uidlMap:a,sizeMap:Je(s)}}async function rt(e){try{const t=e.MAIL_USER,n=e.MAIL_PASSWORD,a=e.MAIL_SERVER,s=e.MAIL_PORT;if(!(t&&n&&a&&s))throw new Be("MISCONFIGURED_ACCOUNT",(0,d.Z)("Incoming POP server attributes missing for $1",[e.MAIL_EMAIL]));const i=await Ke(a,s,t,n);return U.KU.delete(e.MAIL_EMAIL,"POP"),i}catch(t){throw U.KU.set(e.MAIL_EMAIL,"POP",t,t.code),t}}function ot(e){return e.popDeletion||{when:C.qd,howManyDays:0}}async function ct(e){const t=(await k.Z.loadPopAccounts()).find((({MAIL_EMAIL:t})=>t===e));if(t)return t;throw new Error("Account not found "+e)}async function lt(e,t,n){const a=[],s=[];let i=!0;const r=ot(e),o=function(e){const t=e.popMaxSize||{limited:!1,limit:0};return t.limited?t.limit*ze:0}(e);for(const e of t){const{index:t,size:c}=e;let l;if(i&&o&&void 0!==c&&c>o)try{l=await Ge(n,e)}catch(e){i=!1,m.Z.warn("Mail",["pop-client"],"Error using TOP to fetch mail, using RETR instead.",e)}l||(l=await Xe(n,e),r.when===C.eQ&&s.push(t)),a.push(l)}return{popMails:a,safeToDelete:s}}async function dt(e,t){for(const n of t){if(!$e(await qe(e,`DELE ${n}`)))throw new Be("DELETE_ERROR",(0,d.Z)("Failed to delete mail with index $1",[n]),e)}}const ut={verifyLogin:async function(e){const{MAIL_SERVER:t,MAIL_PORT:n,MAIL_USER:a,MAIL_PASSWORD:s,MAIL_EMAIL:i}=e;if(!(t&&n&&(a&&s||e.useOAuth)))throw new Be("MISCONFIGURED_ACCOUNT",(0,d.Z)("Incoming server attributes missing for $1",[i]));try{const e=await Ke(t,n,a,s,1e4);await st(e)}catch(e){await at(e,i)}},deleteMail:async function(e,t){if(!e.popDeletion||e.popDeletion.when!==C.Qp)return;const n=e.MAIL_EMAIL;try{const a=await rt(e),s=await qe(a,"UIDL",!0);if(!$e(s))throw new Be("NO_UIDL",(0,d.Z)("POP server $1 does not support UIDL",[n]),a);const i=(await g.Z.pop.where("searchListId").anyOf(t).toArray()).filter((e=>e.accountId===n)).map((e=>e.uidl)),r=Ye(s),o=[];for(const e of i)r.has(e)&&o.push(e);await dt(a,o),await qe(a,"QUIT"),await a.close()}catch(e){await at(e,n)}},getMail:async function(e){const t=await rt(e),n=e.MAIL_EMAIL;U.U.setStatus(ne.A4,(0,d.Z)("Checking for new mail on POP account $1",[n]));try{const{uidlMap:a,sizeMap:s}=await it(t,n),i=await async function(e,t,n){const a=e.MAIL_EMAIL,s=[...t.keys()],i=await async function(e,t){const n=t.map((t=>[e,t]));return await g.Z.pop.where("[accountId+uidl]").anyOf(n).toArray()}(a,s),r=new Map,o=new Set;for(const e of i){const{uidl:t,searchListId:n}=e,a=r.get(t);a?a.push(e):r.set(t,[e]),o.add(n)}const c=await A.Z.getBySearchListIdsAccountId([...o],a),l=new Map;for(const e of c)if(e){const{searchListId:t,hasRaw:n}=e;l.set(t,1===n)}const d=[],u=new Set,h=ot(e);for(const[e,s]of t){if(!e){m.Z.warn("Mail",["pop-client"],"POP message does not have UIDL: "+a+" index: "+s);continue}const t=r.get(e);if(t&&0!==t.length){const[{searchListId:e,createdTimestamp:n}]=t;!1!==l.get(e)&&(h.when===C.eQ||h.when===C.kA&&n+24*h.howManyDays*60*60*1e3<Date.now())&&u.add(s)}else{const t={index:s,uidl:e,size:n.get(s)||0};d.push(t)}}return{toFetch:d,safeToDelete:u}}(e,a,s),{toFetch:r}=i,o=r.length;let c=0;U.U.setStatus(ne.A4,(0,d.Z)("Need to fetch $1 message - $2","Need to fetch $1 messages - $2",[o,n]));let l=123;const u=new I.Z.BatchSizeOptimizer(123,5e3);for(;r.length>0;){const a=Date.now(),s=r.splice(0,l),h=await ct(n);if((0,De.OM)(e,h))break;const f=await lt(h,s,t),{popMails:p,safeToDelete:g}=f;if(p.length>0){const e=await tt(t,n,p);e.length>0&&U.QO.updateIndex({addedSles:e}),we.filter(),Pe.updateThreads()}if(g.length>0){await dt(t,g);for(const e of g)i.safeToDelete.delete(e)}const m=Date.now();c+=l,l=u.optimize(l,m-a),U.U.setStatus(ne.A4,(0,d.Z)("Indexing mail $1 $2/$3",[n,c,o]))}i.safeToDelete.size>0&&await dt(t,[...i.safeToDelete]),await st(t)}catch(e){await at(e,n)}},getMessage:async function(e,t,n){const a=e.MAIL_EMAIL,s=await rt(e),{uidlMap:i,sizeMap:r}=await it(s,a),o=i.get(t);if(void 0===o)throw new Error("Message not listed on POP server "+t);const c={index:o,uidl:t,size:r.get(o)||0},{message:l}=await Xe(s,c);U.QO.runStoredQueryFilters([n]);const d=(0,Ue.Zp)(l),u=(0,Ue.Dc)(d).length;return u>0&&(await g.Z.searchList.update(n,{attachment:u}),U.QO.updateIndex({sleUpdates:[{id:n,updates:{attachment:u}}]})),l},repliedOK:$e,openPOP:Ve,sendAndReceive:qe,parseUidlResponse:Ye,parseListResponse:Je,parseRetrResponse:et,arrayEndsWith:Ce.MF,getNonce:We};let ht=!1;const ft={};async function pt(e){if(e.isDeleted)return;const t=e.MAIL_EMAIL;if(navigator.onLine)if(e.offline)U.U.setStatus(ne.A4,(0,d.Z)("Account $1 has been set as an offline account. Check settings.",[t]));else{if(!e.MAIL_PORT||e.MAIL_PORT<=0)throw new Error(`Port missing or invalid: ${e.MAIL_PORT||""}`);if(!ft[t]){ft[t]=!0,U.U.setStatus(ne.A4,(0,d.Z)("Indexing - $1 $2",[t,C.Gf]));try{await ut.getMail(e),U.U.setStatus(ne.A4,(0,d.Z)("Finished indexing - $1",[t]),C.QM)}catch(t){!function(e,t){m.Z.error("Mail",["pop"],t);const n=`${e.MAIL_SERVER||""} / ${e.MAIL_USER||""}: ${t.name} `;t.message=n+t.message,U.U.setStatus(ne.A4,t.message)}(e,t)}finally{ft[t]=!1,U.QO.removePathIndicator(t,C.Gf)}}}else U.U.setStatus(ne.A4,(0,d.Z)("No network connection"))}async function gt(e){let t=await k.Z.loadPopAccounts();if(t=t.filter((e=>!e.offline)),!t)return;if((await g.Z.systemTasks.toArray()).some((e=>"restore_mail_db"===e.taskName)))m.Z.warn("Mail",["pop"],"Not connecting while restoration in progress");else if(e){const n=t.find((t=>t.MAIL_EMAIL===e));n&&await pt(n)}else for(let e=0;e<t.length;e++)await pt(t[e])}function mt(e,t){return ut.deleteMail(e,t)}function wt(e,t,n){return ut.getMessage(e,t,n)}const _t={checkForMail:gt,deletePopMail:mt,getPopMessage:wt,setCheckInterval:function(e,t){ht&&clearInterval(ht),ht=!!e&&setInterval(gt,6e4*t)}};self.addEventListener("message",(async function({origin:e,data:t,source:n}){if(e!==ne.oP||!t||!t.pop)return;const{promiseId:a,func:s,args:i=[]}=t.pop;if(s)try{const e=await _t[s](...i),t=e&&"getPopMessage"===s?[e.buffer]:void 0;n.postMessage({pop:{promiseId:a,results:e}},{transfer:t})}catch(e){n.postMessage({pop:{promiseId:a,error:e.message||e}})}}),!1);var bt=n(13248),yt=n(83204),vt=n(92292),It=n(26067);function kt(e,t,n){const{pathArray:a,fileName:s}=(0,It.ZP)(e,t,n);return new Promise((e=>{Z.Z.mailPrivate.messageFileExists(a,s,(t=>{vt.Z.runtime.lastError?e(!1):e(t)}))}))}const Et={runSystemTask:async function(e){const{fileKeys:t}=e,n=t.length;let a=0,s=111;const i=new I.Z.BatchSizeOptimizer(s,2e3);for(;t.length>0;){U.U.setStatus(ne.A4,(0,d.Z)("Checking raw email files $1/$2",[a,n]));const r=Date.now(),o=t.splice(0,s),c=[];for(const e of o){const{accountId:t,searchListId:n,sentDate:a}=e,s=await kt(t,a,n)?1:0;c.push({accountId:t,searchListId:n,hasRaw:s,sentDate:a})}await g.Z.transaction("rw",[g.Z.hasRaw,g.Z.systemTasks],(()=>{g.Z.hasRaw.bulkPut(c),g.Z.systemTasks.update(e.id,{fileKeys:t})})),a+=s;const l=Date.now();s=i.optimize(s,l-r)}await g.Z.systemTasks.delete(e.id),U.U.setStatus(ne.A4,(0,d.Z)("Done checking $1 raw email files",[n]))},isRawOnDisk:kt};var xt=n(5267),At=n(83507);var St=n(89378),Mt=n(57654),Ot=n(19789);var Nt=n(60308),Zt=n(9982),Tt=n(25100),Lt=n(40348);async function Rt(e,t,n,a,s){const i={added:0,failed:0,dups:0,renamed:0};if(e.from.length+e.to.length+e.cc.length===0&&!e.subject){m.Z.warn("Mail",["restoreMailDb",t,n,a],"Selected file does not seem to be a mail file");const e=(0,d.Z)("Selected file does not seem to be a mail file: $1",[a]);return U.U.setStatus(ne.A4,e,C.QM),i}const r=y.Z.getFolderType(t,n),{indexUpdates:o}=await Nt.Z.call(t,n,r,[e]),{addedSles:c=[],sleUpdates:l=[]}=o,u=c[0];if(!(u||l&&0!==l.length))return m.Z.info("Mail",["restoreMailDb",t,n,a],"Message already exists."),i.dups+=1,i;if(u&&s){const n=y.Z.getFolderType(t,C.N1),a=await h.Z.addSourceFilters(t,C.N1,n,[{message:e,searchListEntry:u}],!0);l.push(...a)}U.QO.updateIndex(o),i.added+=c.length;const{id:f}=u||l[0],{relativePathParts:p,fileName:g}=(0,It.xh)(a);try{await Z.Z.mailPrivate.renameMessageFile(p,g,`_${f}.eml`),vt.Z.runtime.lastError&&m.Z.error("Mail",["restoreMailDb","renameMessageFile",g],vt.Z.runtime.lastError)}catch(e){return m.Z.error("Mail",["restoreMailDb",p,g,f],e),i.failed+=1,i}return i.renamed+=1,await M.Z.setHasRaw(t,f),await(0,Zt.Z)(t,n,[e]),J.Z.filter(),Pe.updateThreads(),i}async function Pt(e){try{const t=(0,It.sz)(e),n=await Z.Z.mailPrivate.getFilePaths(t);vt.Z.runtime.lastError&&m.Z.error("Mail",["restoreMailDb","getFilePaths",t],vt.Z.runtime.lastError);for(const e of n){const{fileName:t,relativePathParts:n}=(0,It.xh)(e);if("_"===t[0]){const e=t.slice(1);await Z.Z.mailPrivate.renameMessageFile(n,t,e),vt.Z.runtime.lastError&&m.Z.error("Mail",["restoreMailDb","renameMessageFile",t,e],vt.Z.runtime.lastError)}}}catch(e){m.Z.error("Mail",["restoreMailDb"],e)}}async function Ct(e,t,n){if(!n.includes(e)){if(t.find((t=>t.MAIL_EMAIL===e))){m.Z.warn("Mail",["restoreMailDb"],`Account ${e} missing and being added`);const t=c.Z.getDefaultFolders(),n=await r.Z.add(e,t);await u.Z.addAccounts({[e]:n});const a=await o.Z.foldersToFilters(e,t);b.Z.updateFilters(a)}}}async function Ut(e){"restore_mail_db"===e.taskName?await async function(e){let t=0,n=0,a=0,s=0,i=0,o=0,c=0,l=0,u=0;try{const h=await Z.Z.mailPrivate.getMailFilePaths();vt.Z.runtime.lastError&&m.Z.error("Mail",["restoreMailDb","getMailFilePaths"],vt.Z.runtime.lastError),h.sort();const f=await k.Z.loadAllAccounts(),p=f.map((e=>e.MAIL_EMAIL)),w={};for(const e of p)w[(0,It.BB)(e)]=e;const _=(0,It.BB)(C.u4);let b=[],y=0;if(e.currentFilePath)for(;y<h.length;y++){const t=h[y];if(t.slice(0,t.lastIndexOf("/"))===e.currentFilePath.slice(0,e.currentFilePath.lastIndexOf("/")))break}for(let p=y;p<h.length;p++){p%20==0&&U.U.setStatus(ne.A4,(0,d.Z)("Rebuilding database: $1/$2",[p,h.length]));const y=h[p];try{const{relativePathParts:d,fullPathParts:u}=(0,It.xh)(y),[h]=d;if(h===_)continue;b.length>0&&u.slice(0,u.length-1).some(((e,t)=>b[t]!==e))&&(await Pt(b),await g.Z.systemTasks.update(e.id,{currentFilePath:y})),b=u;const p=u[u.length-1];let[v,I]=p.split(".");if("_"===v[0]&&(v=v.slice(1)),!I||"eml"!==I.toLowerCase()){m.Z.warn("Mail",["restoreMailDb"],"file name does not have an eml extension",y);continue}if(!Number(v)){m.Z.warn("Mail",["restoreMailDb"],"file does not have a numeric file name",y);continue}if(h===_){m.Z.warn("Mail",["restoreMailDb"],"Not able to restore Feed items yet!");continue}const k=await(0,Lt.Z)(y);if(0===k.length){m.Z.warn("Mail",["restoreMailDb"],"file is empty",y);continue}t+=1;const E=ye.Z.call(k),x=await(0,Tt.Z)(E,[],k),A=w[h],S=x.to.find((e=>e.address===A)),M=x.from.find((e=>e.address===A));let O=S?.address;const N=M?.address;let Z;O||N||(O=A);const T=O===N,L=(await r.Z.getAll()).map((e=>e.accountId));if(O){await Ct(O,f,L);const{added:e,failed:t,dups:s,renamed:r}=await Rt(x,O,C.Gf,y,T);T?i+=e:a+=e,o+=t,l+=s,n+=r,n>0&&(Z=y.replace(/([0-9]+\.eml)$/,"_$1"))}if(N&&!T){await Ct(N,f,L);const e=Z||y,{added:t,failed:a,dups:i,renamed:r}=await Rt(x,N,C.N1,e,!1);s+=t,c+=a,l+=i,n+=r}}catch(e){u+=1,m.Z.error("Mail",["restoreMailDb"],e)}}b.length>0&&await Pt(b),await g.Z.systemTasks.delete(e.id)}catch(e){u+=1,m.Z.error("Mail",["restoreMailDb"],e)}m.Z.warn("Mail",["restoreMailDb"],"Message files read",t),m.Z.warn("Mail",["restoreMailDb"],"Message files renamed",n),m.Z.warn("Mail",["restoreMailDb"],"Duplicates",l),m.Z.warn("Mail",["restoreMailDb"],"Added to Inbox",a),m.Z.warn("Mail",["restoreMailDb"],"Added to Inbox and Sent",i),m.Z.warn("Mail",["restoreMailDb"],"Added to Sent",s),m.Z.warn("Mail",["restoreMailDb"],"Failed adding to Inbox",o),m.Z.warn("Mail",["restoreMailDb"],"Failed adding to Sent",c),m.Z.warn("Mail",["restoreMailDb"],"Errors",u)}(e):"restore_full_text_search_db"===e.taskName?await async function(e){const t=await g.Z.searchList.toCollection().last();if(t){Pa.pausePrefetching(!0);try{let{currentPosition:n}=e;for(;n<=t.id;){if(a.Z.get(L.kMailIsTurnedOff)){U.U.setStatus(ne.A4,(0,d.Z)("Mail client turned off - Stopped building text-search database"),3e3);break}U.U.setStatus(ne.A4,(0,d.Z)("Building text-search database: $1/$2",[(0,Ot.uf)(n),(0,Ot.uf)(t.id)]));const s=await g.Z.messages.where("id").between(n,t.id+1).limit(20).toArray();if(0===s.length)break;const i=await g.Z.searchList.where("id").between(n,s[s.length-1].id+1).toArray(),r=[];for(let e=0;e<s.length;e++){const t=s[e],n=i[e],{subject:a,to:o,cc:c,from:l,replyTo:d}=t;let u=(0,Fe.H)(t.bodyParts);if(!u)for(const e of new Set(n.sourceFilterIds.map((e=>b.Z.get(e))).filter(Boolean).map((e=>e.accountId)))){const t=await At.Z.call(e,n.id,n.sentDate);if(t){if(e===C.u4){const e=new TextDecoder("utf-8").decode(t);u=(0,Mt.Z)(e)}else{const e=(0,Ue.PW)((0,Ue.Zp)(t));if(!e)break;const n=await O.Z.parseMail(t,e.mimeTree);u=(0,Fe.H)(n.bodyParts)}break}}r.push({searchListId:n.id,subject:a,body:u,to:(0,St.Z)(o),cc:(0,St.Z)(c),from:(0,St.Z)(l),replyTo:(0,St.Z)(d)})}await(0,z.Z)(r),n=s[s.length-1].id+1,await g.Z.systemTasks.update(e.id,{currentPosition:n})}a.Z.get(L.kMailIsTurnedOff)||(await g.Z.systemTasks.delete(e.id),U.U.setStatus(ne.A4,(0,d.Z)("Building text-search database finished"),C.QM))}finally{Pa.pausePrefetching(!1)}}else await g.Z.systemTasks.delete(e.id)}(e):"delete_full_text_search_entries"===e.taskName?await xt.Z.systemTaskDelete(e):"check_disk_for_raw"===e.taskName?await Et.runSystemTask(e):"generate_missing_previews"===e.taskName?await async function(e){const t=e.currentId||0;let n=128;const a=new I.Z.BatchSizeOptimizer(n,2e3),s=await g.Z.searchList.toCollection().primaryKeys(),i=s[s.length-1];!async function t(s){if(s>=i)return void g.Z.systemTasks.delete(e.id);const r=Date.now(),o=await g.Z.searchList.where("id").between(s,i+1).limit(n).toArray();if(U.U.setStatus(ne.A4,(0,d.Z)("Generate previews: $1/$2",[s,i]),C.QM),0===o.length)return void g.Z.systemTasks.delete(e.id);const c=o.map((e=>e.id)),l=new Map;o.forEach((e=>l.set(e.id,e)));const u=(await g.Z.hasRaw.where("searchListId").anyOf(c).toArray()).filter((e=>e.hasRaw)),h=[];for(const e of u){const{accountId:t,searchListId:n}=e,a=l.get(n);if(a){const e=await At.Z.call(t,n,a.sentDate);if(e){const t=(0,Ue.PW)((0,Ue.Zp)(e));if(t){const a=await O.Z.parseMail(e,t.mimeTree),s=(0,Fe.Q)(a.bodyParts);h.push({id:n,updates:{preview:s}})}}}}s=c[c.length-1]+1,await g.Z.transaction("rw",[g.Z.searchList,g.Z.systemTasks],(async()=>{await Promise.all(h.map((e=>g.Z.searchList.update(e.id,e.updates)))),await g.Z.systemTasks.update(e.id,{currentId:s})})),U.QO.updateIndex({sleUpdates:h});const f=Date.now();n=a.optimize(n,f-r),t(s)}(t)}(e):console.error("task not supported",e)}async function Ft(e,t,n){U.U.setStatus(ne.A4,(0,d.Z)("Removing data from $1 in $2",[t,e]));const a=[e,t,0],s=[e,t,Number.MAX_VALUE];await g.Z.imap.where("[accountId+path+uid]").between(a,s).delete(),await g.Z.mailboxCache.where("[accountId+path]").equals([e,t]).delete();const i=await g.Z.filters.where("[accountId+path]").equals([e,t]).first(),r=await g.Z.filters.toCollection().filter((n=>n.accountId===e&&n.path===t||n.selectedAccountId===e&&n.selectedName===i.name)).primaryKeys(),o=await Bt(e,r);e===C.u4&&await g.Z.deletedFeedItems.where("path").equals(t).delete(),n&&await zt(e,o),await g.Z.buffer.where("[accountId+path]").equals([e,t]).delete(),U.U.setStatus(ne.A4,(0,d.Z)("Finshed removing data from $1 in $2",[t,e]))}async function Dt(e,t){U.U.setStatus(ne.A4,(0,d.Z)("Removing data for $1",[e]));const n=[e,""],a=[e,"ï¿¿"];await g.Z.imap.where("accountId").equals(e).delete(),await g.Z.hasRaw.where("accountId").equals(e).delete(),await g.Z.pop.where("accountId").equals(e).delete(),await g.Z.mailboxCache.where("accountId").equals(e).delete();const s=(await g.Z.filters.where("[accountId+path]").between(n,a).toArray()).map((e=>e.id)),i=await Bt(e,s);t&&await zt(e,i),await g.Z.buffer.where("accountId").equals(e).delete()}async function zt(e,t){U.U.setStatus(ne.A4,(0,d.Z)("Removing raw message files for $1",[e])),await Promise.all(t.map((t=>{yt.Z.call(e,t.id,t.sentDate).catch((n=>console.warn(`Error deleting file for ${e}/${t.id}. May not exist! ${n}`)))})))}async function Bt(e,t){const n=[],a=[],s=new Set;let i,r;t.forEach((e=>{for(let t=0;t<C.XN;t++)s.add(e*C.XN+t)}));const o=[];await g.Z.transaction("rw",[g.Z.messages,g.Z.searchList,g.Z.threading,g.Z.filters,g.Z.viewIds,g.Z.systemTasks,g.Z.hasRaw],(async()=>{U.U.setStatus(ne.A4,(0,d.Z)("Updating database...")),await g.Z.searchList.where("sourceFilterIds").anyOf(t).distinct().modify(((e,s)=>{if(t.forEach((t=>{e.sources.delete(t)})),e.sources.size>0){const a=new Set(t);e.sourceFilterIds=e.sourceFilterIds.filter((e=>!a.has(e))),n.push(e);const s=new Set(b.Z.getByIds([...e.sources.keys()]).map((({accountId:e})=>e))),i=new Set(b.Z.getByIds(t).map((({accountId:e})=>e)).filter((e=>!s.has(e))));for(const t of i)o.push([e.id,t])}else a.push(e),delete s.value})),r=a.map((e=>e.id)),U.U.setStatus(ne.A4,(0,d.Z)("Removing messages...")),await Promise.all([g.Z.messages.where("id").anyOf(r).delete().then((()=>U.U.setStatus(ne.A4,(0,d.Z)("Removing threading info...")))),g.Z.threading.where("id").anyOf(r).delete().then((()=>U.U.setStatus(ne.A4,(0,d.Z)("Removing header info...")))),g.Z.viewIds.where("searchListId").anyOf(r).delete().then((()=>U.U.setStatus(ne.A4,(0,d.Z)("Updating view indices...")))),g.Z.viewIds.where("searchListId").anyOf(n.map((e=>e.id))).modify((e=>{e.viewIds=e.viewIds.filter((e=>!s.has(e)))})).then((()=>U.U.setStatus(ne.A4,(0,d.Z)("Removing raw indicators...")))),g.Z.hasRaw.where("searchListId").anyOf(r).delete().then((()=>U.U.setStatus(ne.A4,(0,d.Z)("Removing raw indicators...")))),g.Z.hasRaw.bulkDelete(o).then((()=>U.U.setStatus(ne.A4,(0,d.Z)("Removing message filters...")))),g.Z.filters.where("id").anyOf(t).delete().then((()=>U.U.setStatus(ne.A4,(0,d.Z)("Finished updating database"))))]);const e={taskName:"delete_full_text_search_entries",currentPosition:0,searchListIds:r},c=await g.Z.systemTasks.add(e);i={id:c,...e}})),i?Ut(i):console.warn("removeBySourceFilterIds: Expected task to be added"),b.Z.updateFilters(t);const c=n.map((e=>{const n=new Map([...t.map((e=>[e,void 0]))]);for(const[t,a]of e.sources)n.set(t,{...a});return{id:e.id,updates:{sources:n,sourceFilterIds:e.sourceFilterIds,removedViewIds:[...s]}}})),l={removedSles:r,sleUpdates:c};return U.QO.updateIndex(l),a}class $t extends Error{}const jt=new Map;function Vt(e,t,n){switch(U.QO.setAccountIndicator(e.MAIL_EMAIL,"INDICATOR_TYPE_FLUSHING",n.current,n.total),t.operation){case"BUFFER_OPERATION_CUSTOM_FLAG":return Pa.updateFlags(e.MAIL_EMAIL,t.path,t.uids,t.flagUpdates);case"BUFFER_OPERATION_DELETE_IMAP":return Pa.deleteMessages(e.MAIL_EMAIL,t.path,t.uids);case"BUFFER_OPERATION_DELETE_POP":return mt(e,t.searchListIds);case"BUFFER_OPERATION_MOVE":return Pa.moveMessages(t.accountId,t.path,t.uids,t.destinationPath);case"BUFFER_OPERATION_COPY":return Pa.copyMessages(e.MAIL_EMAIL,t.path,t.uids,t.destinationPath);case"BUFFER_OPERATION_UPLOAD_MESSAGE":return Pa.uploadMessage(e.MAIL_EMAIL,t.path,t.searchListId,t.flags);default:return Promise.reject("Unknown batch operation '"+t.operation+"'")}}async function qt(){const e=await g.Z.buffer.where("operation").equals("BUFFER_OPERATION_FETCH_RAW_FOR_ALL_SOURCES").toArray();if(e.length>0){const t=e.map((({searchListId:e})=>e));await async function(e){const t=await A.Z.getBySearchListIdsHasRaw(e,!1);if(0===t.length)return;const n=new Map,a=new Map,s=new Set;for(const{searchListId:e,accountId:i}of t)if((0,bt.mq)(i)){const t=n.get(i);t?t.push(e):n.set(i,[e]),s.add(e)}else if((0,bt.Vd)(i)){const t=a.get(i);t?t.push(e):a.set(i,[e]),s.add(e)}if(0===s.size)return;m.Z.info("Mail",["flushBuffer","fetchRawForAllSources"],`Fetching ${s.size} messages`);const i=await(0,x.Z)([...s]),r=new Map(i.map((e=>[e.id,e]))),o=new Map,c=[],l=new Map,d=new Map,u=[];async function h(e,t,n){const a=r.get(e);if(!a)return void m.Z.error("Mail",["flushBuffer","fetchRawForAllSources",t,e],"Message not found");const s=(0,Ue.PW)((0,Ue.Zp)(n));if(!s)return;const i=await O.Z.parseMail(n,s.mimeTree),h=(0,Fe.Q)(i.bodyParts);u.push({id:e,updates:{preview:h}}),o.has(e)||o.set(e,[a,i]),c.push([e,t,a.sentDate,i.raw]),l.has(e)||l.set(e,h);const f=d.get(t);f?f.push(e):d.set(t,[e])}for(const[e,t]of n)try{const n=await Pa.fetchRawOfMessages(e,t);for(const[t,a]of n)await h(t,e,a)}catch(t){m.Z.error("Mail",["flushBuffer","fetchRawForAllSources",e],t)}for(const[e,t]of a)try{const n=await g.Z.pop.where("searchListId").anyOf(t).filter((t=>t.accountId===e)).toArray(),a=await k.Z.loadAccount(e);for(const{accountId:e,searchListId:t,uidl:s}of n){if(!r.get(t)){m.Z.error("Mail",["flushBuffer","fetchRawForAllSources",e,t],"Message not found");continue}const n=await wt(a,s,t);n&&await h(t,e,n)}}catch(t){m.Z.error("Mail",["flushBuffer","fetchRawForAllSources",e],t)}U.QO.updateIndex({sleUpdates:u}),await Promise.all([...o].map((([e,[t,n]])=>{const a=(0,Fe.H)(n.bodyParts);return(0,ve.K)(e,t,a).catch((t=>m.Z.error("Mail",["fetchRawForAllSources",e],t)))}))),await Promise.all(c.map((([e,t,n,a])=>P.Z.call(t,n,e,a)))),await Promise.all([...l].map((([e,t])=>(0,S.Z)(e,t)))),await Promise.all([...d].map((([e,t])=>M.Z.setHasRaws(e,t))))}(t),U.QO.runStoredQueryFilters(t),await E.byIds(e.map((({_id:e})=>e)))}}async function Qt(e,t){if(e.accountType===C.s9.IMAP&&!e.offline){for(const n of t)if("Inbox"!==n)try{await Pa.selectMailbox(e.MAIL_EMAIL,n)}catch(t){m.Z.error("Mail",["syncAndPark",e.MAIL_EMAIL,n],t)}Pa.park(e.MAIL_EMAIL)}}const Ht=new Map;function Kt(e,t){return I.Z.adjustBatchSize(100,1e3,500,e,t)}const Wt=(0,F.Z)((async()=>{await qt(),await async function(){const e=await g.Z.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT").toArray();for(const t of e){const{accountId:e,deleteFiles:n,deletePasswords:a}=t;await Dt(e,n),R(e,a)}}(),await async function(){const e=await g.Z.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT_PATH").toArray();for(const t of e){const{accountId:e,path:n,deleteFiles:a}=t;await Ft(e,n,a)}}();(await k.Z.loadAllAccounts()).forEach((e=>{const{MAIL_EMAIL:t}=e;void 0===jt.get(t)&&Gt(e)}))}),1e3);async function Gt(e,t=[]){const{MAIL_EMAIL:n}=e,a=jt.get(n)||0;jt.set(n,a);try{let s;if(await g.Z.buffer.where("accountId").equals(n).offset(a).limit(1).modify((e=>{e.isFlushing=!0,s=e})),!s)return jt.set(n,void 0),U.QO.removeAccountIndicator(n,"INDICATOR_TYPE_FLUSHING"),Qt(e,t),void Ht.delete(n);if(e.offline)return await g.Z.buffer.where("_id").equals(s._id).delete(),void await Promise.resolve().then((()=>Gt(e,t)));const i="BUFFER_OPERATION_DELETE_POP"===s.operation?C.Gf:s.path,o=await r.Z.getFolderByPath(n,i);if(!o||e.accountType===C.s9.IMAP&&!o.subscribed)return m.Z.info("Mail",["flushBuffer",n,i],"Removing batch for a path that no longer exist or is not subscribed"),await g.Z.buffer.where("_id").equals(s._id).delete(),void await Promise.resolve().then((()=>Gt(e,t)));t.push(i),s.destinationPath&&t.push(s.destinationPath);const c=Ht.get(n)||Kt(100,500);if(void 0!==s.uids&&s.uids.length>c){const{uids:t}=s,{current:r=0,total:o=t.length}=s,l={current:r,total:o},d=t.slice(0,c),u={...s,uids:d},h=Date.now();try{await Vt(e,u,l);const t=new Set(d);await g.Z.buffer.where("_id").equals(s._id).modify((function(e){e.uids=e.uids.filter((e=>!t.has(e))),e.uids.length>0?(e.current=r+d.length,e.total=o,e.isFlushing=!1):delete this.value}));const a=Kt(c,Date.now()-h);Ht.set(n,a)}catch(e){jt.set(n,a+1),m.Z.error("Mail",["flushBuffer",n,i],e),e instanceof $t?await g.Z.buffer.where("_id").equals(s._id).delete():await g.Z.buffer.where("_id").equals(s._id).modify({isFlushing:!1})}}else{let t;t="BUFFER_OPERATION_DELETE_POP"===s.operation?{current:s.searchListIds.length,total:s.searchListIds.length}:{current:1,total:1};try{if(await Vt(e,s,t),void 0!==s.uids){const e=new Set(s.uids);await g.Z.buffer.where("_id").equals(s._id).modify((function(t){t.isFlushing=!1,t.uids=t.uids.filter((t=>!e.has(t))),0===t.uids.length&&delete this.value}))}else await g.Z.buffer.where("_id").equals(s._id).delete()}catch(e){jt.set(n,a+1),m.Z.error("Mail",["flushBuffer",n,i],e),e instanceof $t?await g.Z.buffer.where("_id").equals(s._id).delete():await g.Z.buffer.where("_id").equals(s._id).modify({isFlushing:!1})}}await Promise.resolve().then((()=>Gt(e,t)))}catch(a){m.Z.error("Mail",["flushBuffer",n],a),jt.set(n,void 0),U.QO.removeAccountIndicator(n,"INDICATOR_TYPE_FLUSHING"),Qt(e,t)}}const Xt={call:function(){navigator.onLine&&Wt()}};var Yt=n(12382);async function Jt(e,t,n){const a=[],s=[],i=new Map,r=b.Z.getByFolderId([e,t]);return n.forEach((n=>{const{uid:a}=n;s.push([e,t,a]),i.set(a,n)})),await g.Z.transaction("rw",[g.Z.imap,g.Z.searchList,g.Z.filteringQueue,g.Z.buffer],(async()=>{const n=await g.Z.imap.where("[accountId+path+uid]").anyOf(s).toArray(),o=new Map;n.forEach((e=>{const{searchListId:t,uid:n}=e,a=i.get(n);if(!a)throw new Error("imapMessage not found");o.set(t,a)}));const c=new Yt.Z.FilteringUpdatesSorter,l=[],d=[],u=[];await g.Z.searchList.where("id").anyOf([...o.keys()]).modify((n=>{const{id:s,unseen:i,flags:h}=n,f=o.get(s),p={},g={sources:new Map},w=(0,H.jw)(f.flags);p.sources=new Map;const _=(0,H.QE)(h,w);Object.keys(_).length>0&&(!function(e,t){delete t[C.T4.RECENT];const n=u.find((e=>(0,H.ui)(e.imapFlagUpdates,t)));n?n.searchListIds.push(e):u.push({searchListIds:[e],imapFlagUpdates:t})}(s,_),p.flags=n.flags=w,(0,H.wh)(h,f.flags,s,d),(0,H.Oj)(h,f.flags,s,l));const v=n.sources.get(r.id);if(!v)return void m.Z.warn("Mail",["imapUpdateFlags"],`Source not found for ${e}, ${t}`);const I=!(0,H.FL)(f),k={};v.read!==I&&(i&&I&&(n.unseen=p.unseen=g.unseen=!1),v.read=k.read=I);for(const[t,a]of n.sources)if(a.internal){const n=b.Z.get(t)?.accountId;t!==r.id&&n===e&&I!==a.read&&(a.read=I,p.sources.set(t,{read:I}))}const E=(0,H.uY)(f);if(v.deleted!==E&&(v.deleted=k.deleted=E),Object.keys(k).length>0&&(p.sources.set(r.id,k),g.sources.set(r.id,k)),!E){const a=y.Z.getFolderType(e,t);if(![C.uT,C.Hd,C.hn].includes(a)){[...n.sources.keys()].forEach((t=>{const a=n.sources.get(t);if(!a)throw new Error("Source not found "+t);if(a.internal&&a.deleted){const a=b.Z.get(t);if(!a)throw new Error("Filter not found "+t);a.accountId===e&&(n.sources.delete(t),p.sources.set(t,void 0),g.sources.set(t,void 0))}}))}}(Object.keys(p).length>1||p.sources.size>0)&&a.push({id:s,updates:p}),(Object.keys(g).length>1||g.sources.size>0)&&c.add(s,g)}));for(const e of c.getSorted()){const{searchListIds:t,updates:n}=e;if(n.sources.size>0){const e=[[C.of,C.cm],[C.of,C.tB],[C.of,C.rp],[C.of,C.$T]];await v.Z.call({type:"FILTERS_SLES",priority:C.Un.HIGH,folderIds:e,searchListIds:t})}}for(const e of d){const{searchListIds:t,oldStandardFlag:n,newStandardFlag:a}=e,s=[];n&&s.push([C.MN,n]),a&&s.push([C.MN,a]),s.length>0&&await v.Z.call({type:"FILTERS_SLES",priority:C.Un.HIGH,folderIds:s,searchListIds:[...t]})}for(const e of l){const{searchListIds:t,flag:n}=e,a=[[C.ut,n]];await v.Z.call({type:"FILTERS_SLES",priority:C.Un.HIGH,folderIds:a,searchListIds:[...t],runLabels:!0})}for(const e of c.getSorted()){const{searchListIds:t,updates:n}=e;await v.Z.call({type:"UPDATE_SLE",priority:C.Un.HIGH,searchListIds:t,...n})}if(u.length>0){for(const{searchListIds:t,imapFlagUpdates:n}of u)await _.Z.call(t,n,e);Xt.call()}})),a}var en=n(89846);async function tn(e,t){return await g.Z.transaction("rw",[g.Z.searchList,g.Z.messages,g.Z.threading],(async()=>{const n=(await g.Z.searchList.where("messageId").equals(e).toArray()).map((e=>e.id));await g.Z.searchList.where("id").anyOf(n).modify((e=>e.messageId=t)),await g.Z.messages.where("id").anyOf(n).modify((e=>e.messageId=t)),await g.Z.threading.where("id").anyOf(n).modify((e=>e.messageId=t))}))}async function nn(e,t,n,a){let s=[];const i=await g.Z.transaction("rw",w.E.concat([g.Z.imap,g.Z.accounts,g.Z.filters,g.Z.searchList,g.Z.filteringQueue,g.Z.buffer]),(async()=>{const i=[],o=[],c=[],l={};for(const e of a)if(e.originalMessageId){const t=e.originalMessageId;l[t]=e.messageId,await tn(t,e.messageId)}if(Object.keys(l).length>0)for(const e of a)l[e.messageId]&&(e.messageId=l[e.messageId]);const d=await h.Z.findMatchingSles(a),u=await async function(e,t,n){if(e.every((({searchListEntry:e})=>!e)))return{intact:e,newImapEntries:[],sleUpdates:[]};const a=await r.Z.getFolderByPath(t,n);if(!a)throw new Error(`${n} not found in db.accounts table for ${t}`);const s=a.type,i=b.Z.getByFolderId([t,n]);if(!i)throw new Error(`Filter not found for ${t} ${n}`);const o=[],c=[],l=[];for(const a of e){const{message:e,searchListEntry:r}=a;if(!r||e.sentDate!==r.sentDate||e.subject!==r.subject){l.push(a);continue}const{sourceFilterIds:d,sources:u}=r,h=u.get(i.id);if(!h||!h.internal){l.push(a);continue}const f=b.Z.getByIds(d);let p,g;for(const e of f){const{accountId:a,path:i}=e,r=a===t&&i===n;if(a===C.of&&i===C.N1&&s===C.Nz||r){p=a,g=i;break}}if(!p){l.push(a);continue}if(!g){l.push(a);continue}const{sleUpdate:m}=await(0,en.Z)(r.id,p,g,t,n,{addedProperties:{searchListSource:{internal:!1}}});o.push(m),c.push({accountId:t,path:n,uid:e.uid,searchListId:m.id})}return{intact:l,newImapEntries:c,sleUpdates:o}}(d,e,t),{intact:f,newImapEntries:_,sleUpdates:y}=u;if(i.push(..._),c.push(...y),0===f.length){await g.Z.imap.bulkPut(i);const n=await Jt(e,t,a);return c.push(...n),{sleUpdates:c}}const{newMessageGroups:v,duplicates:I}=h.Z.findDuplicates(f);for(const n of I){const{message:a,searchListEntry:s}=n,r={accountId:e,path:t,uid:a.uid,searchListId:s.id};i.push(r)}const k=v.map((e=>e[0])),E=await(0,w.Z)(e,t,n,k),x=E.addedSles;if(s=E.forSearchDb,x.forEach(((n,a)=>{v[a].forEach((a=>{i.push({accountId:e,path:t,uid:a.uid,searchListId:n.id})})),o.push(n)})),i.length!==a.length)throw new Error("Assert error in addImap: expected imapEntries to match imapMessages");try{await g.Z.imap.bulkAdd(i)}catch(n){m.Z.info("Mail",["addImap"],"bulkAdd to imap table failed, checking individual items",n);const s=await g.Z.imap.where("[accountId+path+uid]").anyOf(a.map((({uid:n})=>[e,t,n]))).toArray();for(const e of i){const t=p()(s,e,ae.gE);try{if(t<0)await g.Z.imap.add(e);else{const n=s[t];n.searchListId!==e.searchListId?(m.Z.info("Mail",["addImap"],"searchListId mismatch, the imap entry will be updated",{newImapEntry:e,existingImapEntry:n}),await g.Z.imap.put(e)):m.Z.info("Mail",["addImap"],"imap entry already exists, not adding",n)}}catch(e){m.Z.error("Mail",["addImap"],e)}}}const A=new Set(_.map((e=>e.uid))),S=a.filter((e=>A.has(e.uid))),M=await Jt(e,t,S);if(c.push(...M),I.length>0){const a=await h.Z.addSourceFilters(e,t,n,I,!1);c.push(...a)}return{addedSles:o,sleUpdates:c}}));return(0,z.Z)(s),i}var an=n(72315),sn=n.n(an),rn=n(91258);const on={debug:e=>{a.Z.get(L.kMailImapLogsOn)&&m.Z.debug("Mail",["imap-client"],...e())},info:e=>{a.Z.get(L.kMailImapLogsOn)&&m.Z.info("Mail",["imap-client"],...e())},error:e=>{a.Z.get(L.kMailImapLogsOn)&&m.Z.error("Mail",["imap-client"],...e())}};function cn(e,t){const n=t||{user:e.MAIL_USER,pass:(0,Ce.DA)((new TextEncoder).encode(e.MAIL_PASSWORD))},s=new(sn())({host:e.MAIL_SERVER,port:Number(e.MAIL_PORT),auth:n,secure:!0,ignoreTLS:!1,id:{name:`Vivaldi Mail/${Z.Z.utilities.getVersion().vivaldiVersion}`},logger:on});return s._client.logLevel=a.Z.get(L.kMailImapLogsOn)?rn.lw:rn.jF,s._client.timeoutConnection=1e4,s._client._enableCompression=!1,s}const ln=async function(e,t){const n=[],a=e.map((e=>e.searchListId));return g.Z.imap.bulkAdd(e),await g.Z.searchList.where("id").anyOf(a).modify((e=>{const{id:a}=e,s={sources:new Map},i=e.sources.get(t.id);if(i)i.internal=!1,s.sources.set(t.id,{...i});else{const n={read:!1,deleted:!1,internal:!1};e.sources.set(t.id,n),s.sources.set(t.id,{...n})}n.push({id:a,updates:s})})),n};const dn=async function(e,t,n){await g.Z.buffer.where("[accountId+path+operation]").equals([e,t,"BUFFER_OPERATION_CUSTOM_FLAG"]).modify((function(e){const{uids:t,flagUpdates:a}=e,s=new Set(t);n.forEach((e=>{Object.keys(a).every((t=>a[t]?e.flags.includes(t):!e.flags.includes(t)))&&s.delete(e.uid)})),0===s.size?delete this.value:e.uids=[...s]}))};var un=n(93818);const hn=async function(e){const{sources:t}=e;if(0===t.size)return Promise.resolve(!1);if(![...t.values()].every((e=>e.deleted&&e.internal)))return Promise.resolve(!0);const n=new Set,a=b.Z.getByIds([...t.keys()]);for(const e of a)n.add(e.accountId);const s=await A.Z.getBySearchListIdAccountIds(e.id,[...n]);return Promise.resolve(s.some((e=>e?.hasRaw)))};var fn=n(93043);var pn=n(30381),gn=n.n(pn);var mn=n(89555);let wn,_n,bn,yn={};function vn(){m.Z.info("Mail",["imapCache"],"Resetting init promise"),wn=new Promise(((e,t)=>{_n=()=>{m.Z.info("Mail",["imapCache"],"Resolving init promise"),e()},bn=e=>{m.Z.info("Mail",["imapCache"],"Rejecting init promise"),t(e)}})),wn.catch(mn.Z)}function In(){return m.Z.info("Mail",["imapCache"],"Initializing UID lists"),g.Z.imap.orderBy("[accountId+path+uid]").primaryKeys().then((e=>{e.forEach((e=>{const[t,n,a]=e;yn[t]||(yn[t]={}),yn[t][n]||(yn[t][n]=new Set),yn[t][n].add(a)})),_n()})).catch((e=>{throw bn(e),e}))}function kn(e,t){delete yn[e][t]}async function En(e){await wn;const t=await async function(e){const t=new Set,n=await r.Z.getFolder(e);for(const e of Object.keys(n)){const a=n[e];for(const e of a)t.add(e.path)}return t}(e),n=await g.Z.mailboxCache.where("accountId").equals(e).toArray(),a=yn[e]||{},s={};for(const e of n)s[e.path]=e,s[e.path].uidlist=Array.from(a[e.path]||[]),s[e.path].exists=s[e.path].uidlist.length,s[e.path].highestModseq=s[e.path].highestModseq||"0",t.delete(e.path),s[e.path].noModseq=s[e.path].noModseq||!1;for(const e of t){const t=Array.from(a[e]||[]),n=t.length>0?t[t.length-1]+1:0;s[e]={uidlist:t,uidNext:n,exists:t.length}}return s}vn();var xn=n(82164),An=n(36154);let Sn={};async function Mn(e,t){const n=await(0,An.Vf)(e,t),{accessToken:a,refreshToken:s,expiresIn:i,usernameFromIdToken:r}=n;r&&r.toLowerCase()!==e.toLowerCase()&&(Nn(e,["Username and the sub from idToken do not match",e,r]),e=r);const o=Date.now()+1e3*parseInt(i);if(Nn(e,["Fetched both refresh_token and access_token that expires in: ",On(o)]),Tn({[e]:{accessToken:a,expiryTime:o}}),s)try{const n={refreshToken:await Z.Z.utilities.osCrypt(s),provider:t};Pn.call(e,n)}catch(e){m.Z.error("oAuth","Error crypting refresh_token",e)}return{accessToken:a,usernameFromIdToken:e}}function On(e){const t=new Date(e);return`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`}function Nn(e,t){m.Z.info("oAuth",[e],t.join(" "))}async function Zn(e,t){const n=(await Rn.call())[e],s=function(e){return(a.Z.get(L.kOauthRefreshTokens)||{})[e.toLowerCase()]}(e);if(n&&n.expiryTime>Date.now())return Nn(e,[`Valid access_token found in cache that expires in: ${On(n.expiryTime)}`]),{accessToken:n.accessToken,usernameFromIdToken:e};if(s){let n="";try{n=await Z.Z.utilities.osDecrypt(s.refreshToken)}catch{return Ln(e,t)}Nn(e,["The access_token has expired in-session or we restarted the session.","Lets fetch new access_token using refresh_token from prefs"]);const a=await An.jb.call(n,t),{accessToken:i,expiresIn:r,invalidGrant:o,refreshToken:c,usernameFromIdToken:l}=a;if(c&&c!==n&&Pn.call(e,{refreshToken:await Z.Z.utilities.osCrypt(c),provider:t}),o)return Nn(e,["Invalid oAuth grant. Refresh Token has expired or has been revoked"]),m.Z.warn("oAuth","Invalid oAuth grant. Refresh Token has expired or has been revoked"),Ln(e,t);{const t=Date.now()+1e3*parseInt(r);return Nn(e,[`Got new access token with new expiry time: ${On(t)}\n        (fetched with stored refresh_token)`]),Tn({[e]:{accessToken:i,expiryTime:t}}),{accessToken:i,usernameFromIdToken:l}}}return Nn(e,["We don't have a cached token and we don't have a refresh token.","Need to fetch both."]),await Mn(e,t)}function Tn(e){Sn={...Sn,...e}}async function Ln(e,t){return Cn.call(e),Mn(e,t)}const Rn={call:function(){return Sn}},Pn={call:async function(e,t){N.Z.set(L.kOauthRefreshTokens,{...a.Z.get(L.kOauthRefreshTokens),[e]:t})}},Cn={call:async function(e){const t={...a.Z.get(L.kOauthRefreshTokens)},{provider:n}=t[e],s=xn.Z.oAuthProviders().get(n),i=(await Rn.call())[e];if(s?.revokeRefreshToken&&i){const{accessToken:e}=i;s.revokeRefreshToken(e)}!function(e){delete Sn[e]}(e),delete t[e.toLowerCase()],N.Z.set(L.kOauthRefreshTokens,t)}};var Un=n(6271);async function Fn(e){const{accessToken:t}=await Zn(e.MAIL_EMAIL,(0,Un.dn)(e));return{user:e.MAIL_EMAIL,xoauth2:t}}var Dn=n(83065),zn=n(35874);function Bn(e){const t=e.split(","),n=[];return t.forEach((e=>{if(e.indexOf(":")>=0){const[t,a]=e.split(":"),s=Number.parseInt(t),i=Number.parseInt(a);if(s<i)for(let e=s;e<=i;e++)n.push(e);else for(let e=i;e<=s;e++)n.push(e)}else{const t=Number.parseInt(e);n.push(t)}})),n}var $n=n(34155);const jn=new Map,Vn=new Map,qn=new Set,Qn=new Map,Hn=new Map,Kn=18e5,Wn=9e5,Gn={},Xn={},Yn=new Set;let Jn=!1,ea=!1;const ta=new Map;let na,aa=0,sa=0;const ia=new class{constructor(e){this.lock=(0,l.M)(),this._priorityQueue=[];for(let t=0;t<e;t++)this._priorityQueue.push([])}queue(e,t,...n){return new Promise(((a,s)=>{this._priorityQueue[t].push({func:e,resolve:a,reject:s,params:n}),this._processQueue()}))}async _processQueue(){const e=await this.lock();try{await this._runNextInLine()}finally{e()}}async _runNextInLine(){for(const e of this._priorityQueue){const t=e.shift();if(t){const{func:e,resolve:n,reject:a,params:s}=t;try{n(await e(...s))}catch(e){a(e)}return!0}}return!1}}(Object.keys(C.NB).length);let ra=!1;function oa(e){if(!navigator.onLine){const e=(0,d.Z)("No network connection");throw new Error(e)}if(a.Z.get(L.kMailIsTurnedOff))throw new Error((0,d.Z)("Mail has been turned off"));const t=(a.Z.get(L.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));if(!t)throw new Error((0,d.Z)("Account has been deleted"));if(t.offline)throw new Error((0,d.Z)("Account is offline"));const n=jn.get(e);if(n)return n;if(Vn.has(e))throw(0,d.Z)("Is logging into mail account $1",[e]);throw U.U.setStatus(ne.A4,(0,d.Z)("Reconnecting $1",[e])),Aa(e),(0,d.Z)("Not connected to $1 - Attempting to connect",[e])}function ca(e){e!==C.of&&(qn.add(e),da())}function la(e){m.Z.error("Mail",["imap"],e)}const da=(0,F.Z)((async()=>{const e=[...qn];qn.clear();for(const t of e){const[e]=y.Z.getPathsByType(t,C.e9);if(!e)return void m.Z.warn("Mail",["imap",t],"No inbox found to park in");if(jn.has(t))try{await ua(t,e,!0)}catch(e){la(e)}}}),2e3);function ua(e,t,n=!1){if(!navigator.onLine)return Promise.reject((0,d.Z)("No network connection"));Gn[e]||(Gn[e]=[]);const a=Gn[e];return new Promise(((i,r)=>{n?0!==a.length&&a[0].path===t||a.unshift({path:t,resolve:i,reject:r}):a.find((e=>e.path===t))||a.push({path:t,resolve:i,reject:r}),Xn[e]||(Xn[e]=!0,$n.nextTick(s))}));async function s(){const t=Gn[e];if(!t||t.length<=0)return void(Xn[e]=!1);const{path:n,resolve:a,reject:i}=t.pop();try{const t=oa(e);await t.selectMailbox({path:n}),a()}catch(e){i(e)}finally{U.QO.removePathIndicator(e,n),$n.nextTick(s)}}}async function ha(e,t){const n=await g.Z.imap.where("searchListId").anyOf(t).filter((t=>t.accountId===e)).toArray();if(0===n.length)return new Map;const a=new Map;for(const{searchListId:e,path:t,uid:s}of n){const n=a.get(e);n?n.set(t,s):a.set(e,new Map([[t,s]]))}const s=[];for(const[t,n]of a)s.push({accountId:e,pathToUid:n,size:0,searchListId:t});return await ia.queue(fa,C.NB.FETCH_RAW,e,s)}async function fa(e,t){const n=new Map;if(0===t.length)return n;if(!navigator.onLine)throw new Error((0,d.Z)("No network connection"));const a=new Set;for(const{pathToUid:e}of t)for(const t of e.keys())a.add(t);try{for(const s of[...a]){const a=new Map;for(const{searchListId:e,pathToUid:i}of t){if(n.has(e))continue;const t=i.get(s);void 0!==t&&a.set(t,e)}if(0===a.size)continue;const i=[...a.keys()],r=oa(e),o=await r.getMessages({path:s,uids:i});Object.keys(o).forEach((t=>{const i=a.get(parseInt(t));i?o[t]?n.set(i,o[t]):la(`Expected to find raw for ${e}/${s}/${t}`):la(`Un-expected uid ${e}/${s}/${t}`)}))}return ca(e),n}catch(t){throw U.U.setStatus(ne.A4,(0,d.Z)("Failed to get message body - $1",[t])),m.Z.warn("Mail",["imap",e],"Fetch raw",t),t}}async function pa(e,t,n,s,i){if(!navigator.onLine)throw new Error((0,d.Z)("No network connection"));const r=oa(e),o=function(e){const t=[...e];let n;t.sort(((e,t)=>e-t));const a=[];for(const e of t)n&&n[n.length-1]===e-1?n.push(e):(n=[e],a.push(n));const s=a.map((e=>1===e.length?e[0]:e[0]+":"+e[e.length-1]));return s.join(",")}(n),c=await r.listMessages({path:t,sequence:o});a.Z.get(L.kMailAutoGenerateContacts)&&await(0,Zt.Z)(e,t,c);const l=y.Z.getFolderType(e,t),u=await nn(e,t,l,c);U.QO.updateIndex(u),we.filter(),Pe.updateThreads();const{addedSles:h,sleUpdates:f}=u;(h&&h.length>0||f&&f.length>0)&&(U.U.setStatus(ne.A4,(0,d.Z)("Indexing mail $1 $2 $3/$4",[e,t,i,s])),U.QO.setPathIndicator(e,t,"INDICATOR_TYPE_FETCHING",C.NB.SYNC_NEW_DELETED,i,s));!function(e,t,n){if(yn[e]||(yn[e]={}),yn[e][t]){const a=[...yn[e][t],...n].sort(((e,t)=>e-t));yn[e][t]=new Set(a)}else yn[e][t]=new Set(n)}(e,t,c.map((e=>e.uid)))}function ga(e){if(a.Z.get(L.kMailIsTurnedOff))return!1;const t=(a.Z.get(L.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));return!!t&&!t.offline}function ma(e){if(a.Z.get(L.kMailIsTurnedOff)||ea)return!1;const t=(a.Z.get(L.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));return!!t&&!t.offline&&"none"!==wa(e)}function wa(e){const t=(a.Z.get(L.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));if(t)return t.preFetch;throw new Error("Account not found "+e)}function _a(e){switch(wa(e)){case"day":return gn()().subtract(1,"d").startOf("day").valueOf();case"week":return gn()().subtract(1,"w").startOf("day").valueOf();case"month":return gn()().subtract(1,"M").startOf("day").valueOf();case"year":return gn()().subtract(1,"y").startOf("day").valueOf();default:return 0}}async function ba(e,t,n,a){let s=100,i=0;const r=new I.Z.BatchSizeOptimizer(100,2e3);return new Promise(((o,c)=>{ia.queue((async function l(){if(!ga(e))return void o();const d=t.slice(i,i+s);if(0===d.length)return void o();const u=Date.now();try{await a(d,t.length,i),i+=s}catch(e){return void c(e)}const h=Date.now();s=r.optimize(s,h-u),Jn===e&&(na=void 0,aa=await La(e));ia.queue(l,n).catch(c)}),n).catch(c)}))}async function ya(e,t){if(!navigator.onLine)throw new Error((0,d.Z)("No network connection"));U.U.setStatus(ne.A4,(0,d.Z)("Indexing - $1 $2",[e,t.path]));const{list:n,path:a,type:s}=t;try{if("new"===s){m.Z.log("Mail",["imap",e],"new messages received",a,n),n.reverse();try{U.QO.setSyncing(e,!0),await ba(e,n,C.NB.SYNC_NEW_DELETED,(async(t,n,s)=>{await pa(e,a,t,n,s)}))}finally{U.QO.setSyncing(e,!1)}await Za(e)}else if("deleted"===s){if(m.Z.log("Mail",["imap",e],"messages deleted on server",a,n),await ba(e,n,C.NB.SYNC_NEW_DELETED,(async t=>{await async function(e,t,n){const a=n.map((n=>[e,t,n])),s=[];let i=[];const r=[],o=new Yt.Z.FilteringUpdatesSorter,c=b.Z.getByFolderId([e,t]);await g.Z.transaction("rw",[g.Z.searchList,g.Z.messages,g.Z.buffer,g.Z.imap,g.Z.filteringQueue,g.Z.hasRaw,g.Z.threading,g.Z.viewIds],(async()=>{await g.Z.imap.where("[accountId+path+uid]").anyOf(a).modify(((e,t)=>{s.push(e.searchListId),delete t.value}));const l=[];await g.Z.searchList.where("id").anyOf(s).modify((n=>{const{id:a}=n,s={};s.sources=new Map;const r=n.sources.get(c.id);if(r){const i=[C.uT,C.Hd,C.hn],l=y.Z.getFolderType(e,t),d=i.includes(l);let u=!1,h=!1;for(const t of[...n.sources.keys()]){const n=b.Z.get(t);if(!n)throw new Error("Filter not found "+t);if(n.accountId!==e)continue;const a=y.Z.getFolderType(n.accountId,n.path);i.includes(a)?h=!0:u=!0}const f={sources:new Map};let p=!1;!u||!d&&h?(r.deleted=!0,r.internal=!0,f.sources.set(c.id,{...r}),s.sources.set(c.id,{...r})):(n.sources.delete(c.id),p=!0,f.sources.set(c.id,void 0),s.sources.set(c.id,void 0)),o.add(a,f,p)}const d=0===n.sources.size||[...n.sources.values()].every((e=>e.internal));d&&l.push(n),(Object.keys(s).length>1||s.sources.size>0)&&i.push({id:a,updates:s})}));for(const e of l)if(!await hn(e)){const{id:t}=e;r.push(t)}if(r.length>0){await fn.Z.call(r);const e=new Set(r);i=i.filter((({id:t})=>!e.has(t)))}await E.byUids(e,t,n);for(const e of o.getSorted()){const{searchListIds:t,updates:n,rerunFiltering:a}=e;a?await v.Z.call({type:"RE_RUN_SLES",priority:C.Un.NORMAL,searchListIds:t,folderIds:[[C.of,C.cm],[C.of,C.rp]]}):await v.Z.call({type:"FILTERS_SLES",priority:C.Un.NORMAL,searchListIds:t,folderIds:[[C.of,C.cm],[C.of,C.rp]]}),await v.Z.call({type:"UPDATE_SLE",priority:C.Un.NORMAL,searchListIds:t,...n})}})),r.length>0&&await xt.Z.deleteMessages(r),await U.QO.updateIndex({sleUpdates:i,removedSles:r})}(e,a,t)})),y.Z.getFolderType(e,a)!==C.uT){const t=y.Z.getPathsByType(e,C.uT);try{for(const n of t)ua(e,n)}catch(e){la(e)}finally{ca(e)}}}else if("messages"===s){m.Z.log("Mail",["imap",e],"flag updates from server",a,n);try{U.QO.setSyncingFlags(e,!0),await ba(e,n,C.NB.SYNC_FLAGS,(async(t,n,s)=>{await async function(e,t,n,a,s){await dn(e,t,n);const i=await Jt(e,t,n);U.QO.updateIndex({sleUpdates:i}),U.U.setStatus(ne.A4,(0,d.Z)("Updating flags $1 $2 $3/$4",[e,t,s,a])),U.QO.setPathIndicator(e,t,"INDICATOR_TYPE_FLAGS",C.NB.SYNC_FLAGS,s,a)}(e,a,t,n,s)}))}finally{U.QO.setSyncingFlags(e,!1)}}if(ga(e)){const t=oa(e);!function(e,t,n){"inbox"===t.toLowerCase()&&(t=C.Gf),wn.then((()=>g.Z.transaction("rw",g.Z.mailboxCache,(()=>{Object.keys(n).forEach((a=>{const s=n[a];a!==t&&0!==s.exists||g.Z.mailboxCache.put({accountId:e,path:a,uidNext:s.uidNext,highestModseq:s.highestModseq||"0",noModseq:s.noModseq||!1})}))}))))}(e,a,t.mailboxCache)}U.U.setStatus(ne.A4,(0,d.Z)("Finished indexing - $1 $2",[e,a]),C.QM)}catch(e){la(e),U.U.setStatus(ne.A4,(0,d.Z)("Failed indexing - $1",[e]))}U.QO.removePathIndicator(e,a),U.QO.removePathIndicator(e,a),we.filter()}function va(e,t){if(U.KU.set(e,"IMAP",t,t.code),(0,bt.dS)(e)&&"The user did not approve access."===t.message)m.Z.info("Mail",["imap",e],"User closed oAuth popup dialog");else if((0,zn.I)(t.code))m.Z.info("Mail",["imap",e],"Authentication failed"),ta.delete(e),U.QO.setDisconnected(e,!0);else{t.code?(m.Z.info("Mail",["imap",e],"Error",t.code,t.message||t),U.U.setStatus(ne.A4,`[${t.code}] ${t.message||t}`)):(m.Z.info("Mail",["imap",e],"Error",t.message||t),U.U.setStatus(ne.A4,`${t.message||t}`));const n=function(e){let t=ta.get(e)||0;if(++t<=5)return ta.set(e,t),2e3*t;let n=Qn.get(e);n=void 0===n?6e4:Math.min(n+Wn,Kn),Qn.set(e,n);const a=Math.floor(1e3*Math.random()*6-3e3);return n+a}(e);Aa(e,n,t)}}async function Ia(){const e=await k.Z.loadImapAccounts();if(e)for(const t of e)await ka(t);else m.Z.warn("Mail",["imap"],"No IMAP accounts found!")}async function ka(e){const t=e.MAIL_EMAIL;if(m.Z.info("Mail",["imap",t],"connectImapclient"),e.isDeleted||e.offline)return void m.Z.info("Mail",["imap",t],"deleted or offline",!!e.isDeleted,!!e.offline);if(!navigator.onLine)return m.Z.info("Mail",["imap",t],"No network connection"),void U.QO.setDisconnected(t,!0);if(!e.MAIL_PORT||e.MAIL_PORT<=0)throw new Error(`Port missing or invalid: ${e.MAIL_PORT||""}`);if((await g.Z.systemTasks.toArray()).some((e=>"restore_mail_db"===e.taskName)))m.Z.warn("Mail",["imap",t],"Not connecting while restoration in progress");else if(jn.has(t))m.Z.info("Mail",["imap",t],"Already connected");else if(Vn.has(t))m.Z.info("Mail",["imap",t],"Currently being connected");else{try{Vn.set(t);let n=!1;const a=setTimeout((()=>{throw Vn.delete(t),n=!0,new Error(`IMAP client initialization for ${t} timed out`)}),1e4);let s;if(m.Z.info("Mail",["imap",t],"Creating client"),e.useOAuth){s=cn(e,await Fn(e))}else s=cn(e);s.onSyncUpdate=ya.bind(null,t),s.onError=e=>{va(t,e)},m.Z.info("Mail",["imap",t],"Fetching mailbox cache");const i=await En(t);if(s.mailboxCache=i||{},n)return;if(clearTimeout(a),!Vn.has(t))return;if(Vn.set(t,s),U.QO.setAccountIndicator(t,"INDICATOR_TYPE_CONNECTING"),U.QO.setConnecting(t,!0),m.Z.info("Mail",["imap",t],"Connecting"),await s.login(),!Vn.has(t))return;m.Z.info("Mail",["imap",t],"Connected"),U.U.setStatus(ne.A4,(0,d.Z)("Connected to $1",[t]),C.QM);const c=u.Z.get(t);c&&0===Object.keys(c.folders).length&&await async function(e){const t=await e.listWellKnownFolders();for(const n of[C.e9,C.Nz,C.uT])if(Array.isArray(t[n])&&t[n].length>0){const{path:a,subscribed:s}=t[n][0];s||await e.subscribeMailbox({path:a})}}(s);const l=await s.listWellKnownFolders();if(!Vn.has(t))return;l.Inbox&&l.Inbox.forEach((e=>{"inbox"===e.path.toLowerCase()&&(e.path=C.Gf)})),await r.Z.addFolders(t,l),await u.Z.updateAccount(t,{folders:l});const h=await o.Z.foldersToFilters(t,l);b.Z.updateFilters(h),J.Z.addFolders(t,l),m.Z.info("Mail",["imap",t],"Clean up after connection"),Qn.delete(t),Sa(t),ta.delete(t),Vn.has(t)&&(jn.set(t,s),U.QO.setDisconnected(t,!1),U.KU.delete(t,"IMAP"),Xt.call())}catch(e){va(t,e)}finally{Vn.delete(t),U.QO.setConnecting(t,!1),U.QO.removeAccountIndicator(t,"INDICATOR_TYPE_CONNECTING")}if(jn.has(t))try{await Oa(t),Za(t)}catch(e){la(e)}}}async function Ea(){for(const e of[...Vn.keys(),...jn.keys()])await xa(e)}async function xa(e,t){const n=jn.get(e)||Vn.get(e);if(m.Z.info("Mail",["imap",e],"Disconnect",!!n),delete Gn[e],delete Xn[e],Sa(e),Vn.has(e)&&(m.Z.info("Mail",["imap",e],"Client initialization cancelled"),Vn.delete(e)),jn.has(e)&&(m.Z.info("Mail",["imap",e],"Client disconnected"),jn.delete(e)),U.QO.setDisconnected(e,!0),U.QO.removeAllIndicators(e),t&&U.KU.set(e,"IMAP",t,t.code),n)try{n.onSyncUpdate=!1,n.onError=mn.Z,await n.logout()}catch(t){la(t)}finally{m.Z.info("Mail",["imap",e],"Logged out")}}async function Aa(e,t,n){async function s(){if(!navigator.onLine)return void m.Z.info("Mail",["imap",e],"No network. Skip reconnection attempt");const t=(await k.Z.loadImapAccounts()).find((t=>t.MAIL_EMAIL===e));m.Z.info("Mail",["imap",e],"Reconnect",t),t&&await ka(t)}a.Z.get(L.kMailIsTurnedOff)?m.Z.info("Mail",["imap",e],"Mail was turned off"):(await xa(e,n),t?function(e,t,n){if(Hn.has(n))return void m.Z.info("Mail",["imap",n],"Has reconnect timeout");m.Z.info("Mail",["imap",n],"Set reconnect timeout");const a=setTimeout(e,t);Hn.set(n,a)}(s,t,e):await s())}function Sa(e){const t=Hn.get(e);void 0!==t&&(clearTimeout(t),Hn.delete(e))}function Ma(){return 0===jn.size}function Oa(e){if(Ma()||e&&!jn.has(e))return Promise.resolve();let t;return t=e?r.Z.getFolder(e).then((t=>({[e]:{folders:t}}))):k.Z.loadImapAccounts().then((e=>r.Z.getAll().then((t=>{const n={};for(let a=0;a<e.length;a++){const s=e[a],i=t.find((e=>s.MAIL_EMAIL===e.accountId));i&&(n[i.accountId]={folders:i.folders})}return n})))),t.then((e=>{const t=c.Z.getFolders(e,!1);Promise.all(t.map((e=>{const t=e.accountId,a=e.children;if(!a||a.length<=0)return Promise.resolve();a.sort(((e,t)=>e.type===t.type?0:"Inbox"===e.type?1:"Inbox"===t.type||"All"===e.type?-1:"All"===t.type?1:0)),Promise.all(n(t,a)).catch(la).then((()=>ca(t)))})))}));function n(e,t){let a=[];for(const s of t)s.subscribed&&a.push(ua(e,s.path)),s.children&&(a=a.concat(n(e,s.children)));return a}}async function Na(e){Ma()||e&&!jn.has(e)?await Ia():Oa(e)}function Za(e){Yn.add(e),Ta()}function Ta(){if(Jn||ea)return;const e=[...Yn];Yn.clear();let t=!1;e.reduce(((e,n)=>e.then((()=>(Jn=n,async function(e){if(!ma(e))return;m.Z.log("Mail",["imap","prefetch",e],"starting"),t=!1;let n=_a(e),a=wa(e);const s=[],i=200;sa=0,aa=await La(e),na=void 0;try{U.QO.setPreFetching(e,!0);let t=!0;for(;t;)t=await ia.queue(r,C.NB.PRE_FETCH)}finally{U.QO.setPreFetching(e,!1)}t&&U.QO.removeAccountIndicator(e,"INDICATOR_TYPE_PRE_FETCHING");async function r(){if(!ma(e))return t&&(m.Z.log("Mail",["imap","prefetch",e],"stopped"),U.U.setStatus(ne.A4,(0,d.Z)("Stopped prefetching - $1",[e]))),!1;const r=wa(e);r!==a&&(aa=await La(e),a=r);const o=_a(e);if(o>n){let e,t=s.length-1;for(;(s[t]?.sentDate??0)<o;)e=t,t--;void 0!==e&&s.splice(e),n=o}if(s.length<i&&await g.Z.transaction("r",[g.Z.hasRaw,g.Z.imap,g.Z.searchList],(async()=>{const t=await A.Z.getByAccountIdHasRaw(e,!1,5*i,n,na);if(0===t.length)return;const a=t[t.length-1];na=[0,e,a.sentDate,a.searchListId];const r=t.map((({searchListId:e})=>e)),o=await g.Z.imap.where("searchListId").anyOf(r).filter((t=>t.accountId===e)).toArray(),c=await g.Z.searchList.bulkGet(r),l=new Map;for(const e of c)e&&l.set(e.id,e);let d;for(const t of o){const{searchListId:n,path:a,uid:i}=t;if(d&&d.searchListId===n)d.pathToUid.set(a,i);else{const t=l.get(n);if(!t){m.Z.error("Mail",["imap","prefetch",e,a,n],"SearchList entry not found");continue}d={accountId:e,pathToUid:new Map([[a,i]]),size:t.size,searchListId:n,sentDate:t.sentDate},s.push(d)}}})),0===s.length)return m.Z.log("Mail",["imap","prefetch",e],"done"),t&&U.U.setStatus(ne.A4,(0,d.Z)("Finished prefetching - $1",[e])),!1;s.sort(ae.CB);const c=s.shift();let l=c.size,u=l?0:1;const h=524288,f=10,p=[c],w=[...c.pathToUid.keys()][0];let _=0;for(;s.length>0&&_<s.length&&l<h&&u<f;){if(!s[_].pathToUid.has(w)){_++;continue}const[e]=s.splice(_,1);p.push(e),e.size?l+=e.size:u++}m.Z.log("Mail",["imap","prefetch",e],"fetching batch",p.length,l);const b=await async function(e,t){const n=await fa(e,t),a=await(0,x.Z)(Array.from(n.keys())),s=new Map;for(const e of a)s.set(e.id,e);const i=[];for(let[a,r]of n){const n=s.get(a);if(n)try{const{sentDate:t}=n,s=await(0,ve.Z)(a,n,r);if(s){r=s.raw;const e=(0,Fe.Q)(s.bodyParts);await(0,S.Z)(a,e),U.QO.updateIndex({sleUpdates:[{id:a,updates:{preview:e}}]})}await P.Z.call(e,t,a,r),i.push(a)}catch(t){m.Z.error("Mail",["imap",e,a],"Failed to process mail: ",t)}else{const n=t.find((({searchListId:e})=>e===a));if(n){const t=[];for(const[s,i]of n.pathToUid)t.push([e,s,i]),m.Z.warn("Mail",["imap",e],`fetchRawFromImapEntries: Expected message ${a} to exist, deleting imap entry ${s}/${i}`);await g.Z.imap.bulkDelete(t);const s=[n.searchListId,n.accountId];await g.Z.hasRaw.delete(s)}}}return M.Z.setHasRaws(e,i)}(e,p);return t=!0,sa+=b,U.U.setStatus(ne.A4,(0,d.Z)("Prefetching - $1 $2/$3",[e,sa,aa])),U.QO.setAccountIndicator(e,"INDICATOR_TYPE_PRE_FETCHING",C.NB.PRE_FETCH,sa,aa),U.QO.runStoredQueryFilters(p.map((e=>e.searchListId))),!0}}(n).catch((e=>{U.U.setStatus(ne.A4,(0,d.Z)("Error prefetching - $1",[n])),U.QO.removeAllIndicators(n),la(`Error prefetching ${n} ${e}`)})))))),Promise.resolve()).then((()=>{Jn=!1,Yn.size>0&&Ta()}))}async function La(e){try{const t=_a(e);return await g.Z.hasRaw.where("[hasRaw+accountId+sentDate+searchListId]").between([0,e,t,0],[0,e,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER]).count()+sa}catch(e){return la(e),0}}const Ra={setCheckInterval:function(e,t){ra&&clearInterval(ra),ra=!!e&&setInterval(Oa,6e4*t)},fetchRawOfMessage:async function(e,t,n){return(await ha(e,[t])).get(t)},connectIMAPClient:ka,connectIMAPClients:Ia,disconnectIMAPClient:xa,reconnectIMAPClient:Aa,reconnectIMAPClients:async function(){a.Z.get(L.kMailIsTurnedOff)||(await Ea(),await Ia())},disconnectIMAPClients:Ea,checkNewDeletedModified:function(e,t){ua(e,t).catch(la).then((()=>ca(e)))},rescanUnreadFlags:function(e,t){const n=oa(e).mailboxCache[t];n&&(n.highestModseq="0",ua(e,t).catch(la).then((()=>ca(e))))},checkForMail:Na,preFetch:Za,subscribeMailbox:async function(e){const{accountId:t,path:n}=e,a=oa(t);await a.subscribeMailbox({path:n}),Aa(t)},unsubscribeMailbox:async function(e,t){if(!c.Z.isUnsubscribable(e))throw new Error(`Folder ${e.accountId}/${e.path} can not be unsubscribed.`);const{accountId:n,path:a}=e,s=oa(n);await s.unsubscribeMailbox({path:a}),t&&kn(n,a),Aa(n)},createMailbox:async function(e,t){try{t=(0,Dn.y3)(t);const n=oa(e),a=async()=>{await n.createFolder({path:t}),await n.subscribeMailbox({path:t})};await a(),Aa(e)}catch(n){m.Z.error("Mail",["imap",e,t,"create mailbox"],n.message||n)}},deleteMailbox:async function(e,t){try{const n=oa(e),a=async()=>{await n.unsubscribeMailbox({path:t}),await Ft(e,t,!0),await n.deleteFolder({path:t})};await a(),Aa(e)}catch(n){m.Z.error("Mail",["imap",e,t,"delete mailbox"],n.message||n)}},reSyncFolder:async function(e,t){kn(e,t),await Aa(e)},reSyncAccount:async function(e){!function(e){delete yn[e]}(e),await Aa(e)}};self.addEventListener("message",(async function({origin:e,data:t,source:n}){if(e!==ne.oP||!t||!t.imap)return;const{promiseId:a,func:s,args:i=[]}=t.imap;if(s)try{const e=await Ra[s](...i),t=e&&"fetchRawOfMessage"===s?[e.buffer]:void 0;n.postMessage({imap:{promiseId:a,results:e}},{transfer:t})}catch(e){const t=e.message||e;n.postMessage({imap:{promiseId:a,error:t}})}}),!1);const Pa={checkForMail:Na,copyMessages:async function(e,t,n,a){const s={path:t,uids:n,destination:a},i=[e,a],r=b.Z.getByFolderId(i);if(!r)throw new Error("Destination filter not found for "+i.join(", "));const o=await g.Z.imap.where("[accountId+path+uid]").anyOf(n.map((n=>[e,t,n]))).toArray(),c=new Map(o.map((e=>[e.uid,e]))),l=oa(e),d=await l.copyMessages(s);if(!d)return void m.Z.warn("Mail",["imap",e],"UIDPLUS not supported, cannot create imap entries");const{srcSeqSet:u,destSeqSet:h}=d,f=Bn(u),p=Bn(h);let w;await g.Z.transaction("rw",[g.Z.imap,g.Z.searchList],(async()=>{const n=[];f.forEach(((s,i)=>{const r=p[i],o=c.get(s);o?n.push({...o,path:a,uid:r}):m.Z.warn("Mail",["imap",e],"cannot create imap entry for "+JSON.stringify([t,s]))})),w=await ln(n,r)})),w&&U.QO.updateIndex({sleUpdates:w})},deleteMessages:async function(e,t,n){const a={path:t,uids:n};return oa(e).deleteMessages(a)},disconnectIMAPClient:xa,fetchRawOfMessages:ha,moveMessages:function(e,t,n,a){const s={path:t,uids:n,destination:a};return oa(e).moveMessages(s)},park:ca,selectMailbox:ua,updateFlags:function(e,t,n,a){const s=[],i=[];for(const[e,t]of Object.entries(a))t?s.push(e):i.push(e);const r={path:t,uids:n,add:s,remove:i};return oa(e).updateFlags(r)},uploadMessage:async function(e,t,n,a){const s=await(0,un.Z)(n);if(!s)throw new $t(`Entry ${n} not found in searchList table`);const{sentDate:i}=s,r=await At.Z.call(e,n,i);if(!r)throw new $t(`Can not upload message ${n} as raw file was not found on disk`);(await A.Z.getBySearchListId(n)).find((e=>e.hasRaw))||m.Z.warn("Mail",["imap",e,t,n],"imap.js: Data inconsistency, raw file found on disk contrary to hasRaw table");const o=(0,Ce.DA)(r),c=[e,t],l=b.Z.getByFolderId(c);if(!l)throw new Error("Destination filter not found for "+c.join(", "));const d=oa(e),u=a.indexOf(C.T4.RECENT);u>-1&&a.splice(u,1);const h=await d.uploadMessage({path:t,message:o,flags:a});if(ca(e),!h)return void m.Z.warn("Mail",["imap",e],"UIDPLUS not supported, cannot create imap entry");const f=Number.parseInt(h);let p;await g.Z.transaction("rw",[g.Z.imap,g.Z.searchList,g.Z.hasRaw],(async()=>{const a={accountId:e,path:t,uid:f,searchListId:n};p=await ln([a],l);const s={searchListId:n,accountId:e,hasRaw:1,sentDate:i};await g.Z.hasRaw.put(s)})),p&&U.QO.updateIndex({sleUpdates:p})},pausePrefetching:function(e){m.Z.log("Mail",["imap","prefetch"],e?"pause possible prefetching":"resume possible prefetching"),ea=e}};var Ca=n(78134),Ua=n(85834),Fa=n(95064);const Da=[{listId:"meetup.com",name:"meetup.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"facebook.com",name:"facebook.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"github.com",name:"github.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"google.com",name:"google.com",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"googlegroups.com",name:"googlegroups.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"groupon",name:"groupon",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"xt.local",name:"xt.local",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"sparkpostmail.com",name:"sparkpostmail.com",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"substack.com",name:"substack.com",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"list-id.mcsv.net",name:"list-id.mcsv.net",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"spc-",name:"sparkpostmail.com (spc-)",parentFolderType:"startsWith",subFolderType:"host",isIgnored:!1},{listId:"MAILING_LIST_GROUPS_UNCATEGORIZED",name:"",parentFolderType:"uncategorized",subFolderType:"host",isIgnored:!1}];var za=n(65741);const Ba="Contacts";class $a{count=0;constructor(e,t){this.version=e,this.interval=setInterval((()=>this.total&&U.U.setStatus(ne.A4,`Upgrade v${e} mail: ${t} ${this.count} / ${this.total}`)),1e3),m.Z.info("Mail","Upgrade started: ",e)}stop(){clearInterval(this.interval),U.U.setStatus(ne.A4,`Upgrade v${this.version} mail: Finalizing...`,5e3),m.Z.info("Mail","Upgrade finished: ",this.version)}}g.Z.on("populate",(()=>{g.Z.filters.bulkAdd(Fa.j),g.Z.mailingList.bulkAdd(Da),g.Z._upgrades.add({version:g.Z.verno})})),g.Z.version(136).stores({messages:"++id",searchList:["++id","messageId","*sourceFilterIds"].join(","),threading:["++id","*references","inReplyTo","messageId"].join(","),accounts:"accountId",mailboxCache:"[accountId+path],accountId",filters:"++id,&[accountId+path]",buffer:["++_id","[accountId+path+operation]","accountId","[accountId+path]","operation","[accountId+destinationPath+operation]"].join(","),views:"++id,filterId",imap:["[accountId+path+uid]","searchListId","[hasRaw+accountId+searchListId]","[accountId+path+searchListId]","accountId"].join(","),pop:"[accountId+uidl],searchListId,accountId",filteringQueue:"++id,priority",threadingQueue:"++id",viewIds:"searchListId,*viewIds",flaggingQueue:"++id",drafts:null,tokens:null,folders:null}).upgrade((e=>{e.messages.clear(),e.searchList.clear(),e.threading.clear(),e.accounts.clear(),e.mailboxCache.clear(),e.filters.clear(),e.buffer.clear(),e.views.clear(),e.imap.clear(),e.pop.clear(),e.filteringQueue.clear(),e.threadingQueue.clear(),e.viewIds.clear(),e.flaggingQueue.clear()}));const ja=new Map;g.Z.version(137).stores({_upgrades:"version"}),ja.set(137,(async e=>{new $a(137,"Upgrade v137 mail").stop()})),ja.set(138,(async e=>{const t=new $a(138,"Upgrade v138 mail: Run Custom Folder");await e.filteringQueue.add({priority:C.Un.LOW,type:"RUN_FILTERS",folderIds:[[C.Ry,C.ym]],updateFilters:!0}),t.stop()})),ja.set(139,(async e=>{const t=new $a(139,"Upgrade v139 mail: Repair default filters"),n=[],a=["total","unseen","unread","excludeMailingLists","excludeDeleted","excludeRssFeeds","excludeJunk","excludeCustomFolders"];for(const t of Fa.j){const{accountId:s,path:i}=t,r=await e.filters.where("[accountId+path]").equals([s,i]).first();if(r){const{id:s}=r,i={id:s,...t};await e.filters.put(i);const o=await e.views.where("filterId").equals(s).toArray(),c=new Set(o.map((e=>e.type)));for(const t of a)if(!c.has(t)){const n={filterId:s,type:t};e.views.add(n)}n.push(s)}else{const s=await e.filters.add(t);for(const t of a)await e.views.add({filterId:s,type:t});n.push(s)}}if(n.length>0){const t={priority:C.Un.LOW,type:"RUN_FILTERS",filterIds:n};e.filteringQueue.add(t)}t.stop()})),ja.set(140,(async e=>{const t=new $a(140,"Map viewIds to new format");t.total=await e.viewIds.count()+await e.views.count();const n=new Map,a=["total","unseen","unread","excludeMailingLists","excludeDeleted","excludeRssFeeds","excludeJunk","excludeCustomFolders"];await e.views.each((e=>{const s=a.indexOf(e.type);-1!==s&&n.set(e.id,100*e.filterId+s),t.count++})),await e.viewIds.toCollection().modify((e=>{const a=new Set;e.viewIds.forEach((e=>{const t=n.get(e);"number"==typeof t&&a.add(t)})),e.viewIds=[...a],t.count++})),e.views.clear(),t.stop()})),g.Z.version(141).stores({deletedFeedItems:"++id,path"}),ja.set(142,(async e=>{const t=new $a(142,"Fixing default parent filters");let n,a,s,i,r,o;function c(e,t){const{include:n}=e.filterValue;for(const e of t){n.some((t=>(0,za.Z)(t,e)))||n.push(e)}}o=[C.wC,""],r=[C.wC,"ï¿¿"];const l=await e.filters.where("[accountId+path]").between(o,r).toArray(),d=[],u=[];for(const e of l){const{path:t,filterValue:i}=e;if(t===C.ym)n=e;else if(t===C.W4)a=e;else if(t===C.cs)s=e;else{const e=i.include.filter((e=>1===e.length&&(e[0].listId||e[0].senderIsMailingList)));t.startsWith(C.W4)?d.push(...e):t.startsWith(C.cs)&&u.push(...e)}}if(!n)throw new Error("Mailing list root folder not found");if(!a)throw new Error("Mailing list Important folder not found");if(!s)throw new Error("Mailing list Other folder not found");c(n,d),c(n,u),c(a,d),c(s,u),o=[C.ut,""],r=[C.ut,"ï¿¿"];const h=await e.filters.where("[accountId+path]").between(o,r).toArray(),f=[];for(const e of h){const{path:t,filterValue:n}=e;if(t===C.ym)i=e;else{const e=n.include.filter((e=>1===e.length&&e[0].flag));f.push(...e)}}if(!i)throw new Error("Labels root folder not found");c(i,f),await e.filters.bulkPut([n,a,s,i]);const p=[n.id,a.id,s.id,i.id];await b.Z.updateFilters(p),await v.Z.call({type:"RUN_FILTERS",priority:C.Un.LOW,filterIds:p}),t.stop()})),ja.set(143,(async e=>{const t=new $a(143,"Fixing database inconsistency"),n=await e.searchList.toCollection().primaryKeys(),a=await e.viewIds.toCollection().primaryKeys(),s=new Set(n),i=a.filter((e=>!s.has(e)));await e.viewIds.where("searchListId").anyOf(i).delete(),t.stop()})),g.Z.version(144).stores({viewIds:"searchListId"}),ja.set(146,(async e=>{const t=new $a(146,"Fixing state of show-read button in received folder");await e.filters.where("[accountId+path]").equals([C.of,C.ik]).modify((e=>{e.filterValue={...e.filterValue,showReadButton:!0}})),t.stop()})),g.Z.version(147).stores({mailingList:"listId"}),ja.set(147,(async e=>{const t=new $a(147,"Group mailing lists providers (like xt.local and sparkpostmail.com)");await e.mailingList.bulkAdd(Da);const n=C.wC,a=[n,""],s=[n,"ï¿¿"],i=await e.filters.where("[accountId+path]").between(a,s).toArray(),r=[];if(i.forEach((e=>{(e.path.endsWith(".xt.local")||e.path.endsWith(".sparkpostmail.com")||e.path.endsWith("list-id.mcsv.net")||e.path.startsWith(C.cs+"/spc-")||e.path.startsWith(C.W4+"/spc-"))&&r.push(e.id)})),r.length>0){const n=r.map((e=>100*e));await e.filters.where("id").anyOf(r).delete();const a=new Set,s=8;t.total=n.length,n.forEach((e=>{for(let t=0;t<s;t++)a.add(e+t)}));const i=[];await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!a.has(e)));n.length!==e.viewIds&&(i.push(e.searchListId),e.viewIds=n),t.count++})),await e.filteringQueue.add({priority:C.Un.LOW,type:"RE_RUN_SLES",searchListIds:i,runMailingLists:!0,updateFilters:!0})}t.stop()})),ja.set(148,(async e=>{const t=new $a(148,"VB-78846: Rerun views for flags and labels"),n=[C.ut,""],a=[C.ut,"ï¿¿"],s=await e.filters.where("[accountId+path]").between(n,a).primaryKeys(),i=[C.MN,""],r=[C.MN,"ï¿¿"],o=await e.filters.where("[accountId+path]").between(i,r).primaryKeys();await e.filteringQueue.add({priority:C.Un.LOW,type:"RUN_FILTERS",filterIds:[...s,...o]}),t.stop()})),g.Z.version(149).stores({systemTasks:"++id",tokens:null}),ja.set(149,(async e=>{const t=new $a(149,"Clear tokens table and prepare for transition to new search db ...");await e.systemTasks.add({taskName:"restore_full_text_search_db",currentPosition:0}),t.stop()})),ja.set(150,(async e=>{const t=new $a(150,"VB-79158: [Mail] Unseen/Read status does not always match changes done with external server"),n=await e.accounts.toArray(),a=[];for(const e of n){const{accountId:t,folders:n}=e;for(const e in n)n[e].forEach((e=>{a.push([t,e.path])}))}const s=await e.filters.where("[accountId+path]").anyOf(a).toArray(),i=new Set;await e.searchList.toCollection().modify((e=>{const t=[...e.sources].filter((([e,t])=>t.internal)),n=[...e.sources].filter((([e,t])=>!t.internal));t&&0!==t.length&&n&&0!==n.length&&n.forEach((([n,a])=>{const r=s.find((e=>e.id===n))?.accountId;r&&t.forEach((([t,n])=>{const o=s.find((e=>e.id===t))?.accountId;if(o&&o===r){const n=e.sources.get(t);n&&n.read!==a.read&&(n.read=a.read,i.add(e.id),n.read&&(e.unseen=!1))}}))}))})),await e.filteringQueue.add({priority:C.Un.LOW,type:"RE_RUN_SLES",searchListIds:[...i]}),t.stop()})),ja.set(151,(async e=>{const t=new $a(151,"Removing orphan source-filter IDs");t.total=await e.searchList.count();const n=await e.filters.toCollection().primaryKeys(),a=new Set(n);await e.searchList.toCollection().modify((e=>{e.sourceFilterIds=e.sourceFilterIds.filter((e=>a.has(e)));const n=new Map;for(const[t,s]of e.sources)a.has(t)&&n.set(t,s);e.sources=n,t.count++})),t.stop()})),ja.set(152,(async e=>{const t=new $a(152,"Resetting feed data for updating paths"),n=await Ca.Z.waitFor((()=>Z.Z.prefs.get(L.kRssSettings)));if(0===n.length)return void t.stop();const a={},s=[];t.total=n.length;for(const i of n){const n=await e.filters.where("[accountId+path]").equals([C.u4,i.path]).first();if(a[i.path])try{const t={accountId:C.u4,filterValue:{exclude:a[i.path].filterValue.exclude.slice(),include:[[{accountId:C.u4},{path:i.url}]],showCustomFolderButton:!1,showFeedsButton:!1,showJunkButton:!1,showMailingListsButton:!1},name:i.title,path:i.url},n=await e.filters.add(t);s.push(n)}catch(e){console.error(e)}else if(n){a[i.path]=n;const t={...n.filterValue,include:[[{accountId:C.u4},{path:i.url}]]};await e.filters.update(n.id,{path:i.url,filterValue:t}),s.push(n.id)}else console.error("Filter not found for feed path",i.path);i.path=i.url,t.count++}Z.Z.prefs.set({path:"vivaldi.rss.settings",value:n}),await v.Z.call({type:"RUN_FILTERS",priority:C.Un.LOW,filterIds:s}),t.stop()})),ja.set(153,(async e=>{const t=new $a(153,"Re-run sender is a mailing list filters"),n=await e.filters.where("[accountId+path]").between([C.wC,""],[C.wC,"ï¿¿"]).filter((e=>e.filterValue.include?.some((e=>e.some((e=>!!e.senderIsMailingList)))))).primaryKeys();await v.Z.call({type:"RUN_FILTERS",priority:C.Un.LOW,filterIds:n}),t.stop()})),ja.set(154,(async e=>{const t=new $a(154,"Fix unseen counters");t.total=await e.searchList.count();const n=[];await b.Z.initFilters(),await e.searchList.toCollection().modify((e=>{e.unseen&&Q.Z.call(e.sources)&&(e.unseen=!1,n.push(e.id)),t.count++})),await e.filteringQueue.add({priority:C.Un.LOW,type:"RE_RUN_SLES",searchListIds:n}),t.stop()})),ja.set(158,(async e=>{const t=new $a(158,"Update thread key");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((e=>{0===e.threadKey[1]&&(e.threadKey[1]=e.id),t.count++})),t.stop()})),ja.set(159,(async e=>{const t=new $a(159,"Update old filter rules and delete contact filters"),n=await e.filters.where("[accountId+path]").between([C.wC,""],[C.wC,"ï¿¿"]).count()+await e.filters.where("[accountId+path]").between([C.Kz,""],[C.Kz,"ï¿¿"]).count(),a=[Ba,""],s=[Ba,"ï¿¿"],i=await e.filters.where("[accountId+path]").between(a,s).primaryKeys(),r=await e.filters.where("[accountId+path]").equals([C.Kz,C.ym]).primaryKeys();if(i.push(...r),i.length>0){const a=100,s=i.map((e=>e*a));await e.filters.where("id").anyOf(i).delete();const r=new Set,o=8;s.forEach((e=>{for(let t=0;t<o;t++)r.add(e+t)})),t.total=await e.viewIds.count()+n,await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!r.has(e)));n.length!==e.viewIds&&(e.viewIds=n),t.count++}))}else t.total=n;function o(e,t,n,a,s){e||(e="");let i=n;return a.includes("equal")&&["subject"].includes(t)&&(i=`"${i}"`),"anywhere"!==t&&(i=`${t}:${i}`),s&&e&&(i=`${e?" ":""}${s} `+i),e?e+i:i}const c=(e,t)=>{const n=[...e.filterValue[t]].filter(((n,a)=>{const s=[...n].filter(((n,a)=>{for(const s in n){let i="";const r="exclude"===t?"NOT":a?"AND":"OR";return"subject"!==s&&"to"!==s&&"from"!==s&&"cc"!==s||(i="subject"===s?n[s]:n[s].address,e.filterValue.query=o(e.filterValue.query,s,i,"equal",r),!1)}}));return e.filterValue[t][a]=s,0!==s.length}));0===n.length?delete e.filterValue[t]:e.filterValue[t]=n},l=e=>{e.filterValue.include&&c(e,"include"),e.filterValue.exclude&&c(e,"exclude")};await e.filters.where("[accountId+path]").between([C.wC,""],[C.wC,"ï¿¿"]).modify((e=>{l(e),t.count++})),await e.filters.where("[accountId+path]").between([C.Kz,""],[C.Kz,"ï¿¿"]).modify((e=>{e.path===C.ym?(e.filterValue.include=[],e.filterValue.exclude&&delete e.filterValue.exclude):l(e),t.count++})),t.stop()})),ja.set(160,(async e=>{const t=new $a(160,"Update viewIds of messages that have too many unseen counters"),n=[];await e.searchList.toArray().then((e=>{e.forEach((e=>{e.unseen||n.push(e.id)}))})),t.total=n.length,await e.viewIds.where("searchListId").anyOf(n).modify((e=>{e.viewIds=e.viewIds.filter((e=>!function(e){return e%100==1}(e))),t.count++})),t.stop()})),ja.set(161,(async e=>{const t=new $a(161,"Update Received folder to include send to self"),n={name:C.ik,accountId:C.of,path:C.ik,filterValue:{include:[[{folder:"Archive"}],[{folder:"Flagged"}],[{folder:C.Oi}],[{folder:C.e9}],[{folder:C.Hd}],[{folder:C.uT},{folder:"Not Sent Internal"}]],...$.Z.getSearchListButtons(C.HM)}};n&&(await e.filters.where("[accountId+path]").equals([n.accountId,n.path]).modify((e=>{e.filterValue.include=n.filterValue.include,e.filterValue.exclude=e.filterValue.exclude.filter((e=>!e.some((e=>e.folder===C.Nz))))})),await v.Z.call({priority:C.Un.LOW,type:"RUN_FILTERS",folderIds:[[C.of,C.ik]]})),t.stop()})),g.Z.version(162).stores({filteringQueue:"++id"}),ja.set(163,(async e=>{const t=new $a(163,"Adding support for Archive folders"),n="Archive",a="Archive",s=new Map;await e.accounts.toCollection().modify((({accountId:e,folders:t})=>{const i=t.Other;if(!i)return;const r=[];if(t.Other=i.filter((e=>{const{name:t,path:s}=e;return t!==a&&s!==a||(r.push({...e,type:n}),!1)})),r.length>0){const e=t.Archive;e?e.push(...r):t.Archive=r}const o=new Map;s.set(e,o);Object.keys(t).forEach((e=>{t[e].forEach((t=>{o.set(t.path,e)}))}))}));let i=!1;await e.filters.toCollection().modify((e=>{const{accountId:t,path:n,filterValue:a}=e;"All Messages"===t&&"Archive"===n&&(i=!0);const r=function(e,t){const n=s.get(e)?.get(t);return n||(e===C.of&&t===C.rp?C.Hd:t)}(t,n);if((["Sent","Drafts","Outbox"].includes(r)||["Single thread","Feeds"].includes(t))&&(a.showArchivedButton=!1),"Archive"===r){const e=[{accountId:t},{folder:"Archive"}];a.include?a.include.push(e):a.include=[e],a.showCustomFolderButton=!1,a.showJunkButton=!1,a.showArchivedButton=!1}})),i||(await e.filters.add({name:"Archive",accountId:"All Messages",path:"Archive",filterValue:{include:[[{folder:"Archive"}]],exclude:[[{flag:"\\Deleted"}],[{folder:"Trash"}]],showCustomFolderButton:!1,showJunkButton:!1,showArchivedButton:!1}}),await e.filteringQueue.add({priority:15,type:"RE_RUN_SLES",folderIds:[["All Messages","Archive"]],runMailingLists:!0})),t.stop()})),ja.set(164,(async e=>{const t=new $a(164,"Update names for filters");e.filters.toCollection().modify((e=>{e.name===C.ym&&(e.name=e.accountId)})),t.stop()})),ja.set(165,(async e=>{const t=new $a(165,"Fix Archive status in filters"),n=new Map;function a(e,t){return e.some((e=>1===e.length&&e[0]?.folder===t))}await e.accounts.each((({accountId:e,folders:t})=>{const a=new Map;n.set(e,a);Object.keys(t).forEach((e=>{t[e].forEach((t=>{a.set(t.path,e)}))}))})),await e.filters.toCollection().modify((e=>{const{accountId:t,path:s,filterValue:i}=e,r=function(e,t){const a=n.get(e)?.get(t);return a||(e===C.of&&t===C.rp?C.Hd:t)}(t,s);if("Archive"===r){delete i.showJunkButton;const e=[{folder:"Junk"}];i.exclude?a(i.exclude,"Junk")||i.exclude.push(e):i.exclude=[e]}else if(!1!==i.showArchivedButton){const e=[{folder:"Archive"}];i.exclude?a(i.exclude,"Archive")||i.exclude.push(e):i.exclude=[e]}})),t.stop()})),ja.set(166,(async e=>{const t=new $a(166,"Apply default showSubFolders and clear related include rules"),n=new Set(["Custom Folders","Mailing Lists","Filters","Labels","Flags","Feeds"]),a=new Set(["Other Mailing Lists","Important Mailing Lists"]),s=await e.accounts.toCollection().primaryKeys(),i=new Map,r=new Set;await e.filters.toCollection().modify((e=>{const{id:t,accountId:o,path:c,filterValue:l}=e;"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"===c&&(n.has(o)||s.includes(o))?(l.include=[],l.showSubFolders=!0,r.add(t)):"Mailing Lists"===o&&(a.has(c)?(l.include=[],l.showSubFolders=!0,r.add(t)):i.set(c,e))}));for(const e of[...i.values()]){const{include:t}=e.filterValue;if(!t||0===t.length)continue;const n=new Set;for(const e of t)for(const t of e)t.listId&&n.add(t.listId);if(0===n.size)continue;let a=e.path.substring(0,e.path.lastIndexOf("/")),s=i.get(a);for(;s;){const{id:e,filterValue:t}=s;if(t.include?.length>0){const a=t.include.length;t.include=t.include.filter((e=>!e.some((e=>n.has(e.listId))))),t.include.length<a&&r.add(e)}t.showSubFolders=!0,a=a.substring(0,a.lastIndexOf("/")),s=i.get(a)}}i.size>0&&await e.filters.bulkPut([...i.values()]),r.size>0&&await e.filteringQueue.add({priority:C.Un.LOW,type:"RUN_FILTERS",filterIds:[...r]}),t.stop()})),ja.set(167,(async e=>{const t=new $a(167,"Fix filter include rules"),n=[],a=new Set(["Flags","Custom Folders","All Accounts"]),s=await e.accounts.toCollection().primaryKeys(),i=new Set(s);await e.filters.toCollection().modify((e=>{const{id:t,accountId:s,path:r,filterValue:o}=e;"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"===r&&(a.has(s)&&(!o.include||o.include.length>0)&&(o.include=[],n.push(t)),!o.include&&i.has(s)&&(o.include=[],n.push(t)))})),n.length>0&&await e.filteringQueue.add({priority:15,type:"RUN_FILTERS",filterIds:n}),t.stop()})),ja.set(170,(async e=>e.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT_PATH").filter((e=>void 0===e.path)).delete())),ja.set(171,(async e=>{await e.filteringQueue.toCollection().modify((e=>{if(e.folderIds){Array.isArray(e.folderIds[0])||(e.folderIds=[e.folderIds]);for(const t of e.folderIds)t[1]=t[1]||"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"}}))})),ja.set(173,(async e=>{const t=new $a(173,"Fix casing of inbox and remove duplicates if found"),n=await e.accounts.toArray();for(const t of n){if(t.accountId===C.of){await e.accounts.delete(C.of);continue}const n=t.folders.Inbox||[];for(const a of n)"inbox"===a.path.toLowerCase()&&"Inbox"!==a.path&&(a.path="Inbox",await e.accounts.update(t.accountId,t))}function a(e){let t=!1;"inbox"===e.path.toLowerCase()&&"Inbox"!==e.path&&(e.path="Inbox",t=!0);for(const n of["include","exclude"])if(e.filterValue[n])for(const a of e.filterValue[n])for(const e of a)e.path&&"inbox"===e.path.toLowerCase()&&"Inbox"!==e.path&&(e.path="Inbox",t=!0);return t}const s=await e.filters.toArray(),i=s.filter((e=>"inbox"===e.path.toLowerCase())),r={};for(const e of i)r[e.accountId]?r[e.accountId].push(e):r[e.accountId]=[e];for(const n in r){const s=(await e.imap.where("accountId").equals(n).toArray()).filter((e=>"inbox"===e.path.toLowerCase())),i=new Map;t.total=s.length,t.count=0;for(const n of s){t.count++;const{accountId:a,path:s,uid:r}=n,o=i.get(r);o?0===o.hasRaw&&1===n.hasRaw&&(o.hasRaw=1):i.set(r,{...n,path:"Inbox"}),"Inbox"!==s&&await e.imap.delete([a,s,r])}await e.imap.bulkPut(Array.from(i.values()));const o=(await e.mailboxCache.where("accountId").equals(n).toArray()).filter((e=>"inbox"===e.path.toLowerCase())),c=new Map;t.total=o.length,t.count=0;for(const n of o){t.count++;const{accountId:a,path:s}=n,i=c.get(s);i?(Number(n.highestModseq)>Number(i.highestModseq)&&(i.highestModseq=n.highestModseq),n.uidNext>i.uidNext&&(i.uidNext=n.uidNext),n.exists>i.exists&&(i.exists=n.exists)):c.set(s,{...n,path:"Inbox"}),await e.mailboxCache.delete([a,s])}await e.mailboxCache.bulkPut(Array.from(c.values()));const l=await e.buffer.where("accountId").equals(n).toArray();t.total=l.length,t.count=0;for(const n of l){t.count++;const{_id:a,path:s="",destinationPath:i=""}=n;"inbox"===s.toLowerCase()&&"Inbox"!==s&&await e.buffer.update(a,{path:"Inbox"}),i&&"inbox"===i.toLowerCase()&&"Inbox"!==i&&await e.buffer.update(a,{destinationPath:"Inbox"})}const d=await e.filteringQueue.toArray();t.total=d.length,t.count=0;for(const n of d){t.count++;let a=!1;const{id:s,folderIds:i,fromFolderId:r,toFolderId:o}=n;if(i)for(const e of i)"inbox"===e[1].toLowerCase()&&"Inbox"!==e[1]&&(e[1]="Inbox",a=!0);r&&"inbox"===r[1].toLowerCase()&&"Inbox"!==r[1]&&(r[1]="Inbox",a=!0),o&&"inbox"===o[1].toLowerCase()&&"Inbox"!==o[1]&&(o[1]="Inbox",a=!0),a&&await e.filteringQueue.update(s,n)}const u=r[n];if(1===u.length){const t=u[0];a(t)&&await e.filters.update(t.id,t)}else if(u.length>1){let n=u.find((e=>"Inbox"===e.path));n||(n=u[0],a(n)&&await e.filters.update(n.id,n));const s=u.filter((e=>e.id!==n.id)),i=s.map((e=>e.id)),r=s.map((e=>100*e.id));await e.filters.where("id").anyOf(i).delete();const o=new Set,c=9;t.total=r.length,t.count=0,r.forEach((e=>{for(let t=0;t<c;t++)o.add(e+t)})),await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!o.has(e)));n.length!==e.viewIds&&(e.viewIds=n),t.count++}))}}const o=s.filter((e=>"inbox"!==e.path.toLowerCase()));t.total=o.length,t.count=0;for(const n of o)t.count++,a(n)&&await e.filters.update(n.id,n);t.stop()})),ja.set(174,(async e=>{const t=new $a(174,"Delete empty label if there is one"),n=await e.filters.where("[accountId+path]").equals([C.ut,""]).primaryKeys(),a=[0,1,2,3,4,5,6,7,8];if(n.length>0)for(const s of n){t.total=await e.viewIds.count();const n=100,i=new Set(a.map((e=>s*n+e)));await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!i.has(e)));n.length!==e.viewIds&&(e.viewIds=n),t.count++})),e.filters.delete(s)}t.stop()})),ja.set(175,(async e=>{const t=new $a(175,"Re-run filtering"),n=new Map;await e.searchList.each((({id:e,sourceFilterIds:a})=>{for(const t of a){const a=n.get(t);a?a.push(e):n.set(t,[e])}t.count++}));for(const[t,a]of n)await e.filteringQueue.add({type:"FILTERS_SLES",priority:20,searchListIds:a,filterIds:[t],runAllMessages:!0,runMailingLists:!0,runCustomFolders:!0,runFlagFolders:!0,runLabels:!0,runQueries:!0,runSingleThread:!0})})),ja.set(176,(async e=>{const t=new $a(176,"Fix grouped mailing lists"),n=await e.mailingList.toArray(),a=await e.filters.where("[accountId+path]").between(["Mailing Lists",""],["Mailing Lists","ï¿¿"]).filter((e=>{const{path:t}=e,a=t.indexOf("/");if(a<0)return!1;const s=t.substring(a+1);return!s.includes("/")&&n.some((({listId:e,parentFolderType:t})=>{switch(t){case"endsWith":return s.endsWith(e);case"startsWith":return s.startsWith(e);case"matches":return s===e}}))})).primaryKeys();if(0===a.length)return;await e.filters.bulkDelete(a);const s=new Set;for(const e of a)for(let t=0;t<9;t++)s.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!s.has(e)));n.length<e.viewIds.length&&(e.viewIds=n),t.count++})),await e.filteringQueue.add({priority:20,type:"RE_RUN_SLES",runMailingLists:!0}),t.stop()})),ja.set(177,(async e=>{const t=new $a(177,"Add default labels"),n=structuredClone(Fa.j).filter((e=>e.accountId===C.ut)),a=await e.filters.where("[accountId+path]").between([C.ut,""],[C.ut,"ï¿¿"]).toArray(),s=n.filter((e=>!a.some((t=>t.path===e.path))));s.length>0&&await e.filters.bulkAdd(s),t.stop()})),ja.set(178,(async e=>{const t=new $a(178,"Delete empty label actions");await e.filters.where("[accountId+path]").between([C.Kz,""],[C.ut,"ï¿¿"]).modify((e=>{e.triggers&&(e.triggers=e.triggers.filter((e=>void 0===e.label||""!==e.label)))})),t.stop()})),ja.set(179,(async e=>{const t=new $a(179,"Fixing saved searches"),n=["Filters",""],a=["Filters","ï¿¿"],s=await e.accounts.toCollection().primaryKeys();if(s.length>0){const t="VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH",i=s.map((e=>[e,t])),r=(e,t)=>{const{filterValue:n}=e;if(n.showSubFolders){delete n.showSubFolders;const e=n.include||[];n.include=[...e,[{accountId:t}]]}};await e.filters.where("[accountId+path]").anyOf(i).modify((e=>r(e,e.accountId))),await e.filters.where("[accountId+path]").between(n,a).filter((e=>{const{selectedAccountId:t,selectedName:n}=e;return t===n&&s.includes(t)})).modify((e=>{const{selectedAccountId:t,accountId:n,path:a}=e;r(e,t),i.push([n,a])})),await e.filteringQueue.add({type:"RUN_FILTERS",priority:15,folderIds:i})}const i=await e.filters.toArray(),r=await e.filters.where("[accountId+path]").between(n,a).filter((({filterValue:e,selectedAccountId:t,selectedName:n})=>{if(e.showSubFolders)return!0;if(t&&n){if(!i.some((e=>e.accountId===t&&e.name===n)))return!0}return!1})).primaryKeys();if(r.length>0){await e.filters.bulkDelete(r);const n=new Set;for(const e of r)for(let t=0;t<9;t++)n.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const a=e.viewIds.filter((e=>!n.has(e)));a.length<e.viewIds.length&&(e.viewIds=a),t.count++}))}t.stop()})),ja.set(180,(async e=>{const t=new $a(180,"Decode imap folder filter names"),n=await e.accounts.toCollection().primaryKeys();await e.filters.toCollection().modify((e=>{n.includes(e.accountId)&&(e.name=(0,Dn.kF)(e.name))})),t.stop()})),ja.set(181,(async e=>{const t=new $a(181,"Adding labels made from webmail");const n=[C.ut,""],a=[C.ut,"ï¿¿"],s=(await e.filters.where("[accountId+path]").between(n,a).toArray()).map((e=>e.path)),i=new Set,r=new Set,o=await e.searchList.toArray();if(t.total=o.length,o.forEach((e=>{e.flags.forEach((t=>{!s.includes(t)&&function(e){const t=e.toLowerCase();return t.startsWith("$label")||"$"!==t[0]&&"\\"!==t[0]&&!["mdnsent","forwarded","submitpending","submitted","junk","notjunk","nonjunk","phishing","important","draft","seen","flagged","answered","recent"].includes(t)}(t)&&(i.add(t),r.add(e))})),t.count++})),[...i].length>0){const t=[...i].map((e=>{const t=[{flag:e}];return{name:e,accountId:C.ut,path:e,filterValue:{include:[t],...$.Z.getSearchListButtons(C.ut)}}})),n=await e.filters.bulkAdd(t,{allKeys:!0});v.Z.call({type:"RE_RUN_SLES",priority:C.Un.LOW,folderIds:[[C.ut,C.ym]],filterIds:n,searchListIds:[...r].map((e=>e.id))})}t.stop()})),ja.set(182,(async e=>{const t=new $a(182,"Refactor filter view toggles");t.total=await e.filters.count(),await e.filters.toCollection().modify((e=>{const{accountId:n,path:a,filterValue:s}=e;s.exclude&&(s.exclude=s.exclude.filter((t=>{for(const s of t)return s.flag===C.T4.SEEN?(e.filterValue.showRead=!1,n===C.of&&a===C.tB):s.flag===C.T4.DELETED||s.folder===C.uT?(e.filterValue.showDeleted=!1,!1):s.folder===C.Hd?(e.filterValue.showJunk=!1,!1):s.folder===C.Oi?(e.filterValue.showCustomFolder=!1,!1):s.folder!==C.hn||(e.filterValue.showArchived=!1,!1)})),0===s.exclude.length&&delete s.exclude),s.include&&(s.include=s.include.filter((t=>{let a=!1,s=!1,i=!1;return 2!==t.length||(t.forEach((e=>{a=e.accountId===n||a,s=e.folder===C.Hd||s,i=e.folder===C.hn||i})),a&&s?(e.filterValue.showJunk=!0,!1):!a||!i||(e.filterValue.showArchived=!0,!1))}))),t.count++})),t.stop()})),g.Z.version(183).stores({importStatus:null,importProgress:"path"}),ja.set(184,(async e=>{const t=new $a(184,"Make feed-sources internal"),n=[C.u4,""],a=[C.u4,"ï¿¿"],s=await e.filters.where("[accountId+path]").between(n,a).primaryKeys();t.total=await e.searchList.where("sourceFilterIds").anyOf(s).count(),await e.searchList.where("sourceFilterIds").anyOf(s).modify((e=>{t.count++;for(const[t,n]of e.sources)s.includes(t)&&!n.internal&&(n.internal=!0)})),t.stop()})),ja.set(185,(async e=>{const t=new $a(185,"Removing custom folder filters"),n=await e.filters.toCollection().filter((({accountId:e,path:t})=>"Custom Folders"===e&&"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"!==t)).primaryKeys();if(n.length>0){await e.filters.bulkDelete(n);const a=new Set;for(const e of n)for(let t=0;t<9;t++)a.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!a.has(e)));n.length<e.viewIds.length&&(e.viewIds=n),t.count++}))}t.stop()})),g.Z.version(186).stores({hasRaw:"[searchListId+accountId],[hasRaw+accountId+searchListId],accountId,searchListId"}),ja.set(186,(async e=>{const t=new $a(186,"Processing raw data"),n=await e.searchList.count(),a=await e.imap.count(),s=await e.pop.count();t.total=n+a+s;const i=new Map;await e.imap.toCollection().modify((e=>{const{searchListId:n,accountId:a,hasRaw:s}=e;let r=i.get(n);r||(r=new Map,i.set(n,r)),r.set(a,1===s),delete e.hasRaw,t.count++})),await e.pop.toCollection().modify((e=>{const{searchListId:n,accountId:a,headersOnly:s}=e;let r=i.get(n);r||(r=new Map,i.set(n,r)),r.set(a,!s),delete e.headersOnly,t.count++}));const r=await e.filters.toArray(),o=new Map(r.map((e=>[e.id,e]))),c=[],l=[];for(await e.searchList.each((e=>{const n=new Set;let a=!0;for(const[t,s]of e.sources){const e=o.get(t);e?(n.add(e.accountId),s.internal||(a=!1)):m.Z.error("Mail",["Upgrade","186"],"Filter not found "+t)}for(const s of n){const n=i.get(e.id)?.get(s);let r;if(void 0!==n)r=n?1:0;else if(a)r=1;else{const{id:t,sentDate:n}=e;l.push({accountId:s,searchListId:t,sentDate:n}),r=1}c.push({searchListId:e.id,accountId:s,hasRaw:r}),t.total++}t.count++}));c.length>0;){const n=c.splice(0,1e4);await e.hasRaw.bulkAdd(n),t.count+=n.length}l.length>0&&await e.systemTasks.add({taskName:"check_disk_for_raw",fileKeys:l}),t.stop()})),g.Z.version(187).stores({hasRaw:"[searchListId+accountId],accountId,searchListId,[hasRaw+accountId]"}),g.Z.version(188).stores({hasRaw:"[searchListId+accountId],accountId,searchListId,[hasRaw+accountId+searchListId]"}),ja.set(189,(async e=>{const t=new $a(189,"Upgrade pending upload entries in buffer");t.total=await e.buffer.count();const n=await e.buffer.toArray();for(const a of n)"BUFFER_OPERATION_UPLOAD_MESSAGE"!==a.operation||a.flags?"BUFFER_OPERATION_MOVE"===a.operation&&a.destinationAccountId&&(await e.buffer.delete(a._id),m.Z.warn("Mail",["Upgrade","189"],"An old, broken buffer action for moving between accounts was removed")):(await e.buffer.update(a._id,{flags:[]}),m.Z.info("Mail",["Upgrade","189"],"An old buffer action for uploading was modified to include an empty flags array")),t.count++;t.stop()})),ja.set(191,(async e=>{const t=new $a(191,"Converting draft attachments");t.total=await e.messages.count();const n=new TextEncoder;await e.messages.toCollection().modify((e=>{e.bodyParts?.forEach((e=>{if("attachment"===e.type&&"string"==typeof e.content){const t=(0,Ua.tV)(e.content);if(e.content=n.encode(t),"application/ics"===e.mimeType){const n=t.match(/METHOD:\s*(\w+)/);n&&(e.method=n[1])}}})),t.count++})),t.stop()})),ja.set(192,(async e=>{const t=new $a(192,"Remove buffer entries for moving that have an empty uid list");t.total=await e.buffer.count();const n=await e.buffer.toArray();for(const a of n)"BUFFER_OPERATION_MOVE"!==a.operation||a.uids&&0!==a.uids.length||(await e.buffer.delete(a._id),m.Z.info("Mail",["Upgrade","192"],"Removed an unwanted buffer entry for moving an internal message")),t.count++;t.stop()})),ja.set(193,(async e=>{const t=new $a(193,"Preparing to re-run threading..."),n=await e.threading.toCollection().primaryKeys();await e.threadingQueue.add({threadingIds:n}),t.stop()})),ja.set(194,(async e=>{const t=new $a(194,"Moving size from imap table to searchList table...");t.total=await e.imap.count(),await e.imap.toCollection().modify((async n=>{const{searchListId:a,size:s}=n;await e.searchList.update(a,{size:s}),delete n.size,t.count++})),t.stop()})),ja.set(195,(async e=>{const t=new $a(195,"Clearing capabilities from accounts table");t.total=await e.accounts.count(),await e.accounts.toCollection().modify((async e=>{delete e.capability,t.count++})),t.stop()})),ja.set(196,(async e=>{const t=new $a(196,"Clearing unused gmailId from messages table");t.total=await e.messages.count(),await e.messages.toCollection().modify((e=>{delete e.gmailId,t.count++})),t.stop()})),ja.set(197,(async e=>{const t=new $a(197,"Clearing lastNotificaton from accounts table");t.total=await e.accounts.count(),await e.accounts.toCollection().modify((e=>{delete e.lastNotification,t.count++})),t.stop()})),ja.set(198,(async e=>{const t=await e.filters.get({"[accountId+path]":[C.of,C.rp]});let n=!1;if(t){const a=t.filterValue;a.include&&2===a.include.length&&a.include.find((e=>e.find((e=>e.flag&&e.flag===C.T4.JUNK))&&e.find((e=>e.folder&&e.folder===C.Hd))))||(a.include=[[{folder:C.Hd}],[{flag:C.T4.JUNK}]],await e.filters.update(t.id,{filterValue:a}),n=!0)}else{const t={name:C.rp,accountId:C.of,path:C.rp,filterValue:{include:[[{folder:C.Hd}],[{flag:C.T4.JUNK}]],...$.Z.getSearchListButtons(C.Hd)}};await e.filters.add(t),n=!0}n&&e.filteringQueue.add({type:"RUN_FILTERS",priority:C.Un.LOW,folderIds:[[C.of,C.rp]]})})),ja.set(201,(async e=>{const t=new $a(201,"Update Received folder so Feeds filter button works");await e.filters.where("[accountId+path]").equals([C.of,C.ik]).modify((e=>{e.filterValue.include=[...e.filterValue.include,[{accountId:C.u4}]],e.filterValue={...e.filterValue,showFeeds:!1}})),await v.Z.call({priority:C.Un.LOW,type:"RUN_FILTERS",folderIds:[[C.of,C.ik]]}),t.stop()})),ja.set(202,(async e=>{const t=new $a(202,"Setting new listPost attribute to empty string");t.total=await e.messages.count(),await e.messages.toCollection().modify((e=>{e.listPost="",t.count++})),t.stop()})),ja.set(203,(async e=>{const t=new $a(203,"Make sure All Messages Unread has the exclude seen rule"),n=["All Messages","Unread"];let a=!0;await e.filters.where("[accountId+path]").equals(n).modify((e=>{e.filterValue.exclude||(e.filterValue.exclude=[]),a=e.filterValue.exclude.some((e=>1===e.length&&e[0]?.flag===C.T4.SEEN)),a||e.filterValue.exclude.push([{flag:C.T4.SEEN}])})),a||await e.filteringQueue.add({priority:C.Un.LOW,type:"RUN_FILTERS",folderIds:[n]}),t.stop()})),ja.set(204,(async e=>{const t=new $a(204,"Generate missing previews");await e.systemTasks.add({taskName:"generate_missing_previews",currentId:0}),t.stop()})),ja.set(205,(async e=>{const t=new $a(205,"Fixing mailing lists"),n=await e.filters.where("[accountId+path]").between(["Mailing Lists",""],["Mailing Lists","ï¿¿"]).primaryKeys();0!==n.length&&(await e.filteringQueue.add({priority:20,type:"RE_RUN_SLES",filterIds:n,runMailingLists:!0}),t.stop())})),g.Z.version(206).stores({hasRaw:["[searchListId+accountId]","accountId","searchListId","[hasRaw+accountId+sentDate+searchListId]"].join(",")}),ja.set(206,(async e=>{const t=new $a(206,"Updating raw status");t.total=2*await e.searchList.count();const n=new Map;await e.searchList.each((({id:e,sentDate:a})=>{n.set(e,a),t.count++})),await e.hasRaw.toCollection().modify((e=>{e.sentDate=n.get(e.searchListId),t.count++})),t.stop()})),ja.forEach(((e,t)=>g.Z.version(t).upgrade((async n=>{try{await e(n),await n._upgrades.add({version:t})}catch(e){throw m.Z.error("Mail",["Upgrade",""+t],e),e}})))),g.Z.on("ready",(async()=>{const e=await g.Z._upgrades.toCollection().last();let t=[...ja.keys()];e&&(t=t.filter((t=>t>e.version))),t.sort(((e,t)=>e-t));for(const e of t){const t=ja.get(e);t&&await g.Z.transaction("rw",g.Z.tables,(n=>t(n).then((()=>n._upgrades.add({version:e})))))}}));const Va=g.Z;var qa=n(87192),Qa=n(24600);function Ha(e){if(0===e.length)throw new Error("raceToResolve: Need an array with at least one Promise.");let t;return new Promise(((n,a)=>Promise.all(e.map((e=>e.then(n).catch((e=>t=e))))).then((()=>a(t)))))}var Ka=n(16932);const{OK:Wa,ERROR:Ga,OFFLINE:Xa}=C.In;async function Ya(e){try{let t;if(e.useOAuth){const n=await Fn(e);t=cn(e,n)}else t=cn(e);await new Promise(((e,n)=>{t.onError=n,t.login().then((()=>t.logout())).then(e).catch(n)}))}catch(t){throw new Error((0,d.Z)("Login for $1 failed. $2",[e.MAIL_SERVER,t.message]))}}async function Ja(e){try{await ut.verifyLogin(e)}catch(t){throw new Error((0,d.Z)("Login for $1 failed.",[e.MAIL_SERVER]))}}async function es(e){try{let t;if(e.useOAuth){const n=await Fn(e);t=(0,Qa.Z)(e,n)}else t=(0,Qa.Z)(e);await new Promise(((e,n)=>{t.onidle=t.quit,t.onerror=n,t.onclose=e,t.connect()}))}catch(t){throw e.useOAuth&&await Mn(e.MAIL_EMAIL,(0,Un.dn)(e)),new Error((0,d.Z)("Login for $1 failed.",[e.MAIL_SMTP_SERVER]))}}const ts=(e,t=!1)=>{const[n,a,s,i]=t?[e.MAIL_SMTP_PORT,e.MAIL_SMTP_SERVER,e.MAIL_SMTP_USER,e.MAIL_SMTP_PASSWORD]:[e.MAIL_PORT,e.MAIL_SERVER,e.MAIL_USER,e.MAIL_PASSWORD];if(!n||"number"!=typeof n)throw new Error(t?(0,d.Z)("Outgoing port is missing or not a number"):(0,d.Z)("Incoming port is missing or not a number"));if(!a)throw new Error(t?(0,d.Z)("Outgoing server information is missing"):(0,d.Z)("Incoming server information is missing"));if(!e.useOAuth){if(!s)throw new Error(t?(0,d.Z)("Outgoing username is missing"):(0,d.Z)("Incoming username is missing"));if(!i)throw new Error(t?(0,d.Z)("Outgoing password is missing"):(0,d.Z)("Incoming password is missing"))}},ns=(e,t,n,a,s)=>new Promise(((s,i)=>{const r=D.default.open(e,t,{useSecureTransport:"ssl"===n});r.onerror=i,r.onopen=()=>{r.close(),s("MAIL_SMTP_SERVER"===a?{MAIL_SMTP_SERVER:e,MAIL_SMTP_PORT:t,MAIL_SMTP_SOCKET_TYPE:n}:{MAIL_SERVER:e,MAIL_PORT:t})}})),as=(e,t)=>{const n={...e,MAIL_SMTP_USER:t};return es(n).then((()=>[Wa,"Outgoing connection success",n])).catch((t=>{throw[Ga,t.message,e]}))},ss=async(e,t,n)=>{const a=await rs(t);return a?is(e,a,n):Promise.reject(`No MX record found for ${t}`)},is=(e,t,n)=>{const a=[`https://autoconfig.${t}/mail/config-v1.1.xml?emailaddress=${e.MAIL_EMAIL}`,`https://autoconfig.vivaldi.net/v1.1/${t}`,`https://${t}/.well-known/autoconfig/mail/config-v1.1.xml?emailaddress=${e.MAIL_EMAIL}`],s="pop"===n?"pop3":n;return Ha(a.map((t=>os(e,s,t))))},rs=async e=>{const t=await fetch(`https://autoconfig.vivaldi.net/mxlookup?domain=${e}`);if(t.ok){const e=await t.json();if(e&&e[0]?.target){return ds(e[0]?.target)}}},os=async(e,t,n)=>{const a=await fetch(n);if(!a.ok)throw new Error("autodiscover: Error looking up in autoconfig");try{const n=await a.text(),s=new Ka.XMLParser({ignoreAttributes:!1}).parse(n),{emailProvider:i}=s.clientConfig,{outgoingServer:r,incomingServer:o}=i,c=Array.isArray(o)?o:[o],l=Array.isArray(r)?r:[r];let d,u,h,f,p;for(const e of c)if(e["@_type"]===t&&"ssl"===e.socketType.toLowerCase()){d=e.hostname,u=e.port;break}for(const e of l)if("smtp"===e["@_type"]&&"plain"!==e.socketType.toLowerCase()){h=e.hostname,f=e.port,p=e.socketType.toLowerCase();break}if(!(d&&u&&h&&f&&p))throw new Error("autodiscover: Missing Outgoing or Incoming Server/Port information");const g={...e,MAIL_SERVER:d,MAIL_PORT:Number(u),MAIL_SMTP_SERVER:h,MAIL_SMTP_PORT:Number(f),MAIL_SMTP_SOCKET_TYPE:"ssl"===p?"ssl":"starttls"};return[Wa,g]}catch(e){throw new Error(`autodiscover: ${e}`)}},cs=async(e,t,n,a)=>{const s=await rs(t);return s?ls(e,s,n,a):[Ga,e]},ls=(e,t,n,a)=>{const s=[`${n}.${t}`,`mail.${t}`,`${n}.mail.${t}`],i=[`smtp.${t}`,`mail.${t}`,`smtp.mail.${t}`];let r,o;return Promise.race([new Promise((e=>setTimeout(e,1e4))),Promise.allSettled([Ha([...s.map((e=>ns(e,a,"ssl","MAIL_SERVER")))]).then((e=>{r=e})),new Promise((e=>Promise.allSettled([Ha([...i.map((e=>ns(e,465,"ssl","MAIL_SMTP_SERVER")))]).then((t=>{o=t,e()})),Ha([...i.map((e=>ns(e,587,"starttls","MAIL_SMTP_SERVER")))]).then((e=>{o||(o=e)}))]).then(e)))])]).then((()=>{const t={...e,...r,...o};return[["MAIL_SERVER","MAIL_PORT","MAIL_SMTP_SERVER","MAIL_SMTP_PORT","MAIL_SMTP_SOCKET_TYPE"].every((e=>t[e]))?Wa:Ga,t]}))},ds=e=>{let t=e;if(null!=e){var n=e.split(".").reverse();null!=n&&n.length>1&&(t=n[1]+"."+n[0],-1!==e.toLowerCase().indexOf(".co.uk")&&n.length>2&&(t=n[2]+"."+t))}return t.toLowerCase()};var us=n(6977);const hs={call:async function(e){if(0===e.length)return;const t=[],n=new Map;e.forEach((e=>{const{id:a,updates:s}=e,{sources:i=new Map}=s;i.forEach((async(e,n)=>{if(!e||0===Object.keys(e).length)return;const s=b.Z.get(n);if(!s)throw new Error(`Source filter ${n} not found in cache`);const{accountId:i,path:r}=s;t.push([i,r,a])})),n.set(a,e)})),0!==t.length&&await g.Z.transaction("rw",[g.Z.buffer,g.Z.imap],(async()=>{const e=[];(await g.Z.imap.where("[accountId+path+searchListId]").anyOf(t).toArray()).forEach((t=>{const{accountId:a,path:s,uid:i,searchListId:r}=t,o=n.get(r),c=b.Z.getByFolderId([a,s]),{sources:l}=o.updates;if(l){const t=l.get(c.id),n={},{deleted:r,read:o}=t;void 0!==r&&(n[C.T4.DELETED]=r),void 0!==o&&(n[C.T4.SEEN]=o),e.push({accountId:a,path:s,uid:i,flagUpdates:n})}})),e.length>0&&await us.Z.addCustomFlags(e)}))}};var fs=n(47482);let ps=!1;const gs=I.Z.adjustBatchSize.bind(void 0,100,1e3,500);let ms=100;async function ws(e){const t=await g.Z.flaggingQueue.toCollection().first();if(!t)return;let{id:n,searchListIds:a,sourcesPerSle:s,flagUpdates:i}=t;for(s instanceof Map||(console.warn("flagging.js: Invalid entry in flaggingQueue table"),s=new Map);a.length>0;){const e=a.splice(0,ms),t=Date.now(),r=e.map((e=>({searchListId:e,sources:s.get(e)||new Map})));await g.Z.transaction("rw",[g.Z.searchList,g.Z.filteringQueue,g.Z.flaggingQueue,g.Z.buffer,g.Z.imap],(async()=>{const t=await fs.Z.call(r,i);U.QO.updateIndex({sleUpdates:t}),Object.keys(i).length>0&&await _.Z.call(e,i),s.size>0&&await hs.call(t),Xt.call();const o={id:n,searchListIds:a,sourcesPerSle:s,flagUpdates:i};await g.Z.flaggingQueue.put(o)}));const o=Date.now();ms=gs(ms,o-t),we.filter()}await g.Z.flaggingQueue.delete(n),await ws(e)}Va.open();const _s={updateThreads:Pe.updateThreads,start:async function(){await Promise.all([In(),b.Z.initFilters(),y.Z.initFolders(),Ae(),ee.Z.initMailingLists()])},stop:function(){void 0!==bn&&bn("Clearing UID sequence sets."),vn(),yn={},b.Z.clear(),ee.Z.clear(),Ee(),Ie={level:0,children:new Map},u.Z.clear()},addAccount:async function(e){const t=e.MAIL_EMAIL,{accountType:n,offline:a}=e,s=n===C.s9.POP,i=n===C.s9.IMAP;if(!s&&!i)throw new Error(`Trying to add account ${t} of unsupported type ${n}`);const l=s||a?c.Z.getDefaultFolders():{},d=await r.Z.add(t,l);await u.Z.addAccounts({[t]:d});const h=await o.Z.foldersToFilters(t,l);b.Z.updateFilters(h)},flushBuffer:Xt.call,updateFlags:async function(){if(!ps){ps=!0;try{await ws()}finally{ps=!1}}},runSystemTasks:async function(){const e=await g.Z.systemTasks.toArray();for(const t of e)await Ut(t)},getOAuthAccessToken:Zn,fetchAccessTokenAndRefreshToken:Mn,verify:async function(e){await(async e=>(ts(e,!0),es(e)))(e),await(async e=>{ts(e,!1),e.accountType===C.s9.IMAP?await Ya(e):await Ja(e)})(e)},autofill:async function(e){if(!qa.Z.isValidEmail(e))return[Ga,e];const t=e.MAIL_EMAIL,n=e.MAIL_EMAIL&&t.split("@")[1];let a="imap",s=993;return e.accountType===C.s9.POP&&(a="pop",s=995),Ha([is(e,n,a),ss(e,n,a)]).catch((()=>{let t;return new Promise((i=>Promise.allSettled([ls(e,n,a,s).then((e=>{e[0]===Wa&&i(e),t||(t=e)})),cs(e,n,a,s).then((e=>{e[0]===Wa&&i(e),t||(t=e)}))]).then((()=>i(t)))))})).then((e=>e))},signIn:async function(e){if(e.offline)return[Xa,"offline",e];e.MAIL_PORT||(e.MAIL_PORT=e.accountType===C.s9.IMAP?993:995),e.MAIL_SMTP_PORT||(e.MAIL_SMTP_PORT=465);try{ts(e,!1),ts(e,!0)}catch(t){return[Ga,t.message,e]}if(e.useOAuth)try{return await as(e,e.MAIL_EMAIL)}catch(e){return e}const t=[e.MAIL_USER],n=[e.MAIL_SMTP_USER];if(e.MAIL_EMAIL===e.MAIL_USER&&e.MAIL_EMAIL===e.MAIL_SMTP_USER&&e.MAIL_EMAIL.includes("@")){const a=e.MAIL_EMAIL.split("@")[0];t.push(a),n.push(a)}const a=await Promise.allSettled([Ha(n.map((t=>as(e,t)))),Ha(t.map((t=>(async(e,t)=>{const n={...e,MAIL_USER:t};try{return e.accountType===C.s9.IMAP?(await Ya(n),[Wa,"Incoming connection success",n]):(await Ja(e),[Wa,"Incoming connection success",n])}catch(t){throw[Ga,t.message,e,[]]}})(e,t))))]);let s={...e},i=Wa,r="";for(const e of a)e.reason?(i=Ga,r=e.reason[1],s={...s,...e.reason[2]}):e.value&&(s={...s,...e.value[2]});return[i,r,s]}};function bs(e){if(e.origin!==ne.oP)return;const{background:t}=e.data;if(t){const{promiseId:n,func:a,args:s=[]}=t;Promise.resolve().then((()=>_s[a](...s))).then((t=>{e.source.postMessage({background:{promiseId:n,results:t}})})).catch((t=>{t=t.message||t,e.source.postMessage({background:{promiseId:n,error:t}})}))}}self.addEventListener("install",(e=>{self.skipWaiting()}));let ys=!1;!async function(){ys||(ys=!0,self.addEventListener("message",bs,!1),await Promise.all([a.Z.loadPromise(),s.Z.loadPromise(),i.Z.loadPromise()]))}()},44983:()=>{!function(e){var t={};function n(a){if(t[a])return t[a].exports;var s=t[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(a,s,function(t){return e[t]}.bind(null,s));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(e,t,n){"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(e,t,n){"use strict";var a="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function s(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var a in n)s(n,a)&&(e[a]=n[a])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var i={arraySet:function(e,t,n,a,s){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+a),s);else for(var i=0;i<a;i++)e[s+i]=t[n+i]},flattenChunks:function(e){var t,n,a,s,i,r;for(a=0,t=0,n=e.length;t<n;t++)a+=e[t].length;for(r=new Uint8Array(a),s=0,t=0,n=e.length;t<n;t++)i=e[t],r.set(i,s),s+=i.length;return r}},r={arraySet:function(e,t,n,a,s){for(var i=0;i<a;i++)e[s+i]=t[n+i]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,i)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,r))},t.setTyped(a)},function(e,t,n){"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(e,t,n){"use strict";var a,s=n(2),i=n(8),r=n(6),o=n(7),c=n(1),l=-2,d=258,u=262,h=103,f=113,p=666;function g(e,t){return e.msg=c[t],t}function m(e){return(e<<1)-(e>4?9:0)}function w(e){for(var t=e.length;--t>=0;)e[t]=0}function _(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(s.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function b(e,t){i._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,_(e.strm)}function y(e,t){e.pending_buf[e.pending++]=t}function v(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function I(e,t){var n,a,s=e.max_chain_length,i=e.strstart,r=e.prev_length,o=e.nice_match,c=e.strstart>e.w_size-u?e.strstart-(e.w_size-u):0,l=e.window,h=e.w_mask,f=e.prev,p=e.strstart+d,g=l[i+r-1],m=l[i+r];e.prev_length>=e.good_match&&(s>>=2),o>e.lookahead&&(o=e.lookahead);do{if(l[(n=t)+r]===m&&l[n+r-1]===g&&l[n]===l[i]&&l[++n]===l[i+1]){i+=2,n++;do{}while(l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&i<p);if(a=d-(p-i),i=p-d,a>r){if(e.match_start=t,r=a,a>=o)break;g=l[i+r-1],m=l[i+r]}}}while((t=f[t&h])>c&&0!=--s);return r<=e.lookahead?r:e.lookahead}function k(e){var t,n,a,i,c,l,d,h,f,p,g=e.w_size;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=g+(g-u)){s.arraySet(e.window,e.window,g,g,0),e.match_start-=g,e.strstart-=g,e.block_start-=g,t=n=e.hash_size;do{a=e.head[--t],e.head[t]=a>=g?a-g:0}while(--n);t=n=g;do{a=e.prev[--t],e.prev[t]=a>=g?a-g:0}while(--n);i+=g}if(0===e.strm.avail_in)break;if(l=e.strm,d=e.window,h=e.strstart+e.lookahead,f=i,p=void 0,(p=l.avail_in)>f&&(p=f),n=0===p?0:(l.avail_in-=p,s.arraySet(d,l.input,l.next_in,p,h),1===l.state.wrap?l.adler=r(l.adler,d,p,h):2===l.state.wrap&&(l.adler=o(l.adler,d,p,h)),l.next_in+=p,l.total_in+=p,p),e.lookahead+=n,e.lookahead+e.insert>=3)for(c=e.strstart-e.insert,e.ins_h=e.window[c],e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+3-1])&e.hash_mask,e.prev[c&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=c,c++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<u&&0!==e.strm.avail_in)}function E(e,t){for(var n,a;;){if(e.lookahead<u){if(k(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n)),e.match_length>=3)if(a=i._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else a=i._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(a&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function x(e,t){for(var n,a,s;;){if(e.lookahead<u){if(k(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,a=i._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,a&&(b(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((a=i._tr_tally(e,0,e.window[e.strstart-1]))&&b(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(a=i._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function A(e,t,n,a,s){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=a,this.func=s}function S(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(1146),this.dyn_dtree=new s.Buf16(122),this.bl_tree=new s.Buf16(78),w(this.dyn_ltree),w(this.dyn_dtree),w(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(16),this.heap=new s.Buf16(573),w(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(573),w(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function M(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:f,e.adler=2===t.wrap?0:1,t.last_flush=0,i._tr_init(t),0):g(e,l)}function O(e){var t,n=M(e);return 0===n&&((t=e.state).window_size=2*t.w_size,w(t.head),t.max_lazy_match=a[t.level].max_lazy,t.good_match=a[t.level].good_length,t.nice_match=a[t.level].nice_length,t.max_chain_length=a[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),n}function N(e,t,n,a,i,r){if(!e)return l;var o=1;if(-1===t&&(t=6),a<0?(o=0,a=-a):a>15&&(o=2,a-=16),i<1||i>9||8!==n||a<8||a>15||t<0||t>9||r<0||r>4)return g(e,l);8===a&&(a=9);var c=new S;return e.state=c,c.strm=e,c.wrap=o,c.gzhead=null,c.w_bits=a,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=i+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+3-1)/3),c.window=new s.Buf8(2*c.w_size),c.head=new s.Buf16(c.hash_size),c.prev=new s.Buf16(c.w_size),c.lit_bufsize=1<<i+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new s.Buf8(c.pending_buf_size),c.d_buf=1*c.lit_bufsize,c.l_buf=3*c.lit_bufsize,c.level=t,c.strategy=r,c.method=n,O(e)}a=[new A(0,0,0,0,(function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(k(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var a=e.block_start+n;if((0===e.strstart||e.strstart>=a)&&(e.lookahead=e.strstart-a,e.strstart=a,b(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-u&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(b(e,!1),e.strm.avail_out),1)})),new A(4,4,8,4,E),new A(4,5,16,8,E),new A(4,6,32,32,E),new A(4,4,16,16,x),new A(8,16,32,32,x),new A(8,16,128,128,x),new A(8,32,128,256,x),new A(32,128,258,1024,x),new A(32,258,258,4096,x)],t.deflateInit=function(e,t){return N(e,t,8,15,8,0)},t.deflateInit2=N,t.deflateReset=O,t.deflateResetKeep=M,t.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?l:(e.state.gzhead=t,0):l},t.deflate=function(e,t){var n,s,r,c;if(!e||!e.state||t>5||t<0)return e?g(e,l):l;if(s=e.state,!e.output||!e.input&&0!==e.avail_in||s.status===p&&4!==t)return g(e,0===e.avail_out?-5:l);if(s.strm=e,n=s.last_flush,s.last_flush=t,42===s.status)if(2===s.wrap)e.adler=0,y(s,31),y(s,139),y(s,8),s.gzhead?(y(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),y(s,255&s.gzhead.time),y(s,s.gzhead.time>>8&255),y(s,s.gzhead.time>>16&255),y(s,s.gzhead.time>>24&255),y(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),y(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(y(s,255&s.gzhead.extra.length),y(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(e.adler=o(e.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=69):(y(s,0),y(s,0),y(s,0),y(s,0),y(s,0),y(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),y(s,3),s.status=f);else{var u=8+(s.w_bits-8<<4)<<8;u|=(s.strategy>=2||s.level<2?0:s.level<6?1:6===s.level?2:3)<<6,0!==s.strstart&&(u|=32),u+=31-u%31,s.status=f,v(s,u),0!==s.strstart&&(v(s,e.adler>>>16),v(s,65535&e.adler)),e.adler=1}if(69===s.status)if(s.gzhead.extra){for(r=s.pending;s.gzindex<(65535&s.gzhead.extra.length)&&(s.pending!==s.pending_buf_size||(s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),_(e),r=s.pending,s.pending!==s.pending_buf_size));)y(s,255&s.gzhead.extra[s.gzindex]),s.gzindex++;s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),s.gzindex===s.gzhead.extra.length&&(s.gzindex=0,s.status=73)}else s.status=73;if(73===s.status)if(s.gzhead.name){r=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),_(e),r=s.pending,s.pending===s.pending_buf_size)){c=1;break}c=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,y(s,c)}while(0!==c);s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),0===c&&(s.gzindex=0,s.status=91)}else s.status=91;if(91===s.status)if(s.gzhead.comment){r=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),_(e),r=s.pending,s.pending===s.pending_buf_size)){c=1;break}c=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,y(s,c)}while(0!==c);s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),0===c&&(s.status=h)}else s.status=h;if(s.status===h&&(s.gzhead.hcrc?(s.pending+2>s.pending_buf_size&&_(e),s.pending+2<=s.pending_buf_size&&(y(s,255&e.adler),y(s,e.adler>>8&255),e.adler=0,s.status=f)):s.status=f),0!==s.pending){if(_(e),0===e.avail_out)return s.last_flush=-1,0}else if(0===e.avail_in&&m(t)<=m(n)&&4!==t)return g(e,-5);if(s.status===p&&0!==e.avail_in)return g(e,-5);if(0!==e.avail_in||0!==s.lookahead||0!==t&&s.status!==p){var I=2===s.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(k(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,n=i._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(s,t):3===s.strategy?function(e,t){for(var n,a,s,r,o=e.window;;){if(e.lookahead<=d){if(k(e),e.lookahead<=d&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(a=o[s=e.strstart-1])===o[++s]&&a===o[++s]&&a===o[++s]){r=e.strstart+d;do{}while(a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&s<r);e.match_length=d-(r-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=i._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=i._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(s,t):a[s.level].func(s,t);if(3!==I&&4!==I||(s.status=p),1===I||3===I)return 0===e.avail_out&&(s.last_flush=-1),0;if(2===I&&(1===t?i._tr_align(s):5!==t&&(i._tr_stored_block(s,0,0,!1),3===t&&(w(s.head),0===s.lookahead&&(s.strstart=0,s.block_start=0,s.insert=0))),_(e),0===e.avail_out))return s.last_flush=-1,0}return 4!==t?0:s.wrap<=0?1:(2===s.wrap?(y(s,255&e.adler),y(s,e.adler>>8&255),y(s,e.adler>>16&255),y(s,e.adler>>24&255),y(s,255&e.total_in),y(s,e.total_in>>8&255),y(s,e.total_in>>16&255),y(s,e.total_in>>24&255)):(v(s,e.adler>>>16),v(s,65535&e.adler)),_(e),s.wrap>0&&(s.wrap=-s.wrap),0!==s.pending?0:1)},t.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==h&&t!==f&&t!==p?g(e,l):(e.state=null,t===f?g(e,-3):0):l},t.deflateSetDictionary=function(e,t){var n,a,i,o,c,d,u,h,f=t.length;if(!e||!e.state)return l;if(2===(o=(n=e.state).wrap)||1===o&&42!==n.status||n.lookahead)return l;for(1===o&&(e.adler=r(e.adler,t,f,0)),n.wrap=0,f>=n.w_size&&(0===o&&(w(n.head),n.strstart=0,n.block_start=0,n.insert=0),h=new s.Buf8(n.w_size),s.arraySet(h,t,f-n.w_size,n.w_size,0),t=h,f=n.w_size),c=e.avail_in,d=e.next_in,u=e.input,e.avail_in=f,e.next_in=0,e.input=t,k(n);n.lookahead>=3;){a=n.strstart,i=n.lookahead-2;do{n.ins_h=(n.ins_h<<n.hash_shift^n.window[a+3-1])&n.hash_mask,n.prev[a&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=a,a++}while(--i);n.strstart=a,n.lookahead=2,k(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=d,e.input=u,e.avail_in=c,n.wrap=o,0},t.deflateInfo="pako deflate (from Nodeca project)"},function(e,t,n){"use strict";var a=n(2),s=n(6),i=n(7),r=n(9),o=n(10),c=-2,l=12,d=30;function u(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function h(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new a.Buf16(320),this.work=new a.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function f(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new a.Buf32(852),t.distcode=t.distdyn=new a.Buf32(592),t.sane=1,t.back=-1,0):c}function p(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,f(e)):c}function g(e,t){var n,a;return e&&e.state?(a=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?c:(null!==a.window&&a.wbits!==t&&(a.window=null),a.wrap=n,a.wbits=t,p(e))):c}function m(e,t){var n,a;return e?(a=new h,e.state=a,a.window=null,0!==(n=g(e,t))&&(e.state=null),n):c}var w,_,b=!0;function y(e){if(b){var t;for(w=new a.Buf32(512),_=new a.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(1,e.lens,0,288,w,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(2,e.lens,0,32,_,0,e.work,{bits:5}),b=!1}e.lencode=w,e.lenbits=9,e.distcode=_,e.distbits=5}function v(e,t,n,s){var i,r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new a.Buf8(r.wsize)),s>=r.wsize?(a.arraySet(r.window,t,n-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):((i=r.wsize-r.wnext)>s&&(i=s),a.arraySet(r.window,t,n-s,i,r.wnext),(s-=i)?(a.arraySet(r.window,t,n-s,s,0),r.wnext=s,r.whave=r.wsize):(r.wnext+=i,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=i))),0}t.inflateReset=p,t.inflateReset2=g,t.inflateResetKeep=f,t.inflateInit=function(e){return m(e,15)},t.inflateInit2=m,t.inflate=function(e,t){var n,h,f,p,g,m,w,_,b,I,k,E,x,A,S,M,O,N,Z,T,L,R,P,C,U=0,F=new a.Buf8(4),D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return c;(n=e.state).mode===l&&(n.mode=13),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,I=m,k=w,R=0;e:for(;;)switch(n.mode){case 1:if(0===n.wrap){n.mode=13;break}for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(2&n.wrap&&35615===_){n.check=0,F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0),_=0,b=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&_)<<8)+(_>>8))%31){e.msg="incorrect header check",n.mode=d;break}if(8!=(15&_)){e.msg="unknown compression method",n.mode=d;break}if(b-=4,L=8+(15&(_>>>=4)),0===n.wbits)n.wbits=L;else if(L>n.wbits){e.msg="invalid window size",n.mode=d;break}n.dmax=1<<L,e.adler=n.check=1,n.mode=512&_?10:l,_=0,b=0;break;case 2:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.flags=_,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=d;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=d;break}n.head&&(n.head.text=_>>8&1),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0)),_=0,b=0,n.mode=3;case 3:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.time=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,F[2]=_>>>16&255,F[3]=_>>>24&255,n.check=i(n.check,F,4,0)),_=0,b=0,n.mode=4;case 4:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.xflags=255&_,n.head.os=_>>8),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0)),_=0,b=0,n.mode=5;case 5:if(1024&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length=_,n.head&&(n.head.extra_len=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0)),_=0,b=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((E=n.length)>m&&(E=m),E&&(n.head&&(L=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),a.arraySet(n.head.extra,h,p,E,L)),512&n.flags&&(n.check=i(n.check,h,E,p)),m-=E,p+=E,n.length-=E),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===m)break e;E=0;do{L=h[p+E++],n.head&&L&&n.length<65536&&(n.head.name+=String.fromCharCode(L))}while(L&&E<m);if(512&n.flags&&(n.check=i(n.check,h,E,p)),m-=E,p+=E,L)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===m)break e;E=0;do{L=h[p+E++],n.head&&L&&n.length<65536&&(n.head.comment+=String.fromCharCode(L))}while(L&&E<m);if(512&n.flags&&(n.check=i(n.check,h,E,p)),m-=E,p+=E,L)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(65535&n.check)){e.msg="header crc mismatch",n.mode=d;break}_=0,b=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=l;break;case 10:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}e.adler=n.check=u(_),_=0,b=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,2;e.adler=n.check=1,n.mode=l;case l:if(5===t||6===t)break e;case 13:if(n.last){_>>>=7&b,b-=7&b,n.mode=27;break}for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}switch(n.last=1&_,b-=1,3&(_>>>=1)){case 0:n.mode=14;break;case 1:if(y(n),n.mode=20,6===t){_>>>=2,b-=2;break e}break;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=d}_>>>=2,b-=2;break;case 14:for(_>>>=7&b,b-=7&b;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if((65535&_)!=(_>>>16^65535)){e.msg="invalid stored block lengths",n.mode=d;break}if(n.length=65535&_,_=0,b=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(E=n.length){if(E>m&&(E=m),E>w&&(E=w),0===E)break e;a.arraySet(f,h,p,E,g),m-=E,p+=E,w-=E,g+=E,n.length-=E;break}n.mode=l;break;case 17:for(;b<14;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.nlen=257+(31&_),_>>>=5,b-=5,n.ndist=1+(31&_),_>>>=5,b-=5,n.ncode=4+(15&_),_>>>=4,b-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=d;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.lens[D[n.have++]]=7&_,_>>>=3,b-=3}for(;n.have<19;)n.lens[D[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,P={bits:n.lenbits},R=o(0,n.lens,0,19,n.lencode,0,n.work,P),n.lenbits=P.bits,R){e.msg="invalid code lengths set",n.mode=d;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(O<16)_>>>=S,b-=S,n.lens[n.have++]=O;else{if(16===O){for(C=S+2;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_>>>=S,b-=S,0===n.have){e.msg="invalid bit length repeat",n.mode=d;break}L=n.lens[n.have-1],E=3+(3&_),_>>>=2,b-=2}else if(17===O){for(C=S+3;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,L=0,E=3+(7&(_>>>=S)),_>>>=3,b-=3}else{for(C=S+7;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,L=0,E=11+(127&(_>>>=S)),_>>>=7,b-=7}if(n.have+E>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=d;break}for(;E--;)n.lens[n.have++]=L}}if(n.mode===d)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=d;break}if(n.lenbits=9,P={bits:n.lenbits},R=o(1,n.lens,0,n.nlen,n.lencode,0,n.work,P),n.lenbits=P.bits,R){e.msg="invalid literal/lengths set",n.mode=d;break}if(n.distbits=6,n.distcode=n.distdyn,P={bits:n.distbits},R=o(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,P),n.distbits=P.bits,R){e.msg="invalid distances set",n.mode=d;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(m>=6&&w>=258){e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,r(e,k),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,n.mode===l&&(n.back=-1);break}for(n.back=0;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(M&&0==(240&M)){for(N=S,Z=M,T=O;M=(U=n.lencode[T+((_&(1<<N+Z)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,n.length=O,0===M){n.mode=26;break}if(32&M){n.back=-1,n.mode=l;break}if(64&M){e.msg="invalid literal/length code",n.mode=d;break}n.extra=15&M,n.mode=22;case 22:if(n.extra){for(C=n.extra;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;M=(U=n.distcode[_&(1<<n.distbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(0==(240&M)){for(N=S,Z=M,T=O;M=(U=n.distcode[T+((_&(1<<N+Z)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,64&M){e.msg="invalid distance code",n.mode=d;break}n.offset=O,n.extra=15&M,n.mode=24;case 24:if(n.extra){for(C=n.extra;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.offset+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=d;break}n.mode=25;case 25:if(0===w)break e;if(E=k-w,n.offset>E){if((E=n.offset-E)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=d;break}E>n.wnext?(E-=n.wnext,x=n.wsize-E):x=n.wnext-E,E>n.length&&(E=n.length),A=n.window}else A=f,x=g-n.offset,E=n.length;E>w&&(E=w),w-=E,n.length-=E;do{f[g++]=A[x++]}while(--E);0===n.length&&(n.mode=21);break;case 26:if(0===w)break e;f[g++]=n.length,w--,n.mode=21;break;case 27:if(n.wrap){for(;b<32;){if(0===m)break e;m--,_|=h[p++]<<b,b+=8}if(k-=w,e.total_out+=k,n.total+=k,k&&(e.adler=n.check=n.flags?i(n.check,f,k,g-k):s(n.check,f,k,g-k)),k=w,(n.flags?_:u(_))!==n.check){e.msg="incorrect data check",n.mode=d;break}_=0,b=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=d;break}_=0,b=0}n.mode=29;case 29:R=1;break e;case d:R=-3;break e;case 31:return-4;default:return c}return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,(n.wsize||k!==e.avail_out&&n.mode<d&&(n.mode<27||4!==t))&&v(e,e.output,e.next_out,k-e.avail_out)?(n.mode=31,-4):(I-=e.avail_in,k-=e.avail_out,e.total_in+=I,e.total_out+=k,n.total+=k,n.wrap&&k&&(e.adler=n.check=n.flags?i(n.check,f,k,e.next_out-k):s(n.check,f,k,e.next_out-k)),e.data_type=n.bits+(n.last?64:0)+(n.mode===l?128:0)+(20===n.mode||15===n.mode?256:0),(0===I&&0===k||4===t)&&0===R&&(R=-5),R)},t.inflateEnd=function(e){if(!e||!e.state)return c;var t=e.state;return t.window&&(t.window=null),e.state=null,0},t.inflateGetHeader=function(e,t){var n;return e&&e.state?0==(2&(n=e.state).wrap)?c:(n.head=t,t.done=!1,0):c},t.inflateSetDictionary=function(e,t){var n,a=t.length;return e&&e.state?0!==(n=e.state).wrap&&11!==n.mode?c:11===n.mode&&s(1,t,a,0)!==n.check?-3:v(e,t,a,a)?(n.mode=31,-4):(n.havedict=1,0):c},t.inflateInfo="pako inflate (from Nodeca project)"},function(e,t,n){"use strict";e.exports=function(e,t,n,a){for(var s=65535&e|0,i=e>>>16&65535|0,r=0;0!==n;){n-=r=n>2e3?2e3:n;do{i=i+(s=s+t[a++]|0)|0}while(--r);s%=65521,i%=65521}return s|i<<16|0}},function(e,t,n){"use strict";var a=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var a=0;a<8;a++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();e.exports=function(e,t,n,s){var i=a,r=s+n;e^=-1;for(var o=s;o<r;o++)e=e>>>8^i[255&(e^t[o])];return-1^e}},function(e,t,n){"use strict";var a=n(2);function s(e){for(var t=e.length;--t>=0;)e[t]=0}var i=256,r=286,o=30,c=15,l=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],d=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],h=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],f=new Array(576);s(f);var p=new Array(60);s(p);var g=new Array(512);s(g);var m=new Array(256);s(m);var w=new Array(29);s(w);var _,b,y,v=new Array(o);function I(e,t,n,a,s){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=a,this.max_length=s,this.has_stree=e&&e.length}function k(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function E(e){return e<256?g[e]:g[256+(e>>>7)]}function x(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function A(e,t,n){e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,x(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function S(e,t,n){A(e,n[2*t],n[2*t+1])}function M(e,t){var n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}function O(e,t,n){var a,s,i=new Array(16),r=0;for(a=1;a<=c;a++)i[a]=r=r+n[a-1]<<1;for(s=0;s<=t;s++){var o=e[2*s+1];0!==o&&(e[2*s]=M(i[o]++,o))}}function N(e){var t;for(t=0;t<r;t++)e.dyn_ltree[2*t]=0;for(t=0;t<o;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function Z(e){e.bi_valid>8?x(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function T(e,t,n,a){var s=2*t,i=2*n;return e[s]<e[i]||e[s]===e[i]&&a[t]<=a[n]}function L(e,t,n){for(var a=e.heap[n],s=n<<1;s<=e.heap_len&&(s<e.heap_len&&T(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!T(t,a,e.heap[s],e.depth));)e.heap[n]=e.heap[s],n=s,s<<=1;e.heap[n]=a}function R(e,t,n){var a,s,r,o,c=0;if(0!==e.last_lit)do{a=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],s=e.pending_buf[e.l_buf+c],c++,0===a?S(e,s,t):(S(e,(r=m[s])+i+1,t),0!==(o=l[r])&&A(e,s-=w[r],o),S(e,r=E(--a),n),0!==(o=d[r])&&A(e,a-=v[r],o))}while(c<e.last_lit);S(e,256,t)}function P(e,t){var n,a,s,i=t.dyn_tree,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,d=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<l;n++)0!==i[2*n]?(e.heap[++e.heap_len]=d=n,e.depth[n]=0):i[2*n+1]=0;for(;e.heap_len<2;)i[2*(s=e.heap[++e.heap_len]=d<2?++d:0)]=1,e.depth[s]=0,e.opt_len--,o&&(e.static_len-=r[2*s+1]);for(t.max_code=d,n=e.heap_len>>1;n>=1;n--)L(e,i,n);s=l;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],L(e,i,1),a=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=a,i[2*s]=i[2*n]+i[2*a],e.depth[s]=(e.depth[n]>=e.depth[a]?e.depth[n]:e.depth[a])+1,i[2*n+1]=i[2*a+1]=s,e.heap[1]=s++,L(e,i,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var n,a,s,i,r,o,l=t.dyn_tree,d=t.max_code,u=t.stat_desc.static_tree,h=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,g=t.stat_desc.max_length,m=0;for(i=0;i<=c;i++)e.bl_count[i]=0;for(l[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<573;n++)(i=l[2*l[2*(a=e.heap[n])+1]+1]+1)>g&&(i=g,m++),l[2*a+1]=i,a>d||(e.bl_count[i]++,r=0,a>=p&&(r=f[a-p]),o=l[2*a],e.opt_len+=o*(i+r),h&&(e.static_len+=o*(u[2*a+1]+r)));if(0!==m){do{for(i=g-1;0===e.bl_count[i];)i--;e.bl_count[i]--,e.bl_count[i+1]+=2,e.bl_count[g]--,m-=2}while(m>0);for(i=g;0!==i;i--)for(a=e.bl_count[i];0!==a;)(s=e.heap[--n])>d||(l[2*s+1]!==i&&(e.opt_len+=(i-l[2*s+1])*l[2*s],l[2*s+1]=i),a--)}}(e,t),O(i,d,e.bl_count)}function C(e,t,n){var a,s,i=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),t[2*(n+1)+1]=65535,a=0;a<=n;a++)s=r,r=t[2*(a+1)+1],++o<c&&s===r||(o<l?e.bl_tree[2*s]+=o:0!==s?(s!==i&&e.bl_tree[2*s]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,i=s,0===r?(c=138,l=3):s===r?(c=6,l=3):(c=7,l=4))}function U(e,t,n){var a,s,i=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),a=0;a<=n;a++)if(s=r,r=t[2*(a+1)+1],!(++o<c&&s===r)){if(o<l)do{S(e,s,e.bl_tree)}while(0!=--o);else 0!==s?(s!==i&&(S(e,s,e.bl_tree),o--),S(e,16,e.bl_tree),A(e,o-3,2)):o<=10?(S(e,17,e.bl_tree),A(e,o-3,3)):(S(e,18,e.bl_tree),A(e,o-11,7));o=0,i=s,0===r?(c=138,l=3):s===r?(c=6,l=3):(c=7,l=4)}}s(v);var F=!1;function D(e,t,n,s){A(e,0+(s?1:0),3),function(e,t,n,s){Z(e),x(e,n),x(e,~n),a.arraySet(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}(e,t,n)}t._tr_init=function(e){F||(function(){var e,t,n,a,s,i=new Array(16);for(n=0,a=0;a<28;a++)for(w[a]=n,e=0;e<1<<l[a];e++)m[n++]=a;for(m[n-1]=a,s=0,a=0;a<16;a++)for(v[a]=s,e=0;e<1<<d[a];e++)g[s++]=a;for(s>>=7;a<o;a++)for(v[a]=s<<7,e=0;e<1<<d[a]-7;e++)g[256+s++]=a;for(t=0;t<=c;t++)i[t]=0;for(e=0;e<=143;)f[2*e+1]=8,e++,i[8]++;for(;e<=255;)f[2*e+1]=9,e++,i[9]++;for(;e<=279;)f[2*e+1]=7,e++,i[7]++;for(;e<=287;)f[2*e+1]=8,e++,i[8]++;for(O(f,287,i),e=0;e<o;e++)p[2*e+1]=5,p[2*e]=M(e,5);_=new I(f,l,257,r,c),b=new I(p,d,0,o,c),y=new I(new Array(0),u,0,19,7)}(),F=!0),e.l_desc=new k(e.dyn_ltree,_),e.d_desc=new k(e.dyn_dtree,b),e.bl_desc=new k(e.bl_tree,y),e.bi_buf=0,e.bi_valid=0,N(e)},t._tr_stored_block=D,t._tr_flush_block=function(e,t,n,a){var s,r,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<i;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),P(e,e.l_desc),P(e,e.d_desc),o=function(e){var t;for(C(e,e.dyn_ltree,e.l_desc.max_code),C(e,e.dyn_dtree,e.d_desc.max_code),P(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*h[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),s=e.opt_len+3+7>>>3,(r=e.static_len+3+7>>>3)<=s&&(s=r)):s=r=n+5,n+4<=s&&-1!==t?D(e,t,n,a):4===e.strategy||r===s?(A(e,2+(a?1:0),3),R(e,f,p)):(A(e,4+(a?1:0),3),function(e,t,n,a){var s;for(A(e,t-257,5),A(e,n-1,5),A(e,a-4,4),s=0;s<a;s++)A(e,e.bl_tree[2*h[s]+1],3);U(e,e.dyn_ltree,t-1),U(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),R(e,e.dyn_ltree,e.dyn_dtree)),N(e),a&&Z(e)},t._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(m[n]+i+1)]++,e.dyn_dtree[2*E(t)]++),e.last_lit===e.lit_bufsize-1},t._tr_align=function(e){A(e,2,3),S(e,256,f),function(e){16===e.bi_valid?(x(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},function(e,t,n){"use strict";e.exports=function(e,t){var n,a,s,i,r,o,c,l,d,u,h,f,p,g,m,w,_,b,y,v,I,k,E,x,A;n=e.state,a=e.next_in,x=e.input,s=a+(e.avail_in-5),i=e.next_out,A=e.output,r=i-(t-e.avail_out),o=i+(e.avail_out-257),c=n.dmax,l=n.wsize,d=n.whave,u=n.wnext,h=n.window,f=n.hold,p=n.bits,g=n.lencode,m=n.distcode,w=(1<<n.lenbits)-1,_=(1<<n.distbits)-1;e:do{p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=g[f&w];t:for(;;){if(f>>>=y=b>>>24,p-=y,0==(y=b>>>16&255))A[i++]=65535&b;else{if(!(16&y)){if(0==(64&y)){b=g[(65535&b)+(f&(1<<y)-1)];continue t}if(32&y){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}v=65535&b,(y&=15)&&(p<y&&(f+=x[a++]<<p,p+=8),v+=f&(1<<y)-1,f>>>=y,p-=y),p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=m[f&_];n:for(;;){if(f>>>=y=b>>>24,p-=y,!(16&(y=b>>>16&255))){if(0==(64&y)){b=m[(65535&b)+(f&(1<<y)-1)];continue n}e.msg="invalid distance code",n.mode=30;break e}if(I=65535&b,p<(y&=15)&&(f+=x[a++]<<p,(p+=8)<y&&(f+=x[a++]<<p,p+=8)),(I+=f&(1<<y)-1)>c){e.msg="invalid distance too far back",n.mode=30;break e}if(f>>>=y,p-=y,I>(y=i-r)){if((y=I-y)>d&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(k=0,E=h,0===u){if(k+=l-y,y<v){v-=y;do{A[i++]=h[k++]}while(--y);k=i-I,E=A}}else if(u<y){if(k+=l+u-y,(y-=u)<v){v-=y;do{A[i++]=h[k++]}while(--y);if(k=0,u<v){v-=y=u;do{A[i++]=h[k++]}while(--y);k=i-I,E=A}}}else if(k+=u-y,y<v){v-=y;do{A[i++]=h[k++]}while(--y);k=i-I,E=A}for(;v>2;)A[i++]=E[k++],A[i++]=E[k++],A[i++]=E[k++],v-=3;v&&(A[i++]=E[k++],v>1&&(A[i++]=E[k++]))}else{k=i-I;do{A[i++]=A[k++],A[i++]=A[k++],A[i++]=A[k++],v-=3}while(v>2);v&&(A[i++]=A[k++],v>1&&(A[i++]=A[k++]))}break}}break}}while(a<s&&i<o);a-=v=p>>3,f&=(1<<(p-=v<<3))-1,e.next_in=a,e.next_out=i,e.avail_in=a<s?s-a+5:5-(a-s),e.avail_out=i<o?o-i+257:257-(i-o),n.hold=f,n.bits=p}},function(e,t,n){"use strict";var a=n(2),s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],i=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(e,t,n,c,l,d,u,h){var f,p,g,m,w,_,b,y,v,I=h.bits,k=0,E=0,x=0,A=0,S=0,M=0,O=0,N=0,Z=0,T=0,L=null,R=0,P=new a.Buf16(16),C=new a.Buf16(16),U=null,F=0;for(k=0;k<=15;k++)P[k]=0;for(E=0;E<c;E++)P[t[n+E]]++;for(S=I,A=15;A>=1&&0===P[A];A--);if(S>A&&(S=A),0===A)return l[d++]=20971520,l[d++]=20971520,h.bits=1,0;for(x=1;x<A&&0===P[x];x++);for(S<x&&(S=x),N=1,k=1;k<=15;k++)if(N<<=1,(N-=P[k])<0)return-1;if(N>0&&(0===e||1!==A))return-1;for(C[1]=0,k=1;k<15;k++)C[k+1]=C[k]+P[k];for(E=0;E<c;E++)0!==t[n+E]&&(u[C[t[n+E]]++]=E);if(0===e?(L=U=u,_=19):1===e?(L=s,R-=257,U=i,F-=257,_=256):(L=r,U=o,_=-1),T=0,E=0,k=x,w=d,M=S,O=0,g=-1,m=(Z=1<<S)-1,1===e&&Z>852||2===e&&Z>592)return 1;for(;;){b=k-O,u[E]<_?(y=0,v=u[E]):u[E]>_?(y=U[F+u[E]],v=L[R+u[E]]):(y=96,v=0),f=1<<k-O,x=p=1<<M;do{l[w+(T>>O)+(p-=f)]=b<<24|y<<16|v|0}while(0!==p);for(f=1<<k-1;T&f;)f>>=1;if(0!==f?(T&=f-1,T+=f):T=0,E++,0==--P[k]){if(k===A)break;k=t[n+u[E]]}if(k>S&&(T&m)!==g){for(0===O&&(O=S),w+=x,N=1<<(M=k-O);M+O<A&&!((N-=P[M+O])<=0);)M++,N<<=1;if(Z+=1<<M,1===e&&Z>852||2===e&&Z>592)return 1;l[g=T&m]=S<<24|M<<16|w-d|0}}return 0!==T&&(l[w+T]=k-O<<24|64<<16|0),h.bits=S,0}},function(e,t,n){"use strict";n.r(t);var a=n(3),s=n.n(a),i=n(4),r=n(5),o=n(1),c=n.n(o),l=n(0),d=16384;function u(e,t){var n=this;this.inflatedReady=e,this.deflatedReady=t,this._inflate=function(e){var t=new s.a,n=Object(r.inflateInit2)(t,15);if(n!==l.Z_OK)throw new Error("Problem initializing inflate stream: "+c.a[n]);return function(n){if(void 0===n)return e();var a,s,i;t.input=n,t.next_in=0,t.avail_in=t.input.length;var o=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(d),a=t.next_out=0,t.avail_out=d),(s=Object(r.inflate)(t,l.Z_NO_FLUSH))!==l.Z_STREAM_END&&s!==l.Z_OK)throw new Error("inflate problem: "+c.a[s]);t.next_out&&(0!==t.avail_out&&s!==l.Z_STREAM_END||(i=t.output.subarray(a,a=t.next_out),o=e(i)))}while(t.avail_in>0&&s!==l.Z_STREAM_END);return t.next_out>a&&(i=t.output.subarray(a,a=t.next_out),o=e(i)),o}}((function(e){return n.inflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length))})),this._deflate=function(e){var t=new s.a,n=Object(i.deflateInit2)(t,l.Z_DEFAULT_COMPRESSION,l.Z_DEFLATED,15,8,l.Z_DEFAULT_STRATEGY);if(n!==l.Z_OK)throw new Error("Problem initializing deflate stream: "+c.a[n]);return function(n){if(void 0===n)return e();var a,s,r;t.input=n,t.next_in=0,t.avail_in=t.input.length;var o=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(d),r=t.next_out=0,t.avail_out=d),(a=Object(i.deflate)(t,l.Z_SYNC_FLUSH))!==l.Z_STREAM_END&&a!==l.Z_OK)throw new Error("Deflate problem: "+c.a[a]);0===t.avail_out&&t.next_out>r&&(s=t.output.subarray(r,r=t.next_out),o=e(s))}while((t.avail_in>0||0===t.avail_out)&&a!==l.Z_STREAM_END);return t.next_out>r&&(s=t.output.subarray(r,r=t.next_out),o=e(s)),o}}((function(e){return n.deflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length))}))}u.prototype.inflate=function(e){this._inflate(new Uint8Array(e))},u.prototype.deflate=function(e){this._deflate(new Uint8Array(e))};var h=function(e,t){return{message:e,buffer:t}},f=new u((function(e){return self.postMessage(h("inflated_ready",e),[e])}),(function(e){return self.postMessage(h("deflated_ready",e),[e])}));self.onmessage=function(e){var t=e.data.message,n=e.data.buffer;switch(t){case"start":break;case"inflate":f.inflate(n);break;case"deflate":f.deflate(n)}}}])},9673:(e,t,n)=>{"use strict";function a(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function s(e){return function t(n){return 0===arguments.length||a(n)?t:e.apply(this,arguments)}}function i(e){return function t(n,i){switch(arguments.length){case 0:return t;case 1:return a(n)?t:s((function(t){return e(n,t)}));default:return a(n)&&a(i)?t:a(n)?s((function(t){return e(t,i)})):a(i)?s((function(t){return e(n,t)})):e(n,i)}}}function r(e){return function t(n,r,o){switch(arguments.length){case 0:return t;case 1:return a(n)?t:i((function(t,a){return e(n,t,a)}));case 2:return a(n)&&a(r)?t:a(n)?i((function(t,n){return e(t,r,n)})):a(r)?i((function(t,a){return e(n,t,a)})):s((function(t){return e(n,r,t)}));default:return a(n)&&a(r)&&a(o)?t:a(n)&&a(r)?i((function(t,n){return e(t,n,o)})):a(n)&&a(o)?i((function(t,n){return e(t,r,n)})):a(r)&&a(o)?i((function(t,a){return e(n,t,a)})):a(n)?s((function(t){return e(t,r,o)})):a(r)?s((function(t){return e(n,t,o)})):a(o)?s((function(t){return e(n,r,t)})):e(n,r,o)}}}n.d(t,{ZP:()=>At});const o=i((function(e,t){return null==t||t!=t?e:t}));const c=i((function(e,t){for(var n=t,a=0;a<e.length;){if(null==n)return;n=n[e[a]],a+=1}return n}));const l=r((function(e,t,n){return o(e,c(t,n))}));const d=r((function(e,t,n){return l(e,[t],n)})),u=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function h(e){return"[object String]"===Object.prototype.toString.call(e)}const f=s((function(e){return!!u(e)||!!e&&("object"==typeof e&&(!h(e)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))}));function p(e){return function t(n){for(var a,s,i,r=[],o=0,c=n.length;o<c;){if(f(n[o]))for(i=0,s=(a=e?t(n[o]):n[o]).length;i<s;)r[r.length]=a[i],i+=1;else r[r.length]=n[o];o+=1}return r}}const g=s(p(!0));const m=s((function(e){for(var t={},n=0;n<e.length;)t[e[n][0]]=e[n][1],n+=1;return t}));const w=i((function(e,t){for(var n=[],a=0,s=Math.min(e.length,t.length);a<s;)n[a]=[e[a],t[a]],a+=1;return n}));function _(e,t){var n;t=t||[];var a=(e=e||[]).length,s=t.length,i=[];for(n=0;n<a;)i[i.length]=e[n],n+=1;for(n=0;n<s;)i[i.length]=t[n],n+=1;return i}function b(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,a){return t.apply(this,arguments)};case 4:return function(e,n,a,s){return t.apply(this,arguments)};case 5:return function(e,n,a,s,i){return t.apply(this,arguments)};case 6:return function(e,n,a,s,i,r){return t.apply(this,arguments)};case 7:return function(e,n,a,s,i,r,o){return t.apply(this,arguments)};case 8:return function(e,n,a,s,i,r,o,c){return t.apply(this,arguments)};case 9:return function(e,n,a,s,i,r,o,c,l){return t.apply(this,arguments)};case 10:return function(e,n,a,s,i,r,o,c,l,d){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function y(e,t){return function(){return t.call(this,e.apply(this,arguments))}}var v=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();const I=i((function(e,t){return b(e.length,(function(){return e.apply(t,arguments)}))}));function k(e,t,n){for(var a=n.next();!a.done;){if((t=e["@@transducer/step"](t,a.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}a=n.next()}return e["@@transducer/result"](t)}function E(e,t,n,a){return e["@@transducer/result"](n[a](I(e["@@transducer/step"],e),t))}var x="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function A(e,t,n){if("function"==typeof e&&(e=function(e){return new v(e)}(e)),f(n))return function(e,t,n){for(var a=0,s=n.length;a<s;){if((t=e["@@transducer/step"](t,n[a]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}a+=1}return e["@@transducer/result"](t)}(e,t,n);if("function"==typeof n["fantasy-land/reduce"])return E(e,t,n,"fantasy-land/reduce");if(null!=n[x])return k(e,t,n[x]());if("function"==typeof n.next)return k(e,t,n);if("function"==typeof n.reduce)return E(e,t,n,"reduce");throw new TypeError("reduce: list must be array or iterable")}const S=r(A);function M(e,t){return function(){var n=arguments.length;if(0===n)return t();var a=arguments[n-1];return u(a)||"function"!=typeof a[e]?t.apply(this,arguments):a[e].apply(a,Array.prototype.slice.call(arguments,0,n-1))}}const O=s(M("tail",r(M("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)})))(1,1/0)));function N(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return b(arguments[0].length,S(y,arguments[0],O(arguments)))}const Z=s((function(e){return h(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()}));function T(){if(0===arguments.length)throw new Error("compose requires at least one argument");return N.apply(this,Z(arguments))}function L(e){return e}const R=s(L);function P(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function C(e,t,n){for(var a=0,s=n.length;a<s;){if(e(t,n[a]))return!0;a+=1}return!1}function U(e,t){return Object.prototype.hasOwnProperty.call(t,e)}const F="function"==typeof Object.is?Object.is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t};var D=Object.prototype.toString;const z=function(){return"[object Arguments]"===D.call(arguments)?function(e){return"[object Arguments]"===D.call(e)}:function(e){return U("callee",e)}}();var B=!{toString:null}.propertyIsEnumerable("toString"),$=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],j=function(){return arguments.propertyIsEnumerable("length")}(),V=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1},q="function"!=typeof Object.keys||j?s((function(e){if(Object(e)!==e)return[];var t,n,a=[],s=j&&z(e);for(t in e)!U(t,e)||s&&"length"===t||(a[a.length]=t);if(B)for(n=$.length-1;n>=0;)U(t=$[n],e)&&!V(a,t)&&(a[a.length]=t),n-=1;return a})):s((function(e){return Object(e)!==e?[]:Object.keys(e)}));const Q=q;const H=s((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function K(e,t,n,a){var s=P(e);function i(e,t){return W(e,t,n.slice(),a.slice())}return!C((function(e,t){return!C(i,t,e)}),P(t),s)}function W(e,t,n,a){if(F(e,t))return!0;var s,i,r=H(e);if(r!==H(t))return!1;if(null==e||null==t)return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(r){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===(s=e.constructor,null==(i=String(s).match(/^function (\w*)/))?"":i[1]))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!F(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!F(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var o=n.length-1;o>=0;){if(n[o]===e)return a[o]===t;o-=1}switch(r){case"Map":return e.size===t.size&&K(e.entries(),t.entries(),n.concat([e]),a.concat([t]));case"Set":return e.size===t.size&&K(e.values(),t.values(),n.concat([e]),a.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var c=Q(e);if(c.length!==Q(t).length)return!1;var l=n.concat([e]),d=a.concat([t]);for(o=c.length-1;o>=0;){var u=c[o];if(!U(u,t)||!W(t[u],e[u],l,d))return!1;o-=1}return!0}const G=i((function(e,t){return W(e,t,[],[])}));function X(e,t){return function(e,t,n){var a,s;if("function"==typeof e.indexOf)switch(typeof t){case"number":if(0===t){for(a=1/t;n<e.length;){if(0===(s=e[n])&&1/s===a)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(s=e[n])&&s!=s)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(G(e[n],t))return n;n+=1}return-1}(t,e,0)>=0}function Y(e,t,n){var a,s=typeof e;switch(s){case"string":case"number":return 0===e&&1/e==-1/0?!!n._items["-0"]||(t&&(n._items["-0"]=!0),!1):null!==n._nativeSet?t?(a=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===a):n._nativeSet.has(e):s in n._items?e in n._items[s]||(t&&(n._items[s][e]=!0),!1):(t&&(n._items[s]={},n._items[s][e]=!0),!1);case"boolean":if(s in n._items){var i=e?1:0;return!!n._items[s][i]||(t&&(n._items[s][i]=!0),!1)}return t&&(n._items[s]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==n._nativeSet?t?(a=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===a):n._nativeSet.has(e):s in n._items?!!X(e,n._items[s])||(t&&n._items[s].push(e),!1):(t&&(n._items[s]=[e]),!1);case"undefined":return!!n._items[s]||(t&&(n._items[s]=!0),!1);case"object":if(null===e)return!!n._items.null||(t&&(n._items.null=!0),!1);default:return(s=Object.prototype.toString.call(e))in n._items?!!X(e,n._items[s])||(t&&n._items[s].push(e),!1):(t&&(n._items[s]=[e]),!1)}}const J=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!Y(e,!0,this)},e.prototype.has=function(e){return Y(e,!1,this)},e}();const ee=i(T(i((function(e,t){for(var n,a,s=new J,i=[],r=0;r<t.length;)n=e(a=t[r]),s.add(n)&&i.push(a),r+=1;return i}))(R),_));function te(e){return null!=e&&"function"==typeof e["@@transducer/step"]}function ne(e,t,n){return function(){if(0===arguments.length)return n();var a=Array.prototype.slice.call(arguments,0),s=a.pop();if(!u(s)){for(var i=0;i<e.length;){if("function"==typeof s[e[i]])return s[e[i]].apply(s,a);i+=1}if(te(s)){var r=t.apply(null,a);return r(s)}}return n.apply(this,arguments)}}function ae(e,t){for(var n=0,a=t.length,s=Array(a);n<a;)s[n]=e(t[n]),n+=1;return s}const se=function(){return this.xf["@@transducer/init"]()},ie=function(e){return this.xf["@@transducer/result"](e)};var re=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=se,e.prototype["@@transducer/result"]=ie,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}();const oe=i((function(e,t){return new re(e,t)}));function ce(e,t,n){return function(){for(var s=[],i=0,r=e,o=0;o<t.length||i<arguments.length;){var c;o<t.length&&(!a(t[o])||i>=arguments.length)?c=t[o]:(c=arguments[i],i+=1),s[o]=c,a(c)||(r-=1),o+=1}return r<=0?n.apply(this,s):b(r,ce(e,s,n))}}const le=i((function(e,t){return 1===e?s(t):b(e,ce(e,[],t))}));const de=i(ne(["fantasy-land/map","map"],oe,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return le(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return A((function(n,a){return n[a]=e(t[a]),n}),{},Q(t));default:return ae(e,t)}})));var ue=n(83065),he=n(84846);const fe=32,pe=93,ge=e=>(e=>e>=1&&e<=127)(e)&&!me(e),me=e=>40===e||41===e||123===e||e===fe||we(e)||_e(e)||be(e)||ye(e),we=e=>e>=0&&e<=31||127===e,_e=e=>37===e||42===e,be=e=>34===e||92===e,ye=e=>e===pe,ve=e=>e>=48&&e<=57,Ie=e=>(e=>e>=65&&e<=90||e>=97&&e<=122)(e)||ve(e),ke=e=>ge(e)||ye(e);function Ee(e,t,n){let a=[],s=(e.tag||"")+(e.command?" "+e.command:""),i=!0,r=function(e){if(s.length>0&&i&&(s+=" "),Array.isArray(e))return i=!1,s+="(",e.forEach(r),void(s+=")");if(i=!0,e||"string"==typeof e||"number"==typeof e)if("string"!=typeof e)if("number"!=typeof e)if(n&&e.sensitive)s+='"(* value hidden *)"';else switch(e.type.toUpperCase()){case"LITERAL":n?s+='"(* '+e.value.length+'B literal *)"':(e.value?s+="{"+e.value.length+"}\r\n":s+="{0}\r\n",a.push(s),s=e.value||"");break;case"STRING":n&&e.value.length>20?s+='"(* '+e.value.length+'B string *)"':s+=JSON.stringify(e.value||"");break;case"TEXT":case"SEQUENCE":s+=e.value||"";break;case"NUMBER":s+=e.value||0;break;case"ATOM":case"SECTION":let t=e.value||"";for(let e=92===t.charCodeAt(0)?1:0;e<t.length;e++)if(!ge(t.charCodeAt(e))){t=JSON.stringify(t);break}s+=t,e.section&&(s+="[",e.section.length&&(i=!1,e.section.forEach(r)),s+="]"),e.partial&&(s+="<"+e.partial.join(".")+">")}else s+=Math.round(e)||0;else n&&e.length>20?s+='"(* '+e.length+'B string *)"':s+=JSON.stringify(e);else s+="NIL"};return[].concat(e.attributes||[]).forEach(r),s.length&&a.push(s),t?a:a.join("")}function xe(e){return"[object Function]"===Object.prototype.toString.call(e)}function Ae(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var Se=function(e){return(e<10?"0":"")+e};const Me="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+Se(e.getUTCMonth()+1)+"-"+Se(e.getUTCDate())+"T"+Se(e.getUTCHours())+":"+Se(e.getUTCMinutes())+":"+Se(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};var Oe=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=se,e.prototype["@@transducer/result"]=ie,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}();const Ne=i(ne(["filter"],i((function(e,t){return new Oe(e,t)})),(function(e,t){return n=t,"[object Object]"===Object.prototype.toString.call(n)?A((function(n,a){return e(t[a])&&(n[a]=t[a]),n}),{},Q(t)):function(e,t){for(var n=0,a=t.length,s=[];n<a;)e(t[n])&&(s[s.length]=t[n]),n+=1;return s}(e,t);var n})));const Ze=i((function(e,t){return Ne((n=e,function(){return!n.apply(this,arguments)}),t);var n}));function Te(e,t){var n=function(n){var a=t.concat([e]);return X(n,a)?"<Circular>":Te(n,a)},a=function(e,t){return ae((function(t){return Ae(t)+": "+n(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(e)){case"[object Arguments]":return"(function() { return arguments; }("+ae(n,e).join(", ")+"))";case"[object Array]":return"["+ae(n,e).concat(a(e,Ze((function(e){return/^\d+$/.test(e)}),Q(e)))).join(", ")+"]";case"[object Boolean]":return"object"==typeof e?"new Boolean("+n(e.valueOf())+")":e.toString();case"[object Date]":return"new Date("+(isNaN(e.valueOf())?n(NaN):Ae(Me(e)))+")";case"[object Null]":return"null";case"[object Number]":return"object"==typeof e?"new Number("+n(e.valueOf())+")":1/e==-1/0?"-0":e.toString(10);case"[object String]":return"object"==typeof e?"new String("+n(e.valueOf())+")":Ae(e);case"[object Undefined]":return"undefined";default:if("function"==typeof e.toString){var s=e.toString();if("[object Object]"!==s)return s}return"{"+a(e,Q(e)).join(", ")+"}"}}const Le=s((function(e){return Te(e,[])}));const Re=i((function(e,t){return le(e+1,(function(){var n=arguments[e];if(null!=n&&xe(n[t]))return n[t].apply(n,Array.prototype.slice.call(arguments,0,e));throw new TypeError(Le(n)+' does not have a method named "'+t+'"')}))}))(0,"toLowerCase");const Pe=i((function(e,t){return c([e],t)}));var Ce=n(85834);function Ue(e){return!!e&&(e=[].concat(e||[])).map((e=>!(!e||!e.length)&&{prefix:e[0].value,delimiter:e[1]&&e[1].value}))}function Fe(e){const t={};return e[0]&&e[0].value&&(t.date=e[0].value),e[1]&&e[1].value&&(t.subject=(0,Ce.Mf)(e[1]&&e[1].value)),e[2]&&e[2].length&&(t.from=De(e[2])),e[3]&&e[3].length&&(t.sender=De(e[3])),e[4]&&e[4].length&&(t["reply-to"]=De(e[4])),e[5]&&e[5].length&&(t.to=De(e[5])),e[6]&&e[6].length&&(t.cc=De(e[6])),e[7]&&e[7].length&&(t.bcc=De(e[7])),e[8]&&e[8].value&&(t["in-reply-to"]=e[8].value),e[9]&&e[9].value&&(t["message-id"]=e[9].value),t}function De(e=[]){return e.map((e=>{const t=l("",["0","value"],e).trim(),n=l("",["2","value"],e)+"@"+l("",["3","value"],e),a=t?function(e){if(!/^[\w ']*$/.test(e))return/^[\x20-\x7e]*$/.test(e)?JSON.stringify(e):(0,Ce.KR)(e,"Q",52);return e}(t)+" <"+n+">":n,s=(0,he.Z)(a).shift();return s.name=(0,Ce.Mf)(s.name),s}))}function ze(e,t=[]){const n={};let a=0,s=0;if(t.length&&(n.part=t.join(".")),Array.isArray(e[0])){for(n.childNodes=[];Array.isArray(e[a]);)n.childNodes.push(ze(e[a],t.concat(++s))),a++;n.type="multipart/"+((e[a++]||{}).value||"").toString().toLowerCase(),a<e.length-1&&(e[a]&&(n.parameters=Be(e[a])),a++)}else n.type=[((e[a++]||{}).value||"").toString().toLowerCase(),((e[a++]||{}).value||"").toString().toLowerCase()].join("/"),e[a]&&(n.parameters=Be(e[a])),a++,e[a]&&(n.id=((e[a]||{}).value||"").toString()),a++,e[a]&&(n.description=((e[a]||{}).value||"").toString()),a++,e[a]&&(n.encoding=((e[a]||{}).value||"").toString().toLowerCase()),a++,e[a]&&(n.size=Number((e[a]||{}).value||0)||0),a++,"message/rfc822"===n.type?(e[a]&&(n.envelope=Fe([].concat(e[a]||[]))),a++,e[a]&&(n.childNodes=[ze(e[a],t)]),a++,e[a]&&(n.lineCount=Number((e[a]||{}).value||0)||0),a++):/^text\//.test(n.type)&&(e[a]&&(n.lineCount=Number((e[a]||{}).value||0)||0),a++),a<e.length-1&&(e[a]&&(n.md5=((e[a]||{}).value||"").toString().toLowerCase()),a++);return a<e.length-1&&(Array.isArray(e[a])&&e[a].length&&(n.disposition=((e[a][0]||{}).value||"").toString().toLowerCase(),Array.isArray(e[a][1])&&(n.dispositionParameters=Be(e[a][1]))),a++),a<e.length-1&&(e[a]&&(n.language=[].concat(e[a]).map((e=>d("","value",e).toLowerCase()))),a++),a<e.length-1&&(e[a]&&(n.location=((e[a]||{}).value||"").toString()),a++),n}function Be(e=[],t=Re,n=Ce.Mf){const a=e.map(Pe("value")),s=a.filter(((e,t)=>t%2==0)).map(t),i=a.filter(((e,t)=>t%2==1)).map(n);return m(w(s,i))}function $e(e){if(!(e&&e.payload&&e.payload.FETCH&&e.payload.FETCH.length))return[];const t=[],n={};return e.payload.FETCH.forEach((e=>{const a=[].concat([].concat(e.attributes||[])[0]||[]);let s,i,r,o;for(n[e.nr]?s=n[e.nr]:(n[e.nr]=s={"#":e.nr},t.push(s)),i=0,r=a.length;i<r;i++)i%2!=0?s[o]=je(o,a[i]):o=Ee({attributes:[a[i]]}).toLowerCase().replace(/<\d+>$/,"")})),t}function je(e,t){if(!t)return null;if(!Array.isArray(t)){switch(e){case"uid":case"rfc822.size":return Number(t.value)||0;case"modseq":return t.value||"0"}return t.value}switch(e){case"flags":case"x-gm-labels":t=[].concat(t).map((e=>e.value||""));break;case"envelope":t=Fe([].concat(t||[]));break;case"bodystructure":t=ze([].concat(t||[]));break;case"modseq":t=(t.shift()||{}).value||"0"}return t}function Ve(e){for(var t=[],n=0;n<e.length;n+=10240){const a=n,s=Math.min(n+10240,e.length);t.push(String.fromCharCode.apply(null,e.subarray(a,s)))}return t.join("")}function qe(e){let t=0,n=e.length;for(;e[t]===fe;)t++;for(;e[n-1]===fe;)n--;return 0===t&&n===e.length||(e=e.subarray(t,n)),Ve(e)}class Qe{constructor(e,t){this.remainder=new Uint8Array(e||0),this.options=t||{},this.pos=0}getTag(){if(!this.tag){const e=e=>(e=>ke(e)&&43!==e)(e)||42===e||43===e;this.tag=this.getElement(e)}return this.tag}getCommand(){switch(this.command||(this.command=this.getElement(Ie)),(this.command||"").toString().toUpperCase()){case"OK":case"NO":case"BAD":case"PREAUTH":case"BYE":let e=this.remainder.lastIndexOf(pe);91===this.remainder[1]&&e>1?(this.humanReadable=qe(this.remainder.subarray(e+1)),this.remainder=this.remainder.subarray(0,e+1)):(this.humanReadable=qe(this.remainder),this.remainder=new Uint8Array(0))}return this.command}getElement(e){let t;if(this.remainder[0]===fe)throw new Error("Unexpected whitespace at position "+this.pos);let n=this.remainder.indexOf(fe);if(!(this.remainder.length>0&&0!==n))throw new Error("Unexpected end of input at position "+this.pos);t=-1===n?this.remainder:this.remainder.subarray(0,n);for(let n=0;n<t.length;n++)if(!e(t[n]))throw new Error("Unexpected char at position "+(this.pos+n));return this.pos+=t.length,this.remainder=this.remainder.subarray(t.length),Ve(t)}getSpace(){if(!this.remainder.length)throw new Error("Unexpected end of input at position "+this.pos);if(this.remainder[0]!==fe)throw new Error("Unexpected char at position "+this.pos);this.pos++,this.remainder=this.remainder.subarray(1)}getAttributes(){if(!this.remainder.length)throw new Error("Unexpected end of input at position "+this.pos);if(this.remainder[0]===fe)throw new Error("Unexpected whitespace at position "+this.pos);return new Ke(this,this.pos,this.remainder.subarray(),this.options).getAttributes()}}class He{constructor(e,t,n){this.uint8Array=e,this.childNodes=[],this.type=!1,this.closed=!0,this.valueSkip=[],this.startPos=n,this.valueStart=this.valueEnd="number"==typeof n?n+1:0,t&&(this.parentNode=t,t.childNodes.push(this))}getValue(){let e=Ve(this.getValueArray());return this.valueToUpperCase?e.toUpperCase():e}getValueLength(){return this.valueEnd-this.valueStart-this.valueSkip.length}getValueArray(){const e=this.uint8Array.subarray(this.valueStart,this.valueEnd);if(0===this.valueSkip.length)return e;let t=new Uint8Array(e.length-this.valueSkip.length),n=0,a=0,s=this.valueSkip.slice();return s.push(e.length),s.forEach((function(s){if(s>n){var i=e.subarray(n,s);t.set(i,a),a+=i.length}n=s+1})),t}equals(e,t){return this.getValueLength()===e.length&&this.equalsAt(e,0,t)}equalsAt(e,t,n){if(n="boolean"!=typeof n||n,t<0)for(t=this.valueEnd+t;this.valueSkip.indexOf(this.valueStart+t)>=0;)t--;else t=this.valueStart+t;for(let a=0;a<e.length;a++){for(;this.valueSkip.indexOf(t-this.valueStart)>=0;)t++;if(t>=this.valueEnd)return!1;let s=String.fromCharCode(this.uint8Array[t]),i=e[a];if(n||(s=s.toUpperCase(),i=i.toUpperCase()),s!==i)return!1;t++}return!0}isNumber(){for(let e=0;e<this.valueEnd-this.valueStart;e++)if(!(this.valueSkip.indexOf(e)>=0||this.isDigit(e)))return!1;return!0}isDigit(e){if(e<0)for(e=this.valueEnd+e;this.valueSkip.indexOf(this.valueStart+e)>=0;)e--;else for(e=this.valueStart+e;this.valueSkip.indexOf(this.valueStart+e)>=0;)e++;return ve(this.uint8Array[e])}containsChar(e){let t=e.charCodeAt(0);for(let e=this.valueStart;e<this.valueEnd;e++)if(!(this.valueSkip.indexOf(e-this.valueStart)>=0)&&this.uint8Array[e]===t)return!0;return!1}}class Ke{constructor(e,t,n,a={}){this.uint8Array=n,this.options=a,this.parent=e,this.tree=this.currentNode=this.createNode(),this.pos=t||0,this.currentNode.type="TREE",this.state="NORMAL",void 0===this.options.valueAsString&&(this.options.valueAsString=!0),this.processString()}getAttributes(){let e=[],t=e,n=e=>{let a,s,i=t;if(!e.closed&&"SEQUENCE"===e.type&&e.equals("*")&&(e.closed=!0,e.type="ATOM"),!e.closed)throw new Error("Unexpected end of input at position "+(this.pos+this.uint8Array.length-1));switch(e.type.toUpperCase()){case"LITERAL":case"STRING":a={type:e.type.toUpperCase(),value:this.options.valueAsString?e.getValue():e.getValueArray()},t.push(a);break;case"SEQUENCE":a={type:e.type.toUpperCase(),value:e.getValue()},t.push(a);break;case"ATOM":if(e.equals("NIL",!0)){t.push(null);break}a={type:e.type.toUpperCase(),value:e.getValue()},t.push(a);break;case"SECTION":t=t[t.length-1].section=[];break;case"LIST":a=[],t.push(a),t=a;break;case"PARTIAL":s=e.getValue().split(".").map(Number),t[t.length-1].partial=s}e.childNodes.forEach((function(e){n(e)})),t=i};return n(this.tree),e}createNode(e,t){return new He(this.uint8Array,e,t)}processString(){let e,t;const n=t=>{for(;this.uint8Array[e+1]===fe;)e++};for(e=0,t=this.uint8Array.length;e<t;e++){let a=this.uint8Array[e];switch(this.state){case"NORMAL":switch(a){case 34:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="string",this.state="STRING",this.currentNode.closed=!1;break;case 40:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="LIST",this.currentNode.closed=!1;break;case 41:if("LIST"!==this.currentNode.type)throw new Error("Unexpected list terminator ) at position "+(this.pos+e));this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,n();break;case pe:if("SECTION"!==this.currentNode.type)throw new Error("Unexpected section terminator ] at position "+(this.pos+e));this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,n();break;case 60:this.uint8Array[e-1]!==pe?(this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="ATOM",this.currentNode.valueStart=e,this.currentNode.valueEnd=e+1,this.state="ATOM"):(this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="PARTIAL",this.state="PARTIAL",this.currentNode.closed=!1);break;case 123:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="LITERAL",this.state="LITERAL",this.currentNode.closed=!1;break;case 42:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="SEQUENCE",this.currentNode.valueStart=e,this.currentNode.valueEnd=e+1,this.currentNode.closed=!1,this.state="SEQUENCE";break;case fe:case 126:break;case 91:if(["OK","NO","BAD","BYE","PREAUTH"].indexOf(this.parent.command.toUpperCase())>=0&&this.currentNode===this.tree){this.currentNode.endPos=this.pos+e,this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="ATOM",this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="SECTION",this.currentNode.closed=!1,this.state="NORMAL","REFERRAL "===Ve(this.uint8Array.subarray(e+1,e+10)).toUpperCase()&&(this.currentNode=this.createNode(this.currentNode,this.pos+e+1),this.currentNode.type="ATOM",this.currentNode.endPos=this.pos+e+8,this.currentNode.valueStart=e+1,this.currentNode.valueEnd=e+9,this.currentNode.valueToUpperCase=!0,this.currentNode=this.currentNode.parentNode,this.currentNode=this.createNode(this.currentNode,this.pos+e+10),this.currentNode.type="ATOM",e=this.uint8Array.indexOf(pe,e+10),this.currentNode.endPos=this.pos+e-1,this.currentNode.valueStart=this.currentNode.startPos-this.pos,this.currentNode.valueEnd=this.currentNode.endPos-this.pos+1,this.currentNode=this.currentNode.parentNode,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,n());break}default:if(!ge(a)&&92!==a&&37!==a)throw new Error("Unexpected char at position "+(this.pos+e));this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="ATOM",this.currentNode.valueStart=e,this.currentNode.valueEnd=e+1,this.state="ATOM"}break;case"ATOM":if(a===fe){this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.state="NORMAL";break}if(this.currentNode.parentNode&&(41===a&&"LIST"===this.currentNode.parentNode.type||a===pe&&"SECTION"===this.currentNode.parentNode.type)){this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(44!==a&&58!==a||!this.currentNode.isNumber()||(this.currentNode.type="SEQUENCE",this.currentNode.closed=!0,this.state="SEQUENCE"),91===a&&(this.currentNode.equals("BODY",!1)||this.currentNode.equals("BODY.PEEK",!1))){this.currentNode.endPos=this.pos+e,this.currentNode=this.createNode(this.currentNode.parentNode,this.pos+e),this.currentNode.type="SECTION",this.currentNode.closed=!1,this.state="NORMAL";break}if(60===a)throw new Error("Unexpected start of partial at position "+this.pos);if(!(ge(a)||a===pe||42===a&&this.currentNode.equals("\\")))throw new Error("Unexpected char at position "+(this.pos+e));if(this.currentNode.equals("\\*"))throw new Error("Unexpected char at position "+(this.pos+e));this.currentNode.valueEnd=e+1;break;case"STRING":if(34===a){this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(92===a){if(this.currentNode.valueSkip.push(e-this.currentNode.valueStart),e++,e>=t)throw new Error("Unexpected end of input at position "+(this.pos+e));a=this.uint8Array[e]}this.currentNode.valueEnd=e+1;break;case"PARTIAL":if(62===a){if(this.currentNode.equalsAt(".",-1))throw new Error("Unexpected end of partial at position "+this.pos);this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(46===a&&(!this.currentNode.getValueLength()||this.currentNode.containsChar(".")))throw new Error("Unexpected partial separator . at position "+this.pos);if(!ve(a)&&46!==a)throw new Error("Unexpected char at position "+(this.pos+e));if(46!==a&&(this.currentNode.equals("0")||this.currentNode.equalsAt(".0",-2)))throw new Error("Invalid partial at position "+(this.pos+e));this.currentNode.valueEnd=e+1;break;case"LITERAL":if(this.currentNode.started){this.currentNode.valueEnd=e+1,this.currentNode.getValueLength()>=this.currentNode.literalLength&&(this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n());break}if(43===a){this.currentNode.literalPlus=!0;break}if(125===a){if(!("literalLength"in this.currentNode))throw new Error("Unexpected literal prefix end char } at position "+(this.pos+e));if(10===this.uint8Array[e+1])e++;else{if(13!==this.uint8Array[e+1]||10!==this.uint8Array[e+2])throw new Error("Unexpected char at position "+(this.pos+e));e+=2}this.currentNode.valueStart=e+1,this.currentNode.literalLength=Number(this.currentNode.literalLength),this.currentNode.started=!0,this.currentNode.literalLength||(this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n());break}if(!ve(a))throw new Error("Unexpected char at position "+(this.pos+e));if("0"===this.currentNode.literalLength)throw new Error("Invalid literal at position "+(this.pos+e));this.currentNode.literalLength=(this.currentNode.literalLength||"")+String.fromCharCode(a);break;case"SEQUENCE":if(a===fe){if(!this.currentNode.isDigit(-1)&&!this.currentNode.equalsAt("*",-1))throw new Error("Unexpected whitespace at position "+(this.pos+e));if(this.currentNode.equalsAt("*",-1)&&!this.currentNode.equalsAt(":",-2))throw new Error("Unexpected whitespace at position "+(this.pos+e));this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.state="NORMAL";break}if(this.currentNode.parentNode&&a===pe&&"SECTION"===this.currentNode.parentNode.type){this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(58===a){if(!this.currentNode.isDigit(-1)&&!this.currentNode.equalsAt("*",-1))throw new Error("Unexpected range separator : at position "+(this.pos+e))}else if(42===a){if(!this.currentNode.equalsAt(",",-1)&&!this.currentNode.equalsAt(":",-1))throw new Error("Unexpected range wildcard at position "+(this.pos+e))}else if(44===a){if(!this.currentNode.isDigit(-1)&&!this.currentNode.equalsAt("*",-1))throw new Error("Unexpected sequence separator , at position "+(this.pos+e));if(this.currentNode.equalsAt("*",-1)&&!this.currentNode.equalsAt(":",-2))throw new Error("Unexpected sequence separator , at position "+(this.pos+e))}else if(!ve(a))throw new Error("Unexpected char at position "+(this.pos+e));if(ve(a)&&this.currentNode.equalsAt("*",-1))throw new Error("Unexpected number at position "+(this.pos+e));this.currentNode.valueEnd=e+1}}}}function We(e,t={}){let n=new Qe(e,t),a={};return a.tag=n.getTag(),n.getSpace(),a.command=n.getCommand(),["UID","AUTHENTICATE"].indexOf((a.command||"").toUpperCase())>=0&&(n.getSpace(),a.command+=" "+n.getElement(Ie)),function(e){for(let t=0;t<e.length;t++)if(e[t]!==fe)return!1;return!0}(n.remainder)||(n.getSpace(),a.attributes=n.getAttributes()),n.humanReadable&&(a.attributes=(a.attributes||[]).concat({type:"TEXT",value:n.humanReadable})),a}var Ge=n(65546);const Xe=e=>new Uint8Array(e.split("").map((e=>e.charCodeAt(0)))),Ye=e=>String.fromCharCode.apply(null,e);function Je(e="",t){const n=[`user=${e}`,`auth=Bearer ${t}`,"",""];return(0,Ge.encode)(n.join(""))}let et=0;function tt(e,t){const n=++et,a=(a,s)=>{s=s.map((e=>"function"==typeof e?e():e));const i=`[${(new Date).toISOString()}][${n}][${e}][${t}] ${s.join(" ")}`;10===a?console.log("[DEBUG]"+i):20===a?console.info("[INFO]"+i):30===a?console.warn("[WARN]"+i):40===a&&console.error("[ERROR]"+i)};return{debug:e=>a(10,e),info:e=>a(20,e),warn:e=>a(30,e),error:e=>a(40,e)}}var nt=n(16504),at=n(62292),st=n.n(at),it=n(30405),rt=n(27948),ot=n(48898),ct=n.n(ot),lt=n(71619);const dt=16384;function ut(e,t){this.inflatedReady=e,this.deflatedReady=t,this._inflate=function(e){const t=new(st()),n=(0,rt.Ul)(t,15);if(n!==lt.Z_OK)throw new Error("Problem initializing inflate stream: "+ct()[n]);return function(n){if(void 0===n)return e();let a,s,i;t.input=n,t.next_in=0,t.avail_in=t.input.length;let r=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(dt),a=t.next_out=0,t.avail_out=dt),s=(0,rt.rr)(t,lt.Z_NO_FLUSH),s!==lt.Z_STREAM_END&&s!==lt.Z_OK)throw new Error("inflate problem: "+ct()[s]);t.next_out&&(0!==t.avail_out&&s!==lt.Z_STREAM_END||(i=t.output.subarray(a,a=t.next_out),r=e(i)))}while(t.avail_in>0&&s!==lt.Z_STREAM_END);return t.next_out>a&&(i=t.output.subarray(a,a=t.next_out),r=e(i)),r}}((e=>this.inflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length)))),this._deflate=function(e){const t=new(st()),n=(0,it.Ue)(t,lt.Z_DEFAULT_COMPRESSION,lt.Z_DEFLATED,15,8,lt.Z_DEFAULT_STRATEGY);if(n!==lt.Z_OK)throw new Error("Problem initializing deflate stream: "+ct()[n]);return function(n){if(void 0===n)return e();let a,s,i;t.input=n,t.next_in=0,t.avail_in=t.input.length;let r=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(dt),i=t.next_out=0,t.avail_out=dt),a=(0,it.Wt)(t,lt.Z_SYNC_FLUSH),a!==lt.Z_STREAM_END&&a!==lt.Z_OK)throw new Error("Deflate problem: "+ct()[a]);0===t.avail_out&&t.next_out>i&&(s=t.output.subarray(i,i=t.next_out),r=e(s))}while((t.avail_in>0||0===t.avail_out)&&a!==lt.Z_STREAM_END);return t.next_out>i&&(s=t.output.subarray(i,i=t.next_out),r=e(s)),r}}((e=>this.deflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length))))}ut.prototype.inflate=function(e){this._inflate(new Uint8Array(e))},ut.prototype.deflate=function(e){this._deflate(new Uint8Array(e))};var ht=n(44983),ft=n.n(ht);const pt="\r\n",gt="literal",mt="literal_length_1",wt="literal_length_2",_t="default";class bt{constructor(e,t,n={}){this.timeoutEnterIdle=1e3,this.timeoutSocketLowerBound=1e4,this.timeoutSocketMultiplier=.1,this.options=n,this.port=t||(this.options.useSecureTransport?993:143),this.host=e||"localhost",this.options.useSecureTransport="useSecureTransport"in this.options?!!this.options.useSecureTransport:993===this.port,this.secureMode=!!this.options.useSecureTransport,this._connectionReady=!1,this._globalAcceptUntagged={},this._clientQueue=[],this._canSend=!1,this._tagCounter=0,this._currentCommand=!1,this._idleTimer=!1,this._socketTimeoutTimer=!1,this.compressed=!1,this._incomingBuffers=[],this._bufferState=_t,this._literalRemaining=0,this.oncert=null,this.onerror=null,this.onready=null,this.onidle=null}connect(e=nt.default){return new Promise(((t,n)=>{this.socket=e.open(this.host,this.port,{binaryType:"arraybuffer",useSecureTransport:this.secureMode,ca:this.options.ca});try{this.socket.oncert=e=>{this.oncert&&this.oncert(e)}}catch(e){}this.socket.onclose=()=>this._onError(new Error("Socket closed unexpectedly!")),this.socket.ondata=e=>{try{this._onData(e)}catch(e){this._onError(e)}},this.socket.onerror=e=>{n(new Error("Could not open socket: "+e.data.message))},this.socket.onopen=()=>{this.socket.onerror=e=>this._onError(e),t()}}))}close(e){return new Promise((t=>{var n=()=>{if(this._clientQueue.forEach((t=>t.callback(e))),this._currentCommand&&this._currentCommand.callback(e),this._clientQueue=[],this._currentCommand=!1,clearTimeout(this._idleTimer),this._idleTimer=null,clearTimeout(this._socketTimeoutTimer),this._socketTimeoutTimer=null,this.socket){this.socket.onopen=null,this.socket.onclose=null,this.socket.ondata=null,this.socket.onerror=null;try{this.socket.oncert=null}catch(e){}this.socket=null}t()};if(this._disableCompression(),!this.socket||"open"!==this.socket.readyState)return n();this.socket.onclose=this.socket.onerror=n,this.socket.close()}))}logout(){return new Promise(((e,t)=>{this.socket.onclose=this.socket.onerror=()=>{this.close("Client logging out").then(e).catch(t)},this.enqueueCommand("LOGOUT")}))}upgrade(){this.secureMode=!0,this.socket.upgradeToSecure()}enqueueCommand(e,t,n){"string"==typeof e&&(e={command:e}),t=[].concat(t||[]).map((e=>(e||"").toString().toUpperCase().trim()));var a="W"+ ++this._tagCounter;return e.tag=a,new Promise(((s,i)=>{var r={tag:a,request:e,payload:t.length?{}:void 0,callback:e=>{if(this.isError(e))return i(e);{const n=d("","command",e).toUpperCase().trim();if(["NO","BAD"].includes(n)){var t=new Error(e.humanReadable||"Error");return t.command=n,e.code&&(t.code=e.code),i(t)}}s(e)}};Object.keys(n||{}).forEach((e=>{r[e]=n[e]})),t.forEach((e=>{r.payload[e]=[]}));var o=r.ctx?this._clientQueue.indexOf(r.ctx):-1;o>=0?(r.tag+=".p",r.request.tag+=".p",this._clientQueue.splice(o,0,r)):this._clientQueue.push(r),this._canSend&&this._sendRequest()}))}getPreviouslyQueued(e,t){for(let e=this._clientQueue.indexOf(t)-1;e>=0;e--)if(n(this._clientQueue[e]))return this._clientQueue[e];return!!n(this._currentCommand)&&this._currentCommand;function n(t){return t&&t.request&&e.indexOf(t.request.command)>=0}}send(e){const t=Xe(e).buffer;this._resetSocketTimeout(t.byteLength),this.compressed?this._sendCompressed(t):this.socket.send(t)}setHandler(e,t){this._globalAcceptUntagged[e.toUpperCase().trim()]=t}_onError(e){var t;t=this.isError(e)?e:e&&this.isError(e.data)?e.data:new Error(e&&e.data&&e.data.message||e.data||e||"Error"),this.onerror||this.logger.error(t),this.close(t).then((()=>{this.onerror&&this.onerror(t)}),(()=>{this.onerror&&this.onerror(t)}))}_onData(e){this._resetSocketTimeout(),this._incomingBuffers.push(new Uint8Array(e.data)),this._parseIncomingCommands(this._iterateIncomingBuffer())}*_iterateIncomingBuffer(){let e=this._incomingBuffers[this._incomingBuffers.length-1]||[],t=0;for(;t<e.length;)switch(this._bufferState){case gt:const n=Math.min(e.length-t,this._literalRemaining);this._literalRemaining-=n,t+=n,0===this._literalRemaining&&(this._bufferState=_t);continue;case wt:t<e.length&&(13===e[t]?(this._literalRemaining=Number(Ye(this._lengthBuffer))+2,this._bufferState=gt):this._bufferState=_t,delete this._lengthBuffer);continue;case mt:const a=t;for(;t<e.length&&e[t]>=48&&e[t]<=57;)t++;if(a!==t){const n=e.subarray(a,t),s=this._lengthBuffer;this._lengthBuffer=new Uint8Array(s.length+n.length),this._lengthBuffer.set(s),this._lengthBuffer.set(n,s.length)}t<e.length&&(this._lengthBuffer.length>0&&125===e[t]?this._bufferState=wt:(delete this._lengthBuffer,this._bufferState=_t),t++);continue;default:const s=e.indexOf(123,t);if(s>-1){if(-1===new Uint8Array(e.buffer,t,s-t).indexOf(10)){t=s+1,this._lengthBuffer=new Uint8Array(0),this._bufferState=mt;continue}}const i=e.indexOf(10,t);if(!(i>-1))return;{i<e.length-1&&(this._incomingBuffers[this._incomingBuffers.length-1]=new Uint8Array(e.buffer,0,i+1));const n=this._incomingBuffers.reduce(((e,t)=>e+t.length),0)-2,a=new Uint8Array(n);let s=0;for(;this._incomingBuffers.length>0;){let e=this._incomingBuffers.shift();const t=n-s;if(e.length>t){const n=e.length-t;e=e.subarray(0,-n),this._incomingBuffers.length>0&&(this._incomingBuffers=[])}a.set(e,s),s+=e.length}if(yield a,!(i<e.length-1))return clearTimeout(this._socketTimeoutTimer),void(this._socketTimeoutTimer=null);e=new Uint8Array(e.subarray(i+1)),this._incomingBuffers.push(e),t=0}}}_parseIncomingCommands(e){for(var t of e)if(this._clearIdle(),43!==t[0]){var n;try{const e=this._currentCommand.request&&this._currentCommand.request.valueAsString;n=We(t,{valueAsString:e}),this.logger.debug("S:",(()=>Ee(n,!1,!0)))}catch(e){return this.logger.error("Error parsing imap command!",n),this._onError(e)}this._processResponse(n),this._handleResponse(n),this._connectionReady||(this._connectionReady=!0,this.onready&&this.onready())}else if(this._currentCommand.data.length){var a=this._currentCommand.data.shift();a+=this._currentCommand.data.length?"":pt,this.send(a)}else this._currentCommand.errorResponseExpectsEmptyLine&&this.send(pt)}_handleResponse(e){var t=d("","command",e).toUpperCase().trim();this._currentCommand?this._currentCommand.payload&&"*"===e.tag&&t in this._currentCommand.payload?(this._currentCommand.payload[t].push(e),this._resetSocketTimeout()):"*"===e.tag&&t in this._globalAcceptUntagged?(this._globalAcceptUntagged[t](e),this._resetSocketTimeout()):e.tag===this._currentCommand.tag&&(this._currentCommand.payload&&Object.keys(this._currentCommand.payload).length&&(e.payload=this._currentCommand.payload),this._currentCommand.callback(e),this._canSend=!0,this._sendRequest()):"*"===e.tag&&t in this._globalAcceptUntagged&&(this._globalAcceptUntagged[t](e),this._canSend=!0,this._sendRequest())}_sendRequest(){if(!this._clientQueue.length)return this._currentCommand=!1,this._enterIdle();this._clearIdle(),this._restartQueue=!1;var e=this._clientQueue[0];if("function"==typeof e.precheck){var t=e,n=t.precheck;return delete t.precheck,this._restartQueue=!0,void n(t).then((()=>{this._restartQueue&&this._sendRequest()})).catch((e=>{let n;const a=this._clientQueue.indexOf(t);a>=0&&(n=this._clientQueue.splice(a,1)[0]),n&&n.callback&&(n.callback(e),this._canSend=!0,this._parseIncomingCommands(this._iterateIncomingBuffer()),this._sendRequest())}))}this._canSend=!1,this._currentCommand=this._clientQueue.shift();try{this._currentCommand.data=Ee(this._currentCommand.request,!0),this.logger.debug("C:",(()=>Ee(this._currentCommand.request,!1,!0)))}catch(e){return this.logger.error("Error compiling imap command!",this._currentCommand.request),this._onError(new Error("Error compiling imap command!"))}var a=this._currentCommand.data.shift();return this.send(a+(this._currentCommand.data.length?"":pt)),this.waitDrain}_enterIdle(){clearTimeout(this._idleTimer),this._idleTimer=setTimeout((()=>this.onidle&&this.onidle()),this.timeoutEnterIdle)}_clearIdle(){clearTimeout(this._idleTimer),this._idleTimer=null}_processResponse(e){const t=d("","command",e).toUpperCase().trim();if(e&&e.attributes&&e.attributes.length&&("*"===e.tag&&/^\d+$/.test(e.command)&&"ATOM"===e.attributes[0].type&&(e.nr=Number(e.command),e.command=(e.attributes.shift().value||"").toString().toUpperCase().trim()),!(["OK","NO","BAD","BYE","PREAUTH"].indexOf(t)<0)&&("TEXT"===e.attributes[e.attributes.length-1].type&&(e.humanReadable=e.attributes[e.attributes.length-1].value),"ATOM"===e.attributes[0].type&&e.attributes[0].section))){const t=e.attributes[0].section.map((e=>{if(e)return Array.isArray(e)?e.map((e=>(e.value||"").toString().trim())):(e.value||"").toString().toUpperCase().trim()})),n=t.shift();e.code=n,1===t.length?e[n.toLowerCase()]=t[0]:t.length>1&&(e[n.toLowerCase()]=t)}}isError(e){return!!Object.prototype.toString.call(e).match(/Error\]$/)}enableCompression(){if(this._socketOnData=this.socket.ondata,this.compressed=!0,"undefined"!=typeof window&&window.Worker)this._compressionWorker=new Worker(URL.createObjectURL(new Blob([ft()]))),this._compressionWorker.onmessage=e=>{var t=e.data.message,n=e.data.buffer;switch(t){case"inflated_ready":this._socketOnData({data:n});break;case"deflated_ready":this.waitDrain=this.socket.send(n)}},this._compressionWorker.onerror=e=>{this._onError(new Error("Error handling compression web worker: "+e.message))},this._compressionWorker.postMessage(yt("start"));else{const e=e=>{this._socketOnData({data:e})},t=e=>{this.waitDrain=this.socket.send(e)};this._compression=new ut(e,t)}this.socket.ondata=e=>{this.compressed&&(this._compressionWorker?this._compressionWorker.postMessage(yt("inflate",e.data),[e.data]):this._compression.inflate(e.data))}}_disableCompression(){this.compressed&&(this.compressed=!1,this.socket.ondata=this._socketOnData,this._socketOnData=null,this._compressionWorker&&(this._compressionWorker.terminate(),this._compressionWorker=null))}_sendCompressed(e){this._compressionWorker?this._compressionWorker.postMessage(yt("deflate",e),[e]):this._compression.deflate(e)}_resetSocketTimeout(e){clearTimeout(this._socketTimeoutTimer);const t=this.timeoutSocketLowerBound+Math.floor((e||4096)*this.timeoutSocketMultiplier);this._socketTimeoutTimer=setTimeout((()=>this._onError(new Error(" Socket timed out!"))),t)}}const yt=(e,t)=>({message:e,buffer:t}),vt=["\\All","\\Archive","\\Drafts","\\Flagged","\\Junk","\\Sent","\\Trash"],It={"\\Sent":["aika","bidaliak","bidalita","dihantar","e rometsweng","e tindami","elkÃ¼ldÃ¶tt","elkÃ¼ldÃ¶ttek","enviadas","enviadas","enviados","enviats","envoyÃ©s","ethunyelweyo","expediate","ezipuru","gesendete","gestuur","gÃ¶nderilmiÅ Ã¶Äeler","gÃ¶ndÉrilÉnlÉr","iberilen","inviati","iÅ¡siÅ³stieji","kuthunyelwe","lasa","lÃ¤hetetyt","messages envoyÃ©s","naipadala","nalefa","napadala","nosÅ«tÄ«tÄs ziÅas","odeslanÃ©","padala","poslane","poslano","poslano","poslanÃ©","poslato","saadetud","saadetud kirjad","sendt","sendt","sent","sent items","sent messages","sÃ¤nda poster","sÃ¤nt","terkirim","ti fi raná¹£áº¹","tÃ« dÃ«rguara","verzonden","vilivyotumwa","wysÅane","ÄÃ£ gá»­i","ÏÏÎ±Î»Î¸Î­Î½ÏÎ±","Ð¶Ð¸Ð±ÐµÑÐ¸Ð»Ð³ÐµÐ½","Ð¶ÑÐ±ÐµÑÑÐ»Ð³ÐµÐ½Ð´ÐµÑ","Ð¸Ð·Ð¿ÑÐ°ÑÐµÐ½Ð¸","Ð¸Ð»Ð³ÑÑÑÑÐ½","Ð¸ÑÑÐ¾Ð» ÑÑÐ´","Ð¸ÑÐ¿ÑÐ°ÑÐµÐ½Ð¾","Ð½Ð°Ð´ÑÑÐ»Ð°Ð½Ñ","Ð¾ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð½ÑÐµ","Ð¿Ð°ÑÐ»Ð°Ð½ÑÑ","ÑÐ±Ð¾ÑÐ¸Ð»Ð³Ð°Ð½","Õ¸ÖÕ²Õ¡ÖÕ¯Õ¾Õ¡Õ®","× ×©×××","×¤×¨×××× ×©× ×©×××","Ø§ÙÙØ±Ø³ÙØ©","Ø¨Ú¾ÛØ¬Û Ú¯Ø¦Û","Ø³ÙØ²ÙÚÛ","ÙÛÚ«Ù Ø´ÙÛ","ÙÙØ§Ø±Ø¯ Ø§Ø±Ø³Ø§Ù Ø´Ø¯Ù","à¤ªà¤¾à¤ à¤µà¤¿à¤²à¥","à¤ªà¤¾à¤ à¤µà¤¿à¤²à¥à¤²à¥","à¤ªà¥à¤°à¥à¤·à¤¿à¤¤","à¤­à¥à¤à¤¾ à¤à¤¯à¤¾","à¦ªà§à¦°à§à¦°à¦¿à¦¤","à¦ªà§à¦°à§à¦°à¦¿à¦¤","à¦ªà§à§°à§à§°à¦¿à¦¤","à¨­à©à¨à©","àª®à«àªàª²à«àª²àª¾","à¬ªà¬ à¬¾à¬à¬²à¬¾","à®à®©à¯à®ªà¯à®ªà®¿à®¯à®µà¯","à°ªà°à°ªà°¿à°à°à°¬à°¡à°¿à°à°¦à°¿","à²à²³à³à²¹à²¿à²¸à²²à²¾à²¦","à´à´¯à´àµà´àµ","à¶ºà·à·à· à¶´à¶«à·à·à·à¶©","à¸ªà¹à¸à¹à¸¥à¹à¸§","áááááááááá","á¨á°áá©","áá¶áâáááá¾","å¯ä»¶åä»½","å¯ä»¶åä»½","å·²åä¿¡æ¯","éä¿¡æ¸ã¿ï¾ï½°ï¾","ë°ì  ë©ìì§","ë³´ë¸ í¸ì§í¨"],"\\Trash":["articole Èterse","bin","borttagna objekt","deleted","deleted items","deleted messages","elementi eliminati","elementos borrados","elementos eliminados","gelÃ¶schte objekte","item dipadam","itens apagados","itens excluÃ­dos","má»¥c ÄÃ£ xÃ³a","odstranÄnÃ© poloÅ¾ky","pesan terhapus","poistetut","praht","prÃ¼gikast","silinmiÅ Ã¶Äeler","slettede beskeder","slettede elementer","trash","tÃ¶rÃ¶lt elemek","usuniÄte wiadomoÅci","verwijderde items","vymazanÃ© sprÃ¡vy","Ã©lÃ©ments supprimÃ©s","Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ñ","Ð¶Ð¾Ð¹ÑÐ»ÒÐ°Ð½Ð´Ð°Ñ","ÑÐ´Ð°Ð»ÐµÐ½Ð½ÑÐµ","×¤×¨×××× ×©× ×××§×","Ø§ÙØ¹ÙØ§ØµØ± Ø§ÙÙØ­Ø°ÙÙØ©","ÙÙØ§Ø±Ø¯ Ø­Ø°Ù Ø´Ø¯Ù","à¸£à¸²à¸¢à¸à¸²à¸£à¸à¸µà¹à¸¥à¸","å·²å é¤é®ä»¶","å·²åªé¤é ç®","å·²åªé¤é ç®"],"\\Junk":["bulk mail","correo no deseado","courrier indÃ©sirable","istenmeyen","istenmeyen e-posta","junk","levÃ©lszemÃ©t","nevyÅ¾iadanÃ¡ poÅ¡ta","nevyÅ¾Ã¡danÃ¡ poÅ¡ta","no deseado","posta indesiderata","pourriel","roskaposti","skrÃ¤ppost","spam","spam","spamowanie","sÃ¸ppelpost","thÆ° rÃ¡c","ÑÐ¿Ð°Ð¼","××××¨ ×××","Ø§ÙØ±Ø³Ø§Ø¦Ù Ø§ÙØ¹Ø´ÙØ§Ø¦ÙØ©","ÙØ±Ø²ÙØ§ÙÙ","à¸ªà¹à¸à¸¡","âåå¾éµä»¶","åå¾é®ä»¶","åå¾é»éµ"],"\\Drafts":["ba brouillon","borrador","borrador","borradores","bozze","brouillons","báº£n tháº£o","ciorne","concepten","draf","drafts","drÃ¶g","entwÃ¼rfe","esborranys","garalamalar","ihe edeturu","iidrafti","izinhlaka","juodraÅ¡Äiai","kladd","kladder","koncepty","koncepty","konsep","konsepte","kopie robocze","layihÉlÉr","luonnokset","melnraksti","meralo","mesazhe tÃ« padÃ«rguara","mga draft","mustandid","nacrti","nacrti","osnutki","piszkozatok","rascunhos","rasimu","skice","taslaklar","tsararrun saÆonni","utkast","vakiraoka","vÃ¡zlatok","zirriborroak","Ã wá»n Ã ká»pamá»Ì","ÏÏÏÏÎµÎ¹ÏÎ±","Ð¶Ð¾Ð±Ð°Ð»Ð°Ñ","Ð½Ð°ÑÑÑÐ¸","Ð½Ð¾Ð¾ÑÐ³ÑÑÐ´","ÑÐ¸ÑÒ³Ð½Ð°Ð²Ð¸Ñ","ÑÐ¾Ð¼Ð°ÐºÐ¸ ÑÐ°ÑÐ»Ð°Ñ","ÑÐ°ÑÐ½Ð°Ð²ÑÐºÑ","ÑÐµÑÐ½ÐµÑÐºÐ¸","ÑÐµÑÐ½Ð¾Ð²Ð¸","ÑÐµÑÐ½Ð¾Ð²Ð¸ÐºÐ¸","ÑÐµÑÐ½Ð¾Ð²Ð¸ÐºÑÐµÑ","Õ½ÖÕ¡Õ£ÖÕ¥Ö","××××××ª","ÙØ³ÙØ¯Ø§Øª","ÙØ³ÙØ¯Ø§Øª","ÙÙØ³ÙØ¯Û","Ù¾ÛØ´ ÙÙÛØ³ÙØ§","ÚØ±Ø§ÙÙ¹/","à¤¡à¥à¤°à¤¾à¥à¥à¤","à¤ªà¥à¤°à¤¾à¤°à¥à¤ª","à¦à¦¸à§à¦¾","à¦à¦¸à§à¦¾","à¦¡à§à§°à¦¾à¦«à§à¦","à¨¡à©à¨°à¨¾à¨«à¨","àª¡à«àª°àª¾àª«à«àªàª¸","à¬¡à­à¬°à¬¾à¬«à­à¬","à®µà®°à¯à®µà¯à®à®³à¯","à°à°¿à°¤à±à°¤à± à°ªà±à°°à°¤à±à°²à±","à²à²°à²¡à³à²à²³à³","à´à´°à´àµà´à´³àµâ","à¶à·à¶§à·à¶¸à· à¶´à¶­à·","à¸à¸à¸±à¸à¸£à¹à¸²à¸","ááááá®ááááá","á¨ááá½","áá¶ááááá¶á","ä¸æ¸ã","èç¨¿","èç¨¿","èç¨¿","ìì ë³´ê´í¨"]},kt=Object.keys(It);function Et(e){if(e.flags)for(let t=0;t<vt.length;t++){const n=vt[t];if((e.flags||[]).indexOf(n)>=0)return e.specialUse=n,e.specialUseFlag=n,n}return function(e){const t=d("","name",e).toLowerCase().trim();for(let n=0;n<kt.length;n++){const a=kt[n];if(It[a].indexOf(t)>=0)return e.specialUse=a,a}return!1}(e)}const xt={name:"emailjs-imap-client"};const At=class{constructor(e,t,n={}){this.timeoutConnection=9e4,this.timeoutNoop=6e4,this.timeoutIdle=6e4,this.serverId=!1,this.oncert=null,this.onupdate=null,this.onselectmailbox=null,this.onclosemailbox=null,this._host=e,this._clientId=d(xt,"id",n),this._state=!1,this._authenticated=!1,this._capability=[],this._humanReadable="",this._okGreeting="",this._selectedMailbox=!1,this._enteredIdle=!1,this._idleTimeout=!1,this._enableCompression=!!n.enableCompression,this._auth=n.auth,this._requireTLS=!!n.requireTLS,this._ignoreTLS=!!n.ignoreTLS,this.client=new bt(e,t,n),this.client.onerror=this._onError.bind(this),this.client.oncert=e=>this.oncert&&this.oncert(e),this.client.onidle=()=>this._onIdle(),this.client.setHandler("capability",(e=>this._untaggedCapabilityHandler(e))),this.client.setHandler("ok",(e=>this._untaggedOkHandler(e))),this.client.setHandler("exists",(e=>this._untaggedExistsHandler(e))),this.client.setHandler("expunge",(e=>this._untaggedExpungeHandler(e))),this.client.setHandler("fetch",(e=>this._untaggedFetchHandler(e))),this.createLogger(),this.logLevel=d(0,"logLevel",n)}_onError(e){clearTimeout(this._idleTimeout),this.onerror&&this.onerror(e)}async connect(){try{await this.openConnection(),await this.upgradeConnection();try{await this.updateId(this._clientId)}catch(e){if("BAD"!==e.command)throw e;this.logger.warn("Failed to update server id!",e.message)}await this.login(this._auth),await this.compressConnection(),this.logger.debug("Connection established, ready to roll!"),this.client.onerror=this._onError.bind(this)}catch(e){throw this.logger.error("Could not connect to server",e),this.close(e),e}}openConnection(){return new Promise(((e,t)=>{const n=setTimeout((()=>t(new Error("Timeout connecting to server"))),this.timeoutConnection);this.logger.debug("Connecting to",this.client.host,":",this.client.port),this._changeState(1),this.client.connect().then((()=>{this.logger.debug("Socket opened, waiting for greeting from the server..."),this.client.onready=()=>{clearTimeout(n),this._changeState(2),this._okGreeting=this._humanReadable,this.updateCapability().then((()=>e(this._capability)))},this.client.onerror=e=>{clearTimeout(n),t(e)}})).catch(t)}))}async logout(){this._changeState(5),this.logger.debug("Logging out..."),await this.client.logout(),clearTimeout(this._idleTimeout)}async close(e){this._changeState(5),clearTimeout(this._idleTimeout),this.logger.debug("Closing connection..."),await this.client.close(e),clearTimeout(this._idleTimeout)}async updateId(e){if(this._capability.indexOf("ID")<0)return;this.logger.debug("Updating id...");const t=e?[g(Object.entries(e))]:[null],n=await this.exec({command:"ID",attributes:t},"ID"),a=g(l([],["payload","ID","0","attributes","0"],n).map(Object.values)),s=a.filter(((e,t)=>t%2==0)),i=a.filter(((e,t)=>t%2==1));this.serverId=m(w(s,i)),this.logger.debug("Server id updated!",this.serverId)}_shouldSelectMailbox(e,t){if(!t)return!0;const n=this.client.getPreviouslyQueued(["SELECT","EXAMINE"],t);if(n&&n.request.attributes){const t=n.request.attributes.find((e=>"STRING"===e.type));if(t)return t.value!==e}return this._selectedMailbox!==e}async selectMailbox(e,t={}){const n={command:t.readOnly?"EXAMINE":"SELECT",attributes:[{type:"STRING",value:e}]};t.condstore&&this._capability.indexOf("CONDSTORE")>=0&&n.attributes.push([{type:"ATOM",value:"CONDSTORE"}]),this.logger.debug("Opening",e,"...");const a=function(e){if(!e||!e.payload)return;const t={readOnly:"READ-ONLY"===e.code},n=e.payload.EXISTS&&e.payload.EXISTS.pop(),a=e.payload.FLAGS&&e.payload.FLAGS.pop(),s=e.payload.OK;return n&&(t.exists=n.nr||0),a&&a.attributes&&a.attributes.length&&(t.flags=a.attributes[0].map((e=>(e.value||"").toString().trim()))),[].concat(s||[]).forEach((e=>{switch(e&&e.code){case"PERMANENTFLAGS":t.permanentFlags=[].concat(e.permanentflags||[]);break;case"UIDVALIDITY":t.uidValidity=Number(e.uidvalidity)||0;break;case"UIDNEXT":t.uidNext=Number(e.uidnext)||0;break;case"HIGHESTMODSEQ":t.highestModseq=e.highestmodseq||"0";break;case"NOMODSEQ":t.noModseq=!0}})),t}(await this.exec(n,["EXISTS","FLAGS","OK"],{ctx:t.ctx}));return this._changeState(4),this._selectedMailbox!==e&&this.onclosemailbox&&await this.onclosemailbox(this._selectedMailbox),this._selectedMailbox=e,this.onselectmailbox&&await this.onselectmailbox(e,a),a}async subscribeMailbox(e){return this.logger.debug("Subscribing to mailbox",e,"..."),this.exec({command:"SUBSCRIBE",attributes:[e]})}async unsubscribeMailbox(e){return this.logger.debug("Unsubscribing to mailbox",e,"..."),this.exec({command:"UNSUBSCRIBE",attributes:[e]})}async listNamespaces(){if(this._capability.indexOf("NAMESPACE")<0)return!1;this.logger.debug("Listing namespaces...");return function(e){if(!e.payload||!e.payload.NAMESPACE||!e.payload.NAMESPACE.length)return!1;const t=[].concat(e.payload.NAMESPACE.pop().attributes||[]);return!!t.length&&{personal:Ue(t[0]),users:Ue(t[1]),shared:Ue(t[2])}}(await this.exec("NAMESPACE","NAMESPACE"))}async listMailboxes(){const e={root:!0,children:[]};this.logger.debug("Listing mailboxes...");const t=await this.exec({command:"LIST",attributes:["","*"]},"LIST");let n;if(l([],["payload","LIST"],t).forEach((t=>{const n=d([],"attributes",t);if(n.length<3)return;const a=l("",["2","value"],n),s=l("/",["1","value"],n),i=this._ensurePath(e,a,s);i.flags=d([],"0",n).map((({value:e})=>e||"")),i.listed=!0,Et(i)})),this._capability.indexOf("LIST-EXTENDED")>-1){const e=await this.exec({command:"LIST (SUBSCRIBED)",attributes:["","*"]},"LIST");n=l([],["payload","LIST"],e)}else{const e=await this.exec({command:"LSUB",attributes:["","*"]},"LSUB");n=l([],["payload","LSUB"],e)}return n.forEach((t=>{const n=d([],"attributes",t);if(n.length<3)return;const a=l("",["2","value"],n),s=l("/",["1","value"],n),i=this._ensurePath(e,a,s);d([],"0",n).map(((e="")=>{i.flags=ee(i.flags,[e])})),i.subscribed=!0})),e}async createMailbox(e){this.logger.debug("Creating mailbox",e,"...");try{await this.exec({command:"CREATE",attributes:[e]})}catch(e){if(e&&"ALREADYEXISTS"===e.code)return;throw e}}deleteMailbox(e){return this.logger.debug("Deleting mailbox",e,"..."),this.exec({command:"DELETE",attributes:[e]})}async listMessages(e,t,n=[{fast:!0}],a={}){this.logger.debug("Fetching messages",t,"from",e,"...");const s=function(e,t,n){const a={command:n.byUid?"UID FETCH":"FETCH",attributes:[{type:"SEQUENCE",value:e}]};void 0!==n.valueAsString&&(a.valueAsString=n.valueAsString);let s=[];return t.forEach((e=>{if(e=e.toUpperCase().trim(),/^\w+$/.test(e))s.push({type:"ATOM",value:e});else if(e)try{const t=We(Xe("* Z "+e));s=s.concat(t.attributes||[])}catch(t){s.push({type:"ATOM",value:e})}})),1===s.length&&(s=s.pop()),a.attributes.push(s),n.changedSince&&a.attributes.push([{type:"ATOM",value:"CHANGEDSINCE"},{type:"ATOM",value:n.changedSince}]),a}(t,n,a);return $e(await this.exec(s,"FETCH",{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}async search(e,t,n={}){this.logger.debug("Searching in",e,"...");const a=function(e={},t={}){const n={command:t.byUid?"UID SEARCH":"SEARCH"};let a=!0;const s=e=>{let t=[];return Object.keys(e).forEach((n=>{let i=[];const r=e=>{return"number"==typeof e?{type:"number",value:e}:"string"==typeof e?/[\u0080-\uFFFF]/.test(e)?(a=!1,{type:"literal",value:Ye((0,Ce.cv)(e))}):{type:"string",value:e}:"[object Date]"===Object.prototype.toString.call(e)?{type:"atom",value:(t=e,t.toUTCString().replace(/^\w+, 0?(\d+) (\w+) (\d+).*/,"$1-$2-$3"))}:Array.isArray(e)?e.map(r):"object"==typeof e?s(e):void 0;var t};i.push({type:"atom",value:n.toUpperCase()}),[].concat(e[n]||[]).forEach((e=>{switch(n.toLowerCase()){case"uid":e={type:"sequence",value:e};break;case"x-gm-thrid":case"x-gm-msgid":e={type:"number",value:e};break;default:e=r(e)}e&&(i=i.concat(e||[]))})),t=t.concat(i||[])})),t};return n.attributes=s(e),a||(n.attributes.unshift({type:"atom",value:"UTF-8"}),n.attributes.unshift({type:"atom",value:"CHARSET"})),n}(t,n);return function(e){const t=[];if(!e)throw new Error("parseSEARCH can not parse undefined response");return e.payload&&e.payload.SEARCH&&e.payload.SEARCH.length?(e.payload.SEARCH.forEach((e=>(e.attributes||[]).forEach((e=>{e=Number(e&&e.value||e)||0;const n=function(e,t,n=((e,t)=>e-t)){for(var a,s,i=0,r=e.length-1;i<=r;)if((s=+n(e[a=i+(r-i>>1)],t))<0)i=a+1;else{if(!(s>0))return a;r=a-1}return~i}(t,e);n<0&&t.splice(-n-1,0,e)})))),t):t}(await this.exec(a,"SEARCH",{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}setFlags(e,t,n,a){let s="",i=[];return Array.isArray(n)||"object"!=typeof n?(i=[].concat(n||[]),s=""):n.add?(i=[].concat(n.add||[]),s="+"):n.set?(s="",i=[].concat(n.set||[])):n.remove&&(s="-",i=[].concat(n.remove||[])),this.logger.debug("Setting flags on",t,"in",e,"..."),this.store(e,t,s+"FLAGS",i,a)}async store(e,t,n,a,s={}){const i=function(e,t="",n=[],a={}){const s={command:a.byUid?"UID STORE":"STORE",attributes:[{type:"sequence",value:e}]};return s.attributes.push({type:"atom",value:t.toUpperCase()+(a.silent?".SILENT":"")}),s.attributes.push(n.map((e=>({type:"atom",value:e})))),s}(t,n,a,s);return $e(await this.exec(i,"FETCH",{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}async upload(e,t,n={}){const a={command:"APPEND",attributes:[{type:"atom",value:e},d(["\\Seen"],"flags",n).map((e=>({type:"atom",value:e}))),{type:"literal",value:t}]};this.logger.debug("Uploading message to",e,"...");return function(e){return e&&e.appenduid&&e.appenduid[1]}(await this.exec(a))}async deleteMessages(e,t,n={}){this.logger.debug("Deleting messages",t,"in",e,"...");const a=n.byUid&&this._capability.indexOf("UIDPLUS")>=0,s={command:"UID EXPUNGE",attributes:[{type:"sequence",value:t}]};await this.setFlags(e,t,{add:"\\Deleted"},n);const i=a?s:"EXPUNGE";return this.exec(i,null,{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()})}async copyMessages(e,t,n,a={}){this.logger.debug("Copying messages",t,"from",e,"to",n,"...");return function(e){const t=e&&e.copyuid;if(t)return{srcSeqSet:t[1],destSeqSet:t[2]}}(await this.exec({command:a.byUid?"UID COPY":"COPY",attributes:[{type:"sequence",value:t},{type:"atom",value:n}]},null,{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}async moveMessages(e,t,n,a={}){return this.logger.debug("Moving messages",t,"from",e,"to",n,"..."),-1===this._capability.indexOf("MOVE")?(await this.copyMessages(e,t,n,a),this.deleteMessages(e,t,a)):this.exec({command:a.byUid?"UID MOVE":"MOVE",attributes:[{type:"sequence",value:t},{type:"atom",value:n}]},["OK"],{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()})}async compressConnection(){if(!this._enableCompression||this._capability.indexOf("COMPRESS=DEFLATE")<0||this.client.compressed)return!1;this.logger.debug("Enabling compression..."),await this.exec({command:"COMPRESS",attributes:[{type:"ATOM",value:"DEFLATE"}]}),this.client.enableCompression(),this.logger.debug("Compression enabled, all data sent and received is deflated!")}async login(e){let t;const n={};if(!e)throw new Error("Authentication information not provided");this._capability.indexOf("AUTH=XOAUTH2")>=0&&e&&e.xoauth2?(t={command:"AUTHENTICATE",attributes:[{type:"ATOM",value:"XOAUTH2"},{type:"ATOM",value:Je(e.user,e.xoauth2),sensitive:!0}]},n.errorResponseExpectsEmptyLine=!0):t={command:"login",attributes:[{type:"STRING",value:e.user||""},{type:"STRING",value:e.pass||"",sensitive:!0}]},this.logger.debug("Logging in...");const a=await this.exec(t,"capability",n);a.capability&&a.capability.length?this._capability=a.capability:a.payload&&a.payload.CAPABILITY&&a.payload.CAPABILITY.length?this._capability=a.payload.CAPABILITY.pop().attributes.map(((e="")=>e.value.toUpperCase().trim())):await this.updateCapability(!0),this._changeState(3),this._authenticated=!0,this.logger.debug("Login successful, post-auth capabilites updated!",this._capability)}async exec(e,t,n){this.breakIdle();const a=await this.client.enqueueCommand(e,t,n);return a&&a.capability&&(this._capability=a.capability),a}enterIdle(){if(this._enteredIdle)return;const e=this._capability.indexOf("IDLE")>=0;this._enteredIdle=e&&this._selectedMailbox?"IDLE":"NOOP",this.logger.debug("Entering idle with "+this._enteredIdle),"NOOP"===this._enteredIdle?this._idleTimeout=setTimeout((()=>{this.logger.debug("Sending NOOP"),this.exec("NOOP").catch((e=>this.logger.error("Could not idle (NOOP)",e)))}),this.timeoutNoop):"IDLE"===this._enteredIdle&&(this.client.enqueueCommand({command:"IDLE"}).catch((e=>this.logger.error("Could not idle (IDLE)",e))),this._idleTimeout=setTimeout((()=>{this.client.send("DONE\r\n"),this._enteredIdle=!1,this.logger.debug("Idle terminated")}),this.timeoutIdle))}breakIdle(){this._enteredIdle&&(clearTimeout(this._idleTimeout),"IDLE"===this._enteredIdle&&(this.client.send("DONE\r\n"),this.logger.debug("Idle terminated")),this._enteredIdle=!1)}async upgradeConnection(){return!this.client.secureMode&&(!((this._capability.indexOf("STARTTLS")<0||this._ignoreTLS)&&!this._requireTLS)&&(this.logger.debug("Encrypting connection..."),await this.exec("STARTTLS"),this._capability=[],this.client.upgrade(),this.updateCapability()))}async updateCapability(e){if((e||!this._capability.length)&&(this.client.secureMode||!this._requireTLS))return this.logger.debug("Updating capability..."),this.exec("CAPABILITY")}hasCapability(e=""){return this._capability.indexOf(e.toUpperCase().trim())>=0}getOkGreeting(){return this._okGreeting}_untaggedOkHandler(e){e&&(e.capability&&(this._capability=e.capability),this._humanReadable=e.humanReadable)}_untaggedCapabilityHandler(e){this._capability=N(d([],"attributes"),de((({value:e})=>(e||"").toUpperCase().trim())))(e)}_untaggedExistsHandler(e){e&&Object.prototype.hasOwnProperty.call(e,"nr")&&this.onupdate&&this.onupdate(this._selectedMailbox,"exists",e.nr)}_untaggedExpungeHandler(e){e&&Object.prototype.hasOwnProperty.call(e,"nr")&&this.onupdate&&this.onupdate(this._selectedMailbox,"expunge",e.nr)}_untaggedFetchHandler(e){this.onupdate&&this.onupdate(this._selectedMailbox,"fetch",[].concat($e({payload:{FETCH:[e]}})||[]).shift())}_onIdle(){this._authenticated&&!this._enteredIdle&&(this.logger.debug("Client started idling"),this.enterIdle())}_changeState(e){e!==this._state&&(this.logger.debug("Entering state: "+e),4===this._state&&this._selectedMailbox&&(this.onclosemailbox&&this.onclosemailbox(this._selectedMailbox),this._selectedMailbox=!1),this._state=e)}_ensurePath(e,t,n){const a=t.split(n);let s=e;for(let e=0;e<a.length;e++){let t=!1;for(let n=0;n<s.children.length;n++)if(this._compareMailboxNames(s.children[n].name,(0,ue.kF)(a[e]))){s=s.children[n],t=!0;break}t||(s.children.push({name:(0,ue.kF)(a[e]),delimiter:n,path:a.slice(0,e+1).join(n),children:[]}),s=s.children[s.children.length-1])}return s}_compareMailboxNames(e,t){return("INBOX"===e.toUpperCase()?"INBOX":e)===("INBOX"===t.toUpperCase()?"INBOX":t)}createLogger(e=tt){const t=e((this._auth||{}).user||"",this._host);this.logger=this.client.logger={debug:(...e)=>{10>=this.logLevel&&t.debug(e)},info:(...e)=>{20>=this.logLevel&&t.info(e)},warn:(...e)=>{30>=this.logLevel&&t.warn(e)},error:(...e)=>{40>=this.logLevel&&t.error(e)}}}}},16932:(e,t,n)=>{"use strict";const a=n(78501),s=n(58844),i=n(41192);e.exports={XMLParser:s,XMLValidator:a,XMLBuilder:i}},17849:(e,t)=>{"use strict";const n=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",a="["+n+"][:A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*",s=new RegExp("^"+a+"$");t.isExist=function(e){return void 0!==e},t.isEmptyObject=function(e){return 0===Object.keys(e).length},t.merge=function(e,t,n){if(t){const a=Object.keys(t),s=a.length;for(let i=0;i<s;i++)e[a[i]]="strict"===n?[t[a[i]]]:t[a[i]]}},t.getValue=function(e){return t.isExist(e)?e:""},t.isName=function(e){const t=s.exec(e);return!(null==t)},t.getAllMatches=function(e,t){const n=[];let a=t.exec(e);for(;a;){const s=[];s.startIndex=t.lastIndex-a[0].length;const i=a.length;for(let e=0;e<i;e++)s.push(a[e]);n.push(s),a=t.exec(e)}return n},t.nameRegexp=a},78501:(e,t,n)=>{"use strict";const a=n(17849),s={allowBooleanAttributes:!1,unpairedTags:[]};function i(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function r(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const a=e.substr(n,t-n);if(t>5&&"xml"===a)return h("InvalidXml","XML declaration allowed only at the start of the document.",p(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function o(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}t.validate=function(e,t){t=Object.assign({},s,t);const n=[];let l=!1,f=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let s=0;s<e.length;s++)if("<"===e[s]&&"?"===e[s+1]){if(s+=2,s=r(e,s),s.err)return s}else{if("<"!==e[s]){if(i(e[s]))continue;return h("InvalidChar","char '"+e[s]+"' is not expected.",p(e,s))}{let m=s;if(s++,"!"===e[s]){s=o(e,s);continue}{let w=!1;"/"===e[s]&&(w=!0,s++);let _="";for(;s<e.length&&">"!==e[s]&&" "!==e[s]&&"\t"!==e[s]&&"\n"!==e[s]&&"\r"!==e[s];s++)_+=e[s];if(_=_.trim(),"/"===_[_.length-1]&&(_=_.substring(0,_.length-1),s--),g=_,!a.isName(g)){let t;return t=0===_.trim().length?"Invalid space after '<'.":"Tag '"+_+"' is an invalid name.",h("InvalidTag",t,p(e,s))}const b=c(e,s);if(!1===b)return h("InvalidAttr","Attributes for '"+_+"' have open quote.",p(e,s));let y=b.value;if(s=b.index,"/"===y[y.length-1]){const n=s-y.length;y=y.substring(0,y.length-1);const a=d(y,t);if(!0!==a)return h(a.err.code,a.err.msg,p(e,n+a.err.line));l=!0}else if(w){if(!b.tagClosed)return h("InvalidTag","Closing tag '"+_+"' doesn't have proper closing.",p(e,s));if(y.trim().length>0)return h("InvalidTag","Closing tag '"+_+"' can't have attributes or invalid starting.",p(e,m));{const t=n.pop();if(_!==t.tagName){let n=p(e,t.tagStartPos);return h("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+_+"'.",p(e,m))}0==n.length&&(f=!0)}}else{const a=d(y,t);if(!0!==a)return h(a.err.code,a.err.msg,p(e,s-y.length+a.err.line));if(!0===f)return h("InvalidXml","Multiple possible root nodes found.",p(e,s));-1!==t.unpairedTags.indexOf(_)||n.push({tagName:_,tagStartPos:m}),l=!0}for(s++;s<e.length;s++)if("<"===e[s]){if("!"===e[s+1]){s++,s=o(e,s);continue}if("?"!==e[s+1])break;if(s=r(e,++s),s.err)return s}else if("&"===e[s]){const t=u(e,s);if(-1==t)return h("InvalidChar","char '&' is not expected.",p(e,s));s=t}else if(!0===f&&!i(e[s]))return h("InvalidXml","Extra text at the end",p(e,s));"<"===e[s]&&s--}}}var g;return l?1==n.length?h("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",p(e,n[0].tagStartPos)):!(n.length>0)||h("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):h("InvalidXml","Start tag expected.",1)};function c(e,t){let n="",a="",s=!1;for(;t<e.length;t++){if('"'===e[t]||"'"===e[t])""===a?a=e[t]:a!==e[t]||(a="");else if(">"===e[t]&&""===a){s=!0;break}n+=e[t]}return""===a&&{value:n,index:t,tagClosed:s}}const l=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function d(e,t){const n=a.getAllMatches(e,l),s={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return h("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",g(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return h("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",g(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return h("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",g(n[e]));const a=n[e][2];if(!f(a))return h("InvalidAttr","Attribute '"+a+"' is an invalid name.",g(n[e]));if(s.hasOwnProperty(a))return h("InvalidAttr","Attribute '"+a+"' is repeated.",g(n[e]));s[a]=1}return!0}function u(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function h(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function f(e){return a.isName(e)}function p(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function g(e){return e.startIndex+e[1].length}},41192:(e,t,n)=>{"use strict";const a=n(82592),s={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function i(e){this.options=Object.assign({},s,e),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=c),this.processTextOrObjNode=r,this.options.format?(this.indentate=o,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function r(e,t,n){const a=this.j2x(e,n+1);return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,a.attrStr,n):this.buildObjectNode(a.val,t,a.attrStr,n)}function o(e){return this.options.indentBy.repeat(e)}function c(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}i.prototype.build=function(e){return this.options.preserveOrder?a(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0).val)},i.prototype.j2x=function(e,t){let n="",a="";for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s))if(void 0===e[s])this.isAttribute(s)&&(a+="");else if(null===e[s])this.isAttribute(s)?a+="":"?"===s[0]?a+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:a+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)a+=this.buildTextValNode(e[s],s,"",t);else if("object"!=typeof e[s]){const i=this.isAttribute(s);if(i)n+=this.buildAttrPairStr(i,""+e[s]);else if(s===this.options.textNodeName){let t=this.options.tagValueProcessor(s,""+e[s]);a+=this.replaceEntitiesValue(t)}else a+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const n=e[s].length;let i="";for(let r=0;r<n;r++){const n=e[s][r];void 0===n||(null===n?"?"===s[0]?a+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:a+=this.indentate(t)+"<"+s+"/"+this.tagEndChar:"object"==typeof n?this.options.oneListGroup?i+=this.j2x(n,t+1).val:i+=this.processTextOrObjNode(n,s,t):i+=this.buildTextValNode(n,s,"",t))}this.options.oneListGroup&&(i=this.buildObjectNode(i,s,"",t)),a+=i}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const t=Object.keys(e[s]),a=t.length;for(let i=0;i<a;i++)n+=this.buildAttrPairStr(t[i],""+e[s][t[i]])}else a+=this.processTextOrObjNode(e[s],s,t);return{attrStr:n,val:a}},i.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},i.prototype.buildObjectNode=function(e,t,n,a){if(""===e)return"?"===t[0]?this.indentate(a)+"<"+t+n+"?"+this.tagEndChar:this.indentate(a)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let s="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",s=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(a)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(a)+"<"+t+n+i+this.tagEndChar+e+this.indentate(a)+s:this.indentate(a)+"<"+t+n+i+">"+e+s}},i.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},i.prototype.buildTextValNode=function(e,t,n,a){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(a)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(a)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(a)+"<"+t+n+"?"+this.tagEndChar;{let s=this.options.tagValueProcessor(t,e);return s=this.replaceEntitiesValue(s),""===s?this.indentate(a)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(a)+"<"+t+n+">"+s+"</"+t+this.tagEndChar}},i.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e},e.exports=i},82592:e=>{function t(e,r,o,c){let l="",d=!1;for(let u=0;u<e.length;u++){const h=e[u],f=n(h);if(void 0===f)continue;let p="";if(p=0===o.length?f:`${o}.${f}`,f===r.textNodeName){let e=h[f];s(p,r)||(e=r.tagValueProcessor(f,e),e=i(e,r)),d&&(l+=c),l+=e,d=!1;continue}if(f===r.cdataPropName){d&&(l+=c),l+=`<![CDATA[${h[f][0][r.textNodeName]}]]>`,d=!1;continue}if(f===r.commentPropName){l+=c+`\x3c!--${h[f][0][r.textNodeName]}--\x3e`,d=!0;continue}if("?"===f[0]){const e=a(h[":@"],r),t="?xml"===f?"":c;let n=h[f][0][r.textNodeName];n=0!==n.length?" "+n:"",l+=t+`<${f}${n}${e}?>`,d=!0;continue}let g=c;""!==g&&(g+=r.indentBy);const m=c+`<${f}${a(h[":@"],r)}`,w=t(h[f],r,p,g);-1!==r.unpairedTags.indexOf(f)?r.suppressUnpairedNode?l+=m+">":l+=m+"/>":w&&0!==w.length||!r.suppressEmptyNode?w&&w.endsWith(">")?l+=m+`>${w}${c}</${f}>`:(l+=m+">",w&&""!==c&&(w.includes("/>")||w.includes("</"))?l+=c+r.indentBy+w+c:l+=w,l+=`</${f}>`):l+=m+"/>",d=!0}return l}function n(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const a=t[n];if(e.hasOwnProperty(a)&&":@"!==a)return a}}function a(e,t){let n="";if(e&&!t.ignoreAttributes)for(let a in e){if(!e.hasOwnProperty(a))continue;let s=t.attributeValueProcessor(a,e[a]);s=i(s,t),!0===s&&t.suppressBooleanAttributes?n+=` ${a.substr(t.attributeNamePrefix.length)}`:n+=` ${a.substr(t.attributeNamePrefix.length)}="${s}"`}return n}function s(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let a in t.stopNodes)if(t.stopNodes[a]===e||t.stopNodes[a]==="*."+n)return!0;return!1}function i(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const a=t.entities[n];e=e.replace(a.regex,a.val)}return e}e.exports=function(e,n){let a="";return n.format&&n.indentBy.length>0&&(a="\n"),t(e,n,"",a)}},74780:(e,t,n)=>{const a=n(17849);function s(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const a=e[t++];let s="";for(;t<e.length&&e[t]!==a;t++)s+=e[t];return[n,s,t]}function i(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function r(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function o(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function c(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function l(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function d(e){if(a.isName(e))return e;throw new Error(`Invalid entity name ${e}`)}e.exports=function(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let a=1,u=!1,h=!1,f="";for(;t<e.length;t++)if("<"!==e[t]||h)if(">"===e[t]){if(h?"-"===e[t-1]&&"-"===e[t-2]&&(h=!1,a--):a--,0===a)break}else"["===e[t]?u=!0:f+=e[t];else{if(u&&r(e,t))t+=7,[entityName,val,t]=s(e,t+1),-1===val.indexOf("&")&&(n[d(entityName)]={regx:RegExp(`&${entityName};`,"g"),val});else if(u&&o(e,t))t+=8;else if(u&&c(e,t))t+=8;else if(u&&l(e,t))t+=9;else{if(!i)throw new Error("Invalid DOCTYPE");h=!0}a++,f=""}if(0!==a)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}},66745:(e,t)=>{const n={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};t.buildOptions=function(e){return Object.assign({},n,e)},t.defaultOptions=n},81078:(e,t,n)=>{"use strict";const a=n(17849),s=n(36311),i=n(74780),r=n(14153);function o(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const a=t[n];this.lastEntities[a]={regex:new RegExp("&"+a+";","g"),val:e[a]}}}function c(e,t,n,a,s,i,r){if(void 0!==e&&(this.options.trimValues&&!a&&(e=e.trim()),e.length>0)){r||(e=this.replaceEntitiesValue(e));const a=this.options.tagValueProcessor(t,e,n,s,i);if(null==a)return e;if(typeof a!=typeof e||a!==e)return a;if(this.options.trimValues)return y(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?y(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function l(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const d=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function u(e,t,n){if(!this.options.ignoreAttributes&&"string"==typeof e){const n=a.getAllMatches(e,d),s=n.length,i={};for(let e=0;e<s;e++){const a=this.resolveNameSpace(n[e][1]);let s=n[e][4],r=this.options.attributeNamePrefix+a;if(a.length)if(this.options.transformAttributeName&&(r=this.options.transformAttributeName(r)),"__proto__"===r&&(r="#__proto__"),void 0!==s){this.options.trimValues&&(s=s.trim()),s=this.replaceEntitiesValue(s);const e=this.options.attributeValueProcessor(a,s,t);i[r]=null==e?s:typeof e!=typeof s||e!==s?e:y(s,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(i[r]=!0)}if(!Object.keys(i).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=i,e}return i}}const h=function(e){e=e.replace(/\r\n?/g,"\n");const t=new s("!xml");let n=t,a="",r="";for(let o=0;o<e.length;o++){if("<"===e[o])if("/"===e[o+1]){const t=w(e,">",o,"Closing Tag is not closed.");let s=e.substring(o+2,t).trim();if(this.options.removeNSPrefix){const e=s.indexOf(":");-1!==e&&(s=s.substr(e+1))}this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&(a=this.saveTextToParentTag(a,n,r));const i=r.substring(r.lastIndexOf(".")+1);if(s&&-1!==this.options.unpairedTags.indexOf(s))throw new Error(`Unpaired tag can not be used as closing tag: </${s}>`);let c=0;i&&-1!==this.options.unpairedTags.indexOf(i)?(c=r.lastIndexOf(".",r.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=r.lastIndexOf("."),r=r.substring(0,c),n=this.tagsNodeStack.pop(),a="",o=t}else if("?"===e[o+1]){let t=_(e,o,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(a=this.saveTextToParentTag(a,n,r),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new s(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,r,t.tagName)),this.addChild(n,e,r)}o=t.closeIndex+1}else if("!--"===e.substr(o+1,3)){const t=w(e,"--\x3e",o+4,"Comment is not closed.");if(this.options.commentPropName){const s=e.substring(o+4,t-2);a=this.saveTextToParentTag(a,n,r),n.add(this.options.commentPropName,[{[this.options.textNodeName]:s}])}o=t}else if("!D"===e.substr(o+1,2)){const t=i(e,o);this.docTypeEntities=t.entities,o=t.i}else if("!["===e.substr(o+1,2)){const t=w(e,"]]>",o,"CDATA is not closed.")-2,s=e.substring(o+9,t);a=this.saveTextToParentTag(a,n,r);let i=this.parseTextData(s,n.tagname,r,!0,!1,!0,!0);null==i&&(i=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:s}]):n.add(this.options.textNodeName,i),o=t+2}else{let i=_(e,o,this.options.removeNSPrefix),c=i.tagName;const l=i.rawTagName;let d=i.tagExp,u=i.attrExpPresent,h=i.closeIndex;this.options.transformTagName&&(c=this.options.transformTagName(c)),n&&a&&"!xml"!==n.tagname&&(a=this.saveTextToParentTag(a,n,r,!1));const f=n;if(f&&-1!==this.options.unpairedTags.indexOf(f.tagname)&&(n=this.tagsNodeStack.pop(),r=r.substring(0,r.lastIndexOf("."))),c!==t.tagname&&(r+=r?"."+c:c),this.isItStopNode(this.options.stopNodes,r,c)){let t="";if(d.length>0&&d.lastIndexOf("/")===d.length-1)o=i.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(c))o=i.closeIndex;else{const n=this.readStopNodeData(e,l,h+1);if(!n)throw new Error(`Unexpected end of ${l}`);o=n.i,t=n.tagContent}const a=new s(c);c!==d&&u&&(a[":@"]=this.buildAttributesMap(d,r,c)),t&&(t=this.parseTextData(t,c,r,!0,u,!0,!0)),r=r.substr(0,r.lastIndexOf(".")),a.add(this.options.textNodeName,t),this.addChild(n,a,r)}else{if(d.length>0&&d.lastIndexOf("/")===d.length-1){"/"===c[c.length-1]?(c=c.substr(0,c.length-1),r=r.substr(0,r.length-1),d=c):d=d.substr(0,d.length-1),this.options.transformTagName&&(c=this.options.transformTagName(c));const e=new s(c);c!==d&&u&&(e[":@"]=this.buildAttributesMap(d,r,c)),this.addChild(n,e,r),r=r.substr(0,r.lastIndexOf("."))}else{const e=new s(c);this.tagsNodeStack.push(n),c!==d&&u&&(e[":@"]=this.buildAttributesMap(d,r,c)),this.addChild(n,e,r),n=e}a="",o=h}}else a+=e[o]}return t.child};function f(e,t,n){const a=this.options.updateTag(t.tagname,n,t[":@"]);!1===a||("string"==typeof a?(t.tagname=a,e.addChild(t)):e.addChild(t))}const p=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function g(e,t,n,a){return e&&(void 0===a&&(a=0===Object.keys(t.child).length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,a))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function m(e,t,n){const a="*."+n;for(const n in e){const s=e[n];if(a===s||t===s)return!0}return!1}function w(e,t,n,a){const s=e.indexOf(t,n);if(-1===s)throw new Error(a);return s+t.length-1}function _(e,t,n,a=">"){const s=function(e,t,n=">"){let a,s="";for(let i=t;i<e.length;i++){let t=e[i];if(a)t===a&&(a="");else if('"'===t||"'"===t)a=t;else if(t===n[0]){if(!n[1])return{data:s,index:i};if(e[i+1]===n[1])return{data:s,index:i}}else"\t"===t&&(t=" ");s+=t}}(e,t+1,a);if(!s)return;let i=s.data;const r=s.index,o=i.search(/\s/);let c=i,l=!0;-1!==o&&(c=i.substring(0,o),i=i.substring(o+1).trimStart());const d=c;if(n){const e=c.indexOf(":");-1!==e&&(c=c.substr(e+1),l=c!==s.data.substr(e+1))}return{tagName:c,tagExp:i,closeIndex:r,attrExpPresent:l,rawTagName:d}}function b(e,t,n){const a=n;let s=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=w(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(s--,0===s))return{tagContent:e.substring(a,n),i};n=i}else if("?"===e[n+1]){n=w(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=w(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=w(e,"]]>",n,"StopNode is not closed.")-2}else{const a=_(e,n,">");if(a){(a&&a.tagName)===t&&"/"!==a.tagExp[a.tagExp.length-1]&&s++,n=a.closeIndex}}}function y(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&r(e,n)}return a.isExist(e)?e:""}e.exports=class{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"Â¢"},pound:{regex:/&(pound|#163);/g,val:"Â£"},yen:{regex:/&(yen|#165);/g,val:"Â¥"},euro:{regex:/&(euro|#8364);/g,val:"â¬"},copyright:{regex:/&(copy|#169);/g,val:"Â©"},reg:{regex:/&(reg|#174);/g,val:"Â®"},inr:{regex:/&(inr|#8377);/g,val:"â¹"}},this.addExternalEntities=o,this.parseXml=h,this.parseTextData=c,this.resolveNameSpace=l,this.buildAttributesMap=u,this.isItStopNode=m,this.replaceEntitiesValue=p,this.readStopNodeData=b,this.saveTextToParentTag=g,this.addChild=f}}},58844:(e,t,n)=>{const{buildOptions:a}=n(66745),s=n(81078),{prettify:i}=n(16997),r=n(78501);e.exports=class{constructor(e){this.externalEntities={},this.options=a(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=r.validate(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new s(this.options);n.addExternalEntities(this.externalEntities);const a=n.parseXml(e);return this.options.preserveOrder||void 0===a?a:i(a,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}}},16997:(e,t)=>{"use strict";function n(e,t,r){let o;const c={};for(let l=0;l<e.length;l++){const d=e[l],u=a(d);let h="";if(h=void 0===r?u:r+"."+u,u===t.textNodeName)void 0===o?o=d[u]:o+=""+d[u];else{if(void 0===u)continue;if(d[u]){let e=n(d[u],t,h);const a=i(e,t);d[":@"]?s(e,d[":@"],h,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==c[u]&&c.hasOwnProperty(u)?(Array.isArray(c[u])||(c[u]=[c[u]]),c[u].push(e)):t.isArray(u,h,a)?c[u]=[e]:c[u]=e}}}return"string"==typeof o?o.length>0&&(c[t.textNodeName]=o):void 0!==o&&(c[t.textNodeName]=o),c}function a(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function s(e,t,n,a){if(t){const s=Object.keys(t),i=s.length;for(let r=0;r<i;r++){const i=s[r];a.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function i(e,t){const{textNodeName:n}=t,a=Object.keys(e).length;return 0===a||!(1!==a||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}t.prettify=function(e,t){return n(e,t)}},36311:e=>{"use strict";e.exports=class{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}},72315:(e,t,n)=>{!function(t){"use strict";e.exports=t(n(9673).ZP,n(84846).Z)}((function(e,t){"use strict";let n;const a={debug:()=>{},info:()=>{},error:()=>{}};var s=function(t,s){var i=this;if(n=t.logger||a,i._loggedIn=!1,i._loggingIn=!1,i._shouldLogOut=!1,s)i._client=s;else{var r={useSecureTransport:t.secure,ignoreTLS:t.ignoreTLS,requireTLS:t.requireTLS,auth:t.auth,ca:t.ca,tlsWorkerPath:t.tlsWorkerPath,enableCompression:!0,compressionWorkerPath:t.compressionWorkerPath,id:t.id};i._client=new e(t.host,t.port,r)}i._client.oncert=function(e){i.onCert(e)},i.mailboxCache={},i._registerEventHandlers(i._client)};function i(e){return e.childNodes?e.childNodes.some((e=>i(e))):/^text\/html/i.test(e.type)}function r(e,t,n){if(e.size&&(t.size+=e.size),e.childNodes)e.childNodes.forEach((function(e){r(e,t,n)}));else{n&&e.id&&e.disposition?.startsWith("inline")||!e.disposition?.startsWith("attachment")&&/^text\/(plain|html)/i.test(e.type)||(t.attachment+=1)}}function o(e,t){return e-t}return s.prototype._registerEventHandlers=function(e){e.onselectmailbox=this._onSelectMailbox.bind(this,e),e.onupdate=this._onUpdate.bind(this,e),e.onerror=this._onError.bind(this,e)},s.prototype._onError=function(e,t){var a="IMAP connection encountered an error! "+t;e===this._client&&(this._loggedIn=!1,n.error((()=>[new Error(a)])),this.onError(new Error(a)))},s.prototype._onSelectMailbox=function(e,t,a){var s,i=this;if(i.onSyncUpdate){if(n.debug((()=>["selected mailbox "+t])),i.mailboxCache[t]||(n.debug((()=>["populating cache object for mailbox "+t])),i.mailboxCache[t]={exists:0,uidNext:0,uidlist:[],highestModseq:"0"}),(s=i.mailboxCache[t]).noModseq=a.noModseq||!1,s.exists!==a.exists||s.uidNext!==a.uidNext){n.debug((()=>["possible updates available in "+t+". exists: "+a.exists+", uidNext: "+a.uidNext]));var r=0===s.exists;return s.exists=a.exists,s.uidNext=a.uidNext,i.search({path:t,client:e}).then((function(c){s.uidlist=s.uidlist||[];var l=0;for(var d of c){if(d<l){n.debug((()=>["imapUidList not sorted"])),c.sort(o);break}l=d}var u=function(e,t){var n=0,a=0,s=[],i=[];for(;n<e.length&&a<t.length;)e[n]<t[a]?(s.push(e[n]),n++):e[n]>t[a]?(i.push(t[a]),a++):(n++,a++);n===e.length?i=i.concat(t.slice(a)):a===t.length&&(s=s.concat(e.slice(n)));return[s,i]}(s.uidlist,c),h=u[0],f=u[1];return s.uidlist=c,Promise.resolve().then((function(){if(h.length)return n.debug((()=>["onSyncUpdate for deleted uids in "+t+": "+h])),i.onSyncUpdate({type:"deleted",path:t,list:h})})).then((function(){if(f.length)return n.debug((()=>["onSyncUpdate for new uids in "+t+": "+f])),i.onSyncUpdate({type:"new",path:t,list:f})})).then((function(){if(!r)return n.debug((()=>["no changes in message count in "+t+". exists: "+a.exists+", uidNext: "+a.uidNext])),i._checkFlags({path:t,highestModseq:a.highestModseq,noModseq:a.noModseq,client:e}).catch((function(e){n.error((()=>["error checking modseq: "+e+"\n"+e.stack]))}))}))}))}return n.debug((()=>["no changes in message count in "+t+". exists: "+a.exists+", uidNext: "+a.uidNext])),i._checkFlags({path:t,highestModseq:a.highestModseq,noModseq:a.noModseq,client:e}).catch((function(e){n.error((()=>["error checking modseq: "+e+"\n"+e.stack]))}))}},s.prototype._onUpdate=function(e,t,a,s){var i=this,r=i.mailboxCache[t];if(i.onSyncUpdate&&r)if("expunge"===a){n.debug((()=>["expunge notice received for "+t+" with sequence number: "+s]));var c=r.uidlist[s-1];r.uidlist.splice(s-1,1),c&&(n.debug((()=>["deleted uid in "+t+": "+c])),i.onSyncUpdate({type:"deleted",path:t,list:[c]}))}else"exists"===a?(n.debug((()=>["exists notice received for "+t+", checking for updates"])),r.exists=s,i.search({path:t,uid:r.uidNext+":*",client:e}).then((function(e){!e.length||1===e.length&&r.uidlist.indexOf(e[0])>=0||(e.sort(o),n.debug((()=>["new uids in "+t+": "+e])),r.uidlist=r.uidlist.concat(e),r.uidNext=r.uidlist[r.uidlist.length-1]+1,n.debug((()=>["new uids in "+t+": "+e])),i.onSyncUpdate({type:"new",path:t,list:e}))})).catch((function(e){n.error((()=>["error handling exists notice: "+e+"\n"+e.stack]))}))):"fetch"===a&&(n.debug((()=>["fetch notice received for "+t])),i.onSyncUpdate({type:"messages",path:t,list:[s].map((function(e){return!e.uid&&r.uidlist&&(e.uid=r.uidlist[e["#"]-1]),e}))}))},s.prototype._checkFlags=function(e){var t=this,a=e.highestModseq,s=e.noModseq,i=e.client||t._client,r=e.path;if(s)return n.info((()=>["can not check MODSEQ, mailbox has NOMODSEQ directive"])),new Promise((function(e){e([])}));if(!i.hasCapability("CONDSTORE")||!a||!r)return n.info((()=>["can not check MODSEQ, server does not support CONDSTORE extension"])),new Promise((function(e){e([])}));var o=t.mailboxCache[r];if(!o||!o.highestModseq||o.highestModseq===a)return new Promise((function(e){e([])}));var c=o.uidNext>1?o.uidNext-1:1;return n.debug((()=>["listing changes since MODSEQ "+a+" for "+r])),i.listMessages(r,"1:"+c,["uid","flags","modseq"],{byUid:!0,changedSince:o.highestModseq}).then((function(e){return o.highestModseq=a,e&&e.length?(n.debug((()=>["changes since MODSEQ "+a+" for "+r+" available!"])),t.onSyncUpdate({type:"messages",path:r,list:e})):[]})).catch((function(e){n.error((()=>["error handling exists notice: "+e+"\n"+e.stack]))}))},s.prototype.onSyncUpdate=!1,s.prototype.login=function(){var e=this;return e._loggedIn||e._loggingIn?(n.debug((()=>["refusing login while logged/logging in!"])),Promise.resolve()):(e._loggingIn=!0,e._client.connect().then((function(){if(n.debug((()=>["login completed, ready to roll!"])),e._loggedIn=!0,e._shouldLogOut)return e.logout()})).finally((function(){e._loggingIn=!1})))},s.prototype.logout=function(){var e=this;return e._loggingIn?(n.debug((()=>["currently logging in, will log right back out!"])),e._shouldLogOut=!0,Promise.resolve()):e._loggedIn?(e._loggedIn=!1,e._shouldLogOut=!1,e._client.close().then((function(){n.debug((()=>["logout completed, kthxbye!"]))}))):(n.debug((()=>["refusing logout while already logged out!"])),Promise.resolve())},s.prototype.selectMailbox=function(e){return n.debug((()=>["selecting mailbox "+e.path])),this._client.selectMailbox(e.path)},s.prototype.subscribeMailbox=function(e){return n.debug((()=>["subscribing to mailbox "+e.path])),this._client.subscribeMailbox(e.path)},s.prototype.unsubscribeMailbox=function(e){return n.debug((()=>["unsubscribing to mailbox "+e.path])),this._client.unsubscribeMailbox(e.path)},s.prototype.listWellKnownFolders=function(){var e=this,t={Inbox:[],Drafts:[],All:[],Flagged:[],Sent:[],Trash:[],Junk:[],Archive:[],Other:[]};return n.debug((()=>["listing folders"])),e._checkOnline().then((function(){return e._client.listMailboxes()})).then((function(e){return n.debug((()=>["folder list received!"])),a(e),t})).catch((function(e){throw n.error((()=>["error listing folders: "+e+"\n"+e.stack])),e}));function a(s){if(s.path&&-1===(s.flags||[]).indexOf("\\Noselect")){n.debug((()=>["name: "+s.name+", path: "+s.path+(s.flags?", flags: "+s.flags:"")+(s.specialUse?", special use: "+s.specialUse:"")]));var i={name:s.name||s.path,path:s.path,subscribed:s.subscribed,delimiter:s.delimiter};"INBOX"===i.name.toUpperCase()?(i.type="Inbox",e._delimiter=s.delimiter,t.Inbox.push(i)):"\\Drafts"===s.specialUse?(i.type="Drafts",t.Drafts.push(i)):"\\All"===s.specialUse?(i.type="All",t.All.push(i)):"\\Flagged"===s.specialUse?(i.type="Flagged",t.Flagged.push(i)):"\\Sent"===s.specialUse?(i.type="Sent",t.Sent.push(i)):"\\Trash"===s.specialUse?(i.type="Trash",t.Trash.push(i)):"\\Junk"===s.specialUse?(i.type="Junk",t.Junk.push(i)):"\\Archive"===s.specialUse||["ARCHIVE","ARCHIVES"].some((e=>function(e){return e.path.split(e.delimiter).map((e=>e.toUpperCase()))}(s).includes(e)))?(i.type="Archive",t.Archive.push(i)):(i.type="Other",t.Other.push(i))}s.children&&s.children.forEach(a)}},s.prototype.deleteFolder=function(e){var t=this;return t._checkOnline().then((function(){return t._client.deleteMailbox(e.path)})).catch((function(t){throw n.error((()=>["error deleting folder"+e.path+": "+t+"\n"+t.stack])),t}))},s.prototype.createFolder=function(e){var t,a=this,s=e.path;return Array.isArray(s)||(s=[s]),a._checkOnline().then((function(){if(void 0===a._delimiter||void 0===a._prefix)return a._client.listNamespaces().then((function(e){return e&&e.personal&&e.personal[0]?(a._delimiter=e.personal[0].delimiter,void(a._prefix=e.personal[0].prefix.split(a._delimiter).shift())):(a._prefix="",a._delimiter?void 0:a._client.listMailboxes().then((function(e){i(e)})))}))})).then((function(){if(!a._delimiter)throw new Error("Could not determine delimiter for mailbox hierarchy");return a._prefix&&s.unshift(a._prefix),t=s.join(a._delimiter),a._client.createMailbox(t)})).then((function(){return t})).catch((function(t){throw n.error((()=>["error creating folder "+e.path+": "+t+"\n"+t.stack])),t}));function i(e){"INBOX"!==(e.path||"").toUpperCase()?e.children&&e.children.forEach(i):a._delimiter=e.delimiter}},s.prototype.search=function(e){var t=e.client||this._client,a={},s={byUid:!0};return a.all=!0,!0===e.unread?a.unseen=!0:!1===e.unread&&(a.seen=!0),!0===e.answered?a.answered=!0:!1===e.answered&&(a.unanswered=!0),e.header&&(a.header=e.header),e.uid&&(a.uid=e.uid),n.debug((()=>["searching in "+e.path+" for "+Object.keys(a).join(",")])),this._checkOnline().then((function(){return t.search(e.path,a,s)})).then((function(t){return n.debug((()=>["searched in "+e.path+" for "+Object.keys(a).join(",")+" ("+t.length+" uids)"])),t})).catch((function(t){throw n.error((()=>["error searching "+e.path+": "+t+"\n"+t.stack])),t}))},s.prototype.listMessages=function(e){var t,a=this,s=["uid","bodystructure","flags","envelope","body.peek[header.fields (references list-id x-microsoft-original-message-id from list-post)]"],o={byUid:!0};this._client.hasCapability("X-GM-EXT-1")&&s.push("x-gm-msgid"),this._client.hasCapability("PREVIEW")&&s.push("preview"),t=e.uids?e.uids.join(","):e.sequence?e.sequence:(e.firstUid||1)+":"+(e.lastUid||"*");let c=a.mailboxCache[e.path];const l=c&&c.noModseq;return this._client.hasCapability("CONDSTORE")&&!l&&s.push("modseq"),n.debug((()=>["listing messages in "+e.path+" for interval "+t])),a._checkOnline().then((function(){return a._client.listMessages(e.path,t,s,o)})).then((function(e){var t=[];return e.forEach((function(e){if(!e.envelope||!e.uid)return void n.debug((()=>["message is malformed: "+JSON.stringify(e)]));var s=e["body[header.fields (references list-id x-microsoft-original-message-id from list-post)]"];s&&(s=s.replace(/\r?\n([ \t])/g,"$1"));var o=/References:\s*((?:<\S+>\s*)+)/.exec(s),c=/list-id *: *(.*(?:\r?\n[\t ].+)*)/i.exec(s),l=/list-post *: *(.*(?:\r?\n[\t ].+)*)/i.exec(s),d=/X-Microsoft-Original-Message-ID:\s*\S*\s<(\S+)>/.exec(s);const u=e.envelope.from||[];a._addFromHeaderAddresses(u,s);var h=Date.now(),f=Date.parse(e.envelope.date)||h;f>h&&(f=h);let p="";Array.isArray(e.preview)?p=e.preview[1].value:"string"==typeof e.preview?p=e.preview:e.preview&&n.debug("Message preview of unexpected type:",e.preview,typeof e.preview);var g={uid:e.uid,messageId:(e.envelope["message-id"]||"").replace(/[<>]/g,"").trim(),originalMessageId:d?d[1]:"",listId:c?c[1]:"",listPost:l?l[1]:"",gmailId:e["x-gm-msgid"]||"",from:u,replyTo:e.envelope["reply-to"]||[],to:e.envelope.to||[],cc:e.envelope.cc||[],bcc:e.envelope.bcc||[],modseq:e.modseq||"0",subject:e.envelope.subject||"(no subject)",preview:p,inReplyTo:(e.envelope["in-reply-to"]||"").replace(/[<>]/g,"").trim(),references:o?o[1].split(/\s+/).filter((function(e){return""!==e})).map((function(e){return e.replace(/[<>]/g,"")})):[],sentDate:f,flags:e.flags||[],attachment:0,size:0};const m=e.bodystructure||{};r(m,g,i(m)),n.debug((()=>["listing message: [uid: "+g.uid+"]"])),t.push(g)})),t})).catch((function(t){throw n.error((()=>["error listing messages in "+e.path+": "+t+"\n"+t.stack])),t}))},s.prototype.getMessages=function(e){var t=this,a=["body.peek[]"],s={byUid:!0,valueAsString:!1},i=e.uids.join(",");return n.debug((()=>["retrieving body parts for uid(s) "+i+" in folder "+e.path+": "+a])),t._checkOnline().then((function(){return t._client.listMessages(e.path,i,a,s)})).then((function(e){const t={};return e.forEach((function(e){t[e.uid]=e["body[]"]})),t})).catch((function(t){throw n.error((()=>["error fetching message for uid(s) "+i+" in folder "+e.path+": "+t+"\n"+t.stack])),t}))},s.prototype.updateFlags=function(e){const t=e.uids.sort(o);let a=t[0],s=[];function i(e){e===a?s.push(a):s.push(a+":"+e)}for(let e=1;e<t.length;e++)t[e]-t[e-1]!=1&&(i(t[e-1]),a=t[e]);i(t[t.length-1]);const r=s.join(",");var c=this,l={byUid:!0},d=e.add||[],u=e.remove||[];return n.debug((()=>["updating flags for uids "+r+" in folder "+e.path+": "+(u.length>0?" removing "+u:"")+(d.length>0?" adding "+d:"")])),c._checkOnline().then((function(){if(d.length>0)return c._client.setFlags(e.path,r,{add:d},l)})).then((function(){if(u.length>0)return c._client.setFlags(e.path,r,{remove:u},l)})).then((function(){n.debug((()=>["successfully updated flags for uids "+r+" in folder "+e.path+": added "+d+" and removed "+u]))})).catch((function(t){throw n.error((()=>["error updating flags for uids "+r+" in folder "+e.path+" : "+t+"\n"+t.stack])),t}))},s.prototype.copyMessages=function(e){var t=this;return n.debug((()=>["copying uids "+e.uids+" from "+e.path+" to "+e.destination])),t._checkOnline().then((function(){var n=e.uids.join(",");return t._client.copyMessages(e.path,n,e.destination,{byUid:!0})})).then((function(t){return n.debug((()=>["successfully copied uids "+e.uids+" from "+e.path+" to "+e.destination])),t})).catch((function(t){throw n.error((()=>["error copying uids "+e.uids+" from "+e.path+" to "+e.destination+" : "+t+"\n"+t.stack])),t}))},s.prototype.moveMessages=function(e){var t=this;return n.debug((()=>["moving uids "+e.uids+" from "+e.path+" to "+e.destination])),t._checkOnline().then((function(){var n=e.uids.join(",");return t._client.moveMessages(e.path,n,e.destination,{byUid:!0})})).then((function(){n.debug((()=>["successfully moved uids "+e.uids+" from "+e.path+" to "+e.destination]))})).catch((function(t){throw n.error((()=>["error moving uids "+e.uids+" from "+e.path+" to "+e.destination+" : "+t+"\n"+t.stack])),t}))},s.prototype.uploadMessage=function(e){var t=this,a=e.message instanceof Uint8Array?function(e){const t=10240,n=[];for(var a=0;a<e.length;a+=t){const s=a,i=Math.min(a+t,e.length);n.push(String.fromCharCode.apply(null,e.subarray(s,i)))}return n.join("")}(e.message):e.message,s=Array.isArray(e.flags)&&e.flags.length>0?{flags:e.flags}:{};return n.debug((()=>["uploading a message of "+a.length+" bytes to "+e.path])),t._checkOnline().then((function(){return t._client.upload(e.path,a,s)})).then((function(t){return n.debug((()=>["successfully uploaded message to "+e.path])),t})).catch((function(t){throw n.error((()=>["error uploading <"+a.length+"> bytes to "+e.path+" : "+t+"\n"+t.stack])),t}))},s.prototype.deleteMessages=function(e){var t=this;return n.debug((()=>["deleting uid "+e.uid+" from "+e.path])),t._checkOnline().then((function(){var n=e.uids.join(",");return t._client.deleteMessages(e.path,n,{byUid:!0})})).then((function(){n.debug((()=>["successfully deleted uid "+e.uid+" from "+e.path]))})).catch((function(t){throw n.error((()=>["error deleting uid "+e.uid+" from "+e.path+" : "+t+"\n"+t.stack])),t}))},s.prototype._addFromHeaderAddresses=function(e,n){if(n)for(const a of n.matchAll(/from\s*:\s*([^\n\r]+)/gi))if(a.length>1&&a[1]){const n=t(a[1])||[];for(const t of n){const n=e.find((e=>e.address===t.address));n?n.name||(n.name=t.name):e.push(t)}}},s.prototype._checkOnline=function(){var e=this;return new Promise((function(t){if(!e._loggedIn)throw new Error("Not logged in!");t()}))},s}))},24236:(e,t)=>{"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function a(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var s in n)a(n,s)&&(e[s]=n[s])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var s={arraySet:function(e,t,n,a,s){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+a),s);else for(var i=0;i<a;i++)e[s+i]=t[n+i]},flattenChunks:function(e){var t,n,a,s,i,r;for(a=0,t=0,n=e.length;t<n;t++)a+=e[t].length;for(r=new Uint8Array(a),s=0,t=0,n=e.length;t<n;t++)i=e[t],r.set(i,s),s+=i.length;return r}},i={arraySet:function(e,t,n,a,s){for(var i=0;i<a;i++)e[s+i]=t[n+i]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,s)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,i))},t.setTyped(n)},66069:e=>{"use strict";e.exports=function(e,t,n,a){for(var s=65535&e|0,i=e>>>16&65535|0,r=0;0!==n;){n-=r=n>2e3?2e3:n;do{i=i+(s=s+t[a++]|0)|0}while(--r);s%=65521,i%=65521}return s|i<<16|0}},71619:e=>{"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},2869:e=>{"use strict";var t=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var a=0;a<8;a++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();e.exports=function(e,n,a,s){var i=t,r=s+a;e^=-1;for(var o=s;o<r;o++)e=e>>>8^i[255&(e^n[o])];return-1^e}},30405:(e,t,n)=>{"use strict";var a,s=n(24236),i=n(10342),r=n(66069),o=n(2869),c=n(48898),l=-2,d=258,u=262,h=103,f=113,p=666;function g(e,t){return e.msg=c[t],t}function m(e){return(e<<1)-(e>4?9:0)}function w(e){for(var t=e.length;--t>=0;)e[t]=0}function _(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(s.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function b(e,t){i._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,_(e.strm)}function y(e,t){e.pending_buf[e.pending++]=t}function v(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function I(e,t){var n,a,s=e.max_chain_length,i=e.strstart,r=e.prev_length,o=e.nice_match,c=e.strstart>e.w_size-u?e.strstart-(e.w_size-u):0,l=e.window,h=e.w_mask,f=e.prev,p=e.strstart+d,g=l[i+r-1],m=l[i+r];e.prev_length>=e.good_match&&(s>>=2),o>e.lookahead&&(o=e.lookahead);do{if(l[(n=t)+r]===m&&l[n+r-1]===g&&l[n]===l[i]&&l[++n]===l[i+1]){i+=2,n++;do{}while(l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&i<p);if(a=d-(p-i),i=p-d,a>r){if(e.match_start=t,r=a,a>=o)break;g=l[i+r-1],m=l[i+r]}}}while((t=f[t&h])>c&&0!=--s);return r<=e.lookahead?r:e.lookahead}function k(e){var t,n,a,i,c,l,d,h,f,p,g=e.w_size;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=g+(g-u)){s.arraySet(e.window,e.window,g,g,0),e.match_start-=g,e.strstart-=g,e.block_start-=g,t=n=e.hash_size;do{a=e.head[--t],e.head[t]=a>=g?a-g:0}while(--n);t=n=g;do{a=e.prev[--t],e.prev[t]=a>=g?a-g:0}while(--n);i+=g}if(0===e.strm.avail_in)break;if(l=e.strm,d=e.window,h=e.strstart+e.lookahead,f=i,p=void 0,(p=l.avail_in)>f&&(p=f),n=0===p?0:(l.avail_in-=p,s.arraySet(d,l.input,l.next_in,p,h),1===l.state.wrap?l.adler=r(l.adler,d,p,h):2===l.state.wrap&&(l.adler=o(l.adler,d,p,h)),l.next_in+=p,l.total_in+=p,p),e.lookahead+=n,e.lookahead+e.insert>=3)for(c=e.strstart-e.insert,e.ins_h=e.window[c],e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+3-1])&e.hash_mask,e.prev[c&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=c,c++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<u&&0!==e.strm.avail_in)}function E(e,t){for(var n,a;;){if(e.lookahead<u){if(k(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n)),e.match_length>=3)if(a=i._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else a=i._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(a&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function x(e,t){for(var n,a,s;;){if(e.lookahead<u){if(k(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,a=i._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,a&&(b(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((a=i._tr_tally(e,0,e.window[e.strstart-1]))&&b(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(a=i._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function A(e,t,n,a,s){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=a,this.func=s}function S(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(1146),this.dyn_dtree=new s.Buf16(122),this.bl_tree=new s.Buf16(78),w(this.dyn_ltree),w(this.dyn_dtree),w(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(16),this.heap=new s.Buf16(573),w(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(573),w(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function M(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:f,e.adler=2===t.wrap?0:1,t.last_flush=0,i._tr_init(t),0):g(e,l)}function O(e){var t,n=M(e);return 0===n&&((t=e.state).window_size=2*t.w_size,w(t.head),t.max_lazy_match=a[t.level].max_lazy,t.good_match=a[t.level].good_length,t.nice_match=a[t.level].nice_length,t.max_chain_length=a[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),n}function N(e,t,n,a,i,r){if(!e)return l;var o=1;if(-1===t&&(t=6),a<0?(o=0,a=-a):a>15&&(o=2,a-=16),i<1||i>9||8!==n||a<8||a>15||t<0||t>9||r<0||r>4)return g(e,l);8===a&&(a=9);var c=new S;return e.state=c,c.strm=e,c.wrap=o,c.gzhead=null,c.w_bits=a,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=i+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+3-1)/3),c.window=new s.Buf8(2*c.w_size),c.head=new s.Buf16(c.hash_size),c.prev=new s.Buf16(c.w_size),c.lit_bufsize=1<<i+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new s.Buf8(c.pending_buf_size),c.d_buf=1*c.lit_bufsize,c.l_buf=3*c.lit_bufsize,c.level=t,c.strategy=r,c.method=n,O(e)}a=[new A(0,0,0,0,(function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(k(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var a=e.block_start+n;if((0===e.strstart||e.strstart>=a)&&(e.lookahead=e.strstart-a,e.strstart=a,b(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-u&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(b(e,!1),e.strm.avail_out),1)})),new A(4,4,8,4,E),new A(4,5,16,8,E),new A(4,6,32,32,E),new A(4,4,16,16,x),new A(8,16,32,32,x),new A(8,16,128,128,x),new A(8,32,128,256,x),new A(32,128,258,1024,x),new A(32,258,258,4096,x)],t.Ue=N,t.Wt=function(e,t){var n,s,r,c;if(!e||!e.state||t>5||t<0)return e?g(e,l):l;if(s=e.state,!e.output||!e.input&&0!==e.avail_in||s.status===p&&4!==t)return g(e,0===e.avail_out?-5:l);if(s.strm=e,n=s.last_flush,s.last_flush=t,42===s.status)if(2===s.wrap)e.adler=0,y(s,31),y(s,139),y(s,8),s.gzhead?(y(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),y(s,255&s.gzhead.time),y(s,s.gzhead.time>>8&255),y(s,s.gzhead.time>>16&255),y(s,s.gzhead.time>>24&255),y(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),y(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(y(s,255&s.gzhead.extra.length),y(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(e.adler=o(e.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=69):(y(s,0),y(s,0),y(s,0),y(s,0),y(s,0),y(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),y(s,3),s.status=f);else{var u=8+(s.w_bits-8<<4)<<8;u|=(s.strategy>=2||s.level<2?0:s.level<6?1:6===s.level?2:3)<<6,0!==s.strstart&&(u|=32),u+=31-u%31,s.status=f,v(s,u),0!==s.strstart&&(v(s,e.adler>>>16),v(s,65535&e.adler)),e.adler=1}if(69===s.status)if(s.gzhead.extra){for(r=s.pending;s.gzindex<(65535&s.gzhead.extra.length)&&(s.pending!==s.pending_buf_size||(s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),_(e),r=s.pending,s.pending!==s.pending_buf_size));)y(s,255&s.gzhead.extra[s.gzindex]),s.gzindex++;s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),s.gzindex===s.gzhead.extra.length&&(s.gzindex=0,s.status=73)}else s.status=73;if(73===s.status)if(s.gzhead.name){r=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),_(e),r=s.pending,s.pending===s.pending_buf_size)){c=1;break}c=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,y(s,c)}while(0!==c);s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),0===c&&(s.gzindex=0,s.status=91)}else s.status=91;if(91===s.status)if(s.gzhead.comment){r=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),_(e),r=s.pending,s.pending===s.pending_buf_size)){c=1;break}c=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,y(s,c)}while(0!==c);s.gzhead.hcrc&&s.pending>r&&(e.adler=o(e.adler,s.pending_buf,s.pending-r,r)),0===c&&(s.status=h)}else s.status=h;if(s.status===h&&(s.gzhead.hcrc?(s.pending+2>s.pending_buf_size&&_(e),s.pending+2<=s.pending_buf_size&&(y(s,255&e.adler),y(s,e.adler>>8&255),e.adler=0,s.status=f)):s.status=f),0!==s.pending){if(_(e),0===e.avail_out)return s.last_flush=-1,0}else if(0===e.avail_in&&m(t)<=m(n)&&4!==t)return g(e,-5);if(s.status===p&&0!==e.avail_in)return g(e,-5);if(0!==e.avail_in||0!==s.lookahead||0!==t&&s.status!==p){var I=2===s.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(k(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,n=i._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(s,t):3===s.strategy?function(e,t){for(var n,a,s,r,o=e.window;;){if(e.lookahead<=d){if(k(e),e.lookahead<=d&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(a=o[s=e.strstart-1])===o[++s]&&a===o[++s]&&a===o[++s]){r=e.strstart+d;do{}while(a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&a===o[++s]&&s<r);e.match_length=d-(r-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=i._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=i._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(s,t):a[s.level].func(s,t);if(3!==I&&4!==I||(s.status=p),1===I||3===I)return 0===e.avail_out&&(s.last_flush=-1),0;if(2===I&&(1===t?i._tr_align(s):5!==t&&(i._tr_stored_block(s,0,0,!1),3===t&&(w(s.head),0===s.lookahead&&(s.strstart=0,s.block_start=0,s.insert=0))),_(e),0===e.avail_out))return s.last_flush=-1,0}return 4!==t?0:s.wrap<=0?1:(2===s.wrap?(y(s,255&e.adler),y(s,e.adler>>8&255),y(s,e.adler>>16&255),y(s,e.adler>>24&255),y(s,255&e.total_in),y(s,e.total_in>>8&255),y(s,e.total_in>>16&255),y(s,e.total_in>>24&255)):(v(s,e.adler>>>16),v(s,65535&e.adler)),_(e),s.wrap>0&&(s.wrap=-s.wrap),0!==s.pending?0:1)}},94264:e=>{"use strict";e.exports=function(e,t){var n,a,s,i,r,o,c,l,d,u,h,f,p,g,m,w,_,b,y,v,I,k,E,x,A;n=e.state,a=e.next_in,x=e.input,s=a+(e.avail_in-5),i=e.next_out,A=e.output,r=i-(t-e.avail_out),o=i+(e.avail_out-257),c=n.dmax,l=n.wsize,d=n.whave,u=n.wnext,h=n.window,f=n.hold,p=n.bits,g=n.lencode,m=n.distcode,w=(1<<n.lenbits)-1,_=(1<<n.distbits)-1;e:do{p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=g[f&w];t:for(;;){if(f>>>=y=b>>>24,p-=y,0===(y=b>>>16&255))A[i++]=65535&b;else{if(!(16&y)){if(0==(64&y)){b=g[(65535&b)+(f&(1<<y)-1)];continue t}if(32&y){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}v=65535&b,(y&=15)&&(p<y&&(f+=x[a++]<<p,p+=8),v+=f&(1<<y)-1,f>>>=y,p-=y),p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=m[f&_];n:for(;;){if(f>>>=y=b>>>24,p-=y,!(16&(y=b>>>16&255))){if(0==(64&y)){b=m[(65535&b)+(f&(1<<y)-1)];continue n}e.msg="invalid distance code",n.mode=30;break e}if(I=65535&b,p<(y&=15)&&(f+=x[a++]<<p,(p+=8)<y&&(f+=x[a++]<<p,p+=8)),(I+=f&(1<<y)-1)>c){e.msg="invalid distance too far back",n.mode=30;break e}if(f>>>=y,p-=y,I>(y=i-r)){if((y=I-y)>d&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(k=0,E=h,0===u){if(k+=l-y,y<v){v-=y;do{A[i++]=h[k++]}while(--y);k=i-I,E=A}}else if(u<y){if(k+=l+u-y,(y-=u)<v){v-=y;do{A[i++]=h[k++]}while(--y);if(k=0,u<v){v-=y=u;do{A[i++]=h[k++]}while(--y);k=i-I,E=A}}}else if(k+=u-y,y<v){v-=y;do{A[i++]=h[k++]}while(--y);k=i-I,E=A}for(;v>2;)A[i++]=E[k++],A[i++]=E[k++],A[i++]=E[k++],v-=3;v&&(A[i++]=E[k++],v>1&&(A[i++]=E[k++]))}else{k=i-I;do{A[i++]=A[k++],A[i++]=A[k++],A[i++]=A[k++],v-=3}while(v>2);v&&(A[i++]=A[k++],v>1&&(A[i++]=A[k++]))}break}}break}}while(a<s&&i<o);a-=v=p>>3,f&=(1<<(p-=v<<3))-1,e.next_in=a,e.next_out=i,e.avail_in=a<s?s-a+5:5-(a-s),e.avail_out=i<o?o-i+257:257-(i-o),n.hold=f,n.bits=p}},27948:(e,t,n)=>{"use strict";var a=n(24236),s=n(66069),i=n(2869),r=n(94264),o=n(9241),c=-2,l=12,d=30;function u(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function h(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new a.Buf16(320),this.work=new a.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function f(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new a.Buf32(852),t.distcode=t.distdyn=new a.Buf32(592),t.sane=1,t.back=-1,0):c}function p(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,f(e)):c}function g(e,t){var n,a;return e&&e.state?(a=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?c:(null!==a.window&&a.wbits!==t&&(a.window=null),a.wrap=n,a.wbits=t,p(e))):c}function m(e,t){var n,a;return e?(a=new h,e.state=a,a.window=null,0!==(n=g(e,t))&&(e.state=null),n):c}var w,_,b=!0;function y(e){if(b){var t;for(w=new a.Buf32(512),_=new a.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(1,e.lens,0,288,w,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(2,e.lens,0,32,_,0,e.work,{bits:5}),b=!1}e.lencode=w,e.lenbits=9,e.distcode=_,e.distbits=5}function v(e,t,n,s){var i,r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new a.Buf8(r.wsize)),s>=r.wsize?(a.arraySet(r.window,t,n-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):((i=r.wsize-r.wnext)>s&&(i=s),a.arraySet(r.window,t,n-s,i,r.wnext),(s-=i)?(a.arraySet(r.window,t,n-s,s,0),r.wnext=s,r.whave=r.wsize):(r.wnext+=i,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=i))),0}t.Ul=m,t.rr=function(e,t){var n,h,f,p,g,m,w,_,b,I,k,E,x,A,S,M,O,N,Z,T,L,R,P,C,U=0,F=new a.Buf8(4),D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return c;(n=e.state).mode===l&&(n.mode=13),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,I=m,k=w,R=0;e:for(;;)switch(n.mode){case 1:if(0===n.wrap){n.mode=13;break}for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(2&n.wrap&&35615===_){n.check=0,F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0),_=0,b=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&_)<<8)+(_>>8))%31){e.msg="incorrect header check",n.mode=d;break}if(8!=(15&_)){e.msg="unknown compression method",n.mode=d;break}if(b-=4,L=8+(15&(_>>>=4)),0===n.wbits)n.wbits=L;else if(L>n.wbits){e.msg="invalid window size",n.mode=d;break}n.dmax=1<<L,e.adler=n.check=1,n.mode=512&_?10:l,_=0,b=0;break;case 2:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.flags=_,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=d;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=d;break}n.head&&(n.head.text=_>>8&1),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0)),_=0,b=0,n.mode=3;case 3:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.time=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,F[2]=_>>>16&255,F[3]=_>>>24&255,n.check=i(n.check,F,4,0)),_=0,b=0,n.mode=4;case 4:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.xflags=255&_,n.head.os=_>>8),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0)),_=0,b=0,n.mode=5;case 5:if(1024&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length=_,n.head&&(n.head.extra_len=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=i(n.check,F,2,0)),_=0,b=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((E=n.length)>m&&(E=m),E&&(n.head&&(L=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),a.arraySet(n.head.extra,h,p,E,L)),512&n.flags&&(n.check=i(n.check,h,E,p)),m-=E,p+=E,n.length-=E),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===m)break e;E=0;do{L=h[p+E++],n.head&&L&&n.length<65536&&(n.head.name+=String.fromCharCode(L))}while(L&&E<m);if(512&n.flags&&(n.check=i(n.check,h,E,p)),m-=E,p+=E,L)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===m)break e;E=0;do{L=h[p+E++],n.head&&L&&n.length<65536&&(n.head.comment+=String.fromCharCode(L))}while(L&&E<m);if(512&n.flags&&(n.check=i(n.check,h,E,p)),m-=E,p+=E,L)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(65535&n.check)){e.msg="header crc mismatch",n.mode=d;break}_=0,b=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=l;break;case 10:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}e.adler=n.check=u(_),_=0,b=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,2;e.adler=n.check=1,n.mode=l;case l:if(5===t||6===t)break e;case 13:if(n.last){_>>>=7&b,b-=7&b,n.mode=27;break}for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}switch(n.last=1&_,b-=1,3&(_>>>=1)){case 0:n.mode=14;break;case 1:if(y(n),n.mode=20,6===t){_>>>=2,b-=2;break e}break;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=d}_>>>=2,b-=2;break;case 14:for(_>>>=7&b,b-=7&b;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if((65535&_)!=(_>>>16^65535)){e.msg="invalid stored block lengths",n.mode=d;break}if(n.length=65535&_,_=0,b=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(E=n.length){if(E>m&&(E=m),E>w&&(E=w),0===E)break e;a.arraySet(f,h,p,E,g),m-=E,p+=E,w-=E,g+=E,n.length-=E;break}n.mode=l;break;case 17:for(;b<14;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.nlen=257+(31&_),_>>>=5,b-=5,n.ndist=1+(31&_),_>>>=5,b-=5,n.ncode=4+(15&_),_>>>=4,b-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=d;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.lens[D[n.have++]]=7&_,_>>>=3,b-=3}for(;n.have<19;)n.lens[D[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,P={bits:n.lenbits},R=o(0,n.lens,0,19,n.lencode,0,n.work,P),n.lenbits=P.bits,R){e.msg="invalid code lengths set",n.mode=d;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(O<16)_>>>=S,b-=S,n.lens[n.have++]=O;else{if(16===O){for(C=S+2;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_>>>=S,b-=S,0===n.have){e.msg="invalid bit length repeat",n.mode=d;break}L=n.lens[n.have-1],E=3+(3&_),_>>>=2,b-=2}else if(17===O){for(C=S+3;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,L=0,E=3+(7&(_>>>=S)),_>>>=3,b-=3}else{for(C=S+7;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,L=0,E=11+(127&(_>>>=S)),_>>>=7,b-=7}if(n.have+E>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=d;break}for(;E--;)n.lens[n.have++]=L}}if(n.mode===d)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=d;break}if(n.lenbits=9,P={bits:n.lenbits},R=o(1,n.lens,0,n.nlen,n.lencode,0,n.work,P),n.lenbits=P.bits,R){e.msg="invalid literal/lengths set",n.mode=d;break}if(n.distbits=6,n.distcode=n.distdyn,P={bits:n.distbits},R=o(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,P),n.distbits=P.bits,R){e.msg="invalid distances set",n.mode=d;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(m>=6&&w>=258){e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,r(e,k),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,n.mode===l&&(n.back=-1);break}for(n.back=0;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(M&&0==(240&M)){for(N=S,Z=M,T=O;M=(U=n.lencode[T+((_&(1<<N+Z)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,n.length=O,0===M){n.mode=26;break}if(32&M){n.back=-1,n.mode=l;break}if(64&M){e.msg="invalid literal/length code",n.mode=d;break}n.extra=15&M,n.mode=22;case 22:if(n.extra){for(C=n.extra;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;M=(U=n.distcode[_&(1<<n.distbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(0==(240&M)){for(N=S,Z=M,T=O;M=(U=n.distcode[T+((_&(1<<N+Z)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,64&M){e.msg="invalid distance code",n.mode=d;break}n.offset=O,n.extra=15&M,n.mode=24;case 24:if(n.extra){for(C=n.extra;b<C;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.offset+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=d;break}n.mode=25;case 25:if(0===w)break e;if(E=k-w,n.offset>E){if((E=n.offset-E)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=d;break}E>n.wnext?(E-=n.wnext,x=n.wsize-E):x=n.wnext-E,E>n.length&&(E=n.length),A=n.window}else A=f,x=g-n.offset,E=n.length;E>w&&(E=w),w-=E,n.length-=E;do{f[g++]=A[x++]}while(--E);0===n.length&&(n.mode=21);break;case 26:if(0===w)break e;f[g++]=n.length,w--,n.mode=21;break;case 27:if(n.wrap){for(;b<32;){if(0===m)break e;m--,_|=h[p++]<<b,b+=8}if(k-=w,e.total_out+=k,n.total+=k,k&&(e.adler=n.check=n.flags?i(n.check,f,k,g-k):s(n.check,f,k,g-k)),k=w,(n.flags?_:u(_))!==n.check){e.msg="incorrect data check",n.mode=d;break}_=0,b=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=d;break}_=0,b=0}n.mode=29;case 29:R=1;break e;case d:R=-3;break e;case 31:return-4;default:return c}return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,(n.wsize||k!==e.avail_out&&n.mode<d&&(n.mode<27||4!==t))&&v(e,e.output,e.next_out,k-e.avail_out)?(n.mode=31,-4):(I-=e.avail_in,k-=e.avail_out,e.total_in+=I,e.total_out+=k,n.total+=k,n.wrap&&k&&(e.adler=n.check=n.flags?i(n.check,f,k,e.next_out-k):s(n.check,f,k,e.next_out-k)),e.data_type=n.bits+(n.last?64:0)+(n.mode===l?128:0)+(20===n.mode||15===n.mode?256:0),(0===I&&0===k||4===t)&&0===R&&(R=-5),R)}},9241:(e,t,n)=>{"use strict";var a=n(24236),s=15,i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],c=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(e,t,n,l,d,u,h,f){var p,g,m,w,_,b,y,v,I,k=f.bits,E=0,x=0,A=0,S=0,M=0,O=0,N=0,Z=0,T=0,L=0,R=null,P=0,C=new a.Buf16(16),U=new a.Buf16(16),F=null,D=0;for(E=0;E<=s;E++)C[E]=0;for(x=0;x<l;x++)C[t[n+x]]++;for(M=k,S=s;S>=1&&0===C[S];S--);if(M>S&&(M=S),0===S)return d[u++]=20971520,d[u++]=20971520,f.bits=1,0;for(A=1;A<S&&0===C[A];A++);for(M<A&&(M=A),Z=1,E=1;E<=s;E++)if(Z<<=1,(Z-=C[E])<0)return-1;if(Z>0&&(0===e||1!==S))return-1;for(U[1]=0,E=1;E<s;E++)U[E+1]=U[E]+C[E];for(x=0;x<l;x++)0!==t[n+x]&&(h[U[t[n+x]]++]=x);if(0===e?(R=F=h,b=19):1===e?(R=i,P-=257,F=r,D-=257,b=256):(R=o,F=c,b=-1),L=0,x=0,E=A,_=u,O=M,N=0,m=-1,w=(T=1<<M)-1,1===e&&T>852||2===e&&T>592)return 1;for(;;){y=E-N,h[x]<b?(v=0,I=h[x]):h[x]>b?(v=F[D+h[x]],I=R[P+h[x]]):(v=96,I=0),p=1<<E-N,A=g=1<<O;do{d[_+(L>>N)+(g-=p)]=y<<24|v<<16|I|0}while(0!==g);for(p=1<<E-1;L&p;)p>>=1;if(0!==p?(L&=p-1,L+=p):L=0,x++,0==--C[E]){if(E===S)break;E=t[n+h[x]]}if(E>M&&(L&w)!==m){for(0===N&&(N=M),_+=A,Z=1<<(O=E-N);O+N<S&&!((Z-=C[O+N])<=0);)O++,Z<<=1;if(T+=1<<O,1===e&&T>852||2===e&&T>592)return 1;d[m=L&w]=M<<24|O<<16|_-u|0}}return 0!==L&&(d[_+L]=E-N<<24|64<<16|0),f.bits=M,0}},48898:e=>{"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},10342:(e,t,n)=>{"use strict";var a=n(24236);function s(e){for(var t=e.length;--t>=0;)e[t]=0}var i=256,r=286,o=30,c=15,l=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],d=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],h=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],f=new Array(576);s(f);var p=new Array(60);s(p);var g=new Array(512);s(g);var m=new Array(256);s(m);var w=new Array(29);s(w);var _,b,y,v=new Array(o);function I(e,t,n,a,s){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=a,this.max_length=s,this.has_stree=e&&e.length}function k(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function E(e){return e<256?g[e]:g[256+(e>>>7)]}function x(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function A(e,t,n){e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,x(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function S(e,t,n){A(e,n[2*t],n[2*t+1])}function M(e,t){var n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}function O(e,t,n){var a,s,i=new Array(16),r=0;for(a=1;a<=c;a++)i[a]=r=r+n[a-1]<<1;for(s=0;s<=t;s++){var o=e[2*s+1];0!==o&&(e[2*s]=M(i[o]++,o))}}function N(e){var t;for(t=0;t<r;t++)e.dyn_ltree[2*t]=0;for(t=0;t<o;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function Z(e){e.bi_valid>8?x(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function T(e,t,n,a){var s=2*t,i=2*n;return e[s]<e[i]||e[s]===e[i]&&a[t]<=a[n]}function L(e,t,n){for(var a=e.heap[n],s=n<<1;s<=e.heap_len&&(s<e.heap_len&&T(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!T(t,a,e.heap[s],e.depth));)e.heap[n]=e.heap[s],n=s,s<<=1;e.heap[n]=a}function R(e,t,n){var a,s,r,o,c=0;if(0!==e.last_lit)do{a=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],s=e.pending_buf[e.l_buf+c],c++,0===a?S(e,s,t):(S(e,(r=m[s])+i+1,t),0!==(o=l[r])&&A(e,s-=w[r],o),S(e,r=E(--a),n),0!==(o=d[r])&&A(e,a-=v[r],o))}while(c<e.last_lit);S(e,256,t)}function P(e,t){var n,a,s,i=t.dyn_tree,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,d=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<l;n++)0!==i[2*n]?(e.heap[++e.heap_len]=d=n,e.depth[n]=0):i[2*n+1]=0;for(;e.heap_len<2;)i[2*(s=e.heap[++e.heap_len]=d<2?++d:0)]=1,e.depth[s]=0,e.opt_len--,o&&(e.static_len-=r[2*s+1]);for(t.max_code=d,n=e.heap_len>>1;n>=1;n--)L(e,i,n);s=l;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],L(e,i,1),a=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=a,i[2*s]=i[2*n]+i[2*a],e.depth[s]=(e.depth[n]>=e.depth[a]?e.depth[n]:e.depth[a])+1,i[2*n+1]=i[2*a+1]=s,e.heap[1]=s++,L(e,i,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var n,a,s,i,r,o,l=t.dyn_tree,d=t.max_code,u=t.stat_desc.static_tree,h=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,g=t.stat_desc.max_length,m=0;for(i=0;i<=c;i++)e.bl_count[i]=0;for(l[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<573;n++)(i=l[2*l[2*(a=e.heap[n])+1]+1]+1)>g&&(i=g,m++),l[2*a+1]=i,a>d||(e.bl_count[i]++,r=0,a>=p&&(r=f[a-p]),o=l[2*a],e.opt_len+=o*(i+r),h&&(e.static_len+=o*(u[2*a+1]+r)));if(0!==m){do{for(i=g-1;0===e.bl_count[i];)i--;e.bl_count[i]--,e.bl_count[i+1]+=2,e.bl_count[g]--,m-=2}while(m>0);for(i=g;0!==i;i--)for(a=e.bl_count[i];0!==a;)(s=e.heap[--n])>d||(l[2*s+1]!==i&&(e.opt_len+=(i-l[2*s+1])*l[2*s],l[2*s+1]=i),a--)}}(e,t),O(i,d,e.bl_count)}function C(e,t,n){var a,s,i=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),t[2*(n+1)+1]=65535,a=0;a<=n;a++)s=r,r=t[2*(a+1)+1],++o<c&&s===r||(o<l?e.bl_tree[2*s]+=o:0!==s?(s!==i&&e.bl_tree[2*s]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,i=s,0===r?(c=138,l=3):s===r?(c=6,l=3):(c=7,l=4))}function U(e,t,n){var a,s,i=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),a=0;a<=n;a++)if(s=r,r=t[2*(a+1)+1],!(++o<c&&s===r)){if(o<l)do{S(e,s,e.bl_tree)}while(0!=--o);else 0!==s?(s!==i&&(S(e,s,e.bl_tree),o--),S(e,16,e.bl_tree),A(e,o-3,2)):o<=10?(S(e,17,e.bl_tree),A(e,o-3,3)):(S(e,18,e.bl_tree),A(e,o-11,7));o=0,i=s,0===r?(c=138,l=3):s===r?(c=6,l=3):(c=7,l=4)}}s(v);var F=!1;function D(e,t,n,s){A(e,0+(s?1:0),3),function(e,t,n,s){Z(e),s&&(x(e,n),x(e,~n)),a.arraySet(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}(e,t,n,!0)}t._tr_init=function(e){F||(!function(){var e,t,n,a,s,i=new Array(16);for(n=0,a=0;a<28;a++)for(w[a]=n,e=0;e<1<<l[a];e++)m[n++]=a;for(m[n-1]=a,s=0,a=0;a<16;a++)for(v[a]=s,e=0;e<1<<d[a];e++)g[s++]=a;for(s>>=7;a<o;a++)for(v[a]=s<<7,e=0;e<1<<d[a]-7;e++)g[256+s++]=a;for(t=0;t<=c;t++)i[t]=0;for(e=0;e<=143;)f[2*e+1]=8,e++,i[8]++;for(;e<=255;)f[2*e+1]=9,e++,i[9]++;for(;e<=279;)f[2*e+1]=7,e++,i[7]++;for(;e<=287;)f[2*e+1]=8,e++,i[8]++;for(O(f,287,i),e=0;e<o;e++)p[2*e+1]=5,p[2*e]=M(e,5);_=new I(f,l,257,r,c),b=new I(p,d,0,o,c),y=new I(new Array(0),u,0,19,7)}(),F=!0),e.l_desc=new k(e.dyn_ltree,_),e.d_desc=new k(e.dyn_dtree,b),e.bl_desc=new k(e.bl_tree,y),e.bi_buf=0,e.bi_valid=0,N(e)},t._tr_stored_block=D,t._tr_flush_block=function(e,t,n,a){var s,r,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<i;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),P(e,e.l_desc),P(e,e.d_desc),o=function(e){var t;for(C(e,e.dyn_ltree,e.l_desc.max_code),C(e,e.dyn_dtree,e.d_desc.max_code),P(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*h[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),s=e.opt_len+3+7>>>3,(r=e.static_len+3+7>>>3)<=s&&(s=r)):s=r=n+5,n+4<=s&&-1!==t?D(e,t,n,a):4===e.strategy||r===s?(A(e,2+(a?1:0),3),R(e,f,p)):(A(e,4+(a?1:0),3),function(e,t,n,a){var s;for(A(e,t-257,5),A(e,n-1,5),A(e,a-4,4),s=0;s<a;s++)A(e,e.bl_tree[2*h[s]+1],3);U(e,e.dyn_ltree,t-1),U(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),R(e,e.dyn_ltree,e.dyn_dtree)),N(e),a&&Z(e)},t._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(m[n]+i+1)]++,e.dyn_dtree[2*E(t)]++),e.last_lit===e.lit_bufsize-1},t._tr_align=function(e){A(e,2,3),S(e,256,f),function(e){16===e.bi_valid?(x(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},62292:e=>{"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},14153:e=>{const t=/^[-+]?0x[a-fA-F0-9]+$/,n=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/;!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt),!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat);const a={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};e.exports=function(e,s={}){if(s=Object.assign({},a,s),!e||"string"!=typeof e)return e;let i=e.trim();if(void 0!==s.skipLike&&s.skipLike.test(i))return e;if(s.hex&&t.test(i))return Number.parseInt(i,16);{const t=n.exec(i);if(t){const n=t[1],a=t[2];let r=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(t[3]);const o=t[4]||t[6];if(!s.leadingZeros&&a.length>0&&n&&"."!==i[2])return e;if(!s.leadingZeros&&a.length>0&&!n&&"."!==i[1])return e;{const t=Number(i),c=""+t;return-1!==c.search(/[eE]/)||o?s.eNotation?t:e:-1!==i.indexOf(".")?"0"===c&&""===r||c===r||n&&c==="-"+r?t:e:a?r===c||n+r===c?t:e:i===c||i===n+c?t:e}}return e}}}},n={};function a(e){var s=n[e];if(void 0!==s)return s.exports;var i=n[e]={id:e,loaded:!1,exports:{}};return t[e].call(i.exports,i,i.exports,a),i.loaded=!0,i.exports}a.m=t,e=[],a.O=(t,n,s,i)=>{if(!n){var r=1/0;for(d=0;d<e.length;d++){for(var[n,s,i]=e[d],o=!0,c=0;c<n.length;c++)(!1&i||r>=i)&&Object.keys(a.O).every((e=>a.O[e](n[c])))?n.splice(c--,1):(o=!1,i<r&&(r=i));if(o){e.splice(d--,1);var l=s();void 0!==l&&(t=l)}}return t}i=i||0;for(var d=e.length;d>0&&e[d-1][2]>i;d--)e[d]=e[d-1];e[d]=[n,s,i]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),a.j=670,(()=>{var e={670:0};a.O.j=t=>0===e[t];var t=(t,n)=>{var s,i,[r,o,c]=n,l=0;if(r.some((t=>0!==e[t]))){for(s in o)a.o(o,s)&&(a.m[s]=o[s]);if(c)var d=c(a)}for(t&&t(n);l<r.length;l++)i=r[l],a.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return a.O(d)},n=self.webpackChunkgapp_browser_react=self.webpackChunkgapp_browser_react||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var s=a.O(void 0,[739],(()=>a(84936)));s=a.O(s)})();