(()=>{var e,t={15528:(e,t,n)=>{"use strict";var a=n(29087),i=n(16716),s=n(81682);n(89907);self.jasmine;var r=n(39045),o=n(95095),c=n(82227),l=n(90864),d=n(82786);var u=n(56371),h=n(78347),f=n(84321),p=n(47513),g=n.n(p),m=n(48868),w=n(71320);const _={call:async function(e){return m.Z.imap.where("[accountId+path+searchListId]").equals(e).toArray()}};var b=n(88212),y=n(21285),v=n(10671),I=n(68906),E=n(97823),k=n(37002),x=n(9112),A=n(35489),S=n(57357),M=n(24651),O=n(11430),N=n(68247),L=n(7064),T=n(87155),Z=n(89175);function R(e,t){const n=a.Z.get(Z.kMailAccounts).slice(),i=n.findIndex((t=>t.MAIL_EMAIL===e));if(-1===i)throw new Error(`Account to be removed, ${e}, was not found in settings`);const s=n.splice(i,1);N.Z.set(Z.kMailAccounts,n);const r=s[0];t&&(L.Z.savedpasswords.delete(!0,(0,T.B)(r)),L.Z.savedpasswords.delete(!0,(0,T.Y)(r)))}var C=n(99895),P=n(5863),U=n(25051),F=n(16152),D=n(16504),z=n(61839);const B={call:async function(e,t){let n=[];const a=Date.now(),i=await m.Z.transaction("rw",y.E.concat([m.Z.pop,m.Z.filters]),(async()=>{const i=await f.Z.findMatchingSles(t),{newMessageGroups:s,duplicates:r}=f.Z.findDuplicates(i),o=[];for(const t of r){const{message:n,searchListEntry:i}=t,s={accountId:e,uidl:n.uidl||"",createdTimestamp:a,searchListId:i.id};o.push(s)}const c=s.map((e=>e[0])),l=await(0,y.Z)(e,P.Gf,P.e9,c),d=l.addedSles;return n=l.forSearchDb,d.forEach(((t,n)=>{s[n].forEach((n=>{o.push({accountId:e,uidl:n.uidl,createdTimestamp:a,searchListId:t.id})}))})),m.Z.pop.bulkPut(o),r.length>0&&await f.Z.addSourceFilters(e,P.Gf,P.e9,r,!1),d}));return(0,z.Z)(n),i}};var $=n(51501),j=n(75401),Q=n(84283),V=n(89165),q=n(95752),H=n(49168),K=n(34198);function W(e,t,n,a){return n.some((n=>0!==n.length&&n.every((n=>function(e,t,n,a){if(n.accountId||n.path||n.hasOwnProperty("folder")){const t=w.Z.getByIds(e.sourceFilterIds);let i;if(n.accountId?i=t.some((e=>e.accountId===n.accountId)):n.path&&(i=t.some((e=>e.path===n.path))),n.hasOwnProperty("folder"))if(n.folder===P.uT){const t=!1;i=Q.Z.isMessageDeleted(e.sources,a,t)}else i=n.folder===P.Hd?(0,V.Z)(e.sources,e.flags):n.folder===P.hn?(0,j.Z)(e.sources):n.folder===P.Z3?!t.some((t=>{if(v.Z.getFolderType(t.accountId,t.path)===P.Nz){return e.sources.get(t.id)?.internal}return!1})):t.some((e=>{const t=v.Z.getFolderType(e.accountId,e.path);return n.folder&&n.folder===t}));if(!i)return!1}if(n.listId&&n.listId!==(0,K.P7)(t.listId))return!1;if(n.flag){let t;if((0,H.R7)(n.flag))if(n.flag===P.T4.DELETED)t=Q.Z.isMessageDeleted(e.sources,a);else{if(n.flag!==P.T4.SEEN)throw new Error("Unhandled source flag "+n.flag);t=q.Z.call(e.sources,a)}else t=e.flags.includes(n.flag);if(!t)return!1}if(n.senderIsMailingList&&(!e.from[0]||n.senderIsMailingList!==e.from[0].address))return!1;return!0}(e,t,n,a)))))}const G={searchAddresses:function(e,t){const n=t.map((e=>e.address)),a=e.address;return n.some((e=>e.toLowerCase()===a))},filterMessage:function(e,t,n){let a=!1;const{filterValue:i}=e,{include:s,exclude:r,attachments:o,sentDate:c,sentDateEnd:l}=i;if("number"==typeof o){if(0===o&&t.attachment>0)return!1;if(o>0&&0===t.attachment)return!1}if(c&&c>t.sentDate)return!1;if(l&&l<t.sentDate)return!1;if(r||s)if(r&&s){const i=W(t,n,r,e),o=W(t,n,s,e);!i&&o&&(a=!0)}else s?a=W(t,n,s,e):r&&(a=!W(t,n,r,e));else a=!0;return a}},X={mergeFilteringQueueItems:function(e){const t=new Map,n=new Set;if(e.length<=1)return{updatedItems:t,deletedItemIds:n};let a,i,s=0;for(;s<e.length;){let r=1;if(a){const i=e[s],r=a.id;a=X.mergeItems(a,i),a&&(a.id===r?n.add(i.id):(n.add(r),t.delete(r)),t.set(a.id,a))}if(!a&&s<e.length-1){if(i){const a=[e[s],e[s+1]],o=i.map((({id:e})=>e));if(i=X.mergeItemPairs(i,a),i){for(let e=0;e<2;e++){const s=i[e],r=o[e],c=a[e];s.id===r?n.add(c.id):(n.add(r),t.delete(r)),t.set(s.id,s)}r=2}}if(!i){const o=e[s],c=e[s+1];if(a=X.mergeItems(o,c),a){const e=a.id===o.id?c.id:o.id;n.add(e),t.set(a.id,a),r=2}else if(s<e.length-3){const a=[o,c],l=[e[s+2],e[s+3]];if(i=X.mergeItemPairs(a,l),i){for(let e=0;e<2;e++){const s=i[e],r=a[e],o=l[e];n.add(s.id===r.id?o.id:r.id),t.set(s.id,s)}r=4}}}}s+=r}return{updatedItems:t,deletedItemIds:n}},mergeItems:function(e,t){if(e.priority!==t.priority)return;if("FILTERS_SLES"===e.type&&"FILTERS_SLES"===t.type)return X.mergeFiltersSles(e,t);if("UPDATE_SLE"===e.type&&"UPDATE_SLE"===t.type)return X.mergeUpdateSle(e,t)},mergeItemPairs:function(e,t){if(X.numberArraysMatch(t[0].searchListIds||void 0,t[1].searchListIds||void 0)){const n=X.mergeItems(e[0],t[0]);if(n){const a=X.mergeItems(e[1],t[1]);if(a)return[n,a]}}},mergeFiltersSles:function(e,t){if(!X.numberArraysMatch(e.filterIds,t.filterIds))return;if(!X.folderIdsMatch(e.folderIds,t.folderIds))return;if(e.runAllMessages!==t.runAllMessages)return;if(e.runMailingLists!==t.runMailingLists)return;if(e.runCustomFolders!==t.runCustomFolders)return;if(e.runFlagFolders!==t.runFlagFolders)return;if(e.runLabels!==t.runLabels)return;if(e.runQueries!==t.runQueries)return;if(e.runSingleThread!==t.runSingleThread)return;const n=new Set([...e.searchListIds,...t.searchListIds]);return{...e,searchListIds:[...n]}},mergeUpdateSle:function(e,t){if(void 0!==e.currentSearchListId||void 0!==t.currentSearchListId)return;if(e.unread!==t.unread)return;if(e.unseen!==t.unseen)return;if(!X.viewIdSetsMatch(e.removeViewIds,t.removeViewIds))return;if(!X.sourcesMatch(e.sources,t.sources))return;if(e.reRunUpdated!==t.reRunUpdated)return;if(e.searchListIds&&t.searchListIds){const n=new Set([...e.searchListIds,...t.searchListIds]);return{...e,searchListIds:[...n]}}return t.searchListIds?{...e}:e.searchListIds?{...t}:{...e}},numberArraysMatch:function(e,t){return X.arraysMatch(e,t,(function(e,t){const n=new Set(t);return!e.some((e=>!n.has(e)))}))},folderIdsMatch:function(e,t){return X.arraysMatch(e,t,(function(e,t){return!e.some((e=>!t.find((t=>e[0]===t[0]&&e[1]===t[1]))))}))},viewIdSetsMatch:function(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;if(e.size!==t.size)return!1;return![...e].some((e=>!t.has(e)))},sourcesMatch:function(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;if(e.size!==t.size)return!1;return![...e.keys()].some((n=>{const a=e.get(n),i=t.get(n);if(!a&&!i)return!1;if(!a||!i)return!0;const s=Object.keys(a),r=Object.keys(i);if(s.length!==r.length)return!0;for(const e of s)if(a[e]!==i[e])return!0;return!1}))},arraysMatch:function(e,t,n){if(void 0===e&&void 0===t)return!0;if(void 0===e||void 0===t)return!1;if(e.length!==t.length)return!1;return n(e,t)}};const Y=X;const J=function(e,t){return[...e.entries()].some((([e,n])=>{if(n.deleted)return!1;const a=w.Z.get(e);if(!a)throw new Error("Source filter not found "+e);const{accountId:i,path:s}=a;return v.Z.getFolderType(i,s)===t}))};var ee=n(5204),te=n(95538),ne=n(81830),ae=n(1407),ie=n(51733);const se={filter:de,filterUpdateSle:async function(e){const{priority:t,searchListIds:n,currentSearchListId:a=0,unread:i,unseen:s,sources:r,removeViewIds:o=new Set,batchSize:c=ce,reRunUpdated:l}=e,d=[],u=Date.now();let h,f;if(n){const e=n.splice(0,c);[h,f]=await m.Z.transaction("rw",[m.Z.searchList,m.Z.viewIds],(()=>Promise.all([m.Z.searchList.where("id").anyOf(e).toArray(),m.Z.viewIds.where("searchListId").anyOf(e).toArray()])))}else{if([h,f]=await m.Z.transaction("rw",[m.Z.searchList,m.Z.viewIds],(()=>Promise.all([m.Z.searchList.where("id").above(a).limit(c).toArray(),m.Z.viewIds.where("searchListId").above(a).limit(c).toArray()]))),0===h.length)return!0;e.currentSearchListId=h[h.length-1].id}const p=new Map(f.map((({searchListId:e,viewIds:t})=>[e,t])));for(const e of h){const t=new Set,n=new Set([...o]),{id:a}=e,c=p.get(a);if(!c)throw new Error("viewIds not found "+a);const l=new Set;if(c.forEach((e=>{const t=Math.floor(e/P.XN);l.add(t)})),l.forEach((a=>{if(void 0!==i){const e=a*P.XN+P.aD;i?t.add(e):n.add(e)}if(void 0!==s){const e=a*P.XN+P.ZC;s?t.add(e):n.add(e)}if(void 0!==r){const i=a*P.XN+P.IK,s=a*P.XN+P.aD;r.forEach(((r,o)=>{a===o?r?(void 0!==r.deleted&&(r.deleted?(0,V.Z)(e.sources,e.flags)||n.add(i):t.add(i)),void 0!==r.read&&(r.read?n.add(s):t.add(s))):$.Z.getAllViewTypes().forEach((e=>{n.add(a*P.XN+e)})):e.sources.has(a)||(Q.Z.isMessageDeleted(e.sources)?n.add(i):t.add(i),q.Z.call(e.sources)?n.add(s):t.add(s))}))}})),c.forEach((e=>{t.delete(e)})),[...n].forEach((e=>{c.includes(e)||n.delete(e)})),t.size>0||n.size>0){const e={id:a,updates:{}};t.size>0&&(e.updates.addedViewIds=[...t],t.forEach((e=>{c.push(e)}))),n.size>0&&(e.updates.removedViewIds=[...n],n.forEach((e=>{const t=c.indexOf(e);t>=0&&c.splice(t,1)}))),d.push(e)}else p.delete(a)}if(p.size>0&&(await m.Z.viewIds.where("searchListId").anyOf([...p.keys()]).modify((e=>{const t=p.get(e.searchListId);t&&(e.viewIds=t)})),l)){const e=[...p.keys()];await I.Z.call({type:"RE_RUN_SLES",priority:t,searchListIds:e})}d.length>0&&U.QO.updateIndex({sleUpdates:d});if(n&&0===n.length)return!0;{const t=Date.now();return e.batchSize=le(c,t-u),!1}},filterSles:async function(e,t,n,a,i){const s=[],r=[],o=[],c=[],l=[],d=new Set,u=new Map,f=new Map,p=new Map,g=function(e){const t=new Set,n=[];for(const{accountId:a,path:i}of e)h.Z.isMailAccount(a)&&(i===P.ym?n.push(a):t.add(a));for(const e of n)t.delete(e);if(0===t.size)return[];const a=[...t].map((e=>[e,P.ym]));return w.Z.getByFolderIds(a)}(a),_=[...a,...g];for(let a=0;a<e.length;a++){const s=e[a],r=t[a],o=new Map;for(const e of _){if(G.filterMessage(e,s,r)){const{query:t}=e.filterValue;if(!n.get(s.id))throw new Error("viewIds not found in viewIdsBySleId for "+s.id);if(t&&!i?.skipQueries){const t=p.get(e);t?t.push(s):p.set(e,[s])}else o.set(e,!0)}else o.set(e,!1)}f.set(s,o)}if(p.size>0)for(const[e,t]of p){const{query:n}=e.filterValue;if(n){const a=await(0,ne.Z)(n),i=new Set(a);for(const n of t){let t=f.get(n);t||(t=new Map,f.set(n,t)),i.has(n.id)?t.set(e,!0):t.set(e,!1)}}}for(const e of _){const t=$.Z.getViewIdsByFilterId(e.id);for(const e of t)d.add(e)}for(let a=0;a<e.length;a++){const h=e[a],p=t[a],g=f.get(h);if(!g)continue;const m=se.getMatchResults(h,p,g,i?.triggerFilterIdCandidates),{id:w}=h,{addedViewIds:_,removedViewIds:b,runTriggerFilterIds:y,isOnMailingList:v}=m,I=n.get(w);if(!I)throw new Error("viewIds not found in viewIdsBySleId for "+w);if(v){[...I,..._].filter((e=>(e-P.EO)%P.XN==0)).forEach((e=>{_.delete(e),b.add(e)}))}const E=I.filter((e=>d.has(e))),k=E.filter((e=>!b.has(e))).concat([..._]);let x;if(!(k.length===E.length&&k.every((e=>E.includes(e))))){const e=I.filter((e=>!b.has(e))).concat([..._]);u.set(w,e),x={addedViewIds:[..._].filter((e=>!I.includes(e))),removedViewIds:I.filter((e=>b.has(e)&&!_.has(e)))},n.set(w,e)}y.size>0&&(x={...x||{},runTriggerFilterIds:[...y]}),x&&s.push({id:w,updates:x}),(0,K.P7)(p.listId)&&(r.push(h),o.push(p)),(0,H.OK)(h.flags)&&(c.push(h),l.push(p))}u.size>0&&await m.Z.viewIds.where("searchListId").anyOf([...u.keys()]).modify((e=>{const t=u.get(e.searchListId);t&&(e.viewIds=t)}));return{sleUpdates:s,mailingListCandidateSles:r,mailingListCandidateMessages:o,labelsCandidateSles:c,labelsCandidateMessages:l}},getMatchResults:function(e,t,n,a){const i=new Set,s=new Set,r=new Set,o=w.Z.getByIds(e.sourceFilterIds);let c=!1;for(const[l,d]of n){const n=$.Z.getViewIdsByFilterId(l.id);for(const e of n)s.add(e);d&&(a?.includes(l.id)&&r.add(l.id),n.forEach((n=>{switch($.Z.getViewType(n)){case P.xE:i.add(n);break;case P.ZC:e.unseen&&i.add(n);break;case P.aD:q.Z.call(e.sources,l)||i.add(n);break;case P.EO:const a=(0,K.P7)(t.listId);if(a){const e=te.Z.getMailingListGroup(a);e&&e.isIgnored?i.add(n):c=!0}else me(e.from)?c=!0:i.add(n);break;case P.IK:const s=v.Z.getFolderType(l.accountId,l.path)===P.Nz;Q.Z.isMessageDeleted(e.sources,l,s)||i.add(n);break;case P.Fz:o.some((e=>e.accountId!==P.u4))&&i.add(n);break;case P.Jq:(0,V.Z)(e.sources,e.flags)||i.add(n);break;case P.js:const r=J(e.sources,P.Oi),d=J(e.sources,P.e9);r&&!d||i.add(n);break;case P.pF:(0,j.Z)(e.sources)||i.add(n)}})))}return{addedViewIds:i,removedViewIds:s,runTriggerFilterIds:r,isOnMailingList:c}},updateFilteringQueue:async function(){return m.Z.transaction("rw",[m.Z.filteringQueue],(async()=>{const e=ue.reduce(((e,{id:t})=>Math.max(e,t)),0),t=await m.Z.filteringQueue.where("id").above(e).toArray();ue.push(...t),ue.sort(ie.Hc);const{updatedItems:n,deletedItemIds:a}=Y.mergeFilteringQueueItems(ue);if(0===n.size&&0===a.size)return ue;const i=[];for(const e of ue){const t=n.get(e.id);t?i.push(t):a.has(e.id)||i.push(e)}return ue=i,m.Z.filteringQueue.bulkPut([...n.values()]),m.Z.filteringQueue.bulkDelete([...a]),i}))},clearQueue:function(){ue=[]},deleteFilteringItem:async function(e){await m.Z.filteringQueue.delete(e.id);const t=ue.indexOf(e);t>=0&&ue.splice(t,1)}};let re=!1;const oe=100,ce=2e3,le=o.Z.adjustBatchSize.bind(void 0,oe,2e4,1e3);async function de(){if(re)return b.Z.log("Mail",["filtering"],"Already filtering."),Promise.resolve();re=!0;try{U.U.setPersistentStatus(ae.A4,"MAIL_FILTERING",(0,u.Z)("Running mail filters..."));let e=await se.updateFilteringQueue();for(;e.length>0;){const t=e[0];let n=!0;try{switch(t.type){case"FILTERS_SLES":n=await he(t);break;case"UPDATE_SLE":n=await se.filterUpdateSle(t);break;case"MOVE_SLE":await fe(t);break;case"RUN_FILTERS":n=await pe(t);break;case"RE_RUN_SLES":n=await ge(t);break;default:b.Z.warn("Mail",["filtering"],"Invalid filtering queue item type",t.type)}n&&await se.deleteFilteringItem(t)}catch(e){b.Z.error("Mail",["filtering"],"Filtering failed",JSON.stringify(t),e),await se.deleteFilteringItem(t)}e=await se.updateFilteringQueue()}}catch(e){b.Z.error("Mail",["filtering"],e)}finally{re=!1,U.U.clearPersistentStatus(ae.A4,"MAIL_FILTERING")}}let ue=[];async function he(e){const{filterIds:t,folderIds:n=[],searchListIds:a,runAllMessages:i=!1,runMailingLists:s=!1,runCustomFolders:r=!1,runLabels:o=!1,runFlagFolders:c=!1,runQueries:l=!1,runSingleThread:d=!1,batchSize:u=ce}=e,h=w.Z.getAll().filter((e=>{const{id:a,accountId:u,path:h}=e;if(!!n.find((e=>{const[t,n]=e;return t===u&&n===h})))return!0;if(t&&t.includes(a))return!0;switch(u){case P.of:return i&&[P.ym,P.tB,P.ik,P.rp,P.N1,P.cm,P.$T].includes(h);case P.wC:return s;case P.MN:return c;case P.Ry:return r;case P.ut:return o;case P.Kz:return l;case P.tQ:return d}}));if(0===h.length)return!0;const f=Date.now(),p=a.splice(0,u),[g,_,b]=await m.Z.transaction("rw",[m.Z.searchList,m.Z.messages,m.Z.viewIds],(()=>Promise.all([m.Z.searchList.where("id").anyOf(p).toArray(),m.Z.messages.where("id").anyOf(p).toArray(),m.Z.viewIds.where("searchListId").anyOf(p).toArray()])));if(0===g.length)return!0;const y=new Map(b.map((e=>[e.searchListId,e.viewIds]))),v=await se.filterSles(g,_,y,h),{sleUpdates:I,mailingListCandidateSles:E,mailingListCandidateMessages:k,labelsCandidateSles:x,labelsCandidateMessages:A}=v;if(I.length>0&&U.QO.updateIndex({sleUpdates:I}),E.length>0){const e=await K.ZP.createMailingListFilters(k);if(e.length>0){await w.Z.updateFilters(e.map((({id:e})=>e)));const t=await se.filterSles(E,k,y,e),{sleUpdates:n}=t;n.length>0&&U.QO.updateIndex({sleUpdates:n})}}if(x.length>0){const e=await(0,H.uR)(x);await w.Z.updateFilters(e);const t=w.Z.getByIds(e),n=await se.filterSles(x,A,y,t),{sleUpdates:a}=n;a.length>0&&U.QO.updateIndex({sleUpdates:a})}if(a.length>0){const t=Date.now();e.batchSize=le(u,t-f)}return 0===a.length}async function fe(e){const{searchListIds:t,fromFolderId:n,toFolderId:a}=e,i=w.Z.getByFolderId(n),s=w.Z.getByFolderId(a);if(!i||!s)throw new Error("Either from- or to-filter not found");const r=[],[o,c]=await m.Z.transaction("rw",[m.Z.searchList,m.Z.viewIds],(()=>Promise.all([m.Z.searchList.where("id").anyOf(t).toArray(),m.Z.viewIds.where("searchListId").anyOf(t).toArray()]))),l=new Map(c.map((e=>[e.searchListId,e.viewIds]))),d=new Set,u=new Set;for(const e of o){const{id:t}=e,n=l.get(t);if(!n)throw new Error("viewIds not found "+t);const a={id:t,updates:{}};for(const e of $.Z.getAllViewTypes()){const t=i.id*P.XN+e;if(n.includes(t)){const n=s.id*P.XN+e;u.add(t),d.add(n)}}a.updates.addedViewIds=[...d],a.updates.removedViewIds=[...u],r.push(a),u.forEach((e=>{const t=n.indexOf(e);t>=0&&n.splice(t,1)})),d.forEach((e=>{n.push(e)}))}await m.Z.viewIds.where("searchListId").anyOf([...l.keys()]).modify((e=>{const t=l.get(e.searchListId);t&&(e.viewIds=t)})),U.QO.updateIndex({sleUpdates:r})}async function pe(e){const t=[],{filterIds:n,folderIds:a,currentSearchListId:i=0,batchSize:s=ce,triggerFilterIdCandidates:r}=e;if(n){const e=w.Z.getByIds(n);t.push(...e)}if(a){const e=w.Z.getByFolderIds(a);t.push(...e)}if(0===t.length)throw new Error("No valid filters in filtering request");const o=Date.now(),[c,l,d]=await m.Z.transaction("rw",[m.Z.searchList,m.Z.messages,m.Z.viewIds],(()=>Promise.all([m.Z.searchList.where("id").above(i).limit(s).toArray(),m.Z.viewIds.where("searchListId").above(i).limit(s).toArray(),m.Z.messages.where("id").above(i).limit(s).toArray()])));if(0===c.length)return!0;const u=new Map(l.map((e=>[e.searchListId,e.viewIds])));e.currentSearchListId=c[c.length-1].id;const h=await se.filterSles(c,d,u,t,{triggerFilterIdCandidates:r}),{sleUpdates:f}=h;f.length>0&&U.QO.updateIndex({sleUpdates:f});const p=Date.now();return e.batchSize=le(s,p-o),!1}async function ge(e){const{filterIds:t,folderIds:n,batchSize:a=oe,currentSearchListId:i=0,runMailingLists:s=!1}=e,r=[];if(t&&r.push(...t),n){const e=w.Z.getByFolderIds(n);r.push(...e.map((e=>e.id)))}const o=Date.now(),c=[],l=[],[d,u,h]=e.searchListIds?await async function(e,t){const n=e.splice(0,t);return await m.Z.transaction("rw",[m.Z.searchList,m.Z.messages,m.Z.viewIds],(()=>Promise.all([m.Z.searchList.where("id").anyOf(n).toArray(),m.Z.messages.where("id").anyOf(n).toArray(),m.Z.viewIds.where("searchListId").anyOf(n).toArray()])))}(e.searchListIds,a):await async function(e,t){return m.Z.transaction("rw",[m.Z.searchList,m.Z.messages,m.Z.viewIds],(()=>Promise.all([m.Z.searchList.where("id").above(e).limit(t).toArray(),m.Z.messages.where("id").above(e).limit(t).toArray(),m.Z.viewIds.where("searchListId").above(e).limit(t).toArray()])))}(i,a);if(0===d.length)return!0;void 0===e.searchListIds&&(e.currentSearchListId=d[d.length-1].id);const f=w.Z.getAll(),p=new Map(h.map((e=>[e.searchListId,e.viewIds]))),g=[];for(let e=0;e<d.length;e++){const t=d[e],n=p.get(t.id),a=g.find((e=>{const[t]=e;if(n.length!==t.length)return!1;for(let e=0;e<t.length;e++)if(n[e]!==t[e])return!1;return!0})),i=u[e];if(a){const[,[e,n]]=a;e.push(t),n.push(i)}else g.push([n,[[t],[i]]])}const _=[];for(const t of g){const[n,[a,i]]=t,o=new Set([...r,..._]);n.forEach((e=>{const t=Math.floor(e/P.XN);o.add(t)}));const d=f.filter((e=>o.has(e.id)));if(0===d.length)continue;const{skipQueries:u}=e,h=await se.filterSles(a,i,p,d,{skipQueries:u}),{mailingListCandidateSles:g,mailingListCandidateMessages:m}=h;if(c.push(...h.sleUpdates),s&&g.length>0){const t=await K.ZP.createMailingListFilters(m);if(t.length>0){const n=t.map((({id:e})=>e));await w.Z.updateFilters(n);const{filterIds:a=[]}=e;e.filterIds=[...a,...n],_.push(...n);const i=await se.filterSles(g,m,p,t,{skipQueries:u}),{sleUpdates:s}=i;l.push(...s)}}}c.length>0&&U.QO.updateIndex({sleUpdates:c}),l.length>0&&U.QO.updateIndex({sleUpdates:l});const b=Date.now();return e.batchSize=le(a,b-o),!1}function me(e){const t=e[0]?.address;return!!t&&!!w.Z.getByAddress(t)}ee.Z.addListener((async function(e){if("filter"===e.func)await de()}));const we=se;var _e=n(77150),be=n.n(_e),ye=n(16445),ve=n(16888);let Ie={level:0,children:new Map};const Ee={data:new Map,add:e=>{void 0!==e.id&&Ee.data.set(e.id,e)},async get(e){const t=Ee.data.get(e);if(t)return t;{const t=await m.Z.threading.get(e);if(!t)return;const n={id:t.id,messageId:t.messageId};return Ee.add(n),n}},clear:()=>{Ee.data.clear()}};function ke(){Ee.clear()}function xe(e){e.forEach((e=>{const{id:t,messageId:n}=e,a={id:t,messageId:n};Ee.add(a)}))}async function Ae(){const e=await m.Z.threading.toArray();for(const t of e){const{id:e,messageId:n}=t,a={id:e,messageId:n};Ee.add(a),await Se(t)}ke()}function Se(e){const{inReplyTo:t,references:n}=e,a=[...n];return t&&!a.includes(t)&&a.push(t),a.reduce(((e,t)=>e.then((e=>Ne(t).then((n=>{if(n)return n;{const n={messageId:t},a=Oe(void 0,e);return Me(n,a).then((()=>a))}}))))),Promise.resolve()).then((t=>{const{id:n,sentDate:a,messageId:i,outbound:s}=e,r={id:n,messageId:i};return Ne(i).then((e=>{if(e)return e.sentDateById.has(n)?(e.sentDateById.set(n,a),e):(e.sentDateById.set(n,a),Me(r,e).then((()=>e)));{const e=Oe({id:n,sentDate:a,outbound:s},t);return Me(r,e).then((()=>e))}}))}))}function Me(e,t,n=Ie){if(n.threadNode)return Promise.resolve().then((()=>{if(void 0!==n.id)return Ee.get(n.id).then((t=>{if(t&&t.messageId!==e.messageId)return{id:t.id,messageId:t.messageId}}));if(void 0!==n.messageId){if(n.messageId!==e.messageId)return{messageId:n.messageId};void 0!==e.id&&(n.id=e.id,delete n.messageId)}})).then((i=>{if(!i)return;const s=n.parent,r={children:new Map,level:s.level+1},o=e.messageId.substr(2*s.level,2);s.children.set(o,r);const c=n.threadNode,l=i.messageId.substr(2*r.level,2),d=e.messageId.substr(2*r.level,2);if(l!==d)return a(i,r,c),a(e,r,t),Promise.resolve();{const n={level:r.level+1,children:new Map};return r.children.set(d,n),Promise.all([Me(i,c,n),Me(e,t,n)])}}));{const i=e.messageId.substr(2*n.level,2),s=n.children.get(i);return s?Me(e,t,s):(a(e,n,t),Promise.resolve())}function a(e,t,n){const a={parent:t,threadNode:n},{id:i,messageId:s}=e;void 0!==i?a.id=i:a.messageId=s;const r=e.messageId.substr(2*t.level,2);t.children.set(r,a)}}function Oe(e,t){const n={sentDateById:new Map,children:[],outbound:!1};if(e){const{id:t,sentDate:a}=e;n.sentDateById.set(t,a),n.outbound=e.outbound}return t&&(t.children.push(n),n.parent=t),n}function Ne(e,t=Ie){if(!e)return Promise.resolve();if(t.threadNode){if(void 0!==t.messageId)return t.messageId===e?Promise.resolve(t.threadNode):Promise.resolve();if(void 0!==t.id)return Ee.get(t.id).then((n=>n&&n.messageId===e?t.threadNode:Promise.resolve()));throw new Error("Missing messageId and id: "+JSON.stringify(t))}{const n=e.substr(2*t.level,2),a=t.children.get(n);return a?Ne(e,a):Promise.resolve()}}function Le(e){const t=new Map,n=[...e.keys()];return m.Z.searchList.where("id").anyOf(n).modify((n=>{const{id:a}=n,i=e.get(a);i&&(t.set(a,i),n.threadKey=i)})).then((()=>t))}var Te=n(13617);let Ze=!1;function Re(e){return Se(e).then((e=>{if(!e.parent&&0===e.children.length)return[];let n=e;for(;n.parent;)n=n.parent;return t(n)}));function t(e,i){const{sentDateById:s,children:r}=e;let o,c=[];if(void 0===i){let t=n(e);t||(t=n(e,!1));let i=e.sentDateById.keys().next().value;i||(i=a(e,[0,Number.MAX_SAFE_INTEGER])[0]),o=(0,Te._)(t,i),s.forEach(((e,t)=>{c.push({id:t,newThreadKey:o})}))}else s.size>0?s.forEach(((e,t)=>{o=[...i,e],c.push({id:t,newThreadKey:o})})):o=i;return r.forEach((e=>{const n=t(e,o);c=[...c,...n]})),c}function n(e,t=!0){const a=t&&e.outbound;let i=[...e.sentDateById.values()].reduce(((e,t)=>Math.max(e,a?0:t)),0);return e.children.forEach((e=>{i=Math.max(i,n(e,t))})),i}function a(e,t){return t=[...e.sentDateById.entries()].reduce(((e,t)=>e[1]<t[1]?e:t),t),e.children.forEach((e=>{t=a(e,t)})),t}}const Ce={updateThreads:async function(){if(!Ze)for(Ze=!0;Ze;)try{const e=await m.Z.threadingQueue.toCollection().first();if(!e)return ke(),void(Ze=!1);const{threadingIds:t}=e;let n=2e3;const a=new o.Z.BatchSizeOptimizer(n,2e3);for(;t.length>0;){const i=t.splice(0,n);await m.Z.transaction("rw",[m.Z.threadingQueue,m.Z.threading,m.Z.searchList],(async()=>{const s=Date.now(),r=await m.Z.threading.where("id").anyOf(i).toArray(),o=new Map;xe(r);for(const e of r){(await Re(e)).forEach((e=>{const{id:t,newThreadKey:n}=e;o.set(t,n)}))}if(o.size>0){const e=await Le(o);U.QO.updateThreadKeys(e)}if(t.length>0){await m.Z.threadingQueue.put(e);const t=Date.now();n=a.optimize(n,t-s)}else await m.Z.threadingQueue.delete(e.id)}))}}catch(e){throw Ze=!1,b.Z.error("Mail",["Threading"],e),U.U.setStatus(ae.A4,(0,u.Z)("Error during threading"),5e3),e}}};var Pe=n(3664),Ue=n(76257),Fe=n(13519),De=n(27950);const ze=1048576;class Be extends Error{constructor(e,t,n){super(t),this.code=e,this.socket=n}}function $e(e){return(0,Pe.vi)(e,[43,79,75])}function je(e){return 0===e.indexOf("PASS")?"PASS":0===e.indexOf("APOP")?e.replace(/\w+\s*$/,"the_md5_hash"):e}async function Qe(e,t,n){const a=[];return new Promise(((i,s)=>{let r=setTimeout((function(){s(new Be("SOCKET_TIMEOUT",(0,u.Z)("Failed to connect to POP server after $1 ms",[n]),o))}),n);const o=D.default.open(e,t,{useSecureTransport:110!==t});if("connecting"!==o.readyState)return clearTimeout(r),void s(new Be("NO_SOCKET",(0,u.Z)('POP socket did not switch to "connecting" when trying to connect to $1:$2',[e,t]),o));o.onerror=e=>{clearTimeout(r),s(new Be("NO_SOCKET",(0,u.Z)("POP socket generated unknown error when connecting. Response message: $1",[e.data?.message||e.message||""]),o))},o.ondata=e=>{clearTimeout(r);const t=new Uint8Array(e.data);a.push(...t),(0,Pe.MF)(a,[13,10])?i({socket:o,response:new Uint8Array(a)}):r=setTimeout((function(){s(new Be("SOCKET_TIMEOUT",(0,u.Z)("POP server failed to send connection chunk after $1 ms",[n]),o))}),n)}}))}async function Ve(e,t,n=!1,a=3e4){if(!e)throw new Be("NO_SOCKET",(0,u.Z)('No POP socket when sending "$1"',[je(t)]),e);if(await!He(e))throw new Be("SOCKET_CLOSED",(0,u.Z)('POP socket unexpectedly closed before "$1" command could be sent',[je(t)]),e);const i=[];return new Promise(((s,r)=>{let o=setTimeout((function(){clearTimeout(o),r(new Be("SOCKET_TIMEOUT",(0,u.Z)('POP server did not reply to command "$1" after $2 ms',[je(t),a]),e))}),a);e.onerror=n=>{clearTimeout(o),r(new Be("SEND_ERROR",(0,u.Z)('POP socket generated unknown error when sending command "$1"',[je(t)]),e))};let c=Date.now();e.ondata=l=>{clearTimeout(o);const d=new Uint8Array(l.data);if(i.push(...d),Date.now()-c>1e3){const e=Math.round(i.length/ze*10)/10;U.U.setStatus(ae.A4,(0,u.Z)("Fetching message: $1 MB",[e])),c=Date.now()}(0,Pe.MF)(i,[13,10,46,13,10])||!n&&(0,Pe.MF)(i,[13,10])?(n?i.splice(-5):i.splice(-2),(0,Pe.Xh)(i,[13,10,46],[13,10]),s(new Uint8Array(i))):o=setTimeout((function(){r(new Be("SOCKET_TIMEOUT",(0,u.Z)('POP server failed to send additional chunk for command "$1" after $2 ms',[je(t),a]),e))}),a)};const l=`${t}\r\n`,d=(0,Pe.sy)(l);e.send(d)}))}async function qe(e,t,n){const a=await Ve(e,`USER ${t}`);if(!$e(a))throw new Be("AUTH_FAIL",(0,u.Z)("Invalid username for POP, server responded with: $1",[(0,Pe.DA)(a)]),e);const i=(0,Pe.DA)((new TextEncoder).encode(n)),s=await Ve(e,`PASS ${i}`);if(!$e(s))throw new Be("AUTH_FAIL",(0,u.Z)("Login to POP server failed, server responded with: $1",[(0,Pe.DA)(s)]),e)}function He(e){return new Promise((t=>{setTimeout((()=>{t("open"===e.readyState)}),0)}))}async function Ke(e,t,n,a,i=6e4,s=!1){const{socket:r,response:o}=await Qe(e,t,i);if(!$e(o))throw new Be("CONNECT_ERROR",(0,u.Z)("POP server $1:$2 responded with an error after connection",[e,t]),r);const c=We(o);if(!c||s)return await qe(r,n,a),r;try{return await async function(e,t,n,a){const i=(0,Pe.DA)((new TextEncoder).encode(n)),s=be()(`${a}${i}`),r=await Ve(e,`APOP ${t} ${s}`);if(!$e(r))throw new Be("AUTH_FAIL",(0,u.Z)("APOP authentication failed: $1",[(0,Pe.DA)(r)]),e)}(r,n,a,c),r}catch(s){if("AUTH_FAIL"===s.message){return await He(r)?(await qe(r,n,a),r):Ke(e,t,n,a,i,!0)}throw s}}function We(e){const t=e.lastIndexOf(60);if(-1!==t){const n=e.indexOf(62,t);if(-1!==n){const a=e.subarray(t,n+1);return(0,Pe.DA)(a)}}}async function Ge(e,t){const n=await Ve(e,`TOP ${t.index} 0`,!0);if($e(n))return{...t,headersOnly:!0,message:et(n)};throw new Be("TOP_ERROR",(0,u.Z)("POP server did not respond correctly to TOP command. Response: $1",[(0,Pe.DA)(n)]))}async function Xe(e,t){const n=await Ve(e,`RETR ${t.index}`,!0);if($e(n))return{...t,headersOnly:!1,message:et(n)};throw new Be("RETR_ERROR",(0,u.Z)("POP server did not respond correctly to RETR command. Response: $1",[(0,Pe.DA)(n)]),e)}function Ye(e){const t=[...e],n=new Map;let a=(0,Pe.L2)(t,[13,10]);for(;-1!==a;){const e=(0,Pe.L2)(t,[13,10],a+1),i=-1!==e?t.slice(a+2,e):t.slice(a+2),s=i.indexOf(32);if(-1===s){a=e;continue}const r=i.slice(0,s),o=i.slice(s+1),c=Number(String.fromCharCode(...r)),l=String.fromCharCode(...o);n.set(l,c),a=e}return n}function Je(e){const t=[...e],n=new Map;let a=(0,Pe.L2)(t,[13,10]);for(;-1!==a;){const e=(0,Pe.L2)(t,[13,10],a+1),i=-1!==e?t.slice(a+2,e):t.slice(a+2),s=i.indexOf(32);if(-1===s){a=e;continue}const r=i.slice(0,s),o=i.slice(s+1),c=Number(String.fromCharCode(...r)),l=parseInt(String.fromCharCode(...o));n.set(c,l),a=e}return n}function et(e){const t=(0,Pe.L2)(e,[13,10]);if(-1===t)throw new Error("parseRetrResponse: Expected end of line");return e.subarray(t+2)}async function tt(e,t,n){const a=[];for(const e of n){const t=ye.Z.call(e.message),n=(0,Ue.Zp)(e.message),i=(0,Ue.Dc)(n),s={to:t.to,from:t.from,cc:t.cc,inReplyTo:t.inReplyTo,replyTo:t.replyTo,subject:t.subject,sentDate:t.sentDate,messageId:t.messageId,listId:t.listId,listPost:t.listPost,references:t.references,flags:[],uidl:e.uidl||"",attachment:i.length,size:e.size};s.messageId||(s.messageId=""),a.push(s)}const i=await B.call(t,a).catch((n=>{throw new Be("STORE_ERROR",(0,u.Z)("Unable to store POP message in mail store.",[t]),e)}));if(i.length>0){const s=[];for(const r of i){const i=a.findIndex((e=>f.Z.messageEqualsSle(e,r))),o=a[i],c=n[i];if(!c.headersOnly){const{sentDate:n,id:a}=r;try{const i=await(0,ve.Z)(a,o,c.message);i&&(c.message=i.raw,r.preview=(0,Fe.Q)(i.bodyParts),await(0,S.Z)(a,r.preview)),await nt(e,t,c,n,a),s.push(a)}catch(e){b.Z.error("Mail",["pop",t,a],"Failed to process mail: ",e)}}}s.length>0&&await M.Z.setHasRaws(t,s)}return i}async function nt(e,t,n,a,i){try{await C.Z.call(t,a,i,n.message)}catch(n){throw new Be("STORE_ERROR",(0,u.Z)("Unable to store POP message as writing to disk failed.",[t]),e)}}async function at(e,t){switch(e.message){case"SOCKET_TIMEOUT":case"SEND_ERROR":case"CONNECT_ERROR":case"DELETE_ERROR":case"NO_UIDL":case"NO_SOCKET":e.socket&&e.socket.close();break;case"MISCONFIGURED_ACCOUNT":case"SOCKET_CLOSED":break;default:if(e.socket){const{socket:t}=e;it(t,!1)}}throw e.socket&&(e.socket.onerror=null),U.KU.set(t,"POP",e,e.code),e}async function it(e,t=!0){try{await Ve(e,"QUIT"),e.close()}catch(e){if(t)throw e;b.Z.error("Mail",["pop-client"],e)}}async function st(e,t){const n=await Ve(e,"UIDL",!0);if(!$e(n))throw new Be("NO_UIDL",(0,u.Z)("POP server $1 does not support UIDL",[t]),e);const a=Ye(n);U.U.setStatus(ae.A4,(0,u.Z)("$1 message exists on POP account $2","$1 messages exist on POP account $2",[a.size,t]));const i=await Ve(e,"LIST",!0);if(!$e(i))throw new Be("NO_LIST",(0,u.Z)("POP server $1 does not support LIST",[t]),e);return{uidlMap:a,sizeMap:Je(i)}}async function rt(e){try{const t=e.MAIL_USER,n=e.MAIL_PASSWORD,a=e.MAIL_SERVER,i=e.MAIL_PORT;if(!(t&&n&&a&&i))throw new Be("MISCONFIGURED_ACCOUNT",(0,u.Z)("Incoming POP server attributes missing for $1",[e.MAIL_EMAIL]));const s=await Ke(a,i,t,n);return U.KU.delete(e.MAIL_EMAIL,"POP"),s}catch(t){throw U.KU.set(e.MAIL_EMAIL,"POP",t,t.code),t}}function ot(e){return e.popDeletion||{when:P.qd,howManyDays:0}}async function ct(e){const t=(await E.Z.loadPopAccounts()).find((({MAIL_EMAIL:t})=>t===e));if(t)return t;throw new Error("Account not found "+e)}async function lt(e,t,n){const a=[],i=[];let s=!0;const r=ot(e),o=function(e){const t=e.popMaxSize||{limited:!1,limit:0};return t.limited?t.limit*ze:0}(e);for(const e of t){const{index:t,size:c}=e;let l;if(s&&o&&void 0!==c&&c>o)try{l=await Ge(n,e)}catch(e){s=!1,b.Z.warn("Mail",["pop-client"],"Error using TOP to fetch mail, using RETR instead.",e)}l||(l=await Xe(n,e),r.when===P.eQ&&i.push(t)),a.push(l)}return{popMails:a,safeToDelete:i}}async function dt(e,t){for(const n of t){if(!$e(await Ve(e,`DELE ${n}`)))throw new Be("DELETE_ERROR",(0,u.Z)("Failed to delete mail with index $1",[n]),e)}}const ut={verifyLogin:async function(e){const{MAIL_SERVER:t,MAIL_PORT:n,MAIL_USER:a,MAIL_PASSWORD:i,MAIL_EMAIL:s}=e;if(!(t&&n&&(a&&i||e.useOAuth)))throw new Be("MISCONFIGURED_ACCOUNT",(0,u.Z)("Incoming server attributes missing for $1",[s]));try{const e=await Ke(t,n,a,i,1e4);await it(e)}catch(e){await at(e,s)}},deleteMail:async function(e,t){if(!e.popDeletion||e.popDeletion.when!==P.Qp)return;const n=e.MAIL_EMAIL;try{const a=await rt(e),i=await Ve(a,"UIDL",!0);if(!$e(i))throw new Be("NO_UIDL",(0,u.Z)("POP server $1 does not support UIDL",[n]),a);const s=(await m.Z.pop.where("searchListId").anyOf(t).toArray()).filter((e=>e.accountId===n)).map((e=>e.uidl)),r=Ye(i),o=[];for(const e of s)r.has(e)&&o.push(e);await dt(a,o),await Ve(a,"QUIT"),await a.close()}catch(e){await at(e,n)}},getMail:async function(e){const t=await rt(e),n=e.MAIL_EMAIL;U.U.setStatus(ae.A4,(0,u.Z)("Checking for new mail on POP account $1",[n]));try{const{uidlMap:a,sizeMap:i}=await st(t,n),s=await async function(e,t,n){const a=e.MAIL_EMAIL,i=[...t.keys()],s=await async function(e,t){const n=t.map((t=>[e,t]));return await m.Z.pop.where("[accountId+uidl]").anyOf(n).toArray()}(a,i),r=new Map,o=new Set;for(const e of s){const{uidl:t,searchListId:n}=e,a=r.get(t);a?a.push(e):r.set(t,[e]),o.add(n)}const c=await A.Z.getBySearchListIdsAccountId([...o],a),l=new Map;for(const e of c)if(e){const{searchListId:t,hasRaw:n}=e;l.set(t,1===n)}const d=[],u=new Set,h=ot(e);for(const[e,i]of t){if(!e){b.Z.warn("Mail",["pop-client"],"POP message does not have UIDL: "+a+" index: "+i);continue}const t=r.get(e);if(t&&0!==t.length){const[{searchListId:e,createdTimestamp:n}]=t;!1!==l.get(e)&&(h.when===P.eQ||h.when===P.kA&&n+24*h.howManyDays*60*60*1e3<Date.now())&&u.add(i)}else{const t={index:i,uidl:e,size:n.get(i)||0};d.push(t)}}return{toFetch:d,safeToDelete:u}}(e,a,i),{toFetch:r}=s,c=r.length;let l=0;U.U.setStatus(ae.A4,(0,u.Z)("Need to fetch $1 message - $2","Need to fetch $1 messages - $2",[c,n]));let d=123;const h=new o.Z.BatchSizeOptimizer(123,5e3);for(;r.length>0;){const a=Date.now(),i=r.splice(0,d),o=await ct(n);if((0,De.OM)(e,o))break;const f=await lt(o,i,t),{popMails:p,safeToDelete:g}=f;if(p.length>0){const e=await tt(t,n,p);e.length>0&&U.QO.updateIndex({addedSles:e}),we.filter(),Ce.updateThreads()}if(g.length>0){await dt(t,g);for(const e of g)s.safeToDelete.delete(e)}const m=Date.now();l+=d,d=h.optimize(d,m-a),U.U.setStatus(ae.A4,(0,u.Z)("Indexing mail $1 $2/$3",[n,l,c]))}s.safeToDelete.size>0&&await dt(t,[...s.safeToDelete]),await it(t)}catch(e){await at(e,n)}},getMessage:async function(e,t,n){const a=e.MAIL_EMAIL,i=await rt(e),{uidlMap:s,sizeMap:r}=await st(i,a),o=s.get(t);if(void 0===o)throw new Error("Message not listed on POP server "+t);const c={index:o,uidl:t,size:r.get(o)||0},{message:l}=await Xe(i,c);U.QO.runStoredQueryFilters([n]);const d=(0,Ue.Zp)(l),u=(0,Ue.Dc)(d).length;return u>0&&(await m.Z.searchList.update(n,{attachment:u}),U.QO.updateIndex({sleUpdates:[{id:n,updates:{attachment:u}}]})),l},repliedOK:$e,openPOP:Qe,sendAndReceive:Ve,parseUidlResponse:Ye,parseListResponse:Je,parseRetrResponse:et,arrayEndsWith:Pe.MF,getNonce:We};let ht;const ft={};async function pt(e){if(e.isDeleted)return;const t=e.MAIL_EMAIL;if(navigator.onLine)if(e.offline)U.U.setStatus(ae.A4,(0,u.Z)("Account $1 has been set as an offline account. Check settings.",[t]));else{if(!e.MAIL_PORT||e.MAIL_PORT<=0)throw new Error(`Port missing or invalid: ${e.MAIL_PORT||""}`);if(!ft[t]){ft[t]=!0,U.U.setStatus(ae.A4,(0,u.Z)("Indexing - $1 $2",[t,P.Gf]));try{await ut.getMail(e),U.U.setStatus(ae.A4,(0,u.Z)("Finished indexing - $1",[t]),P.QM)}catch(t){!function(e,t){b.Z.error("Mail",["pop"],t);const n=`${e.MAIL_SERVER||""} / ${e.MAIL_USER||""}: ${t.name} `;t.message=n+t.message,U.U.setStatus(ae.A4,t.message)}(e,t)}finally{ft[t]=!1,U.QO.removePathIndicator(t,P.Gf)}}}else U.U.setStatus(ae.A4,(0,u.Z)("No network connection"))}async function gt(e){let t=await E.Z.loadPopAccounts();if(t=t.filter((e=>!e.offline)),!t)return;if((await m.Z.systemTasks.toArray()).some((e=>"restore_mail_db"===e.taskName)))b.Z.warn("Mail",["pop"],"Not connecting while restoration in progress");else if(e){const n=t.find((t=>t.MAIL_EMAIL===e));n&&await pt(n)}else for(let e=0;e<t.length;e++)await pt(t[e])}function mt(e,t){return ut.deleteMail(e,t)}function wt(e,t,n){return ut.getMessage(e,t,n)}const _t={checkForMail:gt,deletePopMail:mt,getPopMessage:wt,setCheckInterval:function(e,t){ht&&clearInterval(ht),ht=e?setInterval(gt,6e4*t):void 0}};self.addEventListener("message",(async function({origin:e,data:t,source:n}){if(e!==ae.oP||!t||!t.pop)return;const{promiseId:a,func:i,args:s=[]}=t.pop;if(i)try{const e=await _t[i](...s),t=e&&"getPopMessage"===i?[e.buffer]:void 0;n.postMessage({pop:{promiseId:a,results:e}},{transfer:t})}catch(e){n.postMessage({pop:{promiseId:a,error:e.message||e}})}}),!1);var bt=n(35874),yt=n(13248),vt=n(83204),It=n(92292),Et=n(26067);function kt(e,t,n){const{pathArray:a,fileName:i}=(0,Et.ZP)(e,t,n);return new Promise((e=>{L.Z.mailPrivate.messageFileExists(a,i,(t=>{It.Z.runtime.lastError?e(!1):e(t)}))}))}const xt={runSystemTask:async function(e){const{fileKeys:t}=e,n=t.length;let a=0,i=111;const s=new o.Z.BatchSizeOptimizer(i,2e3);for(;t.length>0;){U.U.setStatus(ae.A4,(0,u.Z)("Checking raw email files $1/$2",[a,n]));const r=Date.now(),o=t.splice(0,i),c=[];for(const e of o){const{accountId:t,searchListId:n,sentDate:a}=e,i=await kt(t,a,n)?1:0;c.push({accountId:t,searchListId:n,hasRaw:i,sentDate:a})}await m.Z.transaction("rw",[m.Z.hasRaw,m.Z.systemTasks],(()=>{m.Z.hasRaw.bulkPut(c),m.Z.systemTasks.update(e.id,{fileKeys:t})})),a+=i;const l=Date.now();i=s.optimize(i,l-r)}await m.Z.systemTasks.delete(e.id),U.U.setStatus(ae.A4,(0,u.Z)("Done checking $1 raw email files",[n]))},isRawOnDisk:kt};var At=n(5267),St=n(83507);var Mt=n(89378),Ot=n(57654),Nt=n(19789);var Lt=n(60308),Tt=n(9982),Zt=n(25100),Rt=n(40348);async function Ct(e,t,n,a,i){const s={added:0,failed:0,dups:0,renamed:0};if(e.from.length+e.to.length+e.cc.length===0&&!e.subject){b.Z.warn("Mail",["restoreMailDb",t,n,a],"Selected file does not seem to be a mail file");const e=(0,u.Z)("Selected file does not seem to be a mail file: $1",[a]);return U.U.setStatus(ae.A4,e,P.QM),s}const r=v.Z.getFolderType(t,n),{indexUpdates:o}=await Lt.Z.call(t,n,r,[e]),{addedSles:c=[],sleUpdates:l=[]}=o,d=c[0];if(!(d||l&&0!==l.length))return b.Z.info("Mail",["restoreMailDb",t,n,a],"Message already exists."),s.dups+=1,s;if(d&&i){const n=v.Z.getFolderType(t,P.N1),a=await f.Z.addSourceFilters(t,P.N1,n,[{message:e,searchListEntry:d}],!0);l.push(...a)}U.QO.updateIndex(o),s.added+=c.length;const{id:h}=d||l[0],{relativePathParts:p,fileName:g}=(0,Et.xh)(a);try{await L.Z.mailPrivate.renameMessageFile(p,g,`_${h}.eml`),It.Z.runtime.lastError&&b.Z.error("Mail",["restoreMailDb","renameMessageFile",g],It.Z.runtime.lastError)}catch(e){return b.Z.error("Mail",["restoreMailDb",p,g,h],e),s.failed+=1,s}return s.renamed+=1,await M.Z.setHasRaw(t,h),await(0,Tt.Z)(t,n,[e]),ee.Z.filter(),Ce.updateThreads(),s}async function Pt(e){try{const t=(0,Et.sz)(e),n=await L.Z.mailPrivate.getFilePaths(t);It.Z.runtime.lastError&&b.Z.error("Mail",["restoreMailDb","getFilePaths",t],It.Z.runtime.lastError);for(const e of n){const{fileName:t,relativePathParts:n}=(0,Et.xh)(e);if("_"===t[0]){const e=t.slice(1);await L.Z.mailPrivate.renameMessageFile(n,t,e),It.Z.runtime.lastError&&b.Z.error("Mail",["restoreMailDb","renameMessageFile",t,e],It.Z.runtime.lastError)}}}catch(e){b.Z.error("Mail",["restoreMailDb"],e)}}async function Ut(e,t,n){if(!n.includes(e)){if(t.find((t=>t.MAIL_EMAIL===e))){b.Z.warn("Mail",["restoreMailDb"],`Account ${e} missing and being added`);const t=l.Z.getDefaultFolders(),n=await r.Z.add(e,t);await h.Z.addAccounts({[e]:n});const a=await c.Z.foldersToFilters(e,t);w.Z.updateFilters(a)}}}async function Ft(e){try{"restore_mail_db"===e.taskName?await async function(e){let t=0,n=0,a=0,i=0,s=0,o=0,c=0,l=0,d=0;try{const h=await L.Z.mailPrivate.getMailFilePaths();It.Z.runtime.lastError&&b.Z.error("Mail",["restoreMailDb","getMailFilePaths"],It.Z.runtime.lastError),h.sort();const f=await E.Z.loadAllAccounts(),p=f.map((e=>e.MAIL_EMAIL)),g={};for(const e of p)g[(0,Et.BB)(e)]=e;const w=(0,Et.BB)(P.u4);let _=[],y=0;if(e.currentFilePath)for(;y<h.length;y++){const t=h[y];if(t.slice(0,t.lastIndexOf("/"))===e.currentFilePath.slice(0,e.currentFilePath.lastIndexOf("/")))break}for(let p=y;p<h.length;p++){p%20==0&&U.U.setStatus(ae.A4,(0,u.Z)("Rebuilding database: $1/$2",[p,h.length]));const y=h[p];try{const{relativePathParts:d,fullPathParts:u}=(0,Et.xh)(y),[h]=d;if(h===w)continue;_.length>0&&u.slice(0,u.length-1).some(((e,t)=>_[t]!==e))&&(await Pt(_),await m.Z.systemTasks.update(e.id,{currentFilePath:y})),_=u;const p=u[u.length-1];let[v,I]=p.split(".");if("_"===v[0]&&(v=v.slice(1)),!I||"eml"!==I.toLowerCase()){b.Z.warn("Mail",["restoreMailDb"],"file name does not have an eml extension",y);continue}if(!Number(v)){b.Z.warn("Mail",["restoreMailDb"],"file does not have a numeric file name",y);continue}if(h===w){b.Z.warn("Mail",["restoreMailDb"],"Not able to restore Feed items yet!");continue}const E=await(0,Rt.Z)(y);if(0===E.length){b.Z.warn("Mail",["restoreMailDb"],"file is empty",y);continue}t+=1;const k=ye.Z.call(E),x=await(0,Zt.Z)(k,[],E),A=g[h],S=x.to.find((e=>e.address===A)),M=x.from.find((e=>e.address===A));let O=S?.address;const N=M?.address;let L;O||N||(O=A);const T=O===N,Z=(await r.Z.getAll()).map((e=>e.accountId));if(O){await Ut(O,f,Z);const{added:e,failed:t,dups:i,renamed:r}=await Ct(x,O,P.Gf,y,T);T?s+=e:a+=e,o+=t,l+=i,n+=r,n>0&&(L=y.replace(/([0-9]+\.eml)$/,"_$1"))}if(N&&!T){await Ut(N,f,Z);const e=L||y,{added:t,failed:a,dups:s,renamed:r}=await Ct(x,N,P.N1,e,!1);i+=t,c+=a,l+=s,n+=r}}catch(e){d+=1,b.Z.error("Mail",["restoreMailDb"],e)}}_.length>0&&await Pt(_),await m.Z.systemTasks.delete(e.id)}catch(e){d+=1,b.Z.error("Mail",["restoreMailDb"],e)}b.Z.warn("Mail",["restoreMailDb"],"Message files read",t),b.Z.warn("Mail",["restoreMailDb"],"Message files renamed",n),b.Z.warn("Mail",["restoreMailDb"],"Duplicates",l),b.Z.warn("Mail",["restoreMailDb"],"Added to Inbox",a),b.Z.warn("Mail",["restoreMailDb"],"Added to Inbox and Sent",s),b.Z.warn("Mail",["restoreMailDb"],"Added to Sent",i),b.Z.warn("Mail",["restoreMailDb"],"Failed adding to Inbox",o),b.Z.warn("Mail",["restoreMailDb"],"Failed adding to Sent",c),b.Z.warn("Mail",["restoreMailDb"],"Errors",d)}(e):"restore_full_text_search_db"===e.taskName?await async function(e){const t=await m.Z.searchList.toCollection().last();if(t){U.QO.pausePrefetching("restoreFullTextSearchDb",!0);try{let{currentPosition:n}=e;for(;n<=t.id;){if(a.Z.get(Z.kMailIsTurnedOff)){U.U.setStatus(ae.A4,(0,u.Z)("Mail client turned off - Stopped building text-search database"),3e3);break}U.U.setStatus(ae.A4,(0,u.Z)("Building text-search database: $1/$2",[(0,Nt.uf)(n),(0,Nt.uf)(t.id)]));const i=await m.Z.messages.where("id").between(n,t.id+1).limit(20).toArray();if(0===i.length)break;const s=await m.Z.searchList.where("id").between(n,i[i.length-1].id+1).toArray(),r=[];for(let e=0;e<i.length;e++){const t=i[e],n=s[e],{subject:a,to:o,cc:c,from:l,replyTo:d}=t;let u=(0,Fe.H)(t.bodyParts);if(!u)for(const e of new Set(n.sourceFilterIds.map((e=>w.Z.get(e))).filter(Boolean).map((e=>e.accountId)))){const t=await St.Z.call(e,n.id,n.sentDate);if(t){if(e===P.u4){const e=new TextDecoder("utf-8").decode(t);u=(0,Ot.Z)(e)}else{const e=(0,Ue.PW)((0,Ue.Zp)(t));if(!e)break;const n=await O.Z.parseMail(t,e.mimeTree);u=(0,Fe.H)(n.bodyParts)}break}}r.push({searchListId:n.id,subject:a,body:u,to:(0,Mt.Z)(o),cc:(0,Mt.Z)(c),from:(0,Mt.Z)(l),replyTo:(0,Mt.Z)(d)})}await(0,z.Z)(r),n=i[i.length-1].id+1,await m.Z.systemTasks.update(e.id,{currentPosition:n})}a.Z.get(Z.kMailIsTurnedOff)||(await m.Z.systemTasks.delete(e.id),U.U.setStatus(ae.A4,(0,u.Z)("Building text-search database finished"),P.QM))}finally{U.QO.pausePrefetching("restoreFullTextSearchDb",!1)}}else await m.Z.systemTasks.delete(e.id)}(e):"delete_full_text_search_entries"===e.taskName?await At.Z.systemTaskDelete(e):"check_disk_for_raw"===e.taskName?await xt.runSystemTask(e):"generate_missing_previews"===e.taskName?await async function(e){const t=e.currentId||0;let n=128;const a=new o.Z.BatchSizeOptimizer(n,2e3),i=await m.Z.searchList.toCollection().primaryKeys(),s=i[i.length-1]??-1;!async function t(i){if(i>=s)return void m.Z.systemTasks.delete(e.id);const r=Date.now(),o=await m.Z.searchList.where("id").between(i,s+1).limit(n).toArray();if(U.U.setStatus(ae.A4,(0,u.Z)("Generate previews: $1/$2",[i,s]),P.QM),0===o.length)return void m.Z.systemTasks.delete(e.id);const c=o.map((e=>e.id)),l=new Map;o.forEach((e=>l.set(e.id,e)));const d=(await m.Z.hasRaw.where("searchListId").anyOf(c).toArray()).filter((e=>e.hasRaw)),h=[];for(const e of d){const{accountId:t,searchListId:n}=e,a=l.get(n);if(a){const e=await St.Z.call(t,n,a.sentDate);if(e){const t=(0,Ue.PW)((0,Ue.Zp)(e));if(t){const a=await O.Z.parseMail(e,t.mimeTree),i=(0,Fe.Q)(a.bodyParts);h.push({id:n,updates:{preview:i}})}}}}i=c[c.length-1]+1,await m.Z.transaction("rw",[m.Z.searchList,m.Z.systemTasks],(async()=>{await Promise.all(h.map((e=>m.Z.searchList.update(e.id,e.updates)))),await m.Z.systemTasks.update(e.id,{currentId:i})})),U.QO.updateIndex({sleUpdates:h});const f=Date.now();n=a.optimize(n,f-r),t(i)}(t)}(e):"migrate_feed_paths"===e.taskName?await async function(e){const t=[],n=[...a.Z.get(Z.kRssSettings)];if(0===n.length)return;const i=[];for(const e of n){const n=crypto.randomUUID();if(e.path!==e.url){i.push({...e});continue}i.push({...e,path:n});const a=await m.Z.filters.where("[accountId+path]").equals([P.u4,e.path]).first();if(!a)continue;t.push(a.id),a.path=n;const s=a.filterValue.include;if(s)for(const t of s)for(const a of t)a.path&&a.path===e.path&&(a.path=n);await m.Z.filters.update(a.id,a)}N.Z.set(Z.kRssSettings,i),await m.Z.systemTasks.delete(e.id),t.length>0&&w.Z.updateFilters(t)}(e):console.error("task not supported",e.taskName)}catch(t){const n=(0,u.Z)("Failed to run system task $1: $2",[e.taskName,t.message||t]);console.error(n),U.U.setStatus(ae.A4,n)}}const Dt=["EXPAND_MAIL_SEARCH_","SCROLL_TOP_MAIL_SEARCH_","SEARCH_STYLE_MAIL_SEARCH_","ON_ROWS_RENDERED_OPTIONS_MAIL_SEARCH_","SELECTION_MAIL_SEARCH_"];async function zt(e,t,n){U.U.setStatus(ae.A4,(0,u.Z)("Removing data from $1 in $2",[t,e]));const a=[e,t,0],i=[e,t,Number.MAX_VALUE];await m.Z.imap.where("[accountId+path+uid]").between(a,i).delete(),await m.Z.mailboxCache.where("[accountId+path]").equals([e,t]).delete();const r=await m.Z.filters.where("[accountId+path]").equals([e,t]).first(),o=await m.Z.filters.toCollection().filter((n=>n.accountId===e&&n.path===t||n.selectedAccountId===e&&n.selectedName===r.name)).primaryKeys(),c=await jt(e,o);e===P.u4&&await m.Z.deletedFeedItems.where("path").equals(t).delete(),n&&await $t(e,c),await m.Z.buffer.where("[accountId+path]").equals([e,t]).delete();const l=s.Z.getSync("FOLDER_SELECTION");if(l?.accountId===e)if(l?.path===t)s.Z.remove("FOLDER_SELECTION");else if(l?.children)for(const e of l.children)e.path===t&&s.Z.remove("FOLDER_SELECTION");s.Z.remove("SELECTION_MAIL_PANEL"),s.Z.remove("SELECTION_FEEDS_PANEL"),Dt.forEach((n=>s.Z.remove(n+e+t))),U.U.setStatus(ae.A4,(0,u.Z)("Finshed removing data from $1 in $2",[t,e]))}async function Bt(e,t){U.U.setStatus(ae.A4,(0,u.Z)("Removing data for $1",[e]));const n=[e,""],a=[e,"￿"];await m.Z.imap.where("accountId").equals(e).delete(),await m.Z.hasRaw.where("accountId").equals(e).delete(),await m.Z.pop.where("accountId").equals(e).delete(),await m.Z.mailboxCache.where("accountId").equals(e).delete();const i=(await m.Z.filters.where("[accountId+path]").between(n,a).toArray()).map((e=>e.id)),r=await jt(e,i);t&&await $t(e,r),await m.Z.buffer.where("accountId").equals(e).delete();s.Z.getSync("FOLDER_SELECTION")?.accountId===e&&s.Z.remove("FOLDER_SELECTION"),s.Z.remove("SELECTION_MAIL_PANEL"),s.Z.remove("SELECTION_FEEDS_PANEL"),Dt.forEach((t=>s.Z.removeAllStartingWith(t+e)))}async function $t(e,t){U.U.setStatus(ae.A4,(0,u.Z)("Removing raw message files for $1",[e])),await Promise.all(t.map((t=>{vt.Z.call(e,t.id,t.sentDate).catch((n=>console.warn(`Error deleting file for ${e}/${t.id}. May not exist! ${n}`)))})))}async function jt(e,t){const n=[],a=[],i=new Set;let s,r;t.forEach((e=>{for(let t=0;t<P.XN;t++)i.add(e*P.XN+t)}));const o=[];await m.Z.transaction("rw",[m.Z.messages,m.Z.searchList,m.Z.threading,m.Z.filters,m.Z.viewIds,m.Z.systemTasks,m.Z.hasRaw],(async()=>{U.U.setStatus(ae.A4,(0,u.Z)("Updating database...")),await m.Z.searchList.where("sourceFilterIds").anyOf(t).distinct().modify(((e,i)=>{if(t.forEach((t=>{e.sources.delete(t)})),e.sources.size>0){const a=new Set(t);e.sourceFilterIds=e.sourceFilterIds.filter((e=>!a.has(e))),n.push(e);const i=new Set(w.Z.getByIds([...e.sources.keys()]).map((({accountId:e})=>e))),s=new Set(w.Z.getByIds(t).map((({accountId:e})=>e)).filter((e=>!i.has(e))));for(const t of s)o.push([e.id,t])}else a.push(e),delete i.value})),r=a.map((e=>e.id)),U.U.setStatus(ae.A4,(0,u.Z)("Removing messages...")),await Promise.all([m.Z.messages.where("id").anyOf(r).delete().then((()=>U.U.setStatus(ae.A4,(0,u.Z)("Removing threading info...")))),m.Z.threading.where("id").anyOf(r).delete().then((()=>U.U.setStatus(ae.A4,(0,u.Z)("Removing header info...")))),m.Z.viewIds.where("searchListId").anyOf(r).delete().then((()=>U.U.setStatus(ae.A4,(0,u.Z)("Updating view indices...")))),m.Z.viewIds.where("searchListId").anyOf(n.map((e=>e.id))).modify((e=>{e.viewIds=e.viewIds.filter((e=>!i.has(e)))})).then((()=>U.U.setStatus(ae.A4,(0,u.Z)("Removing raw indicators...")))),m.Z.hasRaw.where("searchListId").anyOf(r).delete().then((()=>U.U.setStatus(ae.A4,(0,u.Z)("Removing raw indicators...")))),m.Z.hasRaw.bulkDelete(o).then((()=>U.U.setStatus(ae.A4,(0,u.Z)("Removing message filters...")))),m.Z.filters.where("id").anyOf(t).delete().then((()=>U.U.setStatus(ae.A4,(0,u.Z)("Finished updating database"))))]);const e={taskName:"delete_full_text_search_entries",currentPosition:0,searchListIds:r},c=await m.Z.systemTasks.add(e);s={id:c,...e}})),s?Ft(s):console.warn("removeBySourceFilterIds: Expected task to be added"),w.Z.updateFilters(t);const c=n.map((e=>{const n=new Map([...t.map((e=>[e,void 0]))]);for(const[t,a]of e.sources)n.set(t,{...a});return{id:e.id,updates:{sources:n,sourceFilterIds:e.sourceFilterIds,removedViewIds:[...i]}}})),l={removedSles:r,sleUpdates:c};return U.QO.updateIndex(l),a}const Qt=new Set;function Vt(e,t,n){switch(U.QO.setAccountIndicator(e.MAIL_EMAIL,"INDICATOR_TYPE_FLUSHING",n.current,n.total),t.operation){case"BUFFER_OPERATION_CUSTOM_FLAG":return za.updateFlags(e.MAIL_EMAIL,t.path,t.uids,t.flagUpdates);case"BUFFER_OPERATION_DELETE_IMAP":return za.deleteMessages(e.MAIL_EMAIL,t.path,t.uids);case"BUFFER_OPERATION_DELETE_POP":return mt(e,t.searchListIds);case"BUFFER_OPERATION_MOVE":return za.moveMessages(t.accountId,t.path,t.uids,t.destinationPath);case"BUFFER_OPERATION_COPY":return za.copyMessages(e.MAIL_EMAIL,t.path,t.uids,t.destinationPath);case"BUFFER_OPERATION_UPLOAD_MESSAGE":return za.uploadMessage(e.MAIL_EMAIL,t.path,t.searchListId,t.flags);default:return Promise.reject("Unknown batch operation '"+t.operation+"'")}}async function qt(){const e=await m.Z.buffer.where("operation").equals("BUFFER_OPERATION_FETCH_RAW_FOR_ALL_SOURCES").toArray();if(e.length>0){const t=e.map((({searchListId:e})=>e));await async function(e){const t=await A.Z.getBySearchListIdsHasRaw(e,!1);if(0===t.length)return;const n=new Map,a=new Map,i=new Set;for(const{searchListId:e,accountId:s}of t)if((0,yt.mq)(s)){const t=n.get(s);t?t.push(e):n.set(s,[e]),i.add(e)}else if((0,yt.Vd)(s)){const t=a.get(s);t?t.push(e):a.set(s,[e]),i.add(e)}if(0===i.size)return;b.Z.info("Mail",["flushBuffer","fetchRawForAllSources"],`Fetching ${i.size} messages`);const s=await(0,x.Z)([...i]),r=new Map(s.map((e=>[e.id,e]))),o=new Map,c=[],l=new Map,d=new Map,u=[];async function h(e,t,n){const a=r.get(e);if(!a)return void b.Z.error("Mail",["flushBuffer","fetchRawForAllSources",t,e],"Message not found");const i=(0,Ue.PW)((0,Ue.Zp)(n));if(!i)return;const s=await O.Z.parseMail(n,i.mimeTree),h=(0,Fe.Q)(s.bodyParts);u.push({id:e,updates:{preview:h}}),o.has(e)||o.set(e,[a,s]),c.push([e,t,a.sentDate,s.raw]),l.has(e)||l.set(e,h);const f=d.get(t);f?f.push(e):d.set(t,[e])}for(const[e,t]of n)try{const n=await za.fetchRawOfMessages(e,t);for(const[t,a]of n)await h(t,e,a)}catch(t){b.Z.error("Mail",["flushBuffer","fetchRawForAllSources",e],t)}for(const[e,t]of a)try{const n=await m.Z.pop.where("searchListId").anyOf(t).filter((t=>t.accountId===e)).toArray(),a=await E.Z.loadAccount(e);for(const{accountId:e,searchListId:t,uidl:i}of n){if(!r.get(t)){b.Z.error("Mail",["flushBuffer","fetchRawForAllSources",e,t],"Message not found");continue}const n=await wt(a,i,t);n&&await h(t,e,n)}}catch(t){b.Z.error("Mail",["flushBuffer","fetchRawForAllSources",e],t)}U.QO.updateIndex({sleUpdates:u}),await Promise.all([...o].map((([e,[t,n]])=>{const a=(0,Fe.H)(n.bodyParts);return(0,ve.K)(e,t,a).catch((t=>b.Z.error("Mail",["fetchRawForAllSources",e],t)))}))),await Promise.all(c.map((([e,t,n,a])=>C.Z.call(t,n,e,a)))),await Promise.all([...l].map((([e,t])=>(0,S.Z)(e,t)))),await Promise.all([...d].map((([e,t])=>M.Z.setHasRaws(e,t))))}(t),U.QO.runStoredQueryFilters(t),await k.Z.byIds(e.map((({_id:e})=>e)))}}async function Ht(e,t){if(e.accountType===P.s9.IMAP&&!e.offline){for(const n of t)if("Inbox"!==n)try{await za.selectMailbox(e.MAIL_EMAIL,n)}catch(t){b.Z.error("Mail",["syncAndPark",e.MAIL_EMAIL,n],t)}za.park(e.MAIL_EMAIL)}}const Kt=new Map;function Wt(e,t){return o.Z.adjustBatchSize(100,1e3,500,e,t)}const Gt=(0,F.Z)((async()=>{await qt(),await async function(){const e=await m.Z.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT").toArray();for(const t of e){const{accountId:e,deleteFiles:n,deletePasswords:a}=t;await Bt(e,n),R(e,a)}}(),await async function(){const e=await m.Z.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT_PATH").toArray();for(const t of e){const{accountId:e,path:n,deleteFiles:a}=t;await zt(e,n,a)}}();(await E.Z.loadAllAccounts()).forEach((e=>{const{MAIL_EMAIL:t}=e;Qt.has(t)||async function(e){const{MAIL_EMAIL:t}=e;Qt.add(t);const n=new Set;for(;Qt.has(t);){let a;try{if(await m.Z.buffer.where("accountId").equals(t).until((e=>{const t="BUFFER_OPERATION_CUSTOM_FLAG"===e.operation;return a&&!t||(a=e),t})).count(),!a){Qt.delete(t),U.QO.removeAccountIndicator(t,"INDICATOR_TYPE_FLUSHING"),await Ht(e,n),Kt.delete(t);break}if(await m.Z.buffer.update(a._id,{isFlushing:!0}),e.offline){await m.Z.buffer.delete(a._id);continue}const i="BUFFER_OPERATION_DELETE_POP"===a.operation?P.Gf:a.path,s=await r.Z.getFolderByPath(t,i);if(!s||s.internal||e.accountType===P.s9.IMAP&&!s.subscribed){b.Z.info("Mail",["flushBuffer",t,i],"Removing batch for a path that no longer exist or is not subscribed"),await m.Z.buffer.delete(a._id);continue}n.add(i),a.destinationPath&&n.add(a.destinationPath);const o=Kt.get(t)||Wt(100,500);if(void 0!==a.uids&&a.uids.length>o){const{uids:n}=a,{current:i=0,total:s=n.length}=a,r={current:i,total:s},c=n.slice(0,o),l={...a,uids:c},d=Date.now();await Vt(e,l,r);const u=new Set(c);await m.Z.buffer.where("_id").equals(a._id).modify((function(e){e.uids=e.uids.filter((e=>!u.has(e))),e.uids.length>0?(e.current=i+c.length,e.total=s,e.isFlushing=!1):delete this.value}));const h=Wt(o,Date.now()-d);Kt.set(t,h)}else{let t;if(t="BUFFER_OPERATION_DELETE_POP"===a.operation?{current:a.searchListIds.length,total:a.searchListIds.length}:{current:1,total:1},await Vt(e,a,t),void 0!==a.uids){const e=new Set(a.uids);await m.Z.buffer.where("_id").equals(a._id).modify((function(t){t.isFlushing=!1,t.uids=t.uids.filter((t=>!e.has(t))),0===t.uids.length&&delete this.value}))}else await m.Z.buffer.delete(a._id)}}catch(e){if(b.Z.error("Mail",["flushBuffer",t],e),b.Z.debug(JSON.stringify(a)),a){if((0,bt.I)(e.code)||(0,bt.b)(e.message)){await m.Z.buffer.update(a._id,{isFlushing:!1}),Qt.delete(t),U.QO.removeAccountIndicator(t,"INDICATOR_TYPE_FLUSHING");break}await m.Z.buffer.delete(a._id);continue}Qt.delete(t),U.QO.removeAccountIndicator(t,"INDICATOR_TYPE_FLUSHING");break}}}(e)}))}),1e3);const Xt={call:function(){navigator.onLine&&Gt()}};var Yt=n(6977),Jt=n(12382);async function en(e,t,n){const a=[],i=[],s=new Map,r=w.Z.getByFolderId([e,t]);return n.forEach((n=>{const{uid:a}=n;i.push([e,t,a]),s.set(a,n)})),await m.Z.transaction("rw",[m.Z.imap,m.Z.searchList,m.Z.filteringQueue,m.Z.buffer],(async()=>{const n=await m.Z.imap.where("[accountId+path+uid]").anyOf(i).toArray(),o=new Map;n.forEach((e=>{const{searchListId:t,uid:n}=e,a=s.get(n);if(!a)throw new Error("imapMessage not found");o.set(t,a)}));const c=new Jt.Z.FilteringUpdatesSorter,l=[],d=[],u=[];await m.Z.searchList.where("id").anyOf([...o.keys()]).modify((n=>{const i=n.sources.get(r.id);if(!i||i.internal)return void b.Z.info("Mail",["imapUpdateFlags"],i?`Source for ${e}, ${t} is internal`:`Source not found for ${e}, ${t}`);const{id:s,unseen:h,flags:f}=n,p=o.get(s),g={},m={sources:new Map},_=(0,H.jw)(p.flags);g.sources=new Map;const y=(0,H.QE)(f,_);Object.keys(y).length>0&&(!function(e,t){delete t[P.T4.RECENT];const n=u.find((e=>(0,H.ui)(e.imapFlagUpdates,t)));n?n.searchListIds.push(e):u.push({searchListIds:[e],imapFlagUpdates:t})}(s,y),g.flags=n.flags=_,(0,H.wh)(f,p.flags,s,d),(0,H.Oj)(f,p.flags,s,l));const I=!(0,H.FL)(p),E={};i.read!==I&&(h&&I&&(n.unseen=g.unseen=m.unseen=!1),i.read=E.read=I);for(const[t,a]of n.sources)if(a.internal){const n=w.Z.get(t)?.accountId;t!==r.id&&n===e&&I!==a.read&&(a.read=I,g.sources.set(t,{read:I}))}const k=(0,H.uY)(p);if(i.deleted!==k&&(i.deleted=E.deleted=k),Object.keys(E).length>0&&(g.sources.set(r.id,E),m.sources.set(r.id,E)),!k){const a=v.Z.getFolderType(e,t);if(![P.uT,P.Hd,P.hn].includes(a)){[...n.sources.keys()].forEach((t=>{const a=n.sources.get(t);if(!a)throw new Error("Source not found "+t);if(a.internal&&a.deleted){const a=w.Z.get(t);if(!a)throw new Error("Filter not found "+t);a.accountId===e&&(n.sources.delete(t),g.sources.set(t,void 0),m.sources.set(t,void 0))}}))}}(Object.keys(g).length>1||g.sources.size>0)&&a.push({id:s,updates:g}),(Object.keys(m).length>1||m.sources.size>0)&&c.add(s,m)}));for(const e of c.getSorted()){const{searchListIds:t,updates:n}=e;if(n.sources.size>0){const e=[[P.of,P.cm],[P.of,P.tB],[P.of,P.rp],[P.of,P.$T]];await I.Z.call({type:"FILTERS_SLES",priority:P.Un.HIGH,folderIds:e,searchListIds:t})}}for(const e of d){const{searchListIds:t,oldStandardFlag:n,newStandardFlag:a}=e,i=[];n&&i.push([P.MN,n]),a&&i.push([P.MN,a]),i.length>0&&await I.Z.call({type:"FILTERS_SLES",priority:P.Un.HIGH,folderIds:i,searchListIds:[...t]})}for(const e of l){const{searchListIds:t,flag:n}=e,a=[[P.ut,n]];await I.Z.call({type:"FILTERS_SLES",priority:P.Un.HIGH,folderIds:a,searchListIds:[...t],runLabels:!0})}for(const e of c.getSorted()){const{searchListIds:t,updates:n}=e;await I.Z.call({type:"UPDATE_SLE",priority:P.Un.HIGH,searchListIds:t,...n})}if(u.length>0){for(const{searchListIds:t,imapFlagUpdates:n}of u)await Yt.Z.addImapFlags(t,n,e);Xt.call()}})),a}var tn=n(89846);async function nn(e,t){return await m.Z.transaction("rw",[m.Z.searchList,m.Z.messages,m.Z.threading],(async()=>{const n=(await m.Z.searchList.where("messageId").equals(e).toArray()).map((e=>e.id));await m.Z.searchList.where("id").anyOf(n).modify((e=>e.messageId=t)),await m.Z.messages.where("id").anyOf(n).modify((e=>e.messageId=t)),await m.Z.threading.where("id").anyOf(n).modify((e=>e.messageId=t))}))}async function an(e,t,n,a){let i=[];const s=await m.Z.transaction("rw",y.E.concat([m.Z.imap,m.Z.accounts,m.Z.filters,m.Z.searchList,m.Z.filteringQueue,m.Z.buffer]),(async()=>{const s=[],o=[],c=[],l={};for(const e of a)if(e.originalMessageId){const t=e.originalMessageId;l[t]=e.messageId,await nn(t,e.messageId)}if(Object.keys(l).length>0)for(const e of a)l[e.messageId]&&(e.messageId=l[e.messageId]);const d=await f.Z.findMatchingSles(a),u=await async function(e,t,n){if(e.every((({searchListEntry:e})=>!e)))return{intact:e,newImapEntries:[],sleUpdates:[]};const a=await r.Z.getFolderByPath(t,n);if(!a)throw new Error(`${n} not found in db.accounts table for ${t}`);const i=a.type,s=w.Z.getByFolderId([t,n]);if(!s)throw new Error(`Filter not found for ${t} ${n}`);const o=[],c=[],l=[];for(const a of e){const{message:e,searchListEntry:r}=a;if(!r||e.sentDate!==r.sentDate||e.subject!==r.subject){l.push(a);continue}const{sourceFilterIds:d,sources:u}=r,h=u.get(s.id);if(!h||!h.internal){l.push(a);continue}const f=w.Z.getByIds(d);let p,g;for(const e of f){const{accountId:a,path:s}=e,r=a===t&&s===n;if(a===P.of&&s===P.N1&&i===P.Nz||r){p=a,g=s;break}}if(!p){l.push(a);continue}if(!g){l.push(a);continue}const{sleUpdate:m}=await(0,tn.Z)(r.id,p,g,t,n,{addedProperties:{searchListSource:{internal:!1}}});o.push(m),c.push({accountId:t,path:n,uid:e.uid,searchListId:m.id})}return{intact:l,newImapEntries:c,sleUpdates:o}}(d,e,t),{intact:h,newImapEntries:p,sleUpdates:v}=u;if(s.push(...p),c.push(...v),0===h.length){await m.Z.imap.bulkPut(s);const n=await en(e,t,a);return c.push(...n),{sleUpdates:c}}const I=w.Z.getByFolderId([e,t]);if(!I)throw new Error(`Filter not found for ${e} ${t}`);const{newMessageGroups:E,duplicates:k}=f.Z.findDuplicates(h);for(const n of k){const{message:a,searchListEntry:i}=n;if(i.sources.get(I.id)){(await _.call([e,t,i.id])).some((({uid:e})=>e===a.uid))||s.push({accountId:e,path:t,uid:a.uid,searchListId:i.id})}else s.push({accountId:e,path:t,uid:a.uid,searchListId:i.id})}const x=E.map((e=>e[0])),A=await(0,y.Z)(e,t,n,x),S=A.addedSles;if(i=A.forSearchDb,S.forEach(((n,a)=>{E[a].forEach((a=>{s.push({accountId:e,path:t,uid:a.uid,searchListId:n.id})})),o.push(n)})),s.length)try{await m.Z.imap.bulkAdd(s)}catch(n){b.Z.info("Mail",["addImap"],"bulkAdd to imap table failed, checking individual items",n);const i=await m.Z.imap.where("[accountId+path+uid]").anyOf(a.map((({uid:n})=>[e,t,n]))).toArray();for(const e of s){const t=g()(i,e,ie.gE);try{if(t<0)await m.Z.imap.add(e);else{const n=i[t];n.searchListId!==e.searchListId?(b.Z.info("Mail",["addImap"],"searchListId mismatch, the imap entry will be updated",{newImapEntry:e,existingImapEntry:n}),await m.Z.imap.put(e)):b.Z.info("Mail",["addImap"],"imap entry already exists, not adding",n)}}catch(e){b.Z.error("Mail",["addImap"],e)}}}const M=new Set(p.map((e=>e.uid))),O=a.filter((e=>M.has(e.uid))),N=await en(e,t,O);if(c.push(...N),k.length>0){const a=await f.Z.addSourceFilters(e,t,n,k,!1);c.push(...a)}return{addedSles:o,sleUpdates:c}}));return(0,z.Z)(i),s}var sn=n(72315),rn=n.n(sn),on=n(91258);const cn={debug:e=>{a.Z.get(Z.kMailImapLogsOn)&&b.Z.debug("Mail",["imap-client"],...e())},info:e=>{a.Z.get(Z.kMailImapLogsOn)&&b.Z.info("Mail",["imap-client"],...e())},error:e=>{a.Z.get(Z.kMailImapLogsOn)&&b.Z.error("Mail",["imap-client"],...e())}};function ln(e,t){const n=t||{user:e.MAIL_USER,pass:(0,Pe.DA)((new TextEncoder).encode(e.MAIL_PASSWORD))},i=new(rn())({host:e.MAIL_SERVER,port:Number(e.MAIL_PORT),auth:n,secure:!0,ignoreTLS:!1,id:{name:`Vivaldi Mail/${L.Z.utilities.getVersion().vivaldiVersion}`},logger:cn});return i._client.logLevel=a.Z.get(Z.kMailImapLogsOn)?on.lw:on.jF,i._client.timeoutConnection=1e4,i._client._enableCompression=!1,i}const dn=async function(e,t){const n=[],a=e.map((e=>e.searchListId));return m.Z.imap.bulkAdd(e),await m.Z.searchList.where("id").anyOf(a).modify((e=>{const{id:a}=e,i={sources:new Map},s=e.sources.get(t.id);if(s)s.internal=!1,i.sources.set(t.id,{...s});else{const n={read:!1,deleted:!1,internal:!1};e.sources.set(t.id,n),i.sources.set(t.id,{...n})}n.push({id:a,updates:i})})),n};const un=async function(e,t,n){await m.Z.buffer.where("[accountId+path+operation]").equals([e,t,"BUFFER_OPERATION_CUSTOM_FLAG"]).modify((function(e){const{uids:t,flagUpdates:a}=e,i=new Set(t);n.forEach((e=>{Object.keys(a).every((t=>a[t]?e.flags.includes(t):!e.flags.includes(t)))&&i.delete(e.uid)})),0===i.size?delete this.value:e.uids=[...i]}))};var hn=n(93818),fn=n(57207),pn=n(30381),gn=n.n(pn);var mn=n(89555);let wn,_n,bn,yn={};function vn(){b.Z.info("Mail",["imapCache"],"Resetting init promise"),wn=new Promise(((e,t)=>{_n=()=>{b.Z.info("Mail",["imapCache"],"Resolving init promise"),e()},bn=e=>{b.Z.info("Mail",["imapCache"],"Rejecting init promise"),t(e)}})),wn.catch(mn.Z)}function In(){return b.Z.info("Mail",["imapCache"],"Initializing UID lists"),m.Z.imap.orderBy("[accountId+path+uid]").primaryKeys().then((e=>{e.forEach((e=>{const[t,n,a]=e;yn[t]||(yn[t]={}),yn[t][n]||(yn[t][n]=new Set),yn[t][n].add(a)})),_n()})).catch((e=>{throw bn(e),e}))}function En(e,t){delete yn[e][t]}async function kn(e){await wn;const t=await async function(e){const t=new Set,n=await r.Z.getFolder(e);for(const e of Object.keys(n)){const a=n[e];for(const e of a)t.add(e.path)}return t}(e),n=await m.Z.mailboxCache.where("accountId").equals(e).toArray(),a=yn[e]||{},i={};for(const e of n)i[e.path]=e,i[e.path].uidlist=Array.from(a[e.path]||[]),i[e.path].exists=i[e.path].uidlist.length,i[e.path].highestModseq=i[e.path].highestModseq||"0",t.delete(e.path),i[e.path].noModseq=i[e.path].noModseq||!1;for(const e of t){const t=Array.from(a[e]||[]),n=t.length>0?t[t.length-1]+1:0;i[e]={uidlist:t,uidNext:n,exists:t.length}}return i}vn();var xn=n(82164),An=n(36154);let Sn={};async function Mn(e,t){const n=await(0,An.Vf)(e,t),{accessToken:a,refreshToken:i,expiresIn:s,usernameFromIdToken:r}=n;r&&r.toLowerCase()!==e.toLowerCase()&&(Nn(e,["Username and the sub from idToken do not match",e,r]),e=r);const o=Date.now()+1e3*parseInt(s);if(Nn(e,["Fetched both refresh_token and access_token that expires in: ",On(o)]),Tn({[e]:{accessToken:a,expiryTime:o}}),i)try{const n={refreshToken:await L.Z.utilities.osCrypt(i),provider:t};Cn.call(e,n)}catch(e){b.Z.error("oAuth","Error crypting refresh_token",e)}return{accessToken:a,usernameFromIdToken:e}}function On(e){const t=new Date(e);return`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`}function Nn(e,t){b.Z.info("oAuth",[e],t.join(" "))}async function Ln(e,t){const n=(await Rn.call())[e],i=function(e){return(a.Z.get(Z.kOauthRefreshTokens)||{})[e.toLowerCase()]}(e);if(n&&n.expiryTime>Date.now())return{accessToken:n.accessToken,usernameFromIdToken:e};if(i){let n="";try{n=await L.Z.utilities.osDecrypt(i.refreshToken)}catch{return Zn(e,t)}Nn(e,["The access_token has expired in-session or we restarted the session.","Lets fetch new access_token using refresh_token from prefs"]);const a=await An.jb.call(n,t),{accessToken:s,expiresIn:r,invalidGrant:o,refreshToken:c,usernameFromIdToken:l}=a;if(c&&c!==n&&Cn.call(e,{refreshToken:await L.Z.utilities.osCrypt(c),provider:t}),o)return Nn(e,["Invalid oAuth grant. Refresh Token has expired or has been revoked"]),b.Z.warn("oAuth","Invalid oAuth grant. Refresh Token has expired or has been revoked"),Zn(e,t);{const t=Date.now()+1e3*parseInt(r);return Nn(e,[`Got new access token with new expiry time: ${On(t)}\n        (fetched with stored refresh_token)`]),Tn({[e]:{accessToken:s,expiryTime:t}}),{accessToken:s,usernameFromIdToken:l}}}return Nn(e,["We don't have a cached token and we don't have a refresh token.","Need to fetch both."]),await Mn(e,t)}function Tn(e){Sn={...Sn,...e}}async function Zn(e,t){return Pn.call(e),Mn(e,t)}const Rn={call:function(){return Sn}},Cn={call:async function(e,t){N.Z.set(Z.kOauthRefreshTokens,{...a.Z.get(Z.kOauthRefreshTokens),[e]:t})}},Pn={call:async function(e){const t={...a.Z.get(Z.kOauthRefreshTokens)},{provider:n}=t[e],i=xn.Z.oAuthProviders().get(n),s=(await Rn.call())[e];if(i?.revokeRefreshToken&&s){const{accessToken:e}=s;i.revokeRefreshToken(e)}!function(e){delete Sn[e]}(e),delete t[e.toLowerCase()],N.Z.set(Z.kOauthRefreshTokens,t)}};var Un=n(6271);async function Fn(e){const{accessToken:t}=await Ln(e.MAIL_EMAIL,(0,Un.dn)(e));return{user:e.MAIL_EMAIL,xoauth2:t}}var Dn=n(83065);function zn(e){const t=e.split(","),n=[];return t.forEach((e=>{if(e.indexOf(":")>=0){const[t,a]=e.split(":"),i=Number.parseInt(t),s=Number.parseInt(a);if(i<s)for(let e=i;e<=s;e++)n.push(e);else for(let e=s;e<=i;e++)n.push(e)}else{const t=Number.parseInt(e);n.push(t)}})),n}var Bn=n(34155);const $n=new Map,jn=new Map,Qn=new Set,Vn=new Map,qn=new Map,Hn=18e5,Kn=9e5,Wn={},Gn={},Xn=new Set;let Yn=!1,Jn=!1;const ea=new Map;let ta,na=0,aa=0,ia=!1,sa=0,ra=0,oa=50;const ca=new o.Z.BatchSizeOptimizer(oa,1e3),la=new class{constructor(e){this.lock=(0,d.M)(),this._priorityQueue=[];for(let t=0;t<e;t++)this._priorityQueue.push([])}queue(e,t,...n){return new Promise(((a,i)=>{this._priorityQueue[t].push({func:e,resolve:a,reject:i,params:n}),this._processQueue()}))}async _processQueue(){const e=await this.lock();try{await this._runNextInLine()}finally{e()}}async _runNextInLine(){for(const e of this._priorityQueue){const t=e.shift();if(t){const{func:e,resolve:n,reject:a,params:i}=t;try{n(await e(...i))}catch(e){a(e)}return!0}}return!1}hasFunc(e){for(const t of this._priorityQueue)for(const n of t)if(n.func===e)return!0;return!1}}(Object.keys(P.NB).length);let da;async function ua(e){if(!navigator.onLine)throw new Error("No network connection");if(a.Z.get(Z.kMailIsTurnedOff))throw new Error("Mail has been turned off");const t=(a.Z.get(Z.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));if(!t)throw new Error("Account has been deleted");if(t.offline)throw new Error("Account is offline");const n=$n.get(e);if(n)return n;const i=jn.get(e);if(i)return b.Z.info("Mail",["_getClient",e],"Connecting..."),i.promise;throw U.U.setStatus(ae.A4,(0,u.Z)("Reconnecting $1",[e])),Oa(e),new Error("Not connected - Attempting to connect "+e)}function ha(e){e!==P.of&&(Qn.add(e),fa())}const fa=(0,F.Z)((async()=>{const e=[...Qn];Qn.clear();for(const t of e){const[e]=v.Z.getPathsByType(t,P.e9);if(!e)return void b.Z.warn("Mail",["imap",t],"No inbox found to park in");if($n.has(t))try{await pa(t,e,!0)}catch(e){ka(e,t)}}}),2e3);function pa(e,t,n=!1){if(!navigator.onLine)return Promise.reject("No network connection");Wn[e]||(Wn[e]=[]);const a=Wn[e];return new Promise(((s,r)=>{n?0!==a.length&&a[0].path===t||a.unshift({path:t,resolve:s,reject:r}):a.find((e=>e.path===t))||a.push({path:t,resolve:s,reject:r}),Gn[e]||(Gn[e]=!0,Bn.nextTick(i))}));async function i(){const t=Wn[e];if(!t||t.length<=0)return void(Gn[e]=!1);const{path:n,resolve:a,reject:s}=t.pop();try{const t=await ua(e);await t.selectMailbox({path:n}),a()}catch(e){s(e)}finally{U.QO.removePathIndicator(e,n),Bn.nextTick(i)}}}async function ga(e,t){const n=await m.Z.imap.where("searchListId").anyOf(t).filter((t=>t.accountId===e)).toArray();if(0===n.length)return new Map;const a=new Map;for(const{searchListId:e,path:t,uid:i}of n){const n=a.get(e);n?n.set(t,i):a.set(e,new Map([[t,i]]))}const i=[];for(const[t,n]of a)i.push({accountId:e,pathToUid:n,size:0,searchListId:t});return await la.queue(ma,P.NB.FETCH_RAW,e,i)}async function ma(e,t){const n=new Map;if(0===t.length)return n;if(!navigator.onLine)throw new Error("No network connection");const a=new Set;for(const{pathToUid:e}of t)for(const t of e.keys())a.add(t);try{for(const i of[...a]){const a=new Map;for(const{searchListId:e,pathToUid:s}of t){if(n.has(e))continue;const t=s.get(i);void 0!==t&&a.set(t,e)}if(0===a.size)continue;const s=[...a.keys()],r=await ua(e),o=await r.getMessages({path:i,uids:s});Object.keys(o).forEach((t=>{const s=a.get(parseInt(t));s?o[t]?n.set(s,o[t]):b.Z.error("Mail",["fetchRaw"],`Expected to find raw for ${e}/${i}/${t}`):b.Z.error("Mail",["fetchRaw"],`Un-expected uid ${e}/${i}/${t}`)}))}return ha(e),n}catch(t){throw U.U.setStatus(ae.A4,(0,u.Z)("Failed to get message body - $1",[t])),b.Z.warn("Mail",["imap",e],"Fetch raw",t),t}}async function wa(e,t,n,i,s){if(!navigator.onLine)throw new Error("No network connection");const r=await ua(e),o=function(e){const t=[...e];let n;t.sort(((e,t)=>e-t));const a=[];for(const e of t)n&&n[n.length-1]===e-1?n.push(e):(n=[e],a.push(n));const i=a.map((e=>1===e.length?e[0]:e[0]+":"+e[e.length-1]));return i.join(",")}(n),c=await r.listMessages({path:t,sequence:o});a.Z.get(Z.kMailAutoGenerateContacts)&&await(0,Tt.Z)(e,t,c);const l=v.Z.getFolderType(e,t),d=await an(e,t,l,c);U.QO.updateIndex(d),we.filter(),Ce.updateThreads();const{addedSles:h,sleUpdates:f}=d;(h&&h.length>0||f&&f.length>0)&&(U.U.setStatus(ae.A4,(0,u.Z)("Indexing mail $1 $2 $3/$4",[e,t,s,i])),U.QO.setPathIndicator(e,t,"INDICATOR_TYPE_FETCHING",P.NB.SYNC_NEW_DELETED,s,i));!function(e,t,n){if(yn[e]||(yn[e]={}),yn[e][t]){const a=[...yn[e][t],...n].sort(((e,t)=>e-t));yn[e][t]=new Set(a)}else yn[e][t]=new Set(n)}(e,t,c.map((e=>e.uid)))}function _a(e){if(a.Z.get(Z.kMailIsTurnedOff))return!1;const t=(a.Z.get(Z.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));return!!t&&!t.offline}function ba(e){if(a.Z.get(Z.kMailIsTurnedOff)||Jn)return!1;const t=(a.Z.get(Z.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));return!!t&&!t.offline&&"none"!==ya(e)}function ya(e){const t=(a.Z.get(Z.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));if(t)return t.preFetch;throw new Error("Account not found "+e)}function va(e){switch(ya(e)){case"day":return gn()().subtract(1,"d").startOf("day").valueOf();case"week":return gn()().subtract(1,"w").startOf("day").valueOf();case"month":return gn()().subtract(1,"M").startOf("day").valueOf();case"year":return gn()().subtract(1,"y").startOf("day").valueOf();default:return 0}}async function Ia(e,t,n,a){let i=100,s=0;const r=new o.Z.BatchSizeOptimizer(100,2e3);return new Promise(((o,c)=>{la.queue((async function l(){if(!_a(e))return void o();const d=t.slice(s,s+i);if(0===d.length)return void o();const u=Date.now();try{await a(d,t.length,s),s+=i}catch(e){return void c(e)}const h=Date.now();i=r.optimize(i,h-u),Yn===e&&(ta=void 0,na=await Ua(e));la.queue(l,n).catch(c)}),n).catch(c)}))}async function Ea(e,t){if(!navigator.onLine)throw new Error("No network connection");U.U.setStatus(ae.A4,(0,u.Z)("Indexing - $1 $2",[e,t.path]));const{list:n,path:a,type:i}=t;try{if("new"===i){b.Z.log("Mail",["imap",e],"new messages received",a,n),n.reverse();try{U.QO.setSyncing(e,!0),await Ia(e,n,P.NB.SYNC_NEW_DELETED,(async(t,n,i)=>{await wa(e,a,t,n,i)}))}finally{U.QO.setSyncing(e,!1)}await Ra(e)}else if("deleted"===i){if(b.Z.log("Mail",["imap",e],"messages deleted on server",a,n),await Ia(e,n,P.NB.SYNC_NEW_DELETED,(async t=>{await fn.Z.deleteFromFolder(e,a,t)})),v.Z.getFolderType(e,a)!==P.uT){const t=v.Z.getPathsByType(e,P.uT);try{for(const n of t)pa(e,n)}catch(t){ka(t,e)}finally{ha(e)}}}else if("messages"===i){b.Z.log("Mail",["imap",e],"flag updates from server",a,n);try{U.QO.setSyncingFlags(e,!0),await Ia(e,n,P.NB.SYNC_FLAGS,(async(t,n,i)=>{await async function(e,t,n,a,i){await un(e,t,n);const s=await en(e,t,n);U.QO.updateIndex({sleUpdates:s}),U.U.setStatus(ae.A4,(0,u.Z)("Updating flags $1 $2 $3/$4",[e,t,i,a])),U.QO.setPathIndicator(e,t,"INDICATOR_TYPE_FLAGS",P.NB.SYNC_FLAGS,i,a)}(e,a,t,n,i)}))}finally{U.QO.setSyncingFlags(e,!1)}}if(_a(e)){const t=await ua(e);!function(e,t,n){"inbox"===t.toLowerCase()&&(t=P.Gf),wn.then((()=>m.Z.transaction("rw",m.Z.mailboxCache,(()=>{Object.keys(n).forEach((a=>{const i=n[a];a!==t&&0!==i.exists||m.Z.mailboxCache.put({accountId:e,path:a,uidNext:i.uidNext,highestModseq:i.highestModseq||"0",noModseq:i.noModseq||!1})}))}))))}(e,a,t.mailboxCache)}U.U.setStatus(ae.A4,(0,u.Z)("Finished indexing - $1 $2",[e,a]),P.QM)}catch(t){ka(t,e,"indexing")}U.QO.removePathIndicator(e,a),U.QO.removePathIndicator(e,a),we.filter()}function ka(e,t,...n){U.KU.set(t,"IMAP",e,e.code);const a=["imap",t,...n];if((0,yt.dS)(t)&&"The user did not approve access."===e.message)return void b.Z.info("Mail",["imap",t],"User closed oAuth popup dialog");if((0,bt.I)(e.code))return b.Z.info("Mail",a,"Authentication failed"),ea.delete(t),void U.QO.setDisconnected(t,!0);const i=e.code?`[${e.code}] ${e.message||e}`:`${e.message||e}`;if((0,bt.b)(i)){b.Z.info("Mail",a,i);const n=function(e){let t=ea.get(e)||0;if(++t<=5)return ea.set(e,t),2e3*t;let n=Vn.get(e);n=void 0===n?6e4:Math.min(n+Kn,Hn),Vn.set(e,n);const a=Math.floor(1e3*Math.random()*6-3e3);return n+a}(t);Oa(t,n,e)}else b.Z.error("Mail",a,i),U.U.setStatus(ae.A4,i)}async function xa(){const e=await E.Z.loadImapAccounts();if(e)for(const t of e)await Aa(t);else b.Z.warn("Mail",["imap"],"No IMAP accounts found!")}async function Aa(e){const t=e.MAIL_EMAIL;if(b.Z.info("Mail",["imap",t],"connectImapclient"),e.isDeleted||e.offline)return void b.Z.info("Mail",["imap",t],"deleted or offline",!!e.isDeleted,!!e.offline);if(!navigator.onLine)return b.Z.info("Mail",["imap",t],"No network connection"),void U.QO.setDisconnected(t,!0);if(!e.MAIL_PORT||e.MAIL_PORT<=0)throw new Error(`Port missing or invalid: ${e.MAIL_PORT||""}`);if((await m.Z.systemTasks.toArray()).some((e=>"restore_mail_db"===e.taskName)))return void b.Z.warn("Mail",["imap",t],"Not connecting while restoration in progress");if($n.has(t))return void b.Z.info("Mail",["imap",t],"Already connected");if(jn.has(t))return void b.Z.info("Mail",["imap",t],"Currently being connected");let n,a;try{let i;jn.set(t,{promise:new Promise(((e,t)=>{n=e,a=t}))}),e.useOAuth&&(i=await Fn(e));let s=!1;const o=setTimeout((()=>{jn.delete(t),s=!0,a&&a("Client initialization timed out")}),1e4);b.Z.info("Mail",["imap",t],"Creating client");const l=i?ln(e,i):ln(e);l.onSyncUpdate=Ea.bind(null,t),l.onError=e=>{ka(e,t)},b.Z.info("Mail",["imap",t],"Fetching mailbox cache");const d=await kn(t);if(l.mailboxCache=d||{},s)return;clearTimeout(o);const f=jn.get(t);if(!f)return void(a&&a("Client initialization cancelled"));if(f.client=l,U.QO.setAccountIndicator(t,"INDICATOR_TYPE_CONNECTING"),U.QO.setConnecting(t,!0),b.Z.info("Mail",["imap",t],"Connecting"),await l.login(),!jn.has(t))return void(a&&a("Client initialization cancelled"));b.Z.info("Mail",["imap",t],"Connected"),U.U.setStatus(ae.A4,(0,u.Z)("Connected to $1",[t]),P.QM);const p=h.Z.get(t);p&&0===Object.keys(p.folders).length&&await async function(e){const t=await e.listWellKnownFolders();for(const n of[P.e9,P.Nz,P.uT])if(Array.isArray(t[n])&&t[n].length>0){const{path:a,subscribed:i}=t[n][0];i||await e.subscribeMailbox({path:a})}}(l);const g=await l.listWellKnownFolders();if(!jn.has(t))return void(a&&a("Client initialization cancelled"));g.Inbox&&g.Inbox.forEach((e=>{"inbox"===e.path.toLowerCase()&&(e.path=P.Gf)}));const m=await r.Z.updateFolders(t,g);await h.Z.updateAccount(t,m);const _=await c.Z.foldersToFilters(t,m);w.Z.updateFilters(_),ee.Z.addFolders(t,m),b.Z.info("Mail",["imap",t],"Clean up after connection"),Vn.delete(t),Na(t),ea.delete(t),jn.has(t)&&($n.set(t,l),n&&n(l),U.QO.setDisconnected(t,!1),U.KU.delete(t,"IMAP"),Xt.call())}catch(e){a&&a(e),ka(e,t)}finally{jn.delete(t),U.QO.setConnecting(t,!1),U.QO.removeAccountIndicator(t,"INDICATOR_TYPE_CONNECTING")}if($n.has(t))try{await Ta(t),Ra(t)}catch(e){ka(e,t)}}async function Sa(){for(const e of[...jn.keys(),...$n.keys()])await Ma(e)}async function Ma(e,t){const n=$n.get(e)||jn.get(e)?.client;if(b.Z.info("Mail",["imap",e],"Disconnect",!!n),delete Wn[e],delete Gn[e],Na(e),jn.has(e)&&(b.Z.info("Mail",["imap",e],"Client initialization cancelled"),jn.delete(e)),$n.has(e)&&(b.Z.info("Mail",["imap",e],"Client disconnected"),$n.delete(e)),U.QO.setDisconnected(e,!0),U.QO.removeAllIndicators(e),t&&U.KU.set(e,"IMAP",t,t.code),n)try{n.onSyncUpdate=!1,n.onError=mn.Z,await n.logout()}catch(t){b.Z.error("Mail",[e],"Failed to log out",t)}finally{b.Z.info("Mail",["imap",e],"Logged out")}}async function Oa(e,t,n){async function i(){if(!navigator.onLine)return void b.Z.info("Mail",["imap",e],"No network. Skip reconnection attempt");const t=(await E.Z.loadImapAccounts()).find((t=>t.MAIL_EMAIL===e));b.Z.info("Mail",["imap",e],"Reconnect",t),t&&await Aa(t)}a.Z.get(Z.kMailIsTurnedOff)?b.Z.info("Mail",["imap",e],"Mail was turned off"):(await Ma(e,n),t?function(e,t,n){if(qn.has(n))return void b.Z.info("Mail",["imap",n],"Has reconnect timeout");b.Z.info("Mail",["imap",n],"Set reconnect timeout");const a=setTimeout(e,t);qn.set(n,a)}(i,t,e):await i())}function Na(e){const t=qn.get(e);void 0!==t&&(clearTimeout(t),qn.delete(e))}function La(){return 0===$n.size}async function Ta(e){if(La()||e&&!$n.has(e))return;let t;if(e)t=await r.Z.getFolder(e).then((t=>({[e]:{folders:t}})));else{const e=await E.Z.loadImapAccounts();t=await r.Z.getAll().then((t=>{const n={};for(let a=0;a<e.length;a++){const i=e[a],s=t.find((e=>i.MAIL_EMAIL===e.accountId));s&&(n[s.accountId]={folders:s.folders})}return n}))}const n=l.Z.getFolders(t,!1);for(const e of n){const t=e.accountId,n=e.children;!n||n.length<=0||(n.sort(((e,t)=>e.type===t.type?0:"Inbox"===e.type?1:"Inbox"===t.type||"All"===e.type?-1:"All"===t.type?1:0)),a(t,n))}function a(e,t){for(const n of t)n.subscribed&&!n.internal&&i(e,n.path),n.children&&a(e,n.children)}async function i(e,t){try{await pa(e,t)}catch(n){ka(n,e,t,"selectMailbox")}}}async function Za(e){La()||e&&!$n.has(e)?await xa():Ta(e)}function Ra(e){Xn.add(e),Pa()}function Ca(e){if(b.Z.log("Mail",["imap","prefetch"],e?"pause possible prefetching":"resume possible prefetching"),Jn=e,!e){const e=(a.Z.get(Z.kMailAccounts)||[]).filter((e=>!e.offline));for(const t of e)Ra(t.MAIL_EMAIL)}}function Pa(){if(Yn||Jn)return;const e=[...Xn];Xn.clear();let t=!1;e.reduce(((e,n)=>e.then((()=>(Yn=n,async function(e){if(!ba(e))return;b.Z.log("Mail",["imap","prefetch",e],"starting"),t=!1;let n=va(e),a=ya(e);const i=[],s=2e3;let r;aa=0,na=await Ua(e),ta=void 0;try{r=setTimeout((()=>{U.QO.setPreFetching(e,!0),r=void 0}),5e3);let t=!0;for(;t;)t=await la.queue(o,P.NB.PRE_FETCH)}finally{r?clearTimeout(r):U.QO.setPreFetching(e,!1)}t&&U.QO.removeAccountIndicator(e,"INDICATOR_TYPE_PRE_FETCHING");async function o(){if(!ba(e))return t&&(b.Z.log("Mail",["imap","prefetch",e],Jn?"paused":"stopped"),U.U.setStatus(ae.A4,Jn?(0,u.Z)("Prefetching paused - $1",[e]):(0,u.Z)("Stopped prefetching - $1",[e]))),!1;const r=ya(e);r!==a&&(na=await Ua(e),a=r);const o=va(e);if(o>n){let e,t=i.length-1;for(;t>0&&(i[t]?.sentDate??0)<o;)e=t,t--;void 0!==e&&i.splice(e),n=o}if(i.length<s&&await m.Z.transaction("r",[m.Z.hasRaw,m.Z.imap,m.Z.searchList],(async()=>{const t=await A.Z.getByAccountIdHasRaw(e,!1,5*s,n,ta);if(0===t.length)return;const a=t[t.length-1];ta=[0,e,a.sentDate,a.searchListId];const r=t.map((({searchListId:e})=>e)),o=await m.Z.imap.where("searchListId").anyOf(r).filter((t=>t.accountId===e)).toArray(),c=await m.Z.searchList.bulkGet(r),l=new Map;for(const e of c)e&&l.set(e.id,e);let d;for(const t of o){const{searchListId:n,path:a,uid:s}=t;if(d&&d.searchListId===n)d.pathToUid.set(a,s);else{const t=l.get(n);if(!t){b.Z.error("Mail",["imap","prefetch",e,a,n],"SearchList entry not found");continue}d={accountId:e,pathToUid:new Map([[a,s]]),size:t.size,searchListId:n,sentDate:t.sentDate},i.push(d)}}})),0===i.length)return b.Z.log("Mail",["imap","prefetch",e],"done"),t&&U.U.setStatus(ae.A4,(0,u.Z)("Finished prefetching - $1",[e])),!1;i.sort(ie.CB);const c=i.shift();let l=c.size;const d=5242880,h=2347,f=[c],p=[...c.pathToUid.keys()][0];let g=0;for(;i.length>0&&g<i.length&&l<d&&f.length<h;){if(!i[g].pathToUid.has(p)){g++;continue}const[e]=i.splice(g,1);f.push(e),e.size&&(l+=e.size)}Jn?U.U.setStatus(ae.A4,(0,u.Z)("Prefetching paused - $1",[e])):U.U.setStatus(ae.A4,(0,u.Z)("Prefetching - $1 $2/$3",[e,aa,na])),U.QO.setAccountIndicator(e,"INDICATOR_TYPE_PRE_FETCHING",P.NB.PRE_FETCH,aa,na),b.Z.log("Mail",["imap","prefetch",e],"fetching batch",f.length,l);const w=await async function(e,t){const n=await ma(e,t),a=new Map;for(const{searchListId:e,sentDate:n}of t)a.set(e,n);const i=[],s=[],r=[],o=new Set(await m.Z.searchList.where("id").anyOf(t.map((({searchListId:e})=>e))).filter((({preview:e})=>!e)).primaryKeys());for(const[c,l]of n){const n=a.get(c);if(void 0!==n)try{if(await C.Z.call(e,n,c,l),r.push([c,n]),o.has(c)){const e=(0,Ue.PW)((0,Ue.Zp)(l));if(e){const t=await O.Z.parseMail(l,e.mimeTree),n=(0,Fe.Q)(t.bodyParts);s.push([c,n]),i.push({id:c,updates:{preview:n}})}}}catch(t){b.Z.error("Mail",["imap",e,c],"Failed to process mail: ",t)}else{const n=t.find((e=>e.searchListId===c));if(n){const t=[];for(const[a,i]of n.pathToUid)t.push([e,a,i]),b.Z.warn("Mail",["imap",e],`fetchRawFromImapEntries: Expected message ${c} to exist, deleting imap entry ${a}/${i}`);await m.Z.imap.bulkDelete(t);const a=[n.searchListId,n.accountId];await m.Z.hasRaw.delete(a)}}}return U.QO.updateIndex({sleUpdates:i}),await m.Z.transaction("rw",[m.Z.hasRaw,m.Z.searchDbQueue,m.Z.searchList],(()=>{r.length>0&&(M.Z.setHasRaws(e,r.map((([e])=>e))),m.Z.searchDbQueue.bulkAdd(r.map((([t,n])=>({accountId:e,searchListId:t,sentDate:n})))));for(const[e,t]of s)(0,S.Z)(e,t)})),sa=0,ra=0,la.hasFunc(Fa)||la.queue(Fa,P.NB.ADD_TO_SEARCH_DB),r.length}(e,f);return t=!0,aa+=w,U.QO.runStoredQueryFilters(f.map((e=>e.searchListId))),!0}}(n).catch((e=>{U.QO.removeAllIndicators(n),ka(e,n,"prefetch")})))))),Promise.resolve()).then((()=>{Yn=!1,Xn.size>0&&Pa()}))}async function Ua(e){try{const t=va(e);return await m.Z.hasRaw.where("[hasRaw+accountId+sentDate+searchListId]").between([0,e,t,0],[0,e,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER]).count()+aa}catch(e){return b.Z.error("Mail",["imap","countWithNoRaw"],e),0}}async function Fa(){if(!ia){ia=!0;try{const e=await m.Z.searchDbQueue.orderBy("sentDate").reverse().limit(oa).toArray();if(0===e.length)return ia=!1,sa=0,ra=0,U.U.setStatus(ae.A4,(0,u.Z)("All downloaded messages are available for a full text search")),void b.Z.info("Mail",["iterateSearchDbQueue"],"Finished indexing message content for search");0===sa&&(sa=await m.Z.searchDbQueue.count()),U.U.setStatus(ae.A4,(0,u.Z)("Preparing downloaded messages for a full text search - $1/$2",[ra,sa])),b.Z.info("Mail",["iterateSearchDbQueue"],"Indexing message contents for search",ra,sa);const t=Date.now(),n=await(0,x.Z)(e.map((({searchListId:e})=>e))),a=new Map(n.map((e=>[e.id,e])));await Promise.all(e.map((async e=>{try{const{accountId:t,searchListId:n,sentDate:i}=e,s=a.get(n),r=await St.Z.call(t,n,i);if(!r||!s)return void b.Z.info("Mail",["iterateSearchDbQueue"],"Ignoring deleted message",JSON.stringify({request:e}));const o=(0,Ue.PW)((0,Ue.Zp)(r));if(o){const e=await O.Z.parseMail(r,o.mimeTree),t=(0,Fe.H)(e.bodyParts);await(0,ve.K)(n,s,t)}}catch(t){b.Z.error("Mail",["iterateSearchDbQueue"],"Error processing request",JSON.stringify({request:e}),t)}}))),await m.Z.searchDbQueue.bulkDelete(e.map((({id:e})=>e))),ra+=e.length,ia=!1,oa=ca.optimize(oa,Date.now()-t),la.queue(Fa,P.NB.ADD_TO_SEARCH_DB)}catch(e){ia=!1,sa=0,ra=0,U.U.setStatus(ae.A4,(0,u.Z)("Error when preparing downloaded messages for search")),b.Z.error("Mail",["iterateSearchDbQueue"],"Error iterating the Search DB Queue",e)}}}const Da={setCheckInterval:function(e,t){da&&clearInterval(da),da=e?setInterval(Ta,6e4*t):void 0},fetchRawOfMessage:async function(e,t,n){return(await ga(e,[t])).get(t)},connectIMAPClient:Aa,connectIMAPClients:xa,disconnectIMAPClient:Ma,reconnectIMAPClient:Oa,reconnectIMAPClients:async function(){a.Z.get(Z.kMailIsTurnedOff)||(await Sa(),await xa())},disconnectIMAPClients:Sa,checkNewDeletedModified:function(e,t){pa(e,t).catch((t=>ka(t,e))).then((()=>ha(e)))},rescanUnreadFlags:async function(e,t){const n=(await ua(e)).mailboxCache[t];n&&(n.highestModseq="0",pa(e,t).catch((t=>ka(t,e))).then((()=>ha(e))))},checkForMail:Za,preFetch:Ra,subscribeMailbox:async function(e){const{accountId:t,path:n}=e,a=await ua(t);await a.subscribeMailbox({path:n}),Oa(t)},unsubscribeMailbox:async function(e,t){if(!l.Z.isUnsubscribable(e))throw new Error(`Folder ${e.accountId}/${e.path} can not be unsubscribed.`);const{accountId:n,path:a}=e,i=await ua(n);await i.unsubscribeMailbox({path:a}),t&&En(n,a),Oa(n)},createMailbox:async function(e,t,n){try{const a=h.Z.getFolder(e,t)?.delimiter||".",i=t.split(a).filter((e=>e!==P.ym));i.push((0,Dn.y3)(n));const s=await ua(e),r=await s.createFolder({path:i});await s.subscribeMailbox({path:r}),Oa(e)}catch(a){b.Z.error("Mail",["imap",e,t,n,"create mailbox"],a.message||a)}},deleteMailbox:async function(e,t){try{const n=await ua(e),a=async()=>{await n.unsubscribeMailbox({path:t}),await zt(e,t,!0),await n.deleteFolder({path:t})};await a(),Oa(e)}catch(n){b.Z.error("Mail",["imap",e,t,"delete mailbox"],n.message||n)}},reSyncFolder:async function(e,t){En(e,t),await Oa(e)},reSyncAccount:async function(e){!function(e){delete yn[e]}(e),await Oa(e)},pausePrefetching:Ca,startAddtoSearchDb:function(){la.queue(Fa,P.NB.ADD_TO_SEARCH_DB)}};self.addEventListener("message",(async function({origin:e,data:t,source:n}){if(e!==ae.oP||!t||!t.imap)return;const{promiseId:a,func:i,args:s=[]}=t.imap;if(i)try{const e=await Da[i](...s),t=e&&"fetchRawOfMessage"===i?[e.buffer]:void 0;n.postMessage({imap:{promiseId:a,results:e}},{transfer:t})}catch(e){const t=e.message||e;n.postMessage({imap:{promiseId:a,error:t}})}}),!1);const za={checkForMail:Za,copyMessages:async function(e,t,n,a){const i={path:t,uids:n,destination:a},s=[e,a],r=w.Z.getByFolderId(s);if(!r)throw new Error("Destination filter not found for "+s.join(", "));const o=await m.Z.imap.where("[accountId+path+uid]").anyOf(n.map((n=>[e,t,n]))).toArray(),c=new Map(o.map((e=>[e.uid,e]))),l=await ua(e),d=await l.copyMessages(i);if(!d)return void b.Z.warn("Mail",["imap",e],"UIDPLUS not supported, cannot create imap entries");const{srcSeqSet:u,destSeqSet:h}=d,f=zn(u),p=zn(h);let g;await m.Z.transaction("rw",[m.Z.imap,m.Z.searchList],(async()=>{const n=[];f.forEach(((i,s)=>{const r=p[s],o=c.get(i);o?n.push({...o,path:a,uid:r}):b.Z.warn("Mail",["imap",e],"cannot create imap entry for "+JSON.stringify([t,i]))})),g=await dn(n,r)})),g&&U.QO.updateIndex({sleUpdates:g})},deleteMessages:async function(e,t,n){const a={path:t,uids:n};return(await ua(e)).deleteMessages(a)},disconnectIMAPClient:Ma,fetchRawOfMessages:ga,moveMessages:async function(e,t,n,a){const i={path:t,uids:n,destination:a};return(await ua(e)).moveMessages(i)},park:ha,selectMailbox:pa,updateFlags:async function(e,t,n,a){const i=[],s=[];for(const[e,t]of Object.entries(a))t?i.push(e):s.push(e);const r={path:t,uids:n,add:i,remove:s};return(await ua(e)).updateFlags(r)},uploadMessage:async function(e,t,n,a){const i=await(0,hn.Z)(n);if(!i)throw new Error(`Entry ${n} not found in searchList table`);const{sentDate:s}=i,r=await St.Z.call(e,n,s);if(!r)throw new Error(`Can not upload message ${n} as raw file was not found on disk`);(await A.Z.getBySearchListId(n)).find((e=>e.hasRaw))||b.Z.warn("Mail",["imap",e,t,n],"imap.js: Data inconsistency, raw file found on disk contrary to hasRaw table");const o=(0,Pe.DA)(r),c=[e,t],l=w.Z.getByFolderId(c);if(!l)throw new Error("Destination filter not found for "+c.join(", "));const d=await ua(e),u=a.indexOf(P.T4.RECENT);u>-1&&a.splice(u,1);const h=await d.uploadMessage({path:t,message:o,flags:a});if(ha(e),!h)return void b.Z.warn("Mail",["imap",e],"UIDPLUS not supported, cannot create imap entry");const f=Number.parseInt(h);let p;await m.Z.transaction("rw",[m.Z.imap,m.Z.searchList,m.Z.hasRaw],(async()=>{const a={accountId:e,path:t,uid:f,searchListId:n};p=await dn([a],l);const i={searchListId:n,accountId:e,hasRaw:1,sentDate:s};await m.Z.hasRaw.put(i)})),p&&U.QO.updateIndex({sleUpdates:p})},pausePrefetching:Ca};var Ba=n(78134),$a=n(85834),ja=n(95064);const Qa=[{listId:"meetup.com",name:"meetup.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"facebook.com",name:"facebook.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"github.com",name:"github.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"google.com",name:"google.com",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"googlegroups.com",name:"googlegroups.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"groupon",name:"groupon",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"xt.local",name:"xt.local",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"sparkpostmail.com",name:"sparkpostmail.com",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"substack.com",name:"substack.com",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"list-id.mcsv.net",name:"list-id.mcsv.net",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"spc-",name:"sparkpostmail.com (spc-)",parentFolderType:"startsWith",subFolderType:"host",isIgnored:!1},{listId:"MAILING_LIST_GROUPS_UNCATEGORIZED",name:"",parentFolderType:"uncategorized",subFolderType:"host",isIgnored:!1}];var Va=n(65741);const qa="Contacts";class Ha{count=0;constructor(e,t){this.version=e,this.interval=setInterval((()=>this.total&&U.U.setStatus(ae.A4,`Upgrade v${e} mail: ${t} ${this.count} / ${this.total}`)),1e3),b.Z.info("Mail","Upgrade started: ",e)}stop(){clearInterval(this.interval),U.U.setStatus(ae.A4,`Upgrade v${this.version} mail: Finalizing...`,5e3),b.Z.info("Mail","Upgrade finished: ",this.version)}}m.Z.on("populate",(()=>{m.Z.filters.bulkAdd(ja.j),m.Z.mailingList.bulkAdd(Qa),m.Z._upgrades.add({version:m.Z.verno})})),m.Z.version(136).stores({messages:"++id",searchList:["++id","messageId","*sourceFilterIds"].join(","),threading:["++id","*references","inReplyTo","messageId"].join(","),accounts:"accountId",mailboxCache:"[accountId+path],accountId",filters:"++id,&[accountId+path]",buffer:["++_id","[accountId+path+operation]","accountId","[accountId+path]","operation","[accountId+destinationPath+operation]"].join(","),views:"++id,filterId",imap:["[accountId+path+uid]","searchListId","[hasRaw+accountId+searchListId]","[accountId+path+searchListId]","accountId"].join(","),pop:"[accountId+uidl],searchListId,accountId",filteringQueue:"++id,priority",threadingQueue:"++id",viewIds:"searchListId,*viewIds",flaggingQueue:"++id",drafts:null,tokens:null,folders:null}).upgrade((e=>{e.messages.clear(),e.searchList.clear(),e.threading.clear(),e.accounts.clear(),e.mailboxCache.clear(),e.filters.clear(),e.buffer.clear(),e.views.clear(),e.imap.clear(),e.pop.clear(),e.filteringQueue.clear(),e.threadingQueue.clear(),e.viewIds.clear(),e.flaggingQueue.clear()}));const Ka=new Map;m.Z.version(137).stores({_upgrades:"version"}),Ka.set(137,(async e=>{new Ha(137,"Upgrade v137 mail").stop()})),Ka.set(138,(async e=>{const t=new Ha(138,"Upgrade v138 mail: Run Custom Folder");await e.filteringQueue.add({priority:P.Un.LOW,type:"RUN_FILTERS",folderIds:[[P.Ry,P.ym]],updateFilters:!0}),t.stop()})),Ka.set(139,(async e=>{const t=new Ha(139,"Upgrade v139 mail: Repair default filters"),n=[],a=["total","unseen","unread","excludeMailingLists","excludeDeleted","excludeRssFeeds","excludeJunk","excludeCustomFolders"];for(const t of ja.j){const{accountId:i,path:s}=t,r=await e.filters.where("[accountId+path]").equals([i,s]).first();if(r){const{id:i}=r,s={id:i,...t};await e.filters.put(s);const o=await e.views.where("filterId").equals(i).toArray(),c=new Set(o.map((e=>e.type)));for(const t of a)if(!c.has(t)){const n={filterId:i,type:t};e.views.add(n)}n.push(i)}else{const i=await e.filters.add(t);for(const t of a)await e.views.add({filterId:i,type:t});n.push(i)}}if(n.length>0){const t={priority:P.Un.LOW,type:"RUN_FILTERS",filterIds:n};e.filteringQueue.add(t)}t.stop()})),Ka.set(140,(async e=>{const t=new Ha(140,"Map viewIds to new format");t.total=await e.viewIds.count()+await e.views.count();const n=new Map,a=["total","unseen","unread","excludeMailingLists","excludeDeleted","excludeRssFeeds","excludeJunk","excludeCustomFolders"];await e.views.each((e=>{const i=a.indexOf(e.type);-1!==i&&n.set(e.id,100*e.filterId+i),t.count++})),await e.viewIds.toCollection().modify((e=>{const a=new Set;e.viewIds.forEach((e=>{const t=n.get(e);"number"==typeof t&&a.add(t)})),e.viewIds=[...a],t.count++})),e.views.clear(),t.stop()})),m.Z.version(141).stores({deletedFeedItems:"++id,path"}),Ka.set(142,(async e=>{const t=new Ha(142,"Fixing default parent filters");let n,a,i,s,r,o;function c(e,t){const{include:n}=e.filterValue;for(const e of t){n.some((t=>(0,Va.Z)(t,e)))||n.push(e)}}o=[P.wC,""],r=[P.wC,"￿"];const l=await e.filters.where("[accountId+path]").between(o,r).toArray(),d=[],u=[];for(const e of l){const{path:t,filterValue:s}=e;if(t===P.ym)n=e;else if(t===P.W4)a=e;else if(t===P.cs)i=e;else{const e=s.include.filter((e=>1===e.length&&(e[0].listId||e[0].senderIsMailingList)));t.startsWith(P.W4)?d.push(...e):t.startsWith(P.cs)&&u.push(...e)}}if(!n)throw new Error("Mailing list root folder not found");if(!a)throw new Error("Mailing list Important folder not found");if(!i)throw new Error("Mailing list Other folder not found");c(n,d),c(n,u),c(a,d),c(i,u),o=[P.ut,""],r=[P.ut,"￿"];const h=await e.filters.where("[accountId+path]").between(o,r).toArray(),f=[];for(const e of h){const{path:t,filterValue:n}=e;if(t===P.ym)s=e;else{const e=n.include.filter((e=>1===e.length&&e[0].flag));f.push(...e)}}if(!s)throw new Error("Labels root folder not found");c(s,f),await e.filters.bulkPut([n,a,i,s]);const p=[n.id,a.id,i.id,s.id];await w.Z.updateFilters(p),await I.Z.call({type:"RUN_FILTERS",priority:P.Un.LOW,filterIds:p}),t.stop()})),Ka.set(143,(async e=>{const t=new Ha(143,"Fixing database inconsistency"),n=await e.searchList.toCollection().primaryKeys(),a=await e.viewIds.toCollection().primaryKeys(),i=new Set(n),s=a.filter((e=>!i.has(e)));await e.viewIds.where("searchListId").anyOf(s).delete(),t.stop()})),m.Z.version(144).stores({viewIds:"searchListId"}),Ka.set(146,(async e=>{const t=new Ha(146,"Fixing state of show-read button in received folder");await e.filters.where("[accountId+path]").equals([P.of,P.ik]).modify((e=>{e.filterValue={...e.filterValue,showReadButton:!0}})),t.stop()})),m.Z.version(147).stores({mailingList:"listId"}),Ka.set(147,(async e=>{const t=new Ha(147,"Group mailing lists providers (like xt.local and sparkpostmail.com)");await e.mailingList.bulkAdd(Qa);const n=P.wC,a=[n,""],i=[n,"￿"],s=await e.filters.where("[accountId+path]").between(a,i).toArray(),r=[];if(s.forEach((e=>{(e.path.endsWith(".xt.local")||e.path.endsWith(".sparkpostmail.com")||e.path.endsWith("list-id.mcsv.net")||e.path.startsWith(P.cs+"/spc-")||e.path.startsWith(P.W4+"/spc-"))&&r.push(e.id)})),r.length>0){const n=r.map((e=>100*e));await e.filters.where("id").anyOf(r).delete();const a=new Set,i=8;t.total=n.length,n.forEach((e=>{for(let t=0;t<i;t++)a.add(e+t)}));const s=[];await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!a.has(e)));n.length!==e.viewIds&&(s.push(e.searchListId),e.viewIds=n),t.count++})),await e.filteringQueue.add({priority:P.Un.LOW,type:"RE_RUN_SLES",searchListIds:s,runMailingLists:!0,updateFilters:!0})}t.stop()})),Ka.set(148,(async e=>{const t=new Ha(148,"VB-78846: Rerun views for flags and labels"),n=[P.ut,""],a=[P.ut,"￿"],i=await e.filters.where("[accountId+path]").between(n,a).primaryKeys(),s=[P.MN,""],r=[P.MN,"￿"],o=await e.filters.where("[accountId+path]").between(s,r).primaryKeys();await e.filteringQueue.add({priority:P.Un.LOW,type:"RUN_FILTERS",filterIds:[...i,...o]}),t.stop()})),m.Z.version(149).stores({systemTasks:"++id",tokens:null}),Ka.set(149,(async e=>{const t=new Ha(149,"Clear tokens table and prepare for transition to new search db ...");await e.systemTasks.add({taskName:"restore_full_text_search_db",currentPosition:0}),t.stop()})),Ka.set(150,(async e=>{const t=new Ha(150,"VB-79158: [Mail] Unseen/Read status does not always match changes done with external server"),n=await e.accounts.toArray(),a=[];for(const e of n){const{accountId:t,folders:n}=e;for(const e in n)n[e].forEach((e=>{a.push([t,e.path])}))}const i=await e.filters.where("[accountId+path]").anyOf(a).toArray(),s=new Set;await e.searchList.toCollection().modify((e=>{const t=[...e.sources].filter((([e,t])=>t.internal)),n=[...e.sources].filter((([e,t])=>!t.internal));t&&0!==t.length&&n&&0!==n.length&&n.forEach((([n,a])=>{const r=i.find((e=>e.id===n))?.accountId;r&&t.forEach((([t,n])=>{const o=i.find((e=>e.id===t))?.accountId;if(o&&o===r){const n=e.sources.get(t);n&&n.read!==a.read&&(n.read=a.read,s.add(e.id),n.read&&(e.unseen=!1))}}))}))})),await e.filteringQueue.add({priority:P.Un.LOW,type:"RE_RUN_SLES",searchListIds:[...s]}),t.stop()})),Ka.set(151,(async e=>{const t=new Ha(151,"Removing orphan source-filter IDs");t.total=await e.searchList.count();const n=await e.filters.toCollection().primaryKeys(),a=new Set(n);await e.searchList.toCollection().modify((e=>{e.sourceFilterIds=e.sourceFilterIds.filter((e=>a.has(e)));const n=new Map;for(const[t,i]of e.sources)a.has(t)&&n.set(t,i);e.sources=n,t.count++})),t.stop()})),Ka.set(152,(async e=>{const t=new Ha(152,"Resetting feed data for updating paths"),n=await Ba.Z.waitFor((()=>L.Z.prefs.get(Z.kRssSettings)));if(0===n.length)return void t.stop();const a={},i=[];t.total=n.length;for(const s of n){const n=await e.filters.where("[accountId+path]").equals([P.u4,s.path]).first();if(a[s.path])try{const t={accountId:P.u4,filterValue:{exclude:a[s.path].filterValue.exclude.slice(),include:[[{accountId:P.u4},{path:s.url}]],showCustomFolderButton:!1,showFeedsButton:!1,showJunkButton:!1,showMailingListsButton:!1},name:s.title,path:s.url},n=await e.filters.add(t);i.push(n)}catch(e){console.error(e)}else if(n){a[s.path]=n;const t={...n.filterValue,include:[[{accountId:P.u4},{path:s.url}]]};await e.filters.update(n.id,{path:s.url,filterValue:t}),i.push(n.id)}else console.error("Filter not found for feed path",s.path);s.path=s.url,t.count++}L.Z.prefs.set({path:"vivaldi.rss.settings",value:n}),await I.Z.call({type:"RUN_FILTERS",priority:P.Un.LOW,filterIds:i}),t.stop()})),Ka.set(153,(async e=>{const t=new Ha(153,"Re-run sender is a mailing list filters"),n=await e.filters.where("[accountId+path]").between([P.wC,""],[P.wC,"￿"]).filter((e=>e.filterValue.include?.some((e=>e.some((e=>!!e.senderIsMailingList)))))).primaryKeys();await I.Z.call({type:"RUN_FILTERS",priority:P.Un.LOW,filterIds:n}),t.stop()})),Ka.set(154,(async e=>{const t=new Ha(154,"Fix unseen counters");t.total=await e.searchList.count();const n=[];await w.Z.initFilters(),await e.searchList.toCollection().modify((e=>{e.unseen&&q.Z.call(e.sources)&&(e.unseen=!1,n.push(e.id)),t.count++})),await e.filteringQueue.add({priority:P.Un.LOW,type:"RE_RUN_SLES",searchListIds:n}),t.stop()})),Ka.set(158,(async e=>{const t=new Ha(158,"Update thread key");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((e=>{0===e.threadKey[1]&&(e.threadKey[1]=e.id),t.count++})),t.stop()})),Ka.set(159,(async e=>{const t=new Ha(159,"Update old filter rules and delete contact filters"),n=await e.filters.where("[accountId+path]").between([P.wC,""],[P.wC,"￿"]).count()+await e.filters.where("[accountId+path]").between([P.Kz,""],[P.Kz,"￿"]).count(),a=[qa,""],i=[qa,"￿"],s=await e.filters.where("[accountId+path]").between(a,i).primaryKeys(),r=await e.filters.where("[accountId+path]").equals([P.Kz,P.ym]).primaryKeys();if(s.push(...r),s.length>0){const a=100,i=s.map((e=>e*a));await e.filters.where("id").anyOf(s).delete();const r=new Set,o=8;i.forEach((e=>{for(let t=0;t<o;t++)r.add(e+t)})),t.total=await e.viewIds.count()+n,await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!r.has(e)));n.length!==e.viewIds&&(e.viewIds=n),t.count++}))}else t.total=n;function o(e,t,n,a,i){e||(e="");let s=n;return a.includes("equal")&&["subject"].includes(t)&&(s=`"${s}"`),"anywhere"!==t&&(s=`${t}:${s}`),i&&e&&(s=`${e?" ":""}${i} `+s),e?e+s:s}const c=(e,t)=>{const n=[...e.filterValue[t]].filter(((n,a)=>{const i=[...n].filter(((n,a)=>{for(const i in n){let s="";const r="exclude"===t?"NOT":a?"AND":"OR";return"subject"!==i&&"to"!==i&&"from"!==i&&"cc"!==i||(s="subject"===i?n[i]:n[i].address,e.filterValue.query=o(e.filterValue.query,i,s,"equal",r),!1)}}));return e.filterValue[t][a]=i,0!==i.length}));0===n.length?delete e.filterValue[t]:e.filterValue[t]=n},l=e=>{e.filterValue.include&&c(e,"include"),e.filterValue.exclude&&c(e,"exclude")};await e.filters.where("[accountId+path]").between([P.wC,""],[P.wC,"￿"]).modify((e=>{l(e),t.count++})),await e.filters.where("[accountId+path]").between([P.Kz,""],[P.Kz,"￿"]).modify((e=>{e.path===P.ym?(e.filterValue.include=[],e.filterValue.exclude&&delete e.filterValue.exclude):l(e),t.count++})),t.stop()})),Ka.set(160,(async e=>{const t=new Ha(160,"Update viewIds of messages that have too many unseen counters"),n=[];await e.searchList.toArray().then((e=>{e.forEach((e=>{e.unseen||n.push(e.id)}))})),t.total=n.length,await e.viewIds.where("searchListId").anyOf(n).modify((e=>{e.viewIds=e.viewIds.filter((e=>!function(e){return e%100==1}(e))),t.count++})),t.stop()})),Ka.set(161,(async e=>{const t=new Ha(161,"Update Received folder to include send to self"),n={name:P.ik,accountId:P.of,path:P.ik,filterValue:{include:[[{folder:"Archive"}],[{folder:"Flagged"}],[{folder:P.Oi}],[{folder:P.e9}],[{folder:P.Hd}],[{folder:P.uT},{folder:"Not Sent Internal"}]],...$.Z.getSearchListButtons(P.HM)}};n&&(await e.filters.where("[accountId+path]").equals([n.accountId,n.path]).modify((e=>{e.filterValue.include=n.filterValue.include,e.filterValue.exclude=e.filterValue.exclude.filter((e=>!e.some((e=>e.folder===P.Nz))))})),await I.Z.call({priority:P.Un.LOW,type:"RUN_FILTERS",folderIds:[[P.of,P.ik]]})),t.stop()})),m.Z.version(162).stores({filteringQueue:"++id"}),Ka.set(163,(async e=>{const t=new Ha(163,"Adding support for Archive folders"),n="Archive",a="Archive",i=new Map;await e.accounts.toCollection().modify((({accountId:e,folders:t})=>{const s=t.Other;if(!s)return;const r=[];if(t.Other=s.filter((e=>{const{name:t,path:i}=e;return t!==a&&i!==a||(r.push({...e,type:n}),!1)})),r.length>0){const e=t.Archive;e?e.push(...r):t.Archive=r}const o=new Map;i.set(e,o);Object.keys(t).forEach((e=>{t[e].forEach((t=>{o.set(t.path,e)}))}))}));let s=!1;await e.filters.toCollection().modify((e=>{const{accountId:t,path:n,filterValue:a}=e;"All Messages"===t&&"Archive"===n&&(s=!0);const r=function(e,t){const n=i.get(e)?.get(t);return n||(e===P.of&&t===P.rp?P.Hd:t)}(t,n);if((["Sent","Drafts","Outbox"].includes(r)||["Single thread","Feeds"].includes(t))&&(a.showArchivedButton=!1),"Archive"===r){const e=[{accountId:t},{folder:"Archive"}];a.include?a.include.push(e):a.include=[e],a.showCustomFolderButton=!1,a.showJunkButton=!1,a.showArchivedButton=!1}})),s||(await e.filters.add({name:"Archive",accountId:"All Messages",path:"Archive",filterValue:{include:[[{folder:"Archive"}]],exclude:[[{flag:"\\Deleted"}],[{folder:"Trash"}]],showCustomFolderButton:!1,showJunkButton:!1,showArchivedButton:!1}}),await e.filteringQueue.add({priority:15,type:"RE_RUN_SLES",folderIds:[["All Messages","Archive"]],runMailingLists:!0})),t.stop()})),Ka.set(164,(async e=>{const t=new Ha(164,"Update names for filters");e.filters.toCollection().modify((e=>{e.name===P.ym&&(e.name=e.accountId)})),t.stop()})),Ka.set(165,(async e=>{const t=new Ha(165,"Fix Archive status in filters"),n=new Map;function a(e,t){return e.some((e=>1===e.length&&e[0]?.folder===t))}await e.accounts.each((({accountId:e,folders:t})=>{const a=new Map;n.set(e,a);Object.keys(t).forEach((e=>{t[e].forEach((t=>{a.set(t.path,e)}))}))})),await e.filters.toCollection().modify((e=>{const{accountId:t,path:i,filterValue:s}=e,r=function(e,t){const a=n.get(e)?.get(t);return a||(e===P.of&&t===P.rp?P.Hd:t)}(t,i);if("Archive"===r){delete s.showJunkButton;const e=[{folder:"Junk"}];s.exclude?a(s.exclude,"Junk")||s.exclude.push(e):s.exclude=[e]}else if(!1!==s.showArchivedButton){const e=[{folder:"Archive"}];s.exclude?a(s.exclude,"Archive")||s.exclude.push(e):s.exclude=[e]}})),t.stop()})),Ka.set(166,(async e=>{const t=new Ha(166,"Apply default showSubFolders and clear related include rules"),n=new Set(["Custom Folders","Mailing Lists","Filters","Labels","Flags","Feeds"]),a=new Set(["Other Mailing Lists","Important Mailing Lists"]),i=await e.accounts.toCollection().primaryKeys(),s=new Map,r=new Set;await e.filters.toCollection().modify((e=>{const{id:t,accountId:o,path:c,filterValue:l}=e;"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"===c&&(n.has(o)||i.includes(o))?(l.include=[],l.showSubFolders=!0,r.add(t)):"Mailing Lists"===o&&(a.has(c)?(l.include=[],l.showSubFolders=!0,r.add(t)):s.set(c,e))}));for(const e of[...s.values()]){const{include:t}=e.filterValue;if(!t||0===t.length)continue;const n=new Set;for(const e of t)for(const t of e)t.listId&&n.add(t.listId);if(0===n.size)continue;let a=e.path.substring(0,e.path.lastIndexOf("/")),i=s.get(a);for(;i;){const{id:e,filterValue:t}=i;if(t.include?.length>0){const a=t.include.length;t.include=t.include.filter((e=>!e.some((e=>n.has(e.listId))))),t.include.length<a&&r.add(e)}t.showSubFolders=!0,a=a.substring(0,a.lastIndexOf("/")),i=s.get(a)}}s.size>0&&await e.filters.bulkPut([...s.values()]),r.size>0&&await e.filteringQueue.add({priority:P.Un.LOW,type:"RUN_FILTERS",filterIds:[...r]}),t.stop()})),Ka.set(167,(async e=>{const t=new Ha(167,"Fix filter include rules"),n=[],a=new Set(["Flags","Custom Folders","All Accounts"]),i=await e.accounts.toCollection().primaryKeys(),s=new Set(i);await e.filters.toCollection().modify((e=>{const{id:t,accountId:i,path:r,filterValue:o}=e;"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"===r&&(a.has(i)&&(!o.include||o.include.length>0)&&(o.include=[],n.push(t)),!o.include&&s.has(i)&&(o.include=[],n.push(t)))})),n.length>0&&await e.filteringQueue.add({priority:15,type:"RUN_FILTERS",filterIds:n}),t.stop()})),Ka.set(170,(async e=>e.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT_PATH").filter((e=>void 0===e.path)).delete())),Ka.set(171,(async e=>{await e.filteringQueue.toCollection().modify((e=>{if(e.folderIds){Array.isArray(e.folderIds[0])||(e.folderIds=[e.folderIds]);for(const t of e.folderIds)t[1]=t[1]||"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"}}))})),Ka.set(173,(async e=>{const t=new Ha(173,"Fix casing of inbox and remove duplicates if found"),n=await e.accounts.toArray();for(const t of n){if(t.accountId===P.of){await e.accounts.delete(P.of);continue}const n=t.folders.Inbox||[];for(const a of n)"inbox"===a.path.toLowerCase()&&"Inbox"!==a.path&&(a.path="Inbox",await e.accounts.update(t.accountId,t))}function a(e){let t=!1;"inbox"===e.path.toLowerCase()&&"Inbox"!==e.path&&(e.path="Inbox",t=!0);for(const n of["include","exclude"])if(e.filterValue[n])for(const a of e.filterValue[n])for(const e of a)e.path&&"inbox"===e.path.toLowerCase()&&"Inbox"!==e.path&&(e.path="Inbox",t=!0);return t}const i=await e.filters.toArray(),s=i.filter((e=>"inbox"===e.path.toLowerCase())),r={};for(const e of s)r[e.accountId]?r[e.accountId].push(e):r[e.accountId]=[e];for(const n in r){const i=(await e.imap.where("accountId").equals(n).toArray()).filter((e=>"inbox"===e.path.toLowerCase())),s=new Map;t.total=i.length,t.count=0;for(const n of i){t.count++;const{accountId:a,path:i,uid:r}=n,o=s.get(r);o?0===o.hasRaw&&1===n.hasRaw&&(o.hasRaw=1):s.set(r,{...n,path:"Inbox"}),"Inbox"!==i&&await e.imap.delete([a,i,r])}await e.imap.bulkPut(Array.from(s.values()));const o=(await e.mailboxCache.where("accountId").equals(n).toArray()).filter((e=>"inbox"===e.path.toLowerCase())),c=new Map;t.total=o.length,t.count=0;for(const n of o){t.count++;const{accountId:a,path:i}=n,s=c.get(i);s?(Number(n.highestModseq)>Number(s.highestModseq)&&(s.highestModseq=n.highestModseq),n.uidNext>s.uidNext&&(s.uidNext=n.uidNext),n.exists>s.exists&&(s.exists=n.exists)):c.set(i,{...n,path:"Inbox"}),await e.mailboxCache.delete([a,i])}await e.mailboxCache.bulkPut(Array.from(c.values()));const l=await e.buffer.where("accountId").equals(n).toArray();t.total=l.length,t.count=0;for(const n of l){t.count++;const{_id:a,path:i="",destinationPath:s=""}=n;"inbox"===i.toLowerCase()&&"Inbox"!==i&&await e.buffer.update(a,{path:"Inbox"}),s&&"inbox"===s.toLowerCase()&&"Inbox"!==s&&await e.buffer.update(a,{destinationPath:"Inbox"})}const d=await e.filteringQueue.toArray();t.total=d.length,t.count=0;for(const n of d){t.count++;let a=!1;const{id:i,folderIds:s,fromFolderId:r,toFolderId:o}=n;if(s)for(const e of s)"inbox"===e[1].toLowerCase()&&"Inbox"!==e[1]&&(e[1]="Inbox",a=!0);r&&"inbox"===r[1].toLowerCase()&&"Inbox"!==r[1]&&(r[1]="Inbox",a=!0),o&&"inbox"===o[1].toLowerCase()&&"Inbox"!==o[1]&&(o[1]="Inbox",a=!0),a&&await e.filteringQueue.update(i,n)}const u=r[n];if(1===u.length){const t=u[0];a(t)&&await e.filters.update(t.id,t)}else if(u.length>1){let n=u.find((e=>"Inbox"===e.path));n||(n=u[0],a(n)&&await e.filters.update(n.id,n));const i=u.filter((e=>e.id!==n.id)),s=i.map((e=>e.id)),r=i.map((e=>100*e.id));await e.filters.where("id").anyOf(s).delete();const o=new Set,c=9;t.total=r.length,t.count=0,r.forEach((e=>{for(let t=0;t<c;t++)o.add(e+t)})),await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!o.has(e)));n.length!==e.viewIds&&(e.viewIds=n),t.count++}))}}const o=i.filter((e=>"inbox"!==e.path.toLowerCase()));t.total=o.length,t.count=0;for(const n of o)t.count++,a(n)&&await e.filters.update(n.id,n);t.stop()})),Ka.set(174,(async e=>{const t=new Ha(174,"Delete empty label if there is one"),n=await e.filters.where("[accountId+path]").equals([P.ut,""]).primaryKeys(),a=[0,1,2,3,4,5,6,7,8];if(n.length>0)for(const i of n){t.total=await e.viewIds.count();const n=100,s=new Set(a.map((e=>i*n+e)));await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!s.has(e)));n.length!==e.viewIds&&(e.viewIds=n),t.count++})),e.filters.delete(i)}t.stop()})),Ka.set(175,(async e=>{const t=new Ha(175,"Re-run filtering"),n=new Map;await e.searchList.each((({id:e,sourceFilterIds:a})=>{for(const t of a){const a=n.get(t);a?a.push(e):n.set(t,[e])}t.count++}));for(const[t,a]of n)await e.filteringQueue.add({type:"FILTERS_SLES",priority:20,searchListIds:a,filterIds:[t],runAllMessages:!0,runMailingLists:!0,runCustomFolders:!0,runFlagFolders:!0,runLabels:!0,runQueries:!0,runSingleThread:!0})})),Ka.set(176,(async e=>{const t=new Ha(176,"Fix grouped mailing lists"),n=await e.mailingList.toArray(),a=await e.filters.where("[accountId+path]").between(["Mailing Lists",""],["Mailing Lists","￿"]).filter((e=>{const{path:t}=e,a=t.indexOf("/");if(a<0)return!1;const i=t.substring(a+1);return!i.includes("/")&&n.some((({listId:e,parentFolderType:t})=>{switch(t){case"endsWith":return i.endsWith(e);case"startsWith":return i.startsWith(e);case"matches":return i===e}}))})).primaryKeys();if(0===a.length)return;await e.filters.bulkDelete(a);const i=new Set;for(const e of a)for(let t=0;t<9;t++)i.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!i.has(e)));n.length<e.viewIds.length&&(e.viewIds=n),t.count++})),await e.filteringQueue.add({priority:20,type:"RE_RUN_SLES",runMailingLists:!0}),t.stop()})),Ka.set(177,(async e=>{const t=new Ha(177,"Add default labels"),n=structuredClone(ja.j).filter((e=>e.accountId===P.ut)),a=await e.filters.where("[accountId+path]").between([P.ut,""],[P.ut,"￿"]).toArray(),i=n.filter((e=>!a.some((t=>t.path===e.path))));i.length>0&&await e.filters.bulkAdd(i),t.stop()})),Ka.set(178,(async e=>{const t=new Ha(178,"Delete empty label actions");await e.filters.where("[accountId+path]").between([P.Kz,""],[P.ut,"￿"]).modify((e=>{e.triggers&&(e.triggers=e.triggers.filter((e=>void 0===e.label||""!==e.label)))})),t.stop()})),Ka.set(179,(async e=>{const t=new Ha(179,"Fixing saved searches"),n=["Filters",""],a=["Filters","￿"],i=await e.accounts.toCollection().primaryKeys();if(i.length>0){const t="VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH",s=i.map((e=>[e,t])),r=(e,t)=>{const{filterValue:n}=e;if(n.showSubFolders){delete n.showSubFolders;const e=n.include||[];n.include=[...e,[{accountId:t}]]}};await e.filters.where("[accountId+path]").anyOf(s).modify((e=>r(e,e.accountId))),await e.filters.where("[accountId+path]").between(n,a).filter((e=>{const{selectedAccountId:t,selectedName:n}=e;return t===n&&i.includes(t)})).modify((e=>{const{selectedAccountId:t,accountId:n,path:a}=e;r(e,t),s.push([n,a])})),await e.filteringQueue.add({type:"RUN_FILTERS",priority:15,folderIds:s})}const s=await e.filters.toArray(),r=await e.filters.where("[accountId+path]").between(n,a).filter((({filterValue:e,selectedAccountId:t,selectedName:n})=>{if(e.showSubFolders)return!0;if(t&&n){if(!s.some((e=>e.accountId===t&&e.name===n)))return!0}return!1})).primaryKeys();if(r.length>0){await e.filters.bulkDelete(r);const n=new Set;for(const e of r)for(let t=0;t<9;t++)n.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const a=e.viewIds.filter((e=>!n.has(e)));a.length<e.viewIds.length&&(e.viewIds=a),t.count++}))}t.stop()})),Ka.set(180,(async e=>{const t=new Ha(180,"Decode imap folder filter names"),n=await e.accounts.toCollection().primaryKeys();await e.filters.toCollection().modify((e=>{n.includes(e.accountId)&&(e.name=(0,Dn.kF)(e.name))})),t.stop()})),Ka.set(181,(async e=>{const t=new Ha(181,"Adding labels made from webmail");const n=[P.ut,""],a=[P.ut,"￿"],i=(await e.filters.where("[accountId+path]").between(n,a).toArray()).map((e=>e.path)),s=new Set,r=new Set,o=await e.searchList.toArray();if(t.total=o.length,o.forEach((e=>{e.flags.forEach((t=>{!i.includes(t)&&function(e){const t=e.toLowerCase();return t.startsWith("$label")||"$"!==t[0]&&"\\"!==t[0]&&!["mdnsent","forwarded","submitpending","submitted","junk","notjunk","nonjunk","phishing","important","draft","seen","flagged","answered","recent"].includes(t)}(t)&&(s.add(t),r.add(e))})),t.count++})),[...s].length>0){const t=[...s].map((e=>{const t=[{flag:e}];return{name:e,accountId:P.ut,path:e,filterValue:{include:[t],...$.Z.getSearchListButtons(P.ut)}}})),n=await e.filters.bulkAdd(t,{allKeys:!0});I.Z.call({type:"RE_RUN_SLES",priority:P.Un.LOW,folderIds:[[P.ut,P.ym]],filterIds:n,searchListIds:[...r].map((e=>e.id))})}t.stop()})),Ka.set(182,(async e=>{const t=new Ha(182,"Refactor filter view toggles");t.total=await e.filters.count(),await e.filters.toCollection().modify((e=>{const{accountId:n,path:a,filterValue:i}=e;i.exclude&&(i.exclude=i.exclude.filter((t=>{for(const i of t)return i.flag===P.T4.SEEN?(e.filterValue.showRead=!1,n===P.of&&a===P.tB):i.flag===P.T4.DELETED||i.folder===P.uT?(e.filterValue.showDeleted=!1,!1):i.folder===P.Hd?(e.filterValue.showJunk=!1,!1):i.folder===P.Oi?(e.filterValue.showCustomFolder=!1,!1):i.folder!==P.hn||(e.filterValue.showArchived=!1,!1)})),0===i.exclude.length&&delete i.exclude),i.include&&(i.include=i.include.filter((t=>{let a=!1,i=!1,s=!1;return 2!==t.length||(t.forEach((e=>{a=e.accountId===n||a,i=e.folder===P.Hd||i,s=e.folder===P.hn||s})),a&&i?(e.filterValue.showJunk=!0,!1):!a||!s||(e.filterValue.showArchived=!0,!1))}))),t.count++})),t.stop()})),m.Z.version(183).stores({importStatus:null,importProgress:"path"}),Ka.set(184,(async e=>{const t=new Ha(184,"Make feed-sources internal"),n=[P.u4,""],a=[P.u4,"￿"],i=await e.filters.where("[accountId+path]").between(n,a).primaryKeys();t.total=await e.searchList.where("sourceFilterIds").anyOf(i).count(),await e.searchList.where("sourceFilterIds").anyOf(i).modify((e=>{t.count++;for(const[t,n]of e.sources)i.includes(t)&&!n.internal&&(n.internal=!0)})),t.stop()})),Ka.set(185,(async e=>{const t=new Ha(185,"Removing custom folder filters"),n=await e.filters.toCollection().filter((({accountId:e,path:t})=>"Custom Folders"===e&&"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"!==t)).primaryKeys();if(n.length>0){await e.filters.bulkDelete(n);const a=new Set;for(const e of n)for(let t=0;t<9;t++)a.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const n=e.viewIds.filter((e=>!a.has(e)));n.length<e.viewIds.length&&(e.viewIds=n),t.count++}))}t.stop()})),m.Z.version(186).stores({hasRaw:"[searchListId+accountId],[hasRaw+accountId+searchListId],accountId,searchListId"}),Ka.set(186,(async e=>{const t=new Ha(186,"Processing raw data"),n=await e.searchList.count(),a=await e.imap.count(),i=await e.pop.count();t.total=n+a+i;const s=new Map;await e.imap.toCollection().modify((e=>{const{searchListId:n,accountId:a,hasRaw:i}=e;let r=s.get(n);r||(r=new Map,s.set(n,r)),r.set(a,1===i),delete e.hasRaw,t.count++})),await e.pop.toCollection().modify((e=>{const{searchListId:n,accountId:a,headersOnly:i}=e;let r=s.get(n);r||(r=new Map,s.set(n,r)),r.set(a,!i),delete e.headersOnly,t.count++}));const r=await e.filters.toArray(),o=new Map(r.map((e=>[e.id,e]))),c=[],l=[];for(await e.searchList.each((e=>{const n=new Set;let a=!0;for(const[t,i]of e.sources){const e=o.get(t);e?(n.add(e.accountId),i.internal||(a=!1)):b.Z.error("Mail",["Upgrade","186"],"Filter not found "+t)}for(const i of n){const n=s.get(e.id)?.get(i);let r;if(void 0!==n)r=n?1:0;else if(a)r=1;else{const{id:t,sentDate:n}=e;l.push({accountId:i,searchListId:t,sentDate:n}),r=1}c.push({searchListId:e.id,accountId:i,hasRaw:r}),t.total++}t.count++}));c.length>0;){const n=c.splice(0,1e4);await e.hasRaw.bulkAdd(n),t.count+=n.length}l.length>0&&await e.systemTasks.add({taskName:"check_disk_for_raw",fileKeys:l}),t.stop()})),m.Z.version(187).stores({hasRaw:"[searchListId+accountId],accountId,searchListId,[hasRaw+accountId]"}),m.Z.version(188).stores({hasRaw:"[searchListId+accountId],accountId,searchListId,[hasRaw+accountId+searchListId]"}),Ka.set(189,(async e=>{const t=new Ha(189,"Upgrade pending upload entries in buffer");t.total=await e.buffer.count();const n=await e.buffer.toArray();for(const a of n)"BUFFER_OPERATION_UPLOAD_MESSAGE"!==a.operation||a.flags?"BUFFER_OPERATION_MOVE"===a.operation&&a.destinationAccountId&&(await e.buffer.delete(a._id),b.Z.warn("Mail",["Upgrade","189"],"An old, broken buffer action for moving between accounts was removed")):(await e.buffer.update(a._id,{flags:[]}),b.Z.info("Mail",["Upgrade","189"],"An old buffer action for uploading was modified to include an empty flags array")),t.count++;t.stop()})),Ka.set(191,(async e=>{const t=new Ha(191,"Converting draft attachments");t.total=await e.messages.count();const n=new TextEncoder;await e.messages.toCollection().modify((e=>{e.bodyParts?.forEach((e=>{if("attachment"===e.type&&"string"==typeof e.content){const t=(0,$a.tV)(e.content);if(e.content=n.encode(t),"application/ics"===e.mimeType){const n=t.match(/METHOD:\s*(\w+)/);n&&(e.method=n[1])}}})),t.count++})),t.stop()})),Ka.set(192,(async e=>{const t=new Ha(192,"Remove buffer entries for moving that have an empty uid list");t.total=await e.buffer.count();const n=await e.buffer.toArray();for(const a of n)"BUFFER_OPERATION_MOVE"!==a.operation||a.uids&&0!==a.uids.length||(await e.buffer.delete(a._id),b.Z.info("Mail",["Upgrade","192"],"Removed an unwanted buffer entry for moving an internal message")),t.count++;t.stop()})),Ka.set(193,(async e=>{const t=new Ha(193,"Preparing to re-run threading..."),n=await e.threading.toCollection().primaryKeys();await e.threadingQueue.add({threadingIds:n}),t.stop()})),Ka.set(194,(async e=>{const t=new Ha(194,"Moving size from imap table to searchList table...");t.total=await e.imap.count(),await e.imap.toCollection().modify((async n=>{const{searchListId:a,size:i}=n;await e.searchList.update(a,{size:i}),delete n.size,t.count++})),t.stop()})),Ka.set(195,(async e=>{const t=new Ha(195,"Clearing capabilities from accounts table");t.total=await e.accounts.count(),await e.accounts.toCollection().modify((async e=>{delete e.capability,t.count++})),t.stop()})),Ka.set(196,(async e=>{const t=new Ha(196,"Clearing unused gmailId from messages table");t.total=await e.messages.count(),await e.messages.toCollection().modify((e=>{delete e.gmailId,t.count++})),t.stop()})),Ka.set(197,(async e=>{const t=new Ha(197,"Clearing lastNotificaton from accounts table");t.total=await e.accounts.count(),await e.accounts.toCollection().modify((e=>{delete e.lastNotification,t.count++})),t.stop()})),Ka.set(198,(async e=>{const t=await e.filters.get({"[accountId+path]":[P.of,P.rp]});let n=!1;if(t){const a=t.filterValue;a.include&&2===a.include.length&&a.include.find((e=>e.find((e=>e.flag&&e.flag===P.T4.JUNK))&&e.find((e=>e.folder&&e.folder===P.Hd))))||(a.include=[[{folder:P.Hd}],[{flag:P.T4.JUNK}]],await e.filters.update(t.id,{filterValue:a}),n=!0)}else{const t={name:P.rp,accountId:P.of,path:P.rp,filterValue:{include:[[{folder:P.Hd}],[{flag:P.T4.JUNK}]],...$.Z.getSearchListButtons(P.Hd)}};await e.filters.add(t),n=!0}n&&e.filteringQueue.add({type:"RUN_FILTERS",priority:P.Un.LOW,folderIds:[[P.of,P.rp]]})})),Ka.set(201,(async e=>{const t=new Ha(201,"Update Received folder so Feeds filter button works");await e.filters.where("[accountId+path]").equals([P.of,P.ik]).modify((e=>{e.filterValue.include=[...e.filterValue.include,[{accountId:P.u4}]],e.filterValue={...e.filterValue,showFeeds:!1}})),await I.Z.call({priority:P.Un.LOW,type:"RUN_FILTERS",folderIds:[[P.of,P.ik]]}),t.stop()})),Ka.set(202,(async e=>{const t=new Ha(202,"Setting new listPost attribute to empty string");t.total=await e.messages.count(),await e.messages.toCollection().modify((e=>{e.listPost="",t.count++})),t.stop()})),Ka.set(203,(async e=>{const t=new Ha(203,"Make sure All Messages Unread has the exclude seen rule"),n=["All Messages","Unread"];let a=!0;await e.filters.where("[accountId+path]").equals(n).modify((e=>{e.filterValue.exclude||(e.filterValue.exclude=[]),a=e.filterValue.exclude.some((e=>1===e.length&&e[0]?.flag===P.T4.SEEN)),a||e.filterValue.exclude.push([{flag:P.T4.SEEN}])})),a||await e.filteringQueue.add({priority:P.Un.LOW,type:"RUN_FILTERS",folderIds:[n]}),t.stop()})),Ka.set(204,(async e=>{const t=new Ha(204,"Generate missing previews");await e.systemTasks.add({taskName:"generate_missing_previews",currentId:0}),t.stop()})),Ka.set(205,(async e=>{const t=new Ha(205,"Fixing mailing lists"),n=await e.filters.where("[accountId+path]").between(["Mailing Lists",""],["Mailing Lists","￿"]).primaryKeys();0!==n.length&&(await e.filteringQueue.add({priority:20,type:"RE_RUN_SLES",filterIds:n,runMailingLists:!0}),t.stop())})),m.Z.version(206).stores({hasRaw:["[searchListId+accountId]","accountId","searchListId","[hasRaw+accountId+sentDate+searchListId]"].join(",")}),Ka.set(206,(async e=>{const t=new Ha(206,"Updating raw status");t.total=2*await e.searchList.count();const n=new Map;await e.searchList.each((({id:e,sentDate:a})=>{n.set(e,a),t.count++})),await e.hasRaw.toCollection().modify((e=>{e.sentDate=n.get(e.searchListId),t.count++})),t.stop()})),Ka.set(208,(async e=>{const t=new Ha(208,"Update account root filter");await e.filters.toCollection().modify((e=>{e.path===P.ym&&([P.Sp,P.of,P.Ry,P.u4,P.MN,P.ut,P.wC,P.Kz].includes(e.accountId)||["showReadButton","showCustomFolderButton","showMailingListsButton","showArchivedButton","showJunkButton","showDeletedButton"].forEach((t=>{delete e.filterValue[t]})))})),t.stop()})),Ka.set(210,(async e=>{const t=new Ha(210,"Fixing message sources");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((e=>{e.sourceFilterIds=[...e.sources.keys()],t.count++})),t.stop()})),Ka.set(211,(async e=>{const t=new Ha(211,"Migrate Feed Paths");await e.systemTasks.add({taskName:"migrate_feed_paths"}),t.stop()})),Ka.forEach(((e,t)=>m.Z.version(t).upgrade((async n=>{try{await e(n),await n._upgrades.add({version:t})}catch(e){throw b.Z.error("Mail",["Upgrade",""+t],e),e}})))),m.Z.on("ready",(async()=>{const e=await m.Z._upgrades.toCollection().last();let t=[...Ka.keys()];e&&(t=t.filter((t=>t>e.version))),t.sort(((e,t)=>e-t));for(const e of t){const t=Ka.get(e);t&&await m.Z.transaction("rw",m.Z.tables,(n=>t(n).then((()=>n._upgrades.add({version:e})))))}}));const Wa=m.Z;var Ga=n(87192),Xa=n(24600);function Ya(e){if(0===e.length)throw new Error("raceToResolve: Need an array with at least one Promise.");let t;return new Promise(((n,a)=>Promise.all(e.map((e=>e.then(n).catch((e=>t=e))))).then((()=>a(t)))))}var Ja=n(16932);const{OK:ei,ERROR:ti,OFFLINE:ni}=P.In;async function ai(e){try{let t;if(e.useOAuth){const n=await Fn(e);t=ln(e,n)}else t=ln(e);await new Promise(((e,n)=>{t.onError=n,t.login().then((()=>t.logout())).then(e).catch(n)}))}catch(t){throw new Error((0,u.Z)("Login for $1 failed. $2",[e.MAIL_SERVER,t.message]))}}async function ii(e){try{await ut.verifyLogin(e)}catch(t){throw new Error((0,u.Z)("Login for $1 failed.",[e.MAIL_SERVER]))}}async function si(e){try{let t;if(e.useOAuth){const n=await Fn(e);t=(0,Xa.Z)(e,n)}else t=(0,Xa.Z)(e);await new Promise(((e,n)=>{t.onidle=t.quit,t.onerror=n,t.onclose=e,t.connect()}))}catch(t){throw e.useOAuth&&await Mn(e.MAIL_EMAIL,(0,Un.dn)(e)),new Error((0,u.Z)("Login for $1 failed.",[e.MAIL_SMTP_SERVER]))}}const ri=(e,t=!1)=>{const[n,a,i,s]=t?[e.MAIL_SMTP_PORT,e.MAIL_SMTP_SERVER,e.MAIL_SMTP_USER,e.MAIL_SMTP_PASSWORD]:[e.MAIL_PORT,e.MAIL_SERVER,e.MAIL_USER,e.MAIL_PASSWORD];if(!n||"number"!=typeof n)throw new Error(t?(0,u.Z)("Outgoing port is missing or not a number"):(0,u.Z)("Incoming port is missing or not a number"));if(!a)throw new Error(t?(0,u.Z)("Outgoing server information is missing"):(0,u.Z)("Incoming server information is missing"));if(!e.useOAuth){if(!i)throw new Error(t?(0,u.Z)("Outgoing username is missing"):(0,u.Z)("Incoming username is missing"));if(!s)throw new Error(t?(0,u.Z)("Outgoing password is missing"):(0,u.Z)("Incoming password is missing"))}},oi=(e,t,n,a,i)=>new Promise(((i,s)=>{const r=D.default.open(e,t,{useSecureTransport:"ssl"===n});r.onerror=s,r.onopen=()=>{r.close(),i("MAIL_SMTP_SERVER"===a?{MAIL_SMTP_SERVER:e,MAIL_SMTP_PORT:t,MAIL_SMTP_SOCKET_TYPE:n}:{MAIL_SERVER:e,MAIL_PORT:t})}})),ci=(e,t)=>{const n={...e,MAIL_SMTP_USER:t};return si(n).then((()=>[ei,"Outgoing connection success",n])).catch((t=>{throw[ti,t.message,e]}))},li=async(e,t,n)=>{const a=await ui(t);return a?di(e,a,n):Promise.reject(`No MX record found for ${t}`)},di=(e,t,n)=>{const a=[`https://autoconfig.${t}/mail/config-v1.1.xml?emailaddress=${e.MAIL_EMAIL}`,`https://autoconfig.vivaldi.net/v1.1/${t}`,`https://${t}/.well-known/autoconfig/mail/config-v1.1.xml?emailaddress=${e.MAIL_EMAIL}`],i="pop"===n?"pop3":n;return Ya(a.map((t=>hi(e,i,t))))},ui=async e=>{const t=await fetch(`https://autoconfig.vivaldi.net/mxlookup?domain=${e}`);if(t.ok){const e=await t.json();if(e&&e[0]?.target){return gi(e[0]?.target)}}},hi=async(e,t,n)=>{const a=await fetch(n);if(!a.ok)throw new Error("autodiscover: Error looking up in autoconfig");try{const n=await a.text(),i=new Ja.XMLParser({ignoreAttributes:!1}).parse(n),{emailProvider:s}=i.clientConfig,{outgoingServer:r,incomingServer:o}=s,c=Array.isArray(o)?o:[o],l=Array.isArray(r)?r:[r];let d,u,h,f,p;for(const e of c)if(e["@_type"]===t&&"ssl"===e.socketType.toLowerCase()){d=e.hostname,u=e.port;break}for(const e of l)if("smtp"===e["@_type"]&&"plain"!==e.socketType.toLowerCase()){h=e.hostname,f=e.port,p=e.socketType.toLowerCase();break}if(!(d&&u&&h&&f&&p))throw new Error("autodiscover: Missing Outgoing or Incoming Server/Port information");const g={...e,MAIL_SERVER:d,MAIL_PORT:Number(u),MAIL_SMTP_SERVER:h,MAIL_SMTP_PORT:Number(f),MAIL_SMTP_SOCKET_TYPE:"ssl"===p?"ssl":"starttls"};return[ei,g]}catch(e){throw new Error(`autodiscover: ${e}`)}},fi=async(e,t,n,a)=>{const i=await ui(t);return i?pi(e,i,n,a):[ti,e]},pi=(e,t,n,a)=>{const i=[`${n}.${t}`,`mail.${t}`,`${n}.mail.${t}`],s=[`smtp.${t}`,`mail.${t}`,`smtp.mail.${t}`];let r,o;return Promise.race([new Promise((e=>setTimeout(e,1e4))),Promise.allSettled([Ya([...i.map((e=>oi(e,a,"ssl","MAIL_SERVER")))]).then((e=>{r=e})),new Promise((e=>Promise.allSettled([Ya([...s.map((e=>oi(e,465,"ssl","MAIL_SMTP_SERVER")))]).then((t=>{o=t,e()})),Ya([...s.map((e=>oi(e,587,"starttls","MAIL_SMTP_SERVER")))]).then((e=>{o||(o=e)}))]).then(e)))])]).then((()=>{const t={...e,...r,...o};return[["MAIL_SERVER","MAIL_PORT","MAIL_SMTP_SERVER","MAIL_SMTP_PORT","MAIL_SMTP_SOCKET_TYPE"].every((e=>t[e]))?ei:ti,t]}))},gi=e=>{let t=e;if(null!=e){var n=e.split(".").reverse();null!=n&&n.length>1&&(t=n[1]+"."+n[0],-1!==e.toLowerCase().indexOf(".co.uk")&&n.length>2&&(t=n[2]+"."+t))}return t.toLowerCase()};var mi=n(47482);let wi=!1;const _i=o.Z.adjustBatchSize.bind(void 0,100,1e3,500);let bi=100;async function yi(){const e=await m.Z.flaggingQueue.toCollection().first();if(!e)return;let{id:t,searchListIds:n,sourcesPerSle:a,flagUpdates:i}=e;for(a instanceof Map||(console.warn("flagging.js: Invalid entry in flaggingQueue table"),a=new Map);n.length>0;){const e=n.splice(0,bi),s=Date.now(),r=e.map((e=>({searchListId:e,sources:a.get(e)||new Map})));await m.Z.transaction("rw",[m.Z.searchList,m.Z.filteringQueue,m.Z.flaggingQueue,m.Z.buffer,m.Z.imap],(async()=>{const s=await mi.Z.call(r,i);U.QO.updateIndex({sleUpdates:s}),await Yt.Z.addCustomFlags(e,a,i),Xt.call();const o={id:t,searchListIds:n,sourcesPerSle:a,flagUpdates:i};await m.Z.flaggingQueue.put(o)}));const o=Date.now();bi=_i(bi,o-s),we.filter()}await m.Z.flaggingQueue.delete(t),await yi()}Wa.open();const vi={updateThreads:Ce.updateThreads,start:async function(){await Promise.all([In(),w.Z.initFilters(),v.Z.initFolders(),Ae(),te.Z.initMailingLists()])},stop:function(){void 0!==bn&&bn("Clearing UID sequence sets."),vn(),yn={},w.Z.clear(),te.Z.clear(),ke(),Ie={level:0,children:new Map},h.Z.clear()},addAccount:async function(e){const t=e.MAIL_EMAIL,{accountType:n,offline:a}=e,i=n===P.s9.POP,s=n===P.s9.IMAP;if(!i&&!s)throw new Error(`Trying to add account ${t} of unsupported type ${n}`);const o=i||a?l.Z.getDefaultFolders():{},d=await r.Z.add(t,o);await h.Z.addAccounts({[t]:d});const u=await c.Z.foldersToFilters(t,o);w.Z.updateFilters(u)},flushBuffer:Xt.call,updateFlags:async function(){if(!wi){wi=!0;try{await yi()}finally{wi=!1}}},runSystemTasks:async function(){const e=await m.Z.systemTasks.toArray();for(const t of e)await Ft(t)},getOAuthAccessToken:Ln,fetchAccessTokenAndRefreshToken:Mn,verify:async function(e){await(async e=>(ri(e,!0),si(e)))(e),await(async e=>{ri(e,!1),e.accountType===P.s9.IMAP?await ai(e):await ii(e)})(e)},autofill:async function(e){if(!Ga.Z.isValidEmail(e))return[ti,e];const t=e.MAIL_EMAIL,n=e.MAIL_EMAIL&&t.split("@")[1];let a="imap",i=993;return e.accountType===P.s9.POP&&(a="pop",i=995),Ya([di(e,n,a),li(e,n,a)]).catch((()=>{let t;return new Promise((s=>Promise.allSettled([pi(e,n,a,i).then((e=>{e[0]===ei&&s(e),t||(t=e)})),fi(e,n,a,i).then((e=>{e[0]===ei&&s(e),t||(t=e)}))]).then((()=>s(t)))))})).then((e=>e))},signIn:async function(e){if(e.offline)return[ni,"offline",e];e.MAIL_PORT||(e.MAIL_PORT=e.accountType===P.s9.IMAP?993:995),e.MAIL_SMTP_PORT||(e.MAIL_SMTP_PORT=465);try{ri(e,!1),ri(e,!0)}catch(t){return[ti,t.message,e]}if(e.useOAuth)try{return await ci(e,e.MAIL_EMAIL)}catch(e){return e}const t=[e.MAIL_USER],n=[e.MAIL_SMTP_USER];if(e.MAIL_EMAIL===e.MAIL_USER&&e.MAIL_EMAIL===e.MAIL_SMTP_USER&&e.MAIL_EMAIL.includes("@")){const a=e.MAIL_EMAIL.split("@")[0];t.push(a),n.push(a)}const a=await Promise.allSettled([Ya(n.map((t=>ci(e,t)))),Ya(t.map((t=>(async(e,t)=>{const n={...e,MAIL_USER:t};try{return e.accountType===P.s9.IMAP?(await ai(n),[ei,"Incoming connection success",n]):(await ii(e),[ei,"Incoming connection success",n])}catch(t){throw[ti,t.message,e,[]]}})(e,t))))]);let i={...e},s=ei,r="";for(const e of a)e.reason?(s=ti,r=e.reason[1],i={...i,...e.reason[2]}):e.value&&(i={...i,...e.value[2]});return[s,r,i]}};function Ii(e){if(e.origin!==ae.oP)return;const{background:t}=e.data;if(t){const{promiseId:n,func:a,args:i=[]}=t;Promise.resolve().then((()=>vi[a](...i))).then((t=>{e.source.postMessage({background:{promiseId:n,results:t}})})).catch((t=>{t=t.message||t,e.source.postMessage({background:{promiseId:n,error:t}})}))}}self.addEventListener("install",(e=>{self.skipWaiting()}));let Ei=!1;!async function(){Ei||(Ei=!0,self.addEventListener("message",Ii,!1),await Promise.all([a.Z.loadPromise(),i.Z.loadPromise(),s.Z.loadPromise()]))}()},44983:()=>{!function(e){var t={};function n(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(a,i,function(t){return e[t]}.bind(null,i));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(e,t,n){"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(e,t,n){"use strict";var a="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var a in n)i(n,a)&&(e[a]=n[a])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var s={arraySet:function(e,t,n,a,i){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+a),i);else for(var s=0;s<a;s++)e[i+s]=t[n+s]},flattenChunks:function(e){var t,n,a,i,s,r;for(a=0,t=0,n=e.length;t<n;t++)a+=e[t].length;for(r=new Uint8Array(a),i=0,t=0,n=e.length;t<n;t++)s=e[t],r.set(s,i),i+=s.length;return r}},r={arraySet:function(e,t,n,a,i){for(var s=0;s<a;s++)e[i+s]=t[n+s]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,s)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,r))},t.setTyped(a)},function(e,t,n){"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(e,t,n){"use strict";var a,i=n(2),s=n(8),r=n(6),o=n(7),c=n(1),l=-2,d=258,u=262,h=103,f=113,p=666;function g(e,t){return e.msg=c[t],t}function m(e){return(e<<1)-(e>4?9:0)}function w(e){for(var t=e.length;--t>=0;)e[t]=0}function _(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(i.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function b(e,t){s._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,_(e.strm)}function y(e,t){e.pending_buf[e.pending++]=t}function v(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function I(e,t){var n,a,i=e.max_chain_length,s=e.strstart,r=e.prev_length,o=e.nice_match,c=e.strstart>e.w_size-u?e.strstart-(e.w_size-u):0,l=e.window,h=e.w_mask,f=e.prev,p=e.strstart+d,g=l[s+r-1],m=l[s+r];e.prev_length>=e.good_match&&(i>>=2),o>e.lookahead&&(o=e.lookahead);do{if(l[(n=t)+r]===m&&l[n+r-1]===g&&l[n]===l[s]&&l[++n]===l[s+1]){s+=2,n++;do{}while(l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&s<p);if(a=d-(p-s),s=p-d,a>r){if(e.match_start=t,r=a,a>=o)break;g=l[s+r-1],m=l[s+r]}}}while((t=f[t&h])>c&&0!=--i);return r<=e.lookahead?r:e.lookahead}function E(e){var t,n,a,s,c,l,d,h,f,p,g=e.w_size;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=g+(g-u)){i.arraySet(e.window,e.window,g,g,0),e.match_start-=g,e.strstart-=g,e.block_start-=g,t=n=e.hash_size;do{a=e.head[--t],e.head[t]=a>=g?a-g:0}while(--n);t=n=g;do{a=e.prev[--t],e.prev[t]=a>=g?a-g:0}while(--n);s+=g}if(0===e.strm.avail_in)break;if(l=e.strm,d=e.window,h=e.strstart+e.lookahead,f=s,p=void 0,(p=l.avail_in)>f&&(p=f),n=0===p?0:(l.avail_in-=p,i.arraySet(d,l.input,l.next_in,p,h),1===l.state.wrap?l.adler=r(l.adler,d,p,h):2===l.state.wrap&&(l.adler=o(l.adler,d,p,h)),l.next_in+=p,l.total_in+=p,p),e.lookahead+=n,e.lookahead+e.insert>=3)for(c=e.strstart-e.insert,e.ins_h=e.window[c],e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+3-1])&e.hash_mask,e.prev[c&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=c,c++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<u&&0!==e.strm.avail_in)}function k(e,t){for(var n,a;;){if(e.lookahead<u){if(E(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n)),e.match_length>=3)if(a=s._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else a=s._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(a&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function x(e,t){for(var n,a,i;;){if(e.lookahead<u){if(E(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-3,a=s._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=i&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,a&&(b(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((a=s._tr_tally(e,0,e.window[e.strstart-1]))&&b(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(a=s._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function A(e,t,n,a,i){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=a,this.func=i}function S(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(1146),this.dyn_dtree=new i.Buf16(122),this.bl_tree=new i.Buf16(78),w(this.dyn_ltree),w(this.dyn_dtree),w(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(16),this.heap=new i.Buf16(573),w(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(573),w(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function M(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:f,e.adler=2===t.wrap?0:1,t.last_flush=0,s._tr_init(t),0):g(e,l)}function O(e){var t,n=M(e);return 0===n&&((t=e.state).window_size=2*t.w_size,w(t.head),t.max_lazy_match=a[t.level].max_lazy,t.good_match=a[t.level].good_length,t.nice_match=a[t.level].nice_length,t.max_chain_length=a[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),n}function N(e,t,n,a,s,r){if(!e)return l;var o=1;if(-1===t&&(t=6),a<0?(o=0,a=-a):a>15&&(o=2,a-=16),s<1||s>9||8!==n||a<8||a>15||t<0||t>9||r<0||r>4)return g(e,l);8===a&&(a=9);var c=new S;return e.state=c,c.strm=e,c.wrap=o,c.gzhead=null,c.w_bits=a,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=s+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+3-1)/3),c.window=new i.Buf8(2*c.w_size),c.head=new i.Buf16(c.hash_size),c.prev=new i.Buf16(c.w_size),c.lit_bufsize=1<<s+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new i.Buf8(c.pending_buf_size),c.d_buf=1*c.lit_bufsize,c.l_buf=3*c.lit_bufsize,c.level=t,c.strategy=r,c.method=n,O(e)}a=[new A(0,0,0,0,(function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(E(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var a=e.block_start+n;if((0===e.strstart||e.strstart>=a)&&(e.lookahead=e.strstart-a,e.strstart=a,b(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-u&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(b(e,!1),e.strm.avail_out),1)})),new A(4,4,8,4,k),new A(4,5,16,8,k),new A(4,6,32,32,k),new A(4,4,16,16,x),new A(8,16,32,32,x),new A(8,16,128,128,x),new A(8,32,128,256,x),new A(32,128,258,1024,x),new A(32,258,258,4096,x)],t.deflateInit=function(e,t){return N(e,t,8,15,8,0)},t.deflateInit2=N,t.deflateReset=O,t.deflateResetKeep=M,t.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?l:(e.state.gzhead=t,0):l},t.deflate=function(e,t){var n,i,r,c;if(!e||!e.state||t>5||t<0)return e?g(e,l):l;if(i=e.state,!e.output||!e.input&&0!==e.avail_in||i.status===p&&4!==t)return g(e,0===e.avail_out?-5:l);if(i.strm=e,n=i.last_flush,i.last_flush=t,42===i.status)if(2===i.wrap)e.adler=0,y(i,31),y(i,139),y(i,8),i.gzhead?(y(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),y(i,255&i.gzhead.time),y(i,i.gzhead.time>>8&255),y(i,i.gzhead.time>>16&255),y(i,i.gzhead.time>>24&255),y(i,9===i.level?2:i.strategy>=2||i.level<2?4:0),y(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(y(i,255&i.gzhead.extra.length),y(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=o(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69):(y(i,0),y(i,0),y(i,0),y(i,0),y(i,0),y(i,9===i.level?2:i.strategy>=2||i.level<2?4:0),y(i,3),i.status=f);else{var u=8+(i.w_bits-8<<4)<<8;u|=(i.strategy>=2||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(u|=32),u+=31-u%31,i.status=f,v(i,u),0!==i.strstart&&(v(i,e.adler>>>16),v(i,65535&e.adler)),e.adler=1}if(69===i.status)if(i.gzhead.extra){for(r=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),_(e),r=i.pending,i.pending!==i.pending_buf_size));)y(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=73)}else i.status=73;if(73===i.status)if(i.gzhead.name){r=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),_(e),r=i.pending,i.pending===i.pending_buf_size)){c=1;break}c=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,y(i,c)}while(0!==c);i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),0===c&&(i.gzindex=0,i.status=91)}else i.status=91;if(91===i.status)if(i.gzhead.comment){r=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),_(e),r=i.pending,i.pending===i.pending_buf_size)){c=1;break}c=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,y(i,c)}while(0!==c);i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),0===c&&(i.status=h)}else i.status=h;if(i.status===h&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&_(e),i.pending+2<=i.pending_buf_size&&(y(i,255&e.adler),y(i,e.adler>>8&255),e.adler=0,i.status=f)):i.status=f),0!==i.pending){if(_(e),0===e.avail_out)return i.last_flush=-1,0}else if(0===e.avail_in&&m(t)<=m(n)&&4!==t)return g(e,-5);if(i.status===p&&0!==e.avail_in)return g(e,-5);if(0!==e.avail_in||0!==i.lookahead||0!==t&&i.status!==p){var I=2===i.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(E(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,n=s._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(i,t):3===i.strategy?function(e,t){for(var n,a,i,r,o=e.window;;){if(e.lookahead<=d){if(E(e),e.lookahead<=d&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(a=o[i=e.strstart-1])===o[++i]&&a===o[++i]&&a===o[++i]){r=e.strstart+d;do{}while(a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&i<r);e.match_length=d-(r-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=s._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=s._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(i,t):a[i.level].func(i,t);if(3!==I&&4!==I||(i.status=p),1===I||3===I)return 0===e.avail_out&&(i.last_flush=-1),0;if(2===I&&(1===t?s._tr_align(i):5!==t&&(s._tr_stored_block(i,0,0,!1),3===t&&(w(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),_(e),0===e.avail_out))return i.last_flush=-1,0}return 4!==t?0:i.wrap<=0?1:(2===i.wrap?(y(i,255&e.adler),y(i,e.adler>>8&255),y(i,e.adler>>16&255),y(i,e.adler>>24&255),y(i,255&e.total_in),y(i,e.total_in>>8&255),y(i,e.total_in>>16&255),y(i,e.total_in>>24&255)):(v(i,e.adler>>>16),v(i,65535&e.adler)),_(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?0:1)},t.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==h&&t!==f&&t!==p?g(e,l):(e.state=null,t===f?g(e,-3):0):l},t.deflateSetDictionary=function(e,t){var n,a,s,o,c,d,u,h,f=t.length;if(!e||!e.state)return l;if(2===(o=(n=e.state).wrap)||1===o&&42!==n.status||n.lookahead)return l;for(1===o&&(e.adler=r(e.adler,t,f,0)),n.wrap=0,f>=n.w_size&&(0===o&&(w(n.head),n.strstart=0,n.block_start=0,n.insert=0),h=new i.Buf8(n.w_size),i.arraySet(h,t,f-n.w_size,n.w_size,0),t=h,f=n.w_size),c=e.avail_in,d=e.next_in,u=e.input,e.avail_in=f,e.next_in=0,e.input=t,E(n);n.lookahead>=3;){a=n.strstart,s=n.lookahead-2;do{n.ins_h=(n.ins_h<<n.hash_shift^n.window[a+3-1])&n.hash_mask,n.prev[a&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=a,a++}while(--s);n.strstart=a,n.lookahead=2,E(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=d,e.input=u,e.avail_in=c,n.wrap=o,0},t.deflateInfo="pako deflate (from Nodeca project)"},function(e,t,n){"use strict";var a=n(2),i=n(6),s=n(7),r=n(9),o=n(10),c=-2,l=12,d=30;function u(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function h(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new a.Buf16(320),this.work=new a.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function f(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new a.Buf32(852),t.distcode=t.distdyn=new a.Buf32(592),t.sane=1,t.back=-1,0):c}function p(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,f(e)):c}function g(e,t){var n,a;return e&&e.state?(a=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?c:(null!==a.window&&a.wbits!==t&&(a.window=null),a.wrap=n,a.wbits=t,p(e))):c}function m(e,t){var n,a;return e?(a=new h,e.state=a,a.window=null,0!==(n=g(e,t))&&(e.state=null),n):c}var w,_,b=!0;function y(e){if(b){var t;for(w=new a.Buf32(512),_=new a.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(1,e.lens,0,288,w,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(2,e.lens,0,32,_,0,e.work,{bits:5}),b=!1}e.lencode=w,e.lenbits=9,e.distcode=_,e.distbits=5}function v(e,t,n,i){var s,r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new a.Buf8(r.wsize)),i>=r.wsize?(a.arraySet(r.window,t,n-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):((s=r.wsize-r.wnext)>i&&(s=i),a.arraySet(r.window,t,n-i,s,r.wnext),(i-=s)?(a.arraySet(r.window,t,n-i,i,0),r.wnext=i,r.whave=r.wsize):(r.wnext+=s,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=s))),0}t.inflateReset=p,t.inflateReset2=g,t.inflateResetKeep=f,t.inflateInit=function(e){return m(e,15)},t.inflateInit2=m,t.inflate=function(e,t){var n,h,f,p,g,m,w,_,b,I,E,k,x,A,S,M,O,N,L,T,Z,R,C,P,U=0,F=new a.Buf8(4),D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return c;(n=e.state).mode===l&&(n.mode=13),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,I=m,E=w,R=0;e:for(;;)switch(n.mode){case 1:if(0===n.wrap){n.mode=13;break}for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(2&n.wrap&&35615===_){n.check=0,F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0),_=0,b=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&_)<<8)+(_>>8))%31){e.msg="incorrect header check",n.mode=d;break}if(8!=(15&_)){e.msg="unknown compression method",n.mode=d;break}if(b-=4,Z=8+(15&(_>>>=4)),0===n.wbits)n.wbits=Z;else if(Z>n.wbits){e.msg="invalid window size",n.mode=d;break}n.dmax=1<<Z,e.adler=n.check=1,n.mode=512&_?10:l,_=0,b=0;break;case 2:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.flags=_,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=d;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=d;break}n.head&&(n.head.text=_>>8&1),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0)),_=0,b=0,n.mode=3;case 3:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.time=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,F[2]=_>>>16&255,F[3]=_>>>24&255,n.check=s(n.check,F,4,0)),_=0,b=0,n.mode=4;case 4:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.xflags=255&_,n.head.os=_>>8),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0)),_=0,b=0,n.mode=5;case 5:if(1024&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length=_,n.head&&(n.head.extra_len=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0)),_=0,b=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((k=n.length)>m&&(k=m),k&&(n.head&&(Z=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),a.arraySet(n.head.extra,h,p,k,Z)),512&n.flags&&(n.check=s(n.check,h,k,p)),m-=k,p+=k,n.length-=k),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===m)break e;k=0;do{Z=h[p+k++],n.head&&Z&&n.length<65536&&(n.head.name+=String.fromCharCode(Z))}while(Z&&k<m);if(512&n.flags&&(n.check=s(n.check,h,k,p)),m-=k,p+=k,Z)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===m)break e;k=0;do{Z=h[p+k++],n.head&&Z&&n.length<65536&&(n.head.comment+=String.fromCharCode(Z))}while(Z&&k<m);if(512&n.flags&&(n.check=s(n.check,h,k,p)),m-=k,p+=k,Z)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(65535&n.check)){e.msg="header crc mismatch",n.mode=d;break}_=0,b=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=l;break;case 10:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}e.adler=n.check=u(_),_=0,b=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,2;e.adler=n.check=1,n.mode=l;case l:if(5===t||6===t)break e;case 13:if(n.last){_>>>=7&b,b-=7&b,n.mode=27;break}for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}switch(n.last=1&_,b-=1,3&(_>>>=1)){case 0:n.mode=14;break;case 1:if(y(n),n.mode=20,6===t){_>>>=2,b-=2;break e}break;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=d}_>>>=2,b-=2;break;case 14:for(_>>>=7&b,b-=7&b;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if((65535&_)!=(_>>>16^65535)){e.msg="invalid stored block lengths",n.mode=d;break}if(n.length=65535&_,_=0,b=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(k=n.length){if(k>m&&(k=m),k>w&&(k=w),0===k)break e;a.arraySet(f,h,p,k,g),m-=k,p+=k,w-=k,g+=k,n.length-=k;break}n.mode=l;break;case 17:for(;b<14;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.nlen=257+(31&_),_>>>=5,b-=5,n.ndist=1+(31&_),_>>>=5,b-=5,n.ncode=4+(15&_),_>>>=4,b-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=d;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.lens[D[n.have++]]=7&_,_>>>=3,b-=3}for(;n.have<19;)n.lens[D[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,C={bits:n.lenbits},R=o(0,n.lens,0,19,n.lencode,0,n.work,C),n.lenbits=C.bits,R){e.msg="invalid code lengths set",n.mode=d;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(O<16)_>>>=S,b-=S,n.lens[n.have++]=O;else{if(16===O){for(P=S+2;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_>>>=S,b-=S,0===n.have){e.msg="invalid bit length repeat",n.mode=d;break}Z=n.lens[n.have-1],k=3+(3&_),_>>>=2,b-=2}else if(17===O){for(P=S+3;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,Z=0,k=3+(7&(_>>>=S)),_>>>=3,b-=3}else{for(P=S+7;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,Z=0,k=11+(127&(_>>>=S)),_>>>=7,b-=7}if(n.have+k>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=d;break}for(;k--;)n.lens[n.have++]=Z}}if(n.mode===d)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=d;break}if(n.lenbits=9,C={bits:n.lenbits},R=o(1,n.lens,0,n.nlen,n.lencode,0,n.work,C),n.lenbits=C.bits,R){e.msg="invalid literal/lengths set",n.mode=d;break}if(n.distbits=6,n.distcode=n.distdyn,C={bits:n.distbits},R=o(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,C),n.distbits=C.bits,R){e.msg="invalid distances set",n.mode=d;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(m>=6&&w>=258){e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,r(e,E),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,n.mode===l&&(n.back=-1);break}for(n.back=0;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(M&&0==(240&M)){for(N=S,L=M,T=O;M=(U=n.lencode[T+((_&(1<<N+L)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,n.length=O,0===M){n.mode=26;break}if(32&M){n.back=-1,n.mode=l;break}if(64&M){e.msg="invalid literal/length code",n.mode=d;break}n.extra=15&M,n.mode=22;case 22:if(n.extra){for(P=n.extra;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;M=(U=n.distcode[_&(1<<n.distbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(0==(240&M)){for(N=S,L=M,T=O;M=(U=n.distcode[T+((_&(1<<N+L)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,64&M){e.msg="invalid distance code",n.mode=d;break}n.offset=O,n.extra=15&M,n.mode=24;case 24:if(n.extra){for(P=n.extra;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.offset+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=d;break}n.mode=25;case 25:if(0===w)break e;if(k=E-w,n.offset>k){if((k=n.offset-k)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=d;break}k>n.wnext?(k-=n.wnext,x=n.wsize-k):x=n.wnext-k,k>n.length&&(k=n.length),A=n.window}else A=f,x=g-n.offset,k=n.length;k>w&&(k=w),w-=k,n.length-=k;do{f[g++]=A[x++]}while(--k);0===n.length&&(n.mode=21);break;case 26:if(0===w)break e;f[g++]=n.length,w--,n.mode=21;break;case 27:if(n.wrap){for(;b<32;){if(0===m)break e;m--,_|=h[p++]<<b,b+=8}if(E-=w,e.total_out+=E,n.total+=E,E&&(e.adler=n.check=n.flags?s(n.check,f,E,g-E):i(n.check,f,E,g-E)),E=w,(n.flags?_:u(_))!==n.check){e.msg="incorrect data check",n.mode=d;break}_=0,b=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=d;break}_=0,b=0}n.mode=29;case 29:R=1;break e;case d:R=-3;break e;case 31:return-4;default:return c}return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,(n.wsize||E!==e.avail_out&&n.mode<d&&(n.mode<27||4!==t))&&v(e,e.output,e.next_out,E-e.avail_out)?(n.mode=31,-4):(I-=e.avail_in,E-=e.avail_out,e.total_in+=I,e.total_out+=E,n.total+=E,n.wrap&&E&&(e.adler=n.check=n.flags?s(n.check,f,E,e.next_out-E):i(n.check,f,E,e.next_out-E)),e.data_type=n.bits+(n.last?64:0)+(n.mode===l?128:0)+(20===n.mode||15===n.mode?256:0),(0===I&&0===E||4===t)&&0===R&&(R=-5),R)},t.inflateEnd=function(e){if(!e||!e.state)return c;var t=e.state;return t.window&&(t.window=null),e.state=null,0},t.inflateGetHeader=function(e,t){var n;return e&&e.state?0==(2&(n=e.state).wrap)?c:(n.head=t,t.done=!1,0):c},t.inflateSetDictionary=function(e,t){var n,a=t.length;return e&&e.state?0!==(n=e.state).wrap&&11!==n.mode?c:11===n.mode&&i(1,t,a,0)!==n.check?-3:v(e,t,a,a)?(n.mode=31,-4):(n.havedict=1,0):c},t.inflateInfo="pako inflate (from Nodeca project)"},function(e,t,n){"use strict";e.exports=function(e,t,n,a){for(var i=65535&e|0,s=e>>>16&65535|0,r=0;0!==n;){n-=r=n>2e3?2e3:n;do{s=s+(i=i+t[a++]|0)|0}while(--r);i%=65521,s%=65521}return i|s<<16|0}},function(e,t,n){"use strict";var a=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var a=0;a<8;a++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();e.exports=function(e,t,n,i){var s=a,r=i+n;e^=-1;for(var o=i;o<r;o++)e=e>>>8^s[255&(e^t[o])];return-1^e}},function(e,t,n){"use strict";var a=n(2);function i(e){for(var t=e.length;--t>=0;)e[t]=0}var s=256,r=286,o=30,c=15,l=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],d=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],h=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],f=new Array(576);i(f);var p=new Array(60);i(p);var g=new Array(512);i(g);var m=new Array(256);i(m);var w=new Array(29);i(w);var _,b,y,v=new Array(o);function I(e,t,n,a,i){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=a,this.max_length=i,this.has_stree=e&&e.length}function E(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function k(e){return e<256?g[e]:g[256+(e>>>7)]}function x(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function A(e,t,n){e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,x(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function S(e,t,n){A(e,n[2*t],n[2*t+1])}function M(e,t){var n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}function O(e,t,n){var a,i,s=new Array(16),r=0;for(a=1;a<=c;a++)s[a]=r=r+n[a-1]<<1;for(i=0;i<=t;i++){var o=e[2*i+1];0!==o&&(e[2*i]=M(s[o]++,o))}}function N(e){var t;for(t=0;t<r;t++)e.dyn_ltree[2*t]=0;for(t=0;t<o;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function L(e){e.bi_valid>8?x(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function T(e,t,n,a){var i=2*t,s=2*n;return e[i]<e[s]||e[i]===e[s]&&a[t]<=a[n]}function Z(e,t,n){for(var a=e.heap[n],i=n<<1;i<=e.heap_len&&(i<e.heap_len&&T(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!T(t,a,e.heap[i],e.depth));)e.heap[n]=e.heap[i],n=i,i<<=1;e.heap[n]=a}function R(e,t,n){var a,i,r,o,c=0;if(0!==e.last_lit)do{a=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],i=e.pending_buf[e.l_buf+c],c++,0===a?S(e,i,t):(S(e,(r=m[i])+s+1,t),0!==(o=l[r])&&A(e,i-=w[r],o),S(e,r=k(--a),n),0!==(o=d[r])&&A(e,a-=v[r],o))}while(c<e.last_lit);S(e,256,t)}function C(e,t){var n,a,i,s=t.dyn_tree,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,d=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<l;n++)0!==s[2*n]?(e.heap[++e.heap_len]=d=n,e.depth[n]=0):s[2*n+1]=0;for(;e.heap_len<2;)s[2*(i=e.heap[++e.heap_len]=d<2?++d:0)]=1,e.depth[i]=0,e.opt_len--,o&&(e.static_len-=r[2*i+1]);for(t.max_code=d,n=e.heap_len>>1;n>=1;n--)Z(e,s,n);i=l;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Z(e,s,1),a=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=a,s[2*i]=s[2*n]+s[2*a],e.depth[i]=(e.depth[n]>=e.depth[a]?e.depth[n]:e.depth[a])+1,s[2*n+1]=s[2*a+1]=i,e.heap[1]=i++,Z(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var n,a,i,s,r,o,l=t.dyn_tree,d=t.max_code,u=t.stat_desc.static_tree,h=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,g=t.stat_desc.max_length,m=0;for(s=0;s<=c;s++)e.bl_count[s]=0;for(l[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<573;n++)(s=l[2*l[2*(a=e.heap[n])+1]+1]+1)>g&&(s=g,m++),l[2*a+1]=s,a>d||(e.bl_count[s]++,r=0,a>=p&&(r=f[a-p]),o=l[2*a],e.opt_len+=o*(s+r),h&&(e.static_len+=o*(u[2*a+1]+r)));if(0!==m){do{for(s=g-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[g]--,m-=2}while(m>0);for(s=g;0!==s;s--)for(a=e.bl_count[s];0!==a;)(i=e.heap[--n])>d||(l[2*i+1]!==s&&(e.opt_len+=(s-l[2*i+1])*l[2*i],l[2*i+1]=s),a--)}}(e,t),O(s,d,e.bl_count)}function P(e,t,n){var a,i,s=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),t[2*(n+1)+1]=65535,a=0;a<=n;a++)i=r,r=t[2*(a+1)+1],++o<c&&i===r||(o<l?e.bl_tree[2*i]+=o:0!==i?(i!==s&&e.bl_tree[2*i]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,s=i,0===r?(c=138,l=3):i===r?(c=6,l=3):(c=7,l=4))}function U(e,t,n){var a,i,s=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),a=0;a<=n;a++)if(i=r,r=t[2*(a+1)+1],!(++o<c&&i===r)){if(o<l)do{S(e,i,e.bl_tree)}while(0!=--o);else 0!==i?(i!==s&&(S(e,i,e.bl_tree),o--),S(e,16,e.bl_tree),A(e,o-3,2)):o<=10?(S(e,17,e.bl_tree),A(e,o-3,3)):(S(e,18,e.bl_tree),A(e,o-11,7));o=0,s=i,0===r?(c=138,l=3):i===r?(c=6,l=3):(c=7,l=4)}}i(v);var F=!1;function D(e,t,n,i){A(e,0+(i?1:0),3),function(e,t,n,i){L(e),x(e,n),x(e,~n),a.arraySet(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}(e,t,n)}t._tr_init=function(e){F||(function(){var e,t,n,a,i,s=new Array(16);for(n=0,a=0;a<28;a++)for(w[a]=n,e=0;e<1<<l[a];e++)m[n++]=a;for(m[n-1]=a,i=0,a=0;a<16;a++)for(v[a]=i,e=0;e<1<<d[a];e++)g[i++]=a;for(i>>=7;a<o;a++)for(v[a]=i<<7,e=0;e<1<<d[a]-7;e++)g[256+i++]=a;for(t=0;t<=c;t++)s[t]=0;for(e=0;e<=143;)f[2*e+1]=8,e++,s[8]++;for(;e<=255;)f[2*e+1]=9,e++,s[9]++;for(;e<=279;)f[2*e+1]=7,e++,s[7]++;for(;e<=287;)f[2*e+1]=8,e++,s[8]++;for(O(f,287,s),e=0;e<o;e++)p[2*e+1]=5,p[2*e]=M(e,5);_=new I(f,l,257,r,c),b=new I(p,d,0,o,c),y=new I(new Array(0),u,0,19,7)}(),F=!0),e.l_desc=new E(e.dyn_ltree,_),e.d_desc=new E(e.dyn_dtree,b),e.bl_desc=new E(e.bl_tree,y),e.bi_buf=0,e.bi_valid=0,N(e)},t._tr_stored_block=D,t._tr_flush_block=function(e,t,n,a){var i,r,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<s;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),C(e,e.l_desc),C(e,e.d_desc),o=function(e){var t;for(P(e,e.dyn_ltree,e.l_desc.max_code),P(e,e.dyn_dtree,e.d_desc.max_code),C(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*h[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),i=e.opt_len+3+7>>>3,(r=e.static_len+3+7>>>3)<=i&&(i=r)):i=r=n+5,n+4<=i&&-1!==t?D(e,t,n,a):4===e.strategy||r===i?(A(e,2+(a?1:0),3),R(e,f,p)):(A(e,4+(a?1:0),3),function(e,t,n,a){var i;for(A(e,t-257,5),A(e,n-1,5),A(e,a-4,4),i=0;i<a;i++)A(e,e.bl_tree[2*h[i]+1],3);U(e,e.dyn_ltree,t-1),U(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),R(e,e.dyn_ltree,e.dyn_dtree)),N(e),a&&L(e)},t._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(m[n]+s+1)]++,e.dyn_dtree[2*k(t)]++),e.last_lit===e.lit_bufsize-1},t._tr_align=function(e){A(e,2,3),S(e,256,f),function(e){16===e.bi_valid?(x(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},function(e,t,n){"use strict";e.exports=function(e,t){var n,a,i,s,r,o,c,l,d,u,h,f,p,g,m,w,_,b,y,v,I,E,k,x,A;n=e.state,a=e.next_in,x=e.input,i=a+(e.avail_in-5),s=e.next_out,A=e.output,r=s-(t-e.avail_out),o=s+(e.avail_out-257),c=n.dmax,l=n.wsize,d=n.whave,u=n.wnext,h=n.window,f=n.hold,p=n.bits,g=n.lencode,m=n.distcode,w=(1<<n.lenbits)-1,_=(1<<n.distbits)-1;e:do{p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=g[f&w];t:for(;;){if(f>>>=y=b>>>24,p-=y,0==(y=b>>>16&255))A[s++]=65535&b;else{if(!(16&y)){if(0==(64&y)){b=g[(65535&b)+(f&(1<<y)-1)];continue t}if(32&y){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}v=65535&b,(y&=15)&&(p<y&&(f+=x[a++]<<p,p+=8),v+=f&(1<<y)-1,f>>>=y,p-=y),p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=m[f&_];n:for(;;){if(f>>>=y=b>>>24,p-=y,!(16&(y=b>>>16&255))){if(0==(64&y)){b=m[(65535&b)+(f&(1<<y)-1)];continue n}e.msg="invalid distance code",n.mode=30;break e}if(I=65535&b,p<(y&=15)&&(f+=x[a++]<<p,(p+=8)<y&&(f+=x[a++]<<p,p+=8)),(I+=f&(1<<y)-1)>c){e.msg="invalid distance too far back",n.mode=30;break e}if(f>>>=y,p-=y,I>(y=s-r)){if((y=I-y)>d&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(E=0,k=h,0===u){if(E+=l-y,y<v){v-=y;do{A[s++]=h[E++]}while(--y);E=s-I,k=A}}else if(u<y){if(E+=l+u-y,(y-=u)<v){v-=y;do{A[s++]=h[E++]}while(--y);if(E=0,u<v){v-=y=u;do{A[s++]=h[E++]}while(--y);E=s-I,k=A}}}else if(E+=u-y,y<v){v-=y;do{A[s++]=h[E++]}while(--y);E=s-I,k=A}for(;v>2;)A[s++]=k[E++],A[s++]=k[E++],A[s++]=k[E++],v-=3;v&&(A[s++]=k[E++],v>1&&(A[s++]=k[E++]))}else{E=s-I;do{A[s++]=A[E++],A[s++]=A[E++],A[s++]=A[E++],v-=3}while(v>2);v&&(A[s++]=A[E++],v>1&&(A[s++]=A[E++]))}break}}break}}while(a<i&&s<o);a-=v=p>>3,f&=(1<<(p-=v<<3))-1,e.next_in=a,e.next_out=s,e.avail_in=a<i?i-a+5:5-(a-i),e.avail_out=s<o?o-s+257:257-(s-o),n.hold=f,n.bits=p}},function(e,t,n){"use strict";var a=n(2),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(e,t,n,c,l,d,u,h){var f,p,g,m,w,_,b,y,v,I=h.bits,E=0,k=0,x=0,A=0,S=0,M=0,O=0,N=0,L=0,T=0,Z=null,R=0,C=new a.Buf16(16),P=new a.Buf16(16),U=null,F=0;for(E=0;E<=15;E++)C[E]=0;for(k=0;k<c;k++)C[t[n+k]]++;for(S=I,A=15;A>=1&&0===C[A];A--);if(S>A&&(S=A),0===A)return l[d++]=20971520,l[d++]=20971520,h.bits=1,0;for(x=1;x<A&&0===C[x];x++);for(S<x&&(S=x),N=1,E=1;E<=15;E++)if(N<<=1,(N-=C[E])<0)return-1;if(N>0&&(0===e||1!==A))return-1;for(P[1]=0,E=1;E<15;E++)P[E+1]=P[E]+C[E];for(k=0;k<c;k++)0!==t[n+k]&&(u[P[t[n+k]]++]=k);if(0===e?(Z=U=u,_=19):1===e?(Z=i,R-=257,U=s,F-=257,_=256):(Z=r,U=o,_=-1),T=0,k=0,E=x,w=d,M=S,O=0,g=-1,m=(L=1<<S)-1,1===e&&L>852||2===e&&L>592)return 1;for(;;){b=E-O,u[k]<_?(y=0,v=u[k]):u[k]>_?(y=U[F+u[k]],v=Z[R+u[k]]):(y=96,v=0),f=1<<E-O,x=p=1<<M;do{l[w+(T>>O)+(p-=f)]=b<<24|y<<16|v|0}while(0!==p);for(f=1<<E-1;T&f;)f>>=1;if(0!==f?(T&=f-1,T+=f):T=0,k++,0==--C[E]){if(E===A)break;E=t[n+u[k]]}if(E>S&&(T&m)!==g){for(0===O&&(O=S),w+=x,N=1<<(M=E-O);M+O<A&&!((N-=C[M+O])<=0);)M++,N<<=1;if(L+=1<<M,1===e&&L>852||2===e&&L>592)return 1;l[g=T&m]=S<<24|M<<16|w-d|0}}return 0!==T&&(l[w+T]=E-O<<24|64<<16|0),h.bits=S,0}},function(e,t,n){"use strict";n.r(t);var a=n(3),i=n.n(a),s=n(4),r=n(5),o=n(1),c=n.n(o),l=n(0),d=16384;function u(e,t){var n=this;this.inflatedReady=e,this.deflatedReady=t,this._inflate=function(e){var t=new i.a,n=Object(r.inflateInit2)(t,15);if(n!==l.Z_OK)throw new Error("Problem initializing inflate stream: "+c.a[n]);return function(n){if(void 0===n)return e();var a,i,s;t.input=n,t.next_in=0,t.avail_in=t.input.length;var o=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(d),a=t.next_out=0,t.avail_out=d),(i=Object(r.inflate)(t,l.Z_NO_FLUSH))!==l.Z_STREAM_END&&i!==l.Z_OK)throw new Error("inflate problem: "+c.a[i]);t.next_out&&(0!==t.avail_out&&i!==l.Z_STREAM_END||(s=t.output.subarray(a,a=t.next_out),o=e(s)))}while(t.avail_in>0&&i!==l.Z_STREAM_END);return t.next_out>a&&(s=t.output.subarray(a,a=t.next_out),o=e(s)),o}}((function(e){return n.inflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length))})),this._deflate=function(e){var t=new i.a,n=Object(s.deflateInit2)(t,l.Z_DEFAULT_COMPRESSION,l.Z_DEFLATED,15,8,l.Z_DEFAULT_STRATEGY);if(n!==l.Z_OK)throw new Error("Problem initializing deflate stream: "+c.a[n]);return function(n){if(void 0===n)return e();var a,i,r;t.input=n,t.next_in=0,t.avail_in=t.input.length;var o=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(d),r=t.next_out=0,t.avail_out=d),(a=Object(s.deflate)(t,l.Z_SYNC_FLUSH))!==l.Z_STREAM_END&&a!==l.Z_OK)throw new Error("Deflate problem: "+c.a[a]);0===t.avail_out&&t.next_out>r&&(i=t.output.subarray(r,r=t.next_out),o=e(i))}while((t.avail_in>0||0===t.avail_out)&&a!==l.Z_STREAM_END);return t.next_out>r&&(i=t.output.subarray(r,r=t.next_out),o=e(i)),o}}((function(e){return n.deflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length))}))}u.prototype.inflate=function(e){this._inflate(new Uint8Array(e))},u.prototype.deflate=function(e){this._deflate(new Uint8Array(e))};var h=function(e,t){return{message:e,buffer:t}},f=new u((function(e){return self.postMessage(h("inflated_ready",e),[e])}),(function(e){return self.postMessage(h("deflated_ready",e),[e])}));self.onmessage=function(e){var t=e.data.message,n=e.data.buffer;switch(t){case"start":break;case"inflate":f.inflate(n);break;case"deflate":f.deflate(n)}}}])},9673:(e,t,n)=>{"use strict";function a(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function i(e){return function t(n){return 0===arguments.length||a(n)?t:e.apply(this,arguments)}}function s(e){return function t(n,s){switch(arguments.length){case 0:return t;case 1:return a(n)?t:i((function(t){return e(n,t)}));default:return a(n)&&a(s)?t:a(n)?i((function(t){return e(t,s)})):a(s)?i((function(t){return e(n,t)})):e(n,s)}}}function r(e){return function t(n,r,o){switch(arguments.length){case 0:return t;case 1:return a(n)?t:s((function(t,a){return e(n,t,a)}));case 2:return a(n)&&a(r)?t:a(n)?s((function(t,n){return e(t,r,n)})):a(r)?s((function(t,a){return e(n,t,a)})):i((function(t){return e(n,r,t)}));default:return a(n)&&a(r)&&a(o)?t:a(n)&&a(r)?s((function(t,n){return e(t,n,o)})):a(n)&&a(o)?s((function(t,n){return e(t,r,n)})):a(r)&&a(o)?s((function(t,a){return e(n,t,a)})):a(n)?i((function(t){return e(t,r,o)})):a(r)?i((function(t){return e(n,t,o)})):a(o)?i((function(t){return e(n,r,t)})):e(n,r,o)}}}n.d(t,{ZP:()=>At});const o=s((function(e,t){return null==t||t!=t?e:t}));const c=s((function(e,t){for(var n=t,a=0;a<e.length;){if(null==n)return;n=n[e[a]],a+=1}return n}));const l=r((function(e,t,n){return o(e,c(t,n))}));const d=r((function(e,t,n){return l(e,[t],n)})),u=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function h(e){return"[object String]"===Object.prototype.toString.call(e)}const f=i((function(e){return!!u(e)||!!e&&("object"==typeof e&&(!h(e)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))}));function p(e){return function t(n){for(var a,i,s,r=[],o=0,c=n.length;o<c;){if(f(n[o]))for(s=0,i=(a=e?t(n[o]):n[o]).length;s<i;)r[r.length]=a[s],s+=1;else r[r.length]=n[o];o+=1}return r}}const g=i(p(!0));const m=i((function(e){for(var t={},n=0;n<e.length;)t[e[n][0]]=e[n][1],n+=1;return t}));const w=s((function(e,t){for(var n=[],a=0,i=Math.min(e.length,t.length);a<i;)n[a]=[e[a],t[a]],a+=1;return n}));function _(e,t){var n;t=t||[];var a=(e=e||[]).length,i=t.length,s=[];for(n=0;n<a;)s[s.length]=e[n],n+=1;for(n=0;n<i;)s[s.length]=t[n],n+=1;return s}function b(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,a){return t.apply(this,arguments)};case 4:return function(e,n,a,i){return t.apply(this,arguments)};case 5:return function(e,n,a,i,s){return t.apply(this,arguments)};case 6:return function(e,n,a,i,s,r){return t.apply(this,arguments)};case 7:return function(e,n,a,i,s,r,o){return t.apply(this,arguments)};case 8:return function(e,n,a,i,s,r,o,c){return t.apply(this,arguments)};case 9:return function(e,n,a,i,s,r,o,c,l){return t.apply(this,arguments)};case 10:return function(e,n,a,i,s,r,o,c,l,d){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function y(e,t){return function(){return t.call(this,e.apply(this,arguments))}}var v=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();const I=s((function(e,t){return b(e.length,(function(){return e.apply(t,arguments)}))}));function E(e,t,n){for(var a=n.next();!a.done;){if((t=e["@@transducer/step"](t,a.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}a=n.next()}return e["@@transducer/result"](t)}function k(e,t,n,a){return e["@@transducer/result"](n[a](I(e["@@transducer/step"],e),t))}var x="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function A(e,t,n){if("function"==typeof e&&(e=function(e){return new v(e)}(e)),f(n))return function(e,t,n){for(var a=0,i=n.length;a<i;){if((t=e["@@transducer/step"](t,n[a]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}a+=1}return e["@@transducer/result"](t)}(e,t,n);if("function"==typeof n["fantasy-land/reduce"])return k(e,t,n,"fantasy-land/reduce");if(null!=n[x])return E(e,t,n[x]());if("function"==typeof n.next)return E(e,t,n);if("function"==typeof n.reduce)return k(e,t,n,"reduce");throw new TypeError("reduce: list must be array or iterable")}const S=r(A);function M(e,t){return function(){var n=arguments.length;if(0===n)return t();var a=arguments[n-1];return u(a)||"function"!=typeof a[e]?t.apply(this,arguments):a[e].apply(a,Array.prototype.slice.call(arguments,0,n-1))}}const O=i(M("tail",r(M("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)})))(1,1/0)));function N(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return b(arguments[0].length,S(y,arguments[0],O(arguments)))}const L=i((function(e){return h(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()}));function T(){if(0===arguments.length)throw new Error("compose requires at least one argument");return N.apply(this,L(arguments))}function Z(e){return e}const R=i(Z);function C(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function P(e,t,n){for(var a=0,i=n.length;a<i;){if(e(t,n[a]))return!0;a+=1}return!1}function U(e,t){return Object.prototype.hasOwnProperty.call(t,e)}const F="function"==typeof Object.is?Object.is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t};var D=Object.prototype.toString;const z=function(){return"[object Arguments]"===D.call(arguments)?function(e){return"[object Arguments]"===D.call(e)}:function(e){return U("callee",e)}}();var B=!{toString:null}.propertyIsEnumerable("toString"),$=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],j=function(){return arguments.propertyIsEnumerable("length")}(),Q=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1},V="function"!=typeof Object.keys||j?i((function(e){if(Object(e)!==e)return[];var t,n,a=[],i=j&&z(e);for(t in e)!U(t,e)||i&&"length"===t||(a[a.length]=t);if(B)for(n=$.length-1;n>=0;)U(t=$[n],e)&&!Q(a,t)&&(a[a.length]=t),n-=1;return a})):i((function(e){return Object(e)!==e?[]:Object.keys(e)}));const q=V;const H=i((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function K(e,t,n,a){var i=C(e);function s(e,t){return W(e,t,n.slice(),a.slice())}return!P((function(e,t){return!P(s,t,e)}),C(t),i)}function W(e,t,n,a){if(F(e,t))return!0;var i,s,r=H(e);if(r!==H(t))return!1;if(null==e||null==t)return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(r){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===(i=e.constructor,null==(s=String(i).match(/^function (\w*)/))?"":s[1]))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!F(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!F(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var o=n.length-1;o>=0;){if(n[o]===e)return a[o]===t;o-=1}switch(r){case"Map":return e.size===t.size&&K(e.entries(),t.entries(),n.concat([e]),a.concat([t]));case"Set":return e.size===t.size&&K(e.values(),t.values(),n.concat([e]),a.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var c=q(e);if(c.length!==q(t).length)return!1;var l=n.concat([e]),d=a.concat([t]);for(o=c.length-1;o>=0;){var u=c[o];if(!U(u,t)||!W(t[u],e[u],l,d))return!1;o-=1}return!0}const G=s((function(e,t){return W(e,t,[],[])}));function X(e,t){return function(e,t,n){var a,i;if("function"==typeof e.indexOf)switch(typeof t){case"number":if(0===t){for(a=1/t;n<e.length;){if(0===(i=e[n])&&1/i===a)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(i=e[n])&&i!=i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(G(e[n],t))return n;n+=1}return-1}(t,e,0)>=0}function Y(e,t,n){var a,i=typeof e;switch(i){case"string":case"number":return 0===e&&1/e==-1/0?!!n._items["-0"]||(t&&(n._items["-0"]=!0),!1):null!==n._nativeSet?t?(a=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===a):n._nativeSet.has(e):i in n._items?e in n._items[i]||(t&&(n._items[i][e]=!0),!1):(t&&(n._items[i]={},n._items[i][e]=!0),!1);case"boolean":if(i in n._items){var s=e?1:0;return!!n._items[i][s]||(t&&(n._items[i][s]=!0),!1)}return t&&(n._items[i]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==n._nativeSet?t?(a=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===a):n._nativeSet.has(e):i in n._items?!!X(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1);case"undefined":return!!n._items[i]||(t&&(n._items[i]=!0),!1);case"object":if(null===e)return!!n._items.null||(t&&(n._items.null=!0),!1);default:return(i=Object.prototype.toString.call(e))in n._items?!!X(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1)}}const J=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!Y(e,!0,this)},e.prototype.has=function(e){return Y(e,!1,this)},e}();const ee=s(T(s((function(e,t){for(var n,a,i=new J,s=[],r=0;r<t.length;)n=e(a=t[r]),i.add(n)&&s.push(a),r+=1;return s}))(R),_));function te(e){return null!=e&&"function"==typeof e["@@transducer/step"]}function ne(e,t,n){return function(){if(0===arguments.length)return n();var a=Array.prototype.slice.call(arguments,0),i=a.pop();if(!u(i)){for(var s=0;s<e.length;){if("function"==typeof i[e[s]])return i[e[s]].apply(i,a);s+=1}if(te(i)){var r=t.apply(null,a);return r(i)}}return n.apply(this,arguments)}}function ae(e,t){for(var n=0,a=t.length,i=Array(a);n<a;)i[n]=e(t[n]),n+=1;return i}const ie=function(){return this.xf["@@transducer/init"]()},se=function(e){return this.xf["@@transducer/result"](e)};var re=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=ie,e.prototype["@@transducer/result"]=se,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}();const oe=s((function(e,t){return new re(e,t)}));function ce(e,t,n){return function(){for(var i=[],s=0,r=e,o=0;o<t.length||s<arguments.length;){var c;o<t.length&&(!a(t[o])||s>=arguments.length)?c=t[o]:(c=arguments[s],s+=1),i[o]=c,a(c)||(r-=1),o+=1}return r<=0?n.apply(this,i):b(r,ce(e,i,n))}}const le=s((function(e,t){return 1===e?i(t):b(e,ce(e,[],t))}));const de=s(ne(["fantasy-land/map","map"],oe,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return le(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return A((function(n,a){return n[a]=e(t[a]),n}),{},q(t));default:return ae(e,t)}})));var ue=n(83065),he=n(84846);const fe=32,pe=93,ge=e=>(e=>e>=1&&e<=127)(e)&&!me(e),me=e=>40===e||41===e||123===e||e===fe||we(e)||_e(e)||be(e)||ye(e),we=e=>e>=0&&e<=31||127===e,_e=e=>37===e||42===e,be=e=>34===e||92===e,ye=e=>e===pe,ve=e=>e>=48&&e<=57,Ie=e=>(e=>e>=65&&e<=90||e>=97&&e<=122)(e)||ve(e),Ee=e=>ge(e)||ye(e);function ke(e,t,n){let a=[],i=(e.tag||"")+(e.command?" "+e.command:""),s=!0,r=function(e){if(i.length>0&&s&&(i+=" "),Array.isArray(e))return s=!1,i+="(",e.forEach(r),void(i+=")");if(s=!0,e||"string"==typeof e||"number"==typeof e)if("string"!=typeof e)if("number"!=typeof e)if(n&&e.sensitive)i+='"(* value hidden *)"';else switch(e.type.toUpperCase()){case"LITERAL":n?i+='"(* '+e.value.length+'B literal *)"':(e.value?i+="{"+e.value.length+"}\r\n":i+="{0}\r\n",a.push(i),i=e.value||"");break;case"STRING":n&&e.value.length>20?i+='"(* '+e.value.length+'B string *)"':i+=JSON.stringify(e.value||"");break;case"TEXT":case"SEQUENCE":i+=e.value||"";break;case"NUMBER":i+=e.value||0;break;case"ATOM":case"SECTION":let t=e.value||"";for(let e=92===t.charCodeAt(0)?1:0;e<t.length;e++)if(!ge(t.charCodeAt(e))){t=JSON.stringify(t);break}i+=t,e.section&&(i+="[",e.section.length&&(s=!1,e.section.forEach(r)),i+="]"),e.partial&&(i+="<"+e.partial.join(".")+">")}else i+=Math.round(e)||0;else n&&e.length>20?i+='"(* '+e.length+'B string *)"':i+=JSON.stringify(e);else i+="NIL"};return[].concat(e.attributes||[]).forEach(r),i.length&&a.push(i),t?a:a.join("")}function xe(e){return"[object Function]"===Object.prototype.toString.call(e)}function Ae(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var Se=function(e){return(e<10?"0":"")+e};const Me="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+Se(e.getUTCMonth()+1)+"-"+Se(e.getUTCDate())+"T"+Se(e.getUTCHours())+":"+Se(e.getUTCMinutes())+":"+Se(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};var Oe=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=ie,e.prototype["@@transducer/result"]=se,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}();const Ne=s(ne(["filter"],s((function(e,t){return new Oe(e,t)})),(function(e,t){return n=t,"[object Object]"===Object.prototype.toString.call(n)?A((function(n,a){return e(t[a])&&(n[a]=t[a]),n}),{},q(t)):function(e,t){for(var n=0,a=t.length,i=[];n<a;)e(t[n])&&(i[i.length]=t[n]),n+=1;return i}(e,t);var n})));const Le=s((function(e,t){return Ne((n=e,function(){return!n.apply(this,arguments)}),t);var n}));function Te(e,t){var n=function(n){var a=t.concat([e]);return X(n,a)?"<Circular>":Te(n,a)},a=function(e,t){return ae((function(t){return Ae(t)+": "+n(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(e)){case"[object Arguments]":return"(function() { return arguments; }("+ae(n,e).join(", ")+"))";case"[object Array]":return"["+ae(n,e).concat(a(e,Le((function(e){return/^\d+$/.test(e)}),q(e)))).join(", ")+"]";case"[object Boolean]":return"object"==typeof e?"new Boolean("+n(e.valueOf())+")":e.toString();case"[object Date]":return"new Date("+(isNaN(e.valueOf())?n(NaN):Ae(Me(e)))+")";case"[object Null]":return"null";case"[object Number]":return"object"==typeof e?"new Number("+n(e.valueOf())+")":1/e==-1/0?"-0":e.toString(10);case"[object String]":return"object"==typeof e?"new String("+n(e.valueOf())+")":Ae(e);case"[object Undefined]":return"undefined";default:if("function"==typeof e.toString){var i=e.toString();if("[object Object]"!==i)return i}return"{"+a(e,q(e)).join(", ")+"}"}}const Ze=i((function(e){return Te(e,[])}));const Re=s((function(e,t){return le(e+1,(function(){var n=arguments[e];if(null!=n&&xe(n[t]))return n[t].apply(n,Array.prototype.slice.call(arguments,0,e));throw new TypeError(Ze(n)+' does not have a method named "'+t+'"')}))}))(0,"toLowerCase");const Ce=s((function(e,t){return c([e],t)}));var Pe=n(85834);function Ue(e){return!!e&&(e=[].concat(e||[])).map((e=>!(!e||!e.length)&&{prefix:e[0].value,delimiter:e[1]&&e[1].value}))}function Fe(e){const t={};return e[0]&&e[0].value&&(t.date=e[0].value),e[1]&&e[1].value&&(t.subject=(0,Pe.Mf)(e[1]&&e[1].value)),e[2]&&e[2].length&&(t.from=De(e[2])),e[3]&&e[3].length&&(t.sender=De(e[3])),e[4]&&e[4].length&&(t["reply-to"]=De(e[4])),e[5]&&e[5].length&&(t.to=De(e[5])),e[6]&&e[6].length&&(t.cc=De(e[6])),e[7]&&e[7].length&&(t.bcc=De(e[7])),e[8]&&e[8].value&&(t["in-reply-to"]=e[8].value),e[9]&&e[9].value&&(t["message-id"]=e[9].value),t}function De(e=[]){return e.map((e=>{const t=l("",["0","value"],e).trim(),n=l("",["2","value"],e)+"@"+l("",["3","value"],e),a=t?function(e){if(!/^[\w ']*$/.test(e))return/^[\x20-\x7e]*$/.test(e)?JSON.stringify(e):(0,Pe.KR)(e,"Q",52);return e}(t)+" <"+n+">":n,i=(0,he.Z)(a).shift();return i.name=(0,Pe.Mf)(i.name),i}))}function ze(e,t=[]){const n={};let a=0,i=0;if(t.length&&(n.part=t.join(".")),Array.isArray(e[0])){for(n.childNodes=[];Array.isArray(e[a]);)n.childNodes.push(ze(e[a],t.concat(++i))),a++;n.type="multipart/"+((e[a++]||{}).value||"").toString().toLowerCase(),a<e.length-1&&(e[a]&&(n.parameters=Be(e[a])),a++)}else n.type=[((e[a++]||{}).value||"").toString().toLowerCase(),((e[a++]||{}).value||"").toString().toLowerCase()].join("/"),e[a]&&(n.parameters=Be(e[a])),a++,e[a]&&(n.id=((e[a]||{}).value||"").toString()),a++,e[a]&&(n.description=((e[a]||{}).value||"").toString()),a++,e[a]&&(n.encoding=((e[a]||{}).value||"").toString().toLowerCase()),a++,e[a]&&(n.size=Number((e[a]||{}).value||0)||0),a++,"message/rfc822"===n.type?(e[a]&&(n.envelope=Fe([].concat(e[a]||[]))),a++,e[a]&&(n.childNodes=[ze(e[a],t)]),a++,e[a]&&(n.lineCount=Number((e[a]||{}).value||0)||0),a++):/^text\//.test(n.type)&&(e[a]&&(n.lineCount=Number((e[a]||{}).value||0)||0),a++),a<e.length-1&&(e[a]&&(n.md5=((e[a]||{}).value||"").toString().toLowerCase()),a++);return a<e.length-1&&(Array.isArray(e[a])&&e[a].length&&(n.disposition=((e[a][0]||{}).value||"").toString().toLowerCase(),Array.isArray(e[a][1])&&(n.dispositionParameters=Be(e[a][1]))),a++),a<e.length-1&&(e[a]&&(n.language=[].concat(e[a]).map((e=>d("","value",e).toLowerCase()))),a++),a<e.length-1&&(e[a]&&(n.location=((e[a]||{}).value||"").toString()),a++),n}function Be(e=[],t=Re,n=Pe.Mf){const a=e.map(Ce("value")),i=a.filter(((e,t)=>t%2==0)).map(t),s=a.filter(((e,t)=>t%2==1)).map(n);return m(w(i,s))}function $e(e){if(!(e&&e.payload&&e.payload.FETCH&&e.payload.FETCH.length))return[];const t=[],n={};return e.payload.FETCH.forEach((e=>{const a=[].concat([].concat(e.attributes||[])[0]||[]);let i,s,r,o;for(n[e.nr]?i=n[e.nr]:(n[e.nr]=i={"#":e.nr},t.push(i)),s=0,r=a.length;s<r;s++)s%2!=0?i[o]=je(o,a[s]):o=ke({attributes:[a[s]]}).toLowerCase().replace(/<\d+>$/,"")})),t}function je(e,t){if(!t)return null;if(!Array.isArray(t)){switch(e){case"uid":case"rfc822.size":return Number(t.value)||0;case"modseq":return t.value||"0"}return t.value}switch(e){case"flags":case"x-gm-labels":t=[].concat(t).map((e=>e.value||""));break;case"envelope":t=Fe([].concat(t||[]));break;case"bodystructure":t=ze([].concat(t||[]));break;case"modseq":t=(t.shift()||{}).value||"0"}return t}function Qe(e){for(var t=[],n=0;n<e.length;n+=10240){const a=n,i=Math.min(n+10240,e.length);t.push(String.fromCharCode.apply(null,e.subarray(a,i)))}return t.join("")}function Ve(e){let t=0,n=e.length;for(;e[t]===fe;)t++;for(;e[n-1]===fe;)n--;return 0===t&&n===e.length||(e=e.subarray(t,n)),Qe(e)}class qe{constructor(e,t){this.remainder=new Uint8Array(e||0),this.options=t||{},this.pos=0}getTag(){if(!this.tag){const e=e=>(e=>Ee(e)&&43!==e)(e)||42===e||43===e;this.tag=this.getElement(e)}return this.tag}getCommand(){switch(this.command||(this.command=this.getElement(Ie)),(this.command||"").toString().toUpperCase()){case"OK":case"NO":case"BAD":case"PREAUTH":case"BYE":let e=this.remainder.lastIndexOf(pe);91===this.remainder[1]&&e>1?(this.humanReadable=Ve(this.remainder.subarray(e+1)),this.remainder=this.remainder.subarray(0,e+1)):(this.humanReadable=Ve(this.remainder),this.remainder=new Uint8Array(0))}return this.command}getElement(e){let t;if(this.remainder[0]===fe)throw new Error("Unexpected whitespace at position "+this.pos);let n=this.remainder.indexOf(fe);if(!(this.remainder.length>0&&0!==n))throw new Error("Unexpected end of input at position "+this.pos);t=-1===n?this.remainder:this.remainder.subarray(0,n);for(let n=0;n<t.length;n++)if(!e(t[n]))throw new Error("Unexpected char at position "+(this.pos+n));return this.pos+=t.length,this.remainder=this.remainder.subarray(t.length),Qe(t)}getSpace(){if(!this.remainder.length)throw new Error("Unexpected end of input at position "+this.pos);if(this.remainder[0]!==fe)throw new Error("Unexpected char at position "+this.pos);this.pos++,this.remainder=this.remainder.subarray(1)}getAttributes(){if(!this.remainder.length)throw new Error("Unexpected end of input at position "+this.pos);if(this.remainder[0]===fe)throw new Error("Unexpected whitespace at position "+this.pos);return new Ke(this,this.pos,this.remainder.subarray(),this.options).getAttributes()}}class He{constructor(e,t,n){this.uint8Array=e,this.childNodes=[],this.type=!1,this.closed=!0,this.valueSkip=[],this.startPos=n,this.valueStart=this.valueEnd="number"==typeof n?n+1:0,t&&(this.parentNode=t,t.childNodes.push(this))}getValue(){let e=Qe(this.getValueArray());return this.valueToUpperCase?e.toUpperCase():e}getValueLength(){return this.valueEnd-this.valueStart-this.valueSkip.length}getValueArray(){const e=this.uint8Array.subarray(this.valueStart,this.valueEnd);if(0===this.valueSkip.length)return e;let t=new Uint8Array(e.length-this.valueSkip.length),n=0,a=0,i=this.valueSkip.slice();return i.push(e.length),i.forEach((function(i){if(i>n){var s=e.subarray(n,i);t.set(s,a),a+=s.length}n=i+1})),t}equals(e,t){return this.getValueLength()===e.length&&this.equalsAt(e,0,t)}equalsAt(e,t,n){if(n="boolean"!=typeof n||n,t<0)for(t=this.valueEnd+t;this.valueSkip.indexOf(this.valueStart+t)>=0;)t--;else t=this.valueStart+t;for(let a=0;a<e.length;a++){for(;this.valueSkip.indexOf(t-this.valueStart)>=0;)t++;if(t>=this.valueEnd)return!1;let i=String.fromCharCode(this.uint8Array[t]),s=e[a];if(n||(i=i.toUpperCase(),s=s.toUpperCase()),i!==s)return!1;t++}return!0}isNumber(){for(let e=0;e<this.valueEnd-this.valueStart;e++)if(!(this.valueSkip.indexOf(e)>=0||this.isDigit(e)))return!1;return!0}isDigit(e){if(e<0)for(e=this.valueEnd+e;this.valueSkip.indexOf(this.valueStart+e)>=0;)e--;else for(e=this.valueStart+e;this.valueSkip.indexOf(this.valueStart+e)>=0;)e++;return ve(this.uint8Array[e])}containsChar(e){let t=e.charCodeAt(0);for(let e=this.valueStart;e<this.valueEnd;e++)if(!(this.valueSkip.indexOf(e-this.valueStart)>=0)&&this.uint8Array[e]===t)return!0;return!1}}class Ke{constructor(e,t,n,a={}){this.uint8Array=n,this.options=a,this.parent=e,this.tree=this.currentNode=this.createNode(),this.pos=t||0,this.currentNode.type="TREE",this.state="NORMAL",void 0===this.options.valueAsString&&(this.options.valueAsString=!0),this.processString()}getAttributes(){let e=[],t=e,n=e=>{let a,i,s=t;if(!e.closed&&"SEQUENCE"===e.type&&e.equals("*")&&(e.closed=!0,e.type="ATOM"),!e.closed)throw new Error("Unexpected end of input at position "+(this.pos+this.uint8Array.length-1));switch(e.type.toUpperCase()){case"LITERAL":case"STRING":a={type:e.type.toUpperCase(),value:this.options.valueAsString?e.getValue():e.getValueArray()},t.push(a);break;case"SEQUENCE":a={type:e.type.toUpperCase(),value:e.getValue()},t.push(a);break;case"ATOM":if(e.equals("NIL",!0)){t.push(null);break}a={type:e.type.toUpperCase(),value:e.getValue()},t.push(a);break;case"SECTION":t=t[t.length-1].section=[];break;case"LIST":a=[],t.push(a),t=a;break;case"PARTIAL":i=e.getValue().split(".").map(Number),t[t.length-1].partial=i}e.childNodes.forEach((function(e){n(e)})),t=s};return n(this.tree),e}createNode(e,t){return new He(this.uint8Array,e,t)}processString(){let e,t;const n=t=>{for(;this.uint8Array[e+1]===fe;)e++};for(e=0,t=this.uint8Array.length;e<t;e++){let a=this.uint8Array[e];switch(this.state){case"NORMAL":switch(a){case 34:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="string",this.state="STRING",this.currentNode.closed=!1;break;case 40:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="LIST",this.currentNode.closed=!1;break;case 41:if("LIST"!==this.currentNode.type)throw new Error("Unexpected list terminator ) at position "+(this.pos+e));this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,n();break;case pe:if("SECTION"!==this.currentNode.type)throw new Error("Unexpected section terminator ] at position "+(this.pos+e));this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,n();break;case 60:this.uint8Array[e-1]!==pe?(this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="ATOM",this.currentNode.valueStart=e,this.currentNode.valueEnd=e+1,this.state="ATOM"):(this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="PARTIAL",this.state="PARTIAL",this.currentNode.closed=!1);break;case 123:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="LITERAL",this.state="LITERAL",this.currentNode.closed=!1;break;case 42:this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="SEQUENCE",this.currentNode.valueStart=e,this.currentNode.valueEnd=e+1,this.currentNode.closed=!1,this.state="SEQUENCE";break;case fe:case 126:break;case 91:if(["OK","NO","BAD","BYE","PREAUTH"].indexOf(this.parent.command.toUpperCase())>=0&&this.currentNode===this.tree){this.currentNode.endPos=this.pos+e,this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="ATOM",this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="SECTION",this.currentNode.closed=!1,this.state="NORMAL","REFERRAL "===Qe(this.uint8Array.subarray(e+1,e+10)).toUpperCase()&&(this.currentNode=this.createNode(this.currentNode,this.pos+e+1),this.currentNode.type="ATOM",this.currentNode.endPos=this.pos+e+8,this.currentNode.valueStart=e+1,this.currentNode.valueEnd=e+9,this.currentNode.valueToUpperCase=!0,this.currentNode=this.currentNode.parentNode,this.currentNode=this.createNode(this.currentNode,this.pos+e+10),this.currentNode.type="ATOM",e=this.uint8Array.indexOf(pe,e+10),this.currentNode.endPos=this.pos+e-1,this.currentNode.valueStart=this.currentNode.startPos-this.pos,this.currentNode.valueEnd=this.currentNode.endPos-this.pos+1,this.currentNode=this.currentNode.parentNode,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,n());break}default:if(!ge(a)&&92!==a&&37!==a)throw new Error("Unexpected char at position "+(this.pos+e));this.currentNode=this.createNode(this.currentNode,e),this.currentNode.type="ATOM",this.currentNode.valueStart=e,this.currentNode.valueEnd=e+1,this.state="ATOM"}break;case"ATOM":if(a===fe){this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.state="NORMAL";break}if(this.currentNode.parentNode&&(41===a&&"LIST"===this.currentNode.parentNode.type||a===pe&&"SECTION"===this.currentNode.parentNode.type)){this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(44!==a&&58!==a||!this.currentNode.isNumber()||(this.currentNode.type="SEQUENCE",this.currentNode.closed=!0,this.state="SEQUENCE"),91===a&&(this.currentNode.equals("BODY",!1)||this.currentNode.equals("BODY.PEEK",!1))){this.currentNode.endPos=this.pos+e,this.currentNode=this.createNode(this.currentNode.parentNode,this.pos+e),this.currentNode.type="SECTION",this.currentNode.closed=!1,this.state="NORMAL";break}if(60===a)throw new Error("Unexpected start of partial at position "+this.pos);if(!(ge(a)||a===pe||42===a&&this.currentNode.equals("\\")))throw new Error("Unexpected char at position "+(this.pos+e));if(this.currentNode.equals("\\*"))throw new Error("Unexpected char at position "+(this.pos+e));this.currentNode.valueEnd=e+1;break;case"STRING":if(34===a){this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(92===a){if(this.currentNode.valueSkip.push(e-this.currentNode.valueStart),e++,e>=t)throw new Error("Unexpected end of input at position "+(this.pos+e));a=this.uint8Array[e]}this.currentNode.valueEnd=e+1;break;case"PARTIAL":if(62===a){if(this.currentNode.equalsAt(".",-1))throw new Error("Unexpected end of partial at position "+this.pos);this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(46===a&&(!this.currentNode.getValueLength()||this.currentNode.containsChar(".")))throw new Error("Unexpected partial separator . at position "+this.pos);if(!ve(a)&&46!==a)throw new Error("Unexpected char at position "+(this.pos+e));if(46!==a&&(this.currentNode.equals("0")||this.currentNode.equalsAt(".0",-2)))throw new Error("Invalid partial at position "+(this.pos+e));this.currentNode.valueEnd=e+1;break;case"LITERAL":if(this.currentNode.started){this.currentNode.valueEnd=e+1,this.currentNode.getValueLength()>=this.currentNode.literalLength&&(this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n());break}if(43===a){this.currentNode.literalPlus=!0;break}if(125===a){if(!("literalLength"in this.currentNode))throw new Error("Unexpected literal prefix end char } at position "+(this.pos+e));if(10===this.uint8Array[e+1])e++;else{if(13!==this.uint8Array[e+1]||10!==this.uint8Array[e+2])throw new Error("Unexpected char at position "+(this.pos+e));e+=2}this.currentNode.valueStart=e+1,this.currentNode.literalLength=Number(this.currentNode.literalLength),this.currentNode.started=!0,this.currentNode.literalLength||(this.currentNode.endPos=this.pos+e,this.currentNode.closed=!0,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n());break}if(!ve(a))throw new Error("Unexpected char at position "+(this.pos+e));if("0"===this.currentNode.literalLength)throw new Error("Invalid literal at position "+(this.pos+e));this.currentNode.literalLength=(this.currentNode.literalLength||"")+String.fromCharCode(a);break;case"SEQUENCE":if(a===fe){if(!this.currentNode.isDigit(-1)&&!this.currentNode.equalsAt("*",-1))throw new Error("Unexpected whitespace at position "+(this.pos+e));if(this.currentNode.equalsAt("*",-1)&&!this.currentNode.equalsAt(":",-2))throw new Error("Unexpected whitespace at position "+(this.pos+e));this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.state="NORMAL";break}if(this.currentNode.parentNode&&a===pe&&"SECTION"===this.currentNode.parentNode.type){this.currentNode.endPos=this.pos+e-1,this.currentNode=this.currentNode.parentNode,this.currentNode.closed=!0,this.currentNode.endPos=this.pos+e,this.currentNode=this.currentNode.parentNode,this.state="NORMAL",n();break}if(58===a){if(!this.currentNode.isDigit(-1)&&!this.currentNode.equalsAt("*",-1))throw new Error("Unexpected range separator : at position "+(this.pos+e))}else if(42===a){if(!this.currentNode.equalsAt(",",-1)&&!this.currentNode.equalsAt(":",-1))throw new Error("Unexpected range wildcard at position "+(this.pos+e))}else if(44===a){if(!this.currentNode.isDigit(-1)&&!this.currentNode.equalsAt("*",-1))throw new Error("Unexpected sequence separator , at position "+(this.pos+e));if(this.currentNode.equalsAt("*",-1)&&!this.currentNode.equalsAt(":",-2))throw new Error("Unexpected sequence separator , at position "+(this.pos+e))}else if(!ve(a))throw new Error("Unexpected char at position "+(this.pos+e));if(ve(a)&&this.currentNode.equalsAt("*",-1))throw new Error("Unexpected number at position "+(this.pos+e));this.currentNode.valueEnd=e+1}}}}function We(e,t={}){let n=new qe(e,t),a={};return a.tag=n.getTag(),n.getSpace(),a.command=n.getCommand(),["UID","AUTHENTICATE"].indexOf((a.command||"").toUpperCase())>=0&&(n.getSpace(),a.command+=" "+n.getElement(Ie)),function(e){for(let t=0;t<e.length;t++)if(e[t]!==fe)return!1;return!0}(n.remainder)||(n.getSpace(),a.attributes=n.getAttributes()),n.humanReadable&&(a.attributes=(a.attributes||[]).concat({type:"TEXT",value:n.humanReadable})),a}var Ge=n(65546);const Xe=e=>new Uint8Array(e.split("").map((e=>e.charCodeAt(0)))),Ye=e=>String.fromCharCode.apply(null,e);function Je(e="",t){const n=[`user=${e}`,`auth=Bearer ${t}`,"",""];return(0,Ge.encode)(n.join(""))}let et=0;function tt(e,t){const n=++et,a=(a,i)=>{i=i.map((e=>"function"==typeof e?e():e));const s=`[${(new Date).toISOString()}][${n}][${e}][${t}] ${i.join(" ")}`;10===a?console.log("[DEBUG]"+s):20===a?console.info("[INFO]"+s):30===a?console.warn("[WARN]"+s):40===a&&console.error("[ERROR]"+s)};return{debug:e=>a(10,e),info:e=>a(20,e),warn:e=>a(30,e),error:e=>a(40,e)}}var nt=n(16504),at=n(62292),it=n.n(at),st=n(30405),rt=n(27948),ot=n(48898),ct=n.n(ot),lt=n(71619);const dt=16384;function ut(e,t){this.inflatedReady=e,this.deflatedReady=t,this._inflate=function(e){const t=new(it()),n=(0,rt.Ul)(t,15);if(n!==lt.Z_OK)throw new Error("Problem initializing inflate stream: "+ct()[n]);return function(n){if(void 0===n)return e();let a,i,s;t.input=n,t.next_in=0,t.avail_in=t.input.length;let r=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(dt),a=t.next_out=0,t.avail_out=dt),i=(0,rt.rr)(t,lt.Z_NO_FLUSH),i!==lt.Z_STREAM_END&&i!==lt.Z_OK)throw new Error("inflate problem: "+ct()[i]);t.next_out&&(0!==t.avail_out&&i!==lt.Z_STREAM_END||(s=t.output.subarray(a,a=t.next_out),r=e(s)))}while(t.avail_in>0&&i!==lt.Z_STREAM_END);return t.next_out>a&&(s=t.output.subarray(a,a=t.next_out),r=e(s)),r}}((e=>this.inflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length)))),this._deflate=function(e){const t=new(it()),n=(0,st.Ue)(t,lt.Z_DEFAULT_COMPRESSION,lt.Z_DEFLATED,15,8,lt.Z_DEFAULT_STRATEGY);if(n!==lt.Z_OK)throw new Error("Problem initializing deflate stream: "+ct()[n]);return function(n){if(void 0===n)return e();let a,i,s;t.input=n,t.next_in=0,t.avail_in=t.input.length;let r=!0;do{if(0===t.avail_out&&(t.output=new Uint8Array(dt),s=t.next_out=0,t.avail_out=dt),a=(0,st.Wt)(t,lt.Z_SYNC_FLUSH),a!==lt.Z_STREAM_END&&a!==lt.Z_OK)throw new Error("Deflate problem: "+ct()[a]);0===t.avail_out&&t.next_out>s&&(i=t.output.subarray(s,s=t.next_out),r=e(i))}while((t.avail_in>0||0===t.avail_out)&&a!==lt.Z_STREAM_END);return t.next_out>s&&(i=t.output.subarray(s,s=t.next_out),r=e(i)),r}}((e=>this.deflatedReady(e.buffer.slice(e.byteOffset,e.byteOffset+e.length))))}ut.prototype.inflate=function(e){this._inflate(new Uint8Array(e))},ut.prototype.deflate=function(e){this._deflate(new Uint8Array(e))};var ht=n(44983),ft=n.n(ht);const pt="\r\n",gt="literal",mt="literal_length_1",wt="literal_length_2",_t="default";class bt{constructor(e,t,n={}){this.timeoutEnterIdle=1e3,this.timeoutSocketLowerBound=1e4,this.timeoutSocketMultiplier=.1,this.options=n,this.port=t||(this.options.useSecureTransport?993:143),this.host=e||"localhost",this.options.useSecureTransport="useSecureTransport"in this.options?!!this.options.useSecureTransport:993===this.port,this.secureMode=!!this.options.useSecureTransport,this._connectionReady=!1,this._globalAcceptUntagged={},this._clientQueue=[],this._canSend=!1,this._tagCounter=0,this._currentCommand=!1,this._idleTimer=!1,this._socketTimeoutTimer=!1,this.compressed=!1,this._incomingBuffers=[],this._bufferState=_t,this._literalRemaining=0,this.oncert=null,this.onerror=null,this.onready=null,this.onidle=null}connect(e=nt.default){return new Promise(((t,n)=>{this.socket=e.open(this.host,this.port,{binaryType:"arraybuffer",useSecureTransport:this.secureMode,ca:this.options.ca});try{this.socket.oncert=e=>{this.oncert&&this.oncert(e)}}catch(e){}this.socket.onclose=()=>this._onError(new Error("Socket closed unexpectedly!")),this.socket.ondata=e=>{try{this._onData(e)}catch(e){this._onError(e)}},this.socket.onerror=e=>{n(new Error("Could not open socket: "+e.data.message))},this.socket.onopen=()=>{this.socket.onerror=e=>this._onError(e),t()}}))}close(e){return new Promise((t=>{var n=()=>{if(this._clientQueue.forEach((t=>t.callback(e))),this._currentCommand&&this._currentCommand.callback(e),this._clientQueue=[],this._currentCommand=!1,clearTimeout(this._idleTimer),this._idleTimer=null,clearTimeout(this._socketTimeoutTimer),this._socketTimeoutTimer=null,this.socket){this.socket.onopen=null,this.socket.onclose=null,this.socket.ondata=null,this.socket.onerror=null;try{this.socket.oncert=null}catch(e){}this.socket=null}t()};if(this._disableCompression(),!this.socket||"open"!==this.socket.readyState)return n();this.socket.onclose=this.socket.onerror=n,this.socket.close()}))}logout(){return new Promise(((e,t)=>{this.socket.onclose=this.socket.onerror=()=>{this.close("Client logging out").then(e).catch(t)},this.enqueueCommand("LOGOUT")}))}upgrade(){this.secureMode=!0,this.socket.upgradeToSecure()}enqueueCommand(e,t,n){"string"==typeof e&&(e={command:e}),t=[].concat(t||[]).map((e=>(e||"").toString().toUpperCase().trim()));var a="W"+ ++this._tagCounter;return e.tag=a,new Promise(((i,s)=>{var r={tag:a,request:e,payload:t.length?{}:void 0,callback:e=>{if(this.isError(e))return s(e);{const n=d("","command",e).toUpperCase().trim();if(["NO","BAD"].includes(n)){var t=new Error(e.humanReadable||"Error");return t.command=n,e.code&&(t.code=e.code),s(t)}}i(e)}};Object.keys(n||{}).forEach((e=>{r[e]=n[e]})),t.forEach((e=>{r.payload[e]=[]}));var o=r.ctx?this._clientQueue.indexOf(r.ctx):-1;o>=0?(r.tag+=".p",r.request.tag+=".p",this._clientQueue.splice(o,0,r)):this._clientQueue.push(r),this._canSend&&this._sendRequest()}))}getPreviouslyQueued(e,t){for(let e=this._clientQueue.indexOf(t)-1;e>=0;e--)if(n(this._clientQueue[e]))return this._clientQueue[e];return!!n(this._currentCommand)&&this._currentCommand;function n(t){return t&&t.request&&e.indexOf(t.request.command)>=0}}send(e){const t=Xe(e).buffer;this._resetSocketTimeout(t.byteLength),this.compressed?this._sendCompressed(t):this.socket.send(t)}setHandler(e,t){this._globalAcceptUntagged[e.toUpperCase().trim()]=t}_onError(e){var t;t=this.isError(e)?e:e&&this.isError(e.data)?e.data:new Error(e&&e.data&&e.data.message||e.data||e||"Error"),this.onerror||this.logger.error(t),this.close(t).then((()=>{this.onerror&&this.onerror(t)}),(()=>{this.onerror&&this.onerror(t)}))}_onData(e){this._resetSocketTimeout(),this._incomingBuffers.push(new Uint8Array(e.data)),this._parseIncomingCommands(this._iterateIncomingBuffer())}*_iterateIncomingBuffer(){let e=this._incomingBuffers[this._incomingBuffers.length-1]||[],t=0;for(;t<e.length;)switch(this._bufferState){case gt:const n=Math.min(e.length-t,this._literalRemaining);this._literalRemaining-=n,t+=n,0===this._literalRemaining&&(this._bufferState=_t);continue;case wt:t<e.length&&(13===e[t]?(this._literalRemaining=Number(Ye(this._lengthBuffer))+2,this._bufferState=gt):this._bufferState=_t,delete this._lengthBuffer);continue;case mt:const a=t;for(;t<e.length&&e[t]>=48&&e[t]<=57;)t++;if(a!==t){const n=e.subarray(a,t),i=this._lengthBuffer;this._lengthBuffer=new Uint8Array(i.length+n.length),this._lengthBuffer.set(i),this._lengthBuffer.set(n,i.length)}t<e.length&&(this._lengthBuffer.length>0&&125===e[t]?this._bufferState=wt:(delete this._lengthBuffer,this._bufferState=_t),t++);continue;default:const i=e.indexOf(123,t);if(i>-1){if(-1===new Uint8Array(e.buffer,t,i-t).indexOf(10)){t=i+1,this._lengthBuffer=new Uint8Array(0),this._bufferState=mt;continue}}const s=e.indexOf(10,t);if(!(s>-1))return;{s<e.length-1&&(this._incomingBuffers[this._incomingBuffers.length-1]=new Uint8Array(e.buffer,0,s+1));const n=this._incomingBuffers.reduce(((e,t)=>e+t.length),0)-2,a=new Uint8Array(n);let i=0;for(;this._incomingBuffers.length>0;){let e=this._incomingBuffers.shift();const t=n-i;if(e.length>t){const n=e.length-t;e=e.subarray(0,-n),this._incomingBuffers.length>0&&(this._incomingBuffers=[])}a.set(e,i),i+=e.length}if(yield a,!(s<e.length-1))return clearTimeout(this._socketTimeoutTimer),void(this._socketTimeoutTimer=null);e=new Uint8Array(e.subarray(s+1)),this._incomingBuffers.push(e),t=0}}}_parseIncomingCommands(e){for(var t of e)if(this._clearIdle(),43!==t[0]){var n;try{const e=this._currentCommand.request&&this._currentCommand.request.valueAsString;n=We(t,{valueAsString:e}),this.logger.debug("S:",(()=>ke(n,!1,!0)))}catch(e){return this.logger.error("Error parsing imap command!",n),this._onError(e)}this._processResponse(n),this._handleResponse(n),this._connectionReady||(this._connectionReady=!0,this.onready&&this.onready())}else if(this._currentCommand.data.length){var a=this._currentCommand.data.shift();a+=this._currentCommand.data.length?"":pt,this.send(a)}else this._currentCommand.errorResponseExpectsEmptyLine&&this.send(pt)}_handleResponse(e){var t=d("","command",e).toUpperCase().trim();this._currentCommand?this._currentCommand.payload&&"*"===e.tag&&t in this._currentCommand.payload?(this._currentCommand.payload[t].push(e),this._resetSocketTimeout()):"*"===e.tag&&t in this._globalAcceptUntagged?(this._globalAcceptUntagged[t](e),this._resetSocketTimeout()):e.tag===this._currentCommand.tag&&(this._currentCommand.payload&&Object.keys(this._currentCommand.payload).length&&(e.payload=this._currentCommand.payload),this._currentCommand.callback(e),this._canSend=!0,this._sendRequest()):"*"===e.tag&&t in this._globalAcceptUntagged&&(this._globalAcceptUntagged[t](e),this._canSend=!0,this._sendRequest())}_sendRequest(){if(!this._clientQueue.length)return this._currentCommand=!1,this._enterIdle();this._clearIdle(),this._restartQueue=!1;var e=this._clientQueue[0];if("function"==typeof e.precheck){var t=e,n=t.precheck;return delete t.precheck,this._restartQueue=!0,void n(t).then((()=>{this._restartQueue&&this._sendRequest()})).catch((e=>{let n;const a=this._clientQueue.indexOf(t);a>=0&&(n=this._clientQueue.splice(a,1)[0]),n&&n.callback&&(n.callback(e),this._canSend=!0,this._parseIncomingCommands(this._iterateIncomingBuffer()),this._sendRequest())}))}this._canSend=!1,this._currentCommand=this._clientQueue.shift();try{this._currentCommand.data=ke(this._currentCommand.request,!0),this.logger.debug("C:",(()=>ke(this._currentCommand.request,!1,!0)))}catch(e){return this.logger.error("Error compiling imap command!",this._currentCommand.request),this._onError(new Error("Error compiling imap command!"))}var a=this._currentCommand.data.shift();return this.send(a+(this._currentCommand.data.length?"":pt)),this.waitDrain}_enterIdle(){clearTimeout(this._idleTimer),this._idleTimer=setTimeout((()=>this.onidle&&this.onidle()),this.timeoutEnterIdle)}_clearIdle(){clearTimeout(this._idleTimer),this._idleTimer=null}_processResponse(e){const t=d("","command",e).toUpperCase().trim();if(e&&e.attributes&&e.attributes.length&&("*"===e.tag&&/^\d+$/.test(e.command)&&"ATOM"===e.attributes[0].type&&(e.nr=Number(e.command),e.command=(e.attributes.shift().value||"").toString().toUpperCase().trim()),!(["OK","NO","BAD","BYE","PREAUTH"].indexOf(t)<0)&&("TEXT"===e.attributes[e.attributes.length-1].type&&(e.humanReadable=e.attributes[e.attributes.length-1].value),"ATOM"===e.attributes[0].type&&e.attributes[0].section))){const t=e.attributes[0].section.map((e=>{if(e)return Array.isArray(e)?e.map((e=>(e.value||"").toString().trim())):(e.value||"").toString().toUpperCase().trim()})),n=t.shift();e.code=n,1===t.length?e[n.toLowerCase()]=t[0]:t.length>1&&(e[n.toLowerCase()]=t)}}isError(e){return!!Object.prototype.toString.call(e).match(/Error\]$/)}enableCompression(){if(this._socketOnData=this.socket.ondata,this.compressed=!0,"undefined"!=typeof window&&window.Worker)this._compressionWorker=new Worker(URL.createObjectURL(new Blob([ft()]))),this._compressionWorker.onmessage=e=>{var t=e.data.message,n=e.data.buffer;switch(t){case"inflated_ready":this._socketOnData({data:n});break;case"deflated_ready":this.waitDrain=this.socket.send(n)}},this._compressionWorker.onerror=e=>{this._onError(new Error("Error handling compression web worker: "+e.message))},this._compressionWorker.postMessage(yt("start"));else{const e=e=>{this._socketOnData({data:e})},t=e=>{this.waitDrain=this.socket.send(e)};this._compression=new ut(e,t)}this.socket.ondata=e=>{this.compressed&&(this._compressionWorker?this._compressionWorker.postMessage(yt("inflate",e.data),[e.data]):this._compression.inflate(e.data))}}_disableCompression(){this.compressed&&(this.compressed=!1,this.socket.ondata=this._socketOnData,this._socketOnData=null,this._compressionWorker&&(this._compressionWorker.terminate(),this._compressionWorker=null))}_sendCompressed(e){this._compressionWorker?this._compressionWorker.postMessage(yt("deflate",e),[e]):this._compression.deflate(e)}_resetSocketTimeout(e){clearTimeout(this._socketTimeoutTimer);const t=this.timeoutSocketLowerBound+Math.floor((e||4096)*this.timeoutSocketMultiplier);this._socketTimeoutTimer=setTimeout((()=>this._onError(new Error(" Socket timed out!"))),t)}}const yt=(e,t)=>({message:e,buffer:t}),vt=["\\All","\\Archive","\\Drafts","\\Flagged","\\Junk","\\Sent","\\Trash"],It={"\\Sent":["aika","bidaliak","bidalita","dihantar","e rometsweng","e tindami","elküldött","elküldöttek","enviadas","enviadas","enviados","enviats","envoyés","ethunyelweyo","expediate","ezipuru","gesendete","gestuur","gönderilmiş öğeler","göndərilənlər","iberilen","inviati","išsiųstieji","kuthunyelwe","lasa","lähetetyt","messages envoyés","naipadala","nalefa","napadala","nosūtītās ziņas","odeslané","padala","poslane","poslano","poslano","poslané","poslato","saadetud","saadetud kirjad","sendt","sendt","sent","sent items","sent messages","sända poster","sänt","terkirim","ti fi ranṣẹ","të dërguara","verzonden","vilivyotumwa","wysłane","đã gửi","σταλθέντα","жиберилген","жіберілгендер","изпратени","илгээсэн","ирсол шуд","испратено","надіслані","отправленные","пасланыя","юборилган","ուղարկված","נשלחו","פריטים שנשלחו","المرسلة","بھیجے گئے","سوزمژہ","لېګل شوی","موارد ارسال شده","पाठविले","पाठविलेले","प्रेषित","भेजा गया","প্রেরিত","প্রেরিত","প্ৰেৰিত","ਭੇਜੇ","મોકલેલા","ପଠାଗଲା","அனுப்பியவை","పంపించబడింది","ಕಳುಹಿಸಲಾದ","അയച്ചു","යැවු පණිවුඩ","ส่งแล้ว","გაგზავნილი","የተላኩ","បាន​ផ្ញើ","寄件備份","寄件備份","已发信息","送信済みﾒｰﾙ","발신 메시지","보낸 편지함"],"\\Trash":["articole șterse","bin","borttagna objekt","deleted","deleted items","deleted messages","elementi eliminati","elementos borrados","elementos eliminados","gelöschte objekte","item dipadam","itens apagados","itens excluídos","mục đã xóa","odstraněné položky","pesan terhapus","poistetut","praht","prügikast","silinmiş öğeler","slettede beskeder","slettede elementer","trash","törölt elemek","usunięte wiadomości","verwijderde items","vymazané správy","éléments supprimés","видалені","жойылғандар","удаленные","פריטים שנמחקו","العناصر المحذوفة","موارد حذف شده","รายการที่ลบ","已删除邮件","已刪除項目","已刪除項目"],"\\Junk":["bulk mail","correo no deseado","courrier indésirable","istenmeyen","istenmeyen e-posta","junk","levélszemét","nevyžiadaná pošta","nevyžádaná pošta","no deseado","posta indesiderata","pourriel","roskaposti","skräppost","spam","spam","spamowanie","søppelpost","thư rác","спам","דואר זבל","الرسائل العشوائية","هرزنامه","สแปม","‎垃圾郵件","垃圾邮件","垃圾電郵"],"\\Drafts":["ba brouillon","borrador","borrador","borradores","bozze","brouillons","bản thảo","ciorne","concepten","draf","drafts","drög","entwürfe","esborranys","garalamalar","ihe edeturu","iidrafti","izinhlaka","juodraščiai","kladd","kladder","koncepty","koncepty","konsep","konsepte","kopie robocze","layihələr","luonnokset","melnraksti","meralo","mesazhe të padërguara","mga draft","mustandid","nacrti","nacrti","osnutki","piszkozatok","rascunhos","rasimu","skice","taslaklar","tsararrun saƙonni","utkast","vakiraoka","vázlatok","zirriborroak","àwọn àkọpamọ́","πρόχειρα","жобалар","нацрти","нооргууд","сиёҳнавис","хомаки хатлар","чарнавікі","чернетки","чернови","черновики","черновиктер","սևագրեր","טיוטות","مسودات","مسودات","موسودې","پیش نویسها","ڈرافٹ/","ड्राफ़्ट","प्रारूप","খসড়া","খসড়া","ড্ৰাফ্ট","ਡ੍ਰਾਫਟ","ડ્રાફ્ટસ","ଡ୍ରାଫ୍ଟ","வரைவுகள்","చిత్తు ప్రతులు","ಕರಡುಗಳು","കരടുകള്‍","කෙටුම් පත්","ฉบับร่าง","მონახაზები","ረቂቆች","សារព្រាង","下書き","草稿","草稿","草稿","임시 보관함"],"\\Archive":["archive","archives"]},Et=Object.keys(It);function kt(e){if(e.flags)for(let t=0;t<vt.length;t++){const n=vt[t];if((e.flags||[]).indexOf(n)>=0)return e.specialUse=n,e.specialUseFlag=n,n}return function(e){const t=d("","name",e).toLowerCase().trim();for(let n=0;n<Et.length;n++){const a=Et[n];if(It[a].indexOf(t)>=0)return e.specialUse=a,a}return!1}(e)}const xt={name:"emailjs-imap-client"};const At=class{constructor(e,t,n={}){this.timeoutConnection=9e4,this.timeoutNoop=6e4,this.timeoutIdle=6e4,this.serverId=!1,this.oncert=null,this.onupdate=null,this.onselectmailbox=null,this.onclosemailbox=null,this._host=e,this._clientId=d(xt,"id",n),this._state=!1,this._authenticated=!1,this._capability=[],this._humanReadable="",this._okGreeting="",this._selectedMailbox=!1,this._enteredIdle=!1,this._idleTimeout=!1,this._enableCompression=!!n.enableCompression,this._auth=n.auth,this._requireTLS=!!n.requireTLS,this._ignoreTLS=!!n.ignoreTLS,this.client=new bt(e,t,n),this.client.onerror=this._onError.bind(this),this.client.oncert=e=>this.oncert&&this.oncert(e),this.client.onidle=()=>this._onIdle(),this.client.setHandler("capability",(e=>this._untaggedCapabilityHandler(e))),this.client.setHandler("ok",(e=>this._untaggedOkHandler(e))),this.client.setHandler("exists",(e=>this._untaggedExistsHandler(e))),this.client.setHandler("expunge",(e=>this._untaggedExpungeHandler(e))),this.client.setHandler("fetch",(e=>this._untaggedFetchHandler(e))),this.createLogger(),this.logLevel=d(0,"logLevel",n)}_onError(e){clearTimeout(this._idleTimeout),this.onerror&&this.onerror(e)}async connect(){try{await this.openConnection(),await this.upgradeConnection();try{await this.updateId(this._clientId)}catch(e){if("BAD"!==e.command)throw e;this.logger.warn("Failed to update server id!",e.message)}await this.login(this._auth),await this.compressConnection(),this.logger.debug("Connection established, ready to roll!"),this.client.onerror=this._onError.bind(this)}catch(e){throw this.logger.error("Could not connect to server",e),this.close(e),e}}openConnection(){return new Promise(((e,t)=>{const n=setTimeout((()=>t(new Error("Timeout connecting to server"))),this.timeoutConnection);this.logger.debug("Connecting to",this.client.host,":",this.client.port),this._changeState(1),this.client.connect().then((()=>{this.logger.debug("Socket opened, waiting for greeting from the server..."),this.client.onready=()=>{clearTimeout(n),this._changeState(2),this._okGreeting=this._humanReadable,this.updateCapability().then((()=>e(this._capability)))},this.client.onerror=e=>{clearTimeout(n),t(e)}})).catch(t)}))}async logout(){this._changeState(5),this.logger.debug("Logging out..."),await this.client.logout(),clearTimeout(this._idleTimeout)}async close(e){this._changeState(5),clearTimeout(this._idleTimeout),this.logger.debug("Closing connection..."),await this.client.close(e),clearTimeout(this._idleTimeout)}async updateId(e){if(this._capability.indexOf("ID")<0)return;this.logger.debug("Updating id...");const t=e?[g(Object.entries(e))]:[null],n=await this.exec({command:"ID",attributes:t},"ID"),a=g(l([],["payload","ID","0","attributes","0"],n).map(Object.values)),i=a.filter(((e,t)=>t%2==0)),s=a.filter(((e,t)=>t%2==1));this.serverId=m(w(i,s)),this.logger.debug("Server id updated!",this.serverId)}_shouldSelectMailbox(e,t){if(!t)return!0;const n=this.client.getPreviouslyQueued(["SELECT","EXAMINE"],t);if(n&&n.request.attributes){const t=n.request.attributes.find((e=>"STRING"===e.type));if(t)return t.value!==e}return this._selectedMailbox!==e}async selectMailbox(e,t={}){const n={command:t.readOnly?"EXAMINE":"SELECT",attributes:[{type:"STRING",value:e}]};t.condstore&&this._capability.indexOf("CONDSTORE")>=0&&n.attributes.push([{type:"ATOM",value:"CONDSTORE"}]),this.logger.debug("Opening",e,"...");const a=function(e){if(!e||!e.payload)return;const t={readOnly:"READ-ONLY"===e.code},n=e.payload.EXISTS&&e.payload.EXISTS.pop(),a=e.payload.FLAGS&&e.payload.FLAGS.pop(),i=e.payload.OK;return n&&(t.exists=n.nr||0),a&&a.attributes&&a.attributes.length&&(t.flags=a.attributes[0].map((e=>(e.value||"").toString().trim()))),[].concat(i||[]).forEach((e=>{switch(e&&e.code){case"PERMANENTFLAGS":t.permanentFlags=[].concat(e.permanentflags||[]);break;case"UIDVALIDITY":t.uidValidity=Number(e.uidvalidity)||0;break;case"UIDNEXT":t.uidNext=Number(e.uidnext)||0;break;case"HIGHESTMODSEQ":t.highestModseq=e.highestmodseq||"0";break;case"NOMODSEQ":t.noModseq=!0}})),t}(await this.exec(n,["EXISTS","FLAGS","OK"],{ctx:t.ctx}));return this._changeState(4),this._selectedMailbox!==e&&this.onclosemailbox&&await this.onclosemailbox(this._selectedMailbox),this._selectedMailbox=e,this.onselectmailbox&&await this.onselectmailbox(e,a),a}async subscribeMailbox(e){return this.logger.debug("Subscribing to mailbox",e,"..."),this.exec({command:"SUBSCRIBE",attributes:[e]})}async unsubscribeMailbox(e){return this.logger.debug("Unsubscribing to mailbox",e,"..."),this.exec({command:"UNSUBSCRIBE",attributes:[e]})}async listNamespaces(){if(this._capability.indexOf("NAMESPACE")<0)return!1;this.logger.debug("Listing namespaces...");return function(e){if(!e.payload||!e.payload.NAMESPACE||!e.payload.NAMESPACE.length)return!1;const t=[].concat(e.payload.NAMESPACE.pop().attributes||[]);return!!t.length&&{personal:Ue(t[0]),users:Ue(t[1]),shared:Ue(t[2])}}(await this.exec("NAMESPACE","NAMESPACE"))}async listMailboxes(){const e={root:!0,children:[]};this.logger.debug("Listing mailboxes...");const t=await this.exec({command:"LIST",attributes:["","*"]},"LIST");let n;if(l([],["payload","LIST"],t).forEach((t=>{const n=d([],"attributes",t);if(n.length<3)return;const a=l("",["2","value"],n),i=l("/",["1","value"],n),s=this._ensurePath(e,a,i);s.flags=d([],"0",n).map((({value:e})=>e||"")),s.listed=!0,kt(s)})),this._capability.indexOf("LIST-EXTENDED")>-1){const e=await this.exec({command:"LIST (SUBSCRIBED)",attributes:["","*"]},"LIST");n=l([],["payload","LIST"],e)}else{const e=await this.exec({command:"LSUB",attributes:["","*"]},"LSUB");n=l([],["payload","LSUB"],e)}return n.forEach((t=>{const n=d([],"attributes",t);if(n.length<3)return;const a=l("",["2","value"],n),i=l("/",["1","value"],n),s=this._ensurePath(e,a,i);d([],"0",n).map(((e="")=>{s.flags=ee(s.flags,[e])})),s.subscribed=!0})),e}async createMailbox(e){this.logger.debug("Creating mailbox",e,"...");try{await this.exec({command:"CREATE",attributes:[e]})}catch(e){if(e&&"ALREADYEXISTS"===e.code)return;throw e}}deleteMailbox(e){return this.logger.debug("Deleting mailbox",e,"..."),this.exec({command:"DELETE",attributes:[e]})}async listMessages(e,t,n=[{fast:!0}],a={}){this.logger.debug("Fetching messages",t,"from",e,"...");const i=function(e,t,n){const a={command:n.byUid?"UID FETCH":"FETCH",attributes:[{type:"SEQUENCE",value:e}]};void 0!==n.valueAsString&&(a.valueAsString=n.valueAsString);let i=[];return t.forEach((e=>{if(e=e.toUpperCase().trim(),/^\w+$/.test(e))i.push({type:"ATOM",value:e});else if(e)try{const t=We(Xe("* Z "+e));i=i.concat(t.attributes||[])}catch(t){i.push({type:"ATOM",value:e})}})),1===i.length&&(i=i.pop()),a.attributes.push(i),n.changedSince&&a.attributes.push([{type:"ATOM",value:"CHANGEDSINCE"},{type:"ATOM",value:n.changedSince}]),a}(t,n,a);return $e(await this.exec(i,"FETCH",{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}async search(e,t,n={}){this.logger.debug("Searching in",e,"...");const a=function(e={},t={}){const n={command:t.byUid?"UID SEARCH":"SEARCH"};let a=!0;const i=e=>{let t=[];return Object.keys(e).forEach((n=>{let s=[];const r=e=>{return"number"==typeof e?{type:"number",value:e}:"string"==typeof e?/[\u0080-\uFFFF]/.test(e)?(a=!1,{type:"literal",value:Ye((0,Pe.cv)(e))}):{type:"string",value:e}:"[object Date]"===Object.prototype.toString.call(e)?{type:"atom",value:(t=e,t.toUTCString().replace(/^\w+, 0?(\d+) (\w+) (\d+).*/,"$1-$2-$3"))}:Array.isArray(e)?e.map(r):"object"==typeof e?i(e):void 0;var t};s.push({type:"atom",value:n.toUpperCase()}),[].concat(e[n]||[]).forEach((e=>{switch(n.toLowerCase()){case"uid":e={type:"sequence",value:e};break;case"x-gm-thrid":case"x-gm-msgid":e={type:"number",value:e};break;default:e=r(e)}e&&(s=s.concat(e||[]))})),t=t.concat(s||[])})),t};return n.attributes=i(e),a||(n.attributes.unshift({type:"atom",value:"UTF-8"}),n.attributes.unshift({type:"atom",value:"CHARSET"})),n}(t,n);return function(e){const t=[];if(!e)throw new Error("parseSEARCH can not parse undefined response");return e.payload&&e.payload.SEARCH&&e.payload.SEARCH.length?(e.payload.SEARCH.forEach((e=>(e.attributes||[]).forEach((e=>{e=Number(e&&e.value||e)||0;const n=function(e,t,n=((e,t)=>e-t)){for(var a,i,s=0,r=e.length-1;s<=r;)if((i=+n(e[a=s+(r-s>>1)],t))<0)s=a+1;else{if(!(i>0))return a;r=a-1}return~s}(t,e);n<0&&t.splice(-n-1,0,e)})))),t):t}(await this.exec(a,"SEARCH",{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}setFlags(e,t,n,a){let i="",s=[];return Array.isArray(n)||"object"!=typeof n?(s=[].concat(n||[]),i=""):n.add?(s=[].concat(n.add||[]),i="+"):n.set?(i="",s=[].concat(n.set||[])):n.remove&&(i="-",s=[].concat(n.remove||[])),this.logger.debug("Setting flags on",t,"in",e,"..."),this.store(e,t,i+"FLAGS",s,a)}async store(e,t,n,a,i={}){const s=function(e,t="",n=[],a={}){const i={command:a.byUid?"UID STORE":"STORE",attributes:[{type:"sequence",value:e}]};return i.attributes.push({type:"atom",value:t.toUpperCase()+(a.silent?".SILENT":"")}),i.attributes.push(n.map((e=>({type:"atom",value:e})))),i}(t,n,a,i);return $e(await this.exec(s,"FETCH",{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}async upload(e,t,n={}){const a={command:"APPEND",attributes:[{type:"atom",value:e},d(["\\Seen"],"flags",n).map((e=>({type:"atom",value:e}))),{type:"literal",value:t}]};this.logger.debug("Uploading message to",e,"...");return function(e){return e&&e.appenduid&&e.appenduid[1]}(await this.exec(a))}async deleteMessages(e,t,n={}){this.logger.debug("Deleting messages",t,"in",e,"...");const a=n.byUid&&this._capability.indexOf("UIDPLUS")>=0,i={command:"UID EXPUNGE",attributes:[{type:"sequence",value:t}]};await this.setFlags(e,t,{add:"\\Deleted"},n);const s=a?i:"EXPUNGE";return this.exec(s,null,{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()})}async copyMessages(e,t,n,a={}){this.logger.debug("Copying messages",t,"from",e,"to",n,"...");return function(e){const t=e&&e.copyuid;if(t)return{srcSeqSet:t[1],destSeqSet:t[2]}}(await this.exec({command:a.byUid?"UID COPY":"COPY",attributes:[{type:"sequence",value:t},{type:"atom",value:n}]},null,{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()}))}async moveMessages(e,t,n,a={}){return this.logger.debug("Moving messages",t,"from",e,"to",n,"..."),-1===this._capability.indexOf("MOVE")?(await this.copyMessages(e,t,n,a),this.deleteMessages(e,t,a)):this.exec({command:a.byUid?"UID MOVE":"MOVE",attributes:[{type:"sequence",value:t},{type:"atom",value:n}]},["OK"],{precheck:t=>this._shouldSelectMailbox(e,t)?this.selectMailbox(e,{ctx:t}):Promise.resolve()})}async compressConnection(){if(!this._enableCompression||this._capability.indexOf("COMPRESS=DEFLATE")<0||this.client.compressed)return!1;this.logger.debug("Enabling compression..."),await this.exec({command:"COMPRESS",attributes:[{type:"ATOM",value:"DEFLATE"}]}),this.client.enableCompression(),this.logger.debug("Compression enabled, all data sent and received is deflated!")}async login(e){let t;const n={};if(!e)throw new Error("Authentication information not provided");this._capability.indexOf("AUTH=XOAUTH2")>=0&&e&&e.xoauth2?(t={command:"AUTHENTICATE",attributes:[{type:"ATOM",value:"XOAUTH2"},{type:"ATOM",value:Je(e.user,e.xoauth2),sensitive:!0}]},n.errorResponseExpectsEmptyLine=!0):t={command:"login",attributes:[{type:"STRING",value:e.user||""},{type:"STRING",value:e.pass||"",sensitive:!0}]},this.logger.debug("Logging in...");const a=await this.exec(t,"capability",n);a.capability&&a.capability.length?this._capability=a.capability:a.payload&&a.payload.CAPABILITY&&a.payload.CAPABILITY.length?this._capability=a.payload.CAPABILITY.pop().attributes.map(((e="")=>e.value.toUpperCase().trim())):await this.updateCapability(!0),this._changeState(3),this._authenticated=!0,this.logger.debug("Login successful, post-auth capabilites updated!",this._capability)}async exec(e,t,n){this.breakIdle();const a=await this.client.enqueueCommand(e,t,n);return a&&a.capability&&(this._capability=a.capability),a}enterIdle(){if(this._enteredIdle)return;const e=this._capability.indexOf("IDLE")>=0;this._enteredIdle=e&&this._selectedMailbox?"IDLE":"NOOP",this.logger.debug("Entering idle with "+this._enteredIdle),"NOOP"===this._enteredIdle?this._idleTimeout=setTimeout((()=>{this.logger.debug("Sending NOOP"),this.exec("NOOP").catch((e=>this.logger.error("Could not idle (NOOP)",e)))}),this.timeoutNoop):"IDLE"===this._enteredIdle&&(this.client.enqueueCommand({command:"IDLE"}).catch((e=>this.logger.error("Could not idle (IDLE)",e))),this._idleTimeout=setTimeout((()=>{this.client.send("DONE\r\n"),this._enteredIdle=!1,this.logger.debug("Idle terminated")}),this.timeoutIdle))}breakIdle(){this._enteredIdle&&(clearTimeout(this._idleTimeout),"IDLE"===this._enteredIdle&&(this.client.send("DONE\r\n"),this.logger.debug("Idle terminated")),this._enteredIdle=!1)}async upgradeConnection(){return!this.client.secureMode&&(!((this._capability.indexOf("STARTTLS")<0||this._ignoreTLS)&&!this._requireTLS)&&(this.logger.debug("Encrypting connection..."),await this.exec("STARTTLS"),this._capability=[],this.client.upgrade(),this.updateCapability()))}async updateCapability(e){if((e||!this._capability.length)&&(this.client.secureMode||!this._requireTLS))return this.logger.debug("Updating capability..."),this.exec("CAPABILITY")}hasCapability(e=""){return this._capability.indexOf(e.toUpperCase().trim())>=0}getOkGreeting(){return this._okGreeting}_untaggedOkHandler(e){e&&(e.capability&&(this._capability=e.capability),this._humanReadable=e.humanReadable)}_untaggedCapabilityHandler(e){this._capability=N(d([],"attributes"),de((({value:e})=>(e||"").toUpperCase().trim())))(e)}_untaggedExistsHandler(e){e&&Object.prototype.hasOwnProperty.call(e,"nr")&&this.onupdate&&this.onupdate(this._selectedMailbox,"exists",e.nr)}_untaggedExpungeHandler(e){e&&Object.prototype.hasOwnProperty.call(e,"nr")&&this.onupdate&&this.onupdate(this._selectedMailbox,"expunge",e.nr)}_untaggedFetchHandler(e){this.onupdate&&this.onupdate(this._selectedMailbox,"fetch",[].concat($e({payload:{FETCH:[e]}})||[]).shift())}_onIdle(){this._authenticated&&!this._enteredIdle&&(this.logger.debug("Client started idling"),this.enterIdle())}_changeState(e){e!==this._state&&(this.logger.debug("Entering state: "+e),4===this._state&&this._selectedMailbox&&(this.onclosemailbox&&this.onclosemailbox(this._selectedMailbox),this._selectedMailbox=!1),this._state=e)}_ensurePath(e,t,n){const a=t.split(n);let i=e;for(let e=0;e<a.length;e++){let t=!1;for(let n=0;n<i.children.length;n++)if(this._compareMailboxNames(i.children[n].name,(0,ue.kF)(a[e]))){i=i.children[n],t=!0;break}t||(i.children.push({name:(0,ue.kF)(a[e]),delimiter:n,path:a.slice(0,e+1).join(n),children:[]}),i=i.children[i.children.length-1])}return i}_compareMailboxNames(e,t){return("INBOX"===e.toUpperCase()?"INBOX":e)===("INBOX"===t.toUpperCase()?"INBOX":t)}createLogger(e=tt){const t=e((this._auth||{}).user||"",this._host);this.logger=this.client.logger={debug:(...e)=>{10>=this.logLevel&&t.debug(e)},info:(...e)=>{20>=this.logLevel&&t.info(e)},warn:(...e)=>{30>=this.logLevel&&t.warn(e)},error:(...e)=>{40>=this.logLevel&&t.error(e)}}}}},16932:(e,t,n)=>{"use strict";const a=n(78501),i=n(58844),s=n(41192);e.exports={XMLParser:i,XMLValidator:a,XMLBuilder:s}},17849:(e,t)=>{"use strict";const n=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",a="["+n+"][:A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*",i=new RegExp("^"+a+"$");t.isExist=function(e){return void 0!==e},t.isEmptyObject=function(e){return 0===Object.keys(e).length},t.merge=function(e,t,n){if(t){const a=Object.keys(t),i=a.length;for(let s=0;s<i;s++)e[a[s]]="strict"===n?[t[a[s]]]:t[a[s]]}},t.getValue=function(e){return t.isExist(e)?e:""},t.isName=function(e){const t=i.exec(e);return!(null==t)},t.getAllMatches=function(e,t){const n=[];let a=t.exec(e);for(;a;){const i=[];i.startIndex=t.lastIndex-a[0].length;const s=a.length;for(let e=0;e<s;e++)i.push(a[e]);n.push(i),a=t.exec(e)}return n},t.nameRegexp=a},78501:(e,t,n)=>{"use strict";const a=n(17849),i={allowBooleanAttributes:!1,unpairedTags:[]};function s(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function r(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const a=e.substr(n,t-n);if(t>5&&"xml"===a)return h("InvalidXml","XML declaration allowed only at the start of the document.",p(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function o(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}t.validate=function(e,t){t=Object.assign({},i,t);const n=[];let l=!1,f=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=r(e,i),i.err)return i}else{if("<"!==e[i]){if(s(e[i]))continue;return h("InvalidChar","char '"+e[i]+"' is not expected.",p(e,i))}{let m=i;if(i++,"!"===e[i]){i=o(e,i);continue}{let w=!1;"/"===e[i]&&(w=!0,i++);let _="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)_+=e[i];if(_=_.trim(),"/"===_[_.length-1]&&(_=_.substring(0,_.length-1),i--),g=_,!a.isName(g)){let t;return t=0===_.trim().length?"Invalid space after '<'.":"Tag '"+_+"' is an invalid name.",h("InvalidTag",t,p(e,i))}const b=c(e,i);if(!1===b)return h("InvalidAttr","Attributes for '"+_+"' have open quote.",p(e,i));let y=b.value;if(i=b.index,"/"===y[y.length-1]){const n=i-y.length;y=y.substring(0,y.length-1);const a=d(y,t);if(!0!==a)return h(a.err.code,a.err.msg,p(e,n+a.err.line));l=!0}else if(w){if(!b.tagClosed)return h("InvalidTag","Closing tag '"+_+"' doesn't have proper closing.",p(e,i));if(y.trim().length>0)return h("InvalidTag","Closing tag '"+_+"' can't have attributes or invalid starting.",p(e,m));{const t=n.pop();if(_!==t.tagName){let n=p(e,t.tagStartPos);return h("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+_+"'.",p(e,m))}0==n.length&&(f=!0)}}else{const a=d(y,t);if(!0!==a)return h(a.err.code,a.err.msg,p(e,i-y.length+a.err.line));if(!0===f)return h("InvalidXml","Multiple possible root nodes found.",p(e,i));-1!==t.unpairedTags.indexOf(_)||n.push({tagName:_,tagStartPos:m}),l=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=o(e,i);continue}if("?"!==e[i+1])break;if(i=r(e,++i),i.err)return i}else if("&"===e[i]){const t=u(e,i);if(-1==t)return h("InvalidChar","char '&' is not expected.",p(e,i));i=t}else if(!0===f&&!s(e[i]))return h("InvalidXml","Extra text at the end",p(e,i));"<"===e[i]&&i--}}}var g;return l?1==n.length?h("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",p(e,n[0].tagStartPos)):!(n.length>0)||h("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):h("InvalidXml","Start tag expected.",1)};function c(e,t){let n="",a="",i=!1;for(;t<e.length;t++){if('"'===e[t]||"'"===e[t])""===a?a=e[t]:a!==e[t]||(a="");else if(">"===e[t]&&""===a){i=!0;break}n+=e[t]}return""===a&&{value:n,index:t,tagClosed:i}}const l=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function d(e,t){const n=a.getAllMatches(e,l),i={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return h("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",g(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return h("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",g(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return h("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",g(n[e]));const a=n[e][2];if(!f(a))return h("InvalidAttr","Attribute '"+a+"' is an invalid name.",g(n[e]));if(i.hasOwnProperty(a))return h("InvalidAttr","Attribute '"+a+"' is repeated.",g(n[e]));i[a]=1}return!0}function u(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function h(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function f(e){return a.isName(e)}function p(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function g(e){return e.startIndex+e[1].length}},41192:(e,t,n)=>{"use strict";const a=n(82592),i={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function s(e){this.options=Object.assign({},i,e),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=c),this.processTextOrObjNode=r,this.options.format?(this.indentate=o,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function r(e,t,n){const a=this.j2x(e,n+1);return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,a.attrStr,n):this.buildObjectNode(a.val,t,a.attrStr,n)}function o(e){return this.options.indentBy.repeat(e)}function c(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}s.prototype.build=function(e){return this.options.preserveOrder?a(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0).val)},s.prototype.j2x=function(e,t){let n="",a="";for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i))if(void 0===e[i])this.isAttribute(i)&&(a+="");else if(null===e[i])this.isAttribute(i)?a+="":"?"===i[0]?a+=this.indentate(t)+"<"+i+"?"+this.tagEndChar:a+=this.indentate(t)+"<"+i+"/"+this.tagEndChar;else if(e[i]instanceof Date)a+=this.buildTextValNode(e[i],i,"",t);else if("object"!=typeof e[i]){const s=this.isAttribute(i);if(s)n+=this.buildAttrPairStr(s,""+e[i]);else if(i===this.options.textNodeName){let t=this.options.tagValueProcessor(i,""+e[i]);a+=this.replaceEntitiesValue(t)}else a+=this.buildTextValNode(e[i],i,"",t)}else if(Array.isArray(e[i])){const n=e[i].length;let s="";for(let r=0;r<n;r++){const n=e[i][r];void 0===n||(null===n?"?"===i[0]?a+=this.indentate(t)+"<"+i+"?"+this.tagEndChar:a+=this.indentate(t)+"<"+i+"/"+this.tagEndChar:"object"==typeof n?this.options.oneListGroup?s+=this.j2x(n,t+1).val:s+=this.processTextOrObjNode(n,i,t):s+=this.buildTextValNode(n,i,"",t))}this.options.oneListGroup&&(s=this.buildObjectNode(s,i,"",t)),a+=s}else if(this.options.attributesGroupName&&i===this.options.attributesGroupName){const t=Object.keys(e[i]),a=t.length;for(let s=0;s<a;s++)n+=this.buildAttrPairStr(t[s],""+e[i][t[s]])}else a+=this.processTextOrObjNode(e[i],i,t);return{attrStr:n,val:a}},s.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},s.prototype.buildObjectNode=function(e,t,n,a){if(""===e)return"?"===t[0]?this.indentate(a)+"<"+t+n+"?"+this.tagEndChar:this.indentate(a)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let i="</"+t+this.tagEndChar,s="";return"?"===t[0]&&(s="?",i=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===s.length?this.indentate(a)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(a)+"<"+t+n+s+this.tagEndChar+e+this.indentate(a)+i:this.indentate(a)+"<"+t+n+s+">"+e+i}},s.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},s.prototype.buildTextValNode=function(e,t,n,a){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(a)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(a)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(a)+"<"+t+n+"?"+this.tagEndChar;{let i=this.options.tagValueProcessor(t,e);return i=this.replaceEntitiesValue(i),""===i?this.indentate(a)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(a)+"<"+t+n+">"+i+"</"+t+this.tagEndChar}},s.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e},e.exports=s},82592:e=>{function t(e,r,o,c){let l="",d=!1;for(let u=0;u<e.length;u++){const h=e[u],f=n(h);if(void 0===f)continue;let p="";if(p=0===o.length?f:`${o}.${f}`,f===r.textNodeName){let e=h[f];i(p,r)||(e=r.tagValueProcessor(f,e),e=s(e,r)),d&&(l+=c),l+=e,d=!1;continue}if(f===r.cdataPropName){d&&(l+=c),l+=`<![CDATA[${h[f][0][r.textNodeName]}]]>`,d=!1;continue}if(f===r.commentPropName){l+=c+`\x3c!--${h[f][0][r.textNodeName]}--\x3e`,d=!0;continue}if("?"===f[0]){const e=a(h[":@"],r),t="?xml"===f?"":c;let n=h[f][0][r.textNodeName];n=0!==n.length?" "+n:"",l+=t+`<${f}${n}${e}?>`,d=!0;continue}let g=c;""!==g&&(g+=r.indentBy);const m=c+`<${f}${a(h[":@"],r)}`,w=t(h[f],r,p,g);-1!==r.unpairedTags.indexOf(f)?r.suppressUnpairedNode?l+=m+">":l+=m+"/>":w&&0!==w.length||!r.suppressEmptyNode?w&&w.endsWith(">")?l+=m+`>${w}${c}</${f}>`:(l+=m+">",w&&""!==c&&(w.includes("/>")||w.includes("</"))?l+=c+r.indentBy+w+c:l+=w,l+=`</${f}>`):l+=m+"/>",d=!0}return l}function n(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const a=t[n];if(e.hasOwnProperty(a)&&":@"!==a)return a}}function a(e,t){let n="";if(e&&!t.ignoreAttributes)for(let a in e){if(!e.hasOwnProperty(a))continue;let i=t.attributeValueProcessor(a,e[a]);i=s(i,t),!0===i&&t.suppressBooleanAttributes?n+=` ${a.substr(t.attributeNamePrefix.length)}`:n+=` ${a.substr(t.attributeNamePrefix.length)}="${i}"`}return n}function i(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let a in t.stopNodes)if(t.stopNodes[a]===e||t.stopNodes[a]==="*."+n)return!0;return!1}function s(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const a=t.entities[n];e=e.replace(a.regex,a.val)}return e}e.exports=function(e,n){let a="";return n.format&&n.indentBy.length>0&&(a="\n"),t(e,n,"",a)}},74780:(e,t,n)=>{const a=n(17849);function i(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const a=e[t++];let i="";for(;t<e.length&&e[t]!==a;t++)i+=e[t];return[n,i,t]}function s(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function r(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function o(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function c(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function l(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function d(e){if(a.isName(e))return e;throw new Error(`Invalid entity name ${e}`)}e.exports=function(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let a=1,u=!1,h=!1,f="";for(;t<e.length;t++)if("<"!==e[t]||h)if(">"===e[t]){if(h?"-"===e[t-1]&&"-"===e[t-2]&&(h=!1,a--):a--,0===a)break}else"["===e[t]?u=!0:f+=e[t];else{if(u&&r(e,t))t+=7,[entityName,val,t]=i(e,t+1),-1===val.indexOf("&")&&(n[d(entityName)]={regx:RegExp(`&${entityName};`,"g"),val});else if(u&&o(e,t))t+=8;else if(u&&c(e,t))t+=8;else if(u&&l(e,t))t+=9;else{if(!s)throw new Error("Invalid DOCTYPE");h=!0}a++,f=""}if(0!==a)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}},66745:(e,t)=>{const n={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};t.buildOptions=function(e){return Object.assign({},n,e)},t.defaultOptions=n},81078:(e,t,n)=>{"use strict";const a=n(17849),i=n(36311),s=n(74780),r=n(14153);function o(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const a=t[n];this.lastEntities[a]={regex:new RegExp("&"+a+";","g"),val:e[a]}}}function c(e,t,n,a,i,s,r){if(void 0!==e&&(this.options.trimValues&&!a&&(e=e.trim()),e.length>0)){r||(e=this.replaceEntitiesValue(e));const a=this.options.tagValueProcessor(t,e,n,i,s);if(null==a)return e;if(typeof a!=typeof e||a!==e)return a;if(this.options.trimValues)return y(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?y(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function l(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const d=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function u(e,t,n){if(!this.options.ignoreAttributes&&"string"==typeof e){const n=a.getAllMatches(e,d),i=n.length,s={};for(let e=0;e<i;e++){const a=this.resolveNameSpace(n[e][1]);let i=n[e][4],r=this.options.attributeNamePrefix+a;if(a.length)if(this.options.transformAttributeName&&(r=this.options.transformAttributeName(r)),"__proto__"===r&&(r="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(a,i,t);s[r]=null==e?i:typeof e!=typeof i||e!==i?e:y(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(s[r]=!0)}if(!Object.keys(s).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=s,e}return s}}const h=function(e){e=e.replace(/\r\n?/g,"\n");const t=new i("!xml");let n=t,a="",r="";for(let o=0;o<e.length;o++){if("<"===e[o])if("/"===e[o+1]){const t=w(e,">",o,"Closing Tag is not closed.");let i=e.substring(o+2,t).trim();if(this.options.removeNSPrefix){const e=i.indexOf(":");-1!==e&&(i=i.substr(e+1))}this.options.transformTagName&&(i=this.options.transformTagName(i)),n&&(a=this.saveTextToParentTag(a,n,r));const s=r.substring(r.lastIndexOf(".")+1);if(i&&-1!==this.options.unpairedTags.indexOf(i))throw new Error(`Unpaired tag can not be used as closing tag: </${i}>`);let c=0;s&&-1!==this.options.unpairedTags.indexOf(s)?(c=r.lastIndexOf(".",r.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=r.lastIndexOf("."),r=r.substring(0,c),n=this.tagsNodeStack.pop(),a="",o=t}else if("?"===e[o+1]){let t=_(e,o,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(a=this.saveTextToParentTag(a,n,r),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new i(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,r,t.tagName)),this.addChild(n,e,r)}o=t.closeIndex+1}else if("!--"===e.substr(o+1,3)){const t=w(e,"--\x3e",o+4,"Comment is not closed.");if(this.options.commentPropName){const i=e.substring(o+4,t-2);a=this.saveTextToParentTag(a,n,r),n.add(this.options.commentPropName,[{[this.options.textNodeName]:i}])}o=t}else if("!D"===e.substr(o+1,2)){const t=s(e,o);this.docTypeEntities=t.entities,o=t.i}else if("!["===e.substr(o+1,2)){const t=w(e,"]]>",o,"CDATA is not closed.")-2,i=e.substring(o+9,t);a=this.saveTextToParentTag(a,n,r);let s=this.parseTextData(i,n.tagname,r,!0,!1,!0,!0);null==s&&(s=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:i}]):n.add(this.options.textNodeName,s),o=t+2}else{let s=_(e,o,this.options.removeNSPrefix),c=s.tagName;const l=s.rawTagName;let d=s.tagExp,u=s.attrExpPresent,h=s.closeIndex;this.options.transformTagName&&(c=this.options.transformTagName(c)),n&&a&&"!xml"!==n.tagname&&(a=this.saveTextToParentTag(a,n,r,!1));const f=n;if(f&&-1!==this.options.unpairedTags.indexOf(f.tagname)&&(n=this.tagsNodeStack.pop(),r=r.substring(0,r.lastIndexOf("."))),c!==t.tagname&&(r+=r?"."+c:c),this.isItStopNode(this.options.stopNodes,r,c)){let t="";if(d.length>0&&d.lastIndexOf("/")===d.length-1)o=s.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(c))o=s.closeIndex;else{const n=this.readStopNodeData(e,l,h+1);if(!n)throw new Error(`Unexpected end of ${l}`);o=n.i,t=n.tagContent}const a=new i(c);c!==d&&u&&(a[":@"]=this.buildAttributesMap(d,r,c)),t&&(t=this.parseTextData(t,c,r,!0,u,!0,!0)),r=r.substr(0,r.lastIndexOf(".")),a.add(this.options.textNodeName,t),this.addChild(n,a,r)}else{if(d.length>0&&d.lastIndexOf("/")===d.length-1){"/"===c[c.length-1]?(c=c.substr(0,c.length-1),r=r.substr(0,r.length-1),d=c):d=d.substr(0,d.length-1),this.options.transformTagName&&(c=this.options.transformTagName(c));const e=new i(c);c!==d&&u&&(e[":@"]=this.buildAttributesMap(d,r,c)),this.addChild(n,e,r),r=r.substr(0,r.lastIndexOf("."))}else{const e=new i(c);this.tagsNodeStack.push(n),c!==d&&u&&(e[":@"]=this.buildAttributesMap(d,r,c)),this.addChild(n,e,r),n=e}a="",o=h}}else a+=e[o]}return t.child};function f(e,t,n){const a=this.options.updateTag(t.tagname,n,t[":@"]);!1===a||("string"==typeof a?(t.tagname=a,e.addChild(t)):e.addChild(t))}const p=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function g(e,t,n,a){return e&&(void 0===a&&(a=0===Object.keys(t.child).length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,a))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function m(e,t,n){const a="*."+n;for(const n in e){const i=e[n];if(a===i||t===i)return!0}return!1}function w(e,t,n,a){const i=e.indexOf(t,n);if(-1===i)throw new Error(a);return i+t.length-1}function _(e,t,n,a=">"){const i=function(e,t,n=">"){let a,i="";for(let s=t;s<e.length;s++){let t=e[s];if(a)t===a&&(a="");else if('"'===t||"'"===t)a=t;else if(t===n[0]){if(!n[1])return{data:i,index:s};if(e[s+1]===n[1])return{data:i,index:s}}else"\t"===t&&(t=" ");i+=t}}(e,t+1,a);if(!i)return;let s=i.data;const r=i.index,o=s.search(/\s/);let c=s,l=!0;-1!==o&&(c=s.substring(0,o),s=s.substring(o+1).trimStart());const d=c;if(n){const e=c.indexOf(":");-1!==e&&(c=c.substr(e+1),l=c!==i.data.substr(e+1))}return{tagName:c,tagExp:s,closeIndex:r,attrExpPresent:l,rawTagName:d}}function b(e,t,n){const a=n;let i=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const s=w(e,">",n,`${t} is not closed`);if(e.substring(n+2,s).trim()===t&&(i--,0===i))return{tagContent:e.substring(a,n),i:s};n=s}else if("?"===e[n+1]){n=w(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=w(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=w(e,"]]>",n,"StopNode is not closed.")-2}else{const a=_(e,n,">");if(a){(a&&a.tagName)===t&&"/"!==a.tagExp[a.tagExp.length-1]&&i++,n=a.closeIndex}}}function y(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&r(e,n)}return a.isExist(e)?e:""}e.exports=class{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"}},this.addExternalEntities=o,this.parseXml=h,this.parseTextData=c,this.resolveNameSpace=l,this.buildAttributesMap=u,this.isItStopNode=m,this.replaceEntitiesValue=p,this.readStopNodeData=b,this.saveTextToParentTag=g,this.addChild=f}}},58844:(e,t,n)=>{const{buildOptions:a}=n(66745),i=n(81078),{prettify:s}=n(16997),r=n(78501);e.exports=class{constructor(e){this.externalEntities={},this.options=a(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=r.validate(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new i(this.options);n.addExternalEntities(this.externalEntities);const a=n.parseXml(e);return this.options.preserveOrder||void 0===a?a:s(a,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}}},16997:(e,t)=>{"use strict";function n(e,t,r){let o;const c={};for(let l=0;l<e.length;l++){const d=e[l],u=a(d);let h="";if(h=void 0===r?u:r+"."+u,u===t.textNodeName)void 0===o?o=d[u]:o+=""+d[u];else{if(void 0===u)continue;if(d[u]){let e=n(d[u],t,h);const a=s(e,t);d[":@"]?i(e,d[":@"],h,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==c[u]&&c.hasOwnProperty(u)?(Array.isArray(c[u])||(c[u]=[c[u]]),c[u].push(e)):t.isArray(u,h,a)?c[u]=[e]:c[u]=e}}}return"string"==typeof o?o.length>0&&(c[t.textNodeName]=o):void 0!==o&&(c[t.textNodeName]=o),c}function a(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function i(e,t,n,a){if(t){const i=Object.keys(t),s=i.length;for(let r=0;r<s;r++){const s=i[r];a.isArray(s,n+"."+s,!0,!0)?e[s]=[t[s]]:e[s]=t[s]}}}function s(e,t){const{textNodeName:n}=t,a=Object.keys(e).length;return 0===a||!(1!==a||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}t.prettify=function(e,t){return n(e,t)}},36311:e=>{"use strict";e.exports=class{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}},72315:(e,t,n)=>{!function(t){"use strict";e.exports=t(n(9673).ZP,n(84846).Z)}((function(e,t){"use strict";let n;const a={debug:()=>{},info:()=>{},error:()=>{}};var i=function(t,i){var s=this;if(n=t.logger||a,s._loggedIn=!1,s._loggingIn=!1,s._shouldLogOut=!1,i)s._client=i;else{var r={useSecureTransport:t.secure,ignoreTLS:t.ignoreTLS,requireTLS:t.requireTLS,auth:t.auth,ca:t.ca,tlsWorkerPath:t.tlsWorkerPath,enableCompression:!0,compressionWorkerPath:t.compressionWorkerPath,id:t.id};s._client=new e(t.host,t.port,r)}s._client.oncert=function(e){s.onCert(e)},s.mailboxCache={},s._registerEventHandlers(s._client)};function s(e){return e.childNodes?e.childNodes.some((e=>s(e))):/^text\/html/i.test(e.type)}function r(e,t,n){if(e.size&&(t.size+=e.size),e.childNodes)e.childNodes.forEach((function(e){r(e,t,n)}));else{n&&e.id&&e.disposition?.startsWith("inline")||!e.disposition?.startsWith("attachment")&&/^text\/(plain|html)/i.test(e.type)||(t.attachment+=1)}}function o(e,t){return e-t}return i.prototype._registerEventHandlers=function(e){e.onselectmailbox=this._onSelectMailbox.bind(this,e),e.onupdate=this._onUpdate.bind(this,e),e.onerror=this._onError.bind(this,e)},i.prototype._onError=function(e,t){var a="IMAP connection encountered an error! "+t;e===this._client&&(this._loggedIn=!1,n.error((()=>[new Error(a)])),this.onError(new Error(a)))},i.prototype._onSelectMailbox=function(e,t,a){var i,s=this;if(s.onSyncUpdate){if(n.debug((()=>["selected mailbox "+t])),s.mailboxCache[t]||(n.debug((()=>["populating cache object for mailbox "+t])),s.mailboxCache[t]={exists:0,uidNext:0,uidlist:[],highestModseq:"0"}),(i=s.mailboxCache[t]).noModseq=a.noModseq||!1,i.exists!==a.exists||i.uidNext!==a.uidNext){n.debug((()=>["possible updates available in "+t+". exists: "+a.exists+", uidNext: "+a.uidNext]));var r=0===i.exists;return i.exists=a.exists,i.uidNext=a.uidNext,s.search({path:t,client:e}).then((function(c){i.uidlist=i.uidlist||[];var l=0;for(var d of c){if(d<l){n.debug((()=>["imapUidList not sorted"])),c.sort(o);break}l=d}var u=function(e,t){var n=0,a=0,i=[],s=[];for(;n<e.length&&a<t.length;)e[n]<t[a]?(i.push(e[n]),n++):e[n]>t[a]?(s.push(t[a]),a++):(n++,a++);n===e.length?s=s.concat(t.slice(a)):a===t.length&&(i=i.concat(e.slice(n)));return[i,s]}(i.uidlist,c),h=u[0],f=u[1];return i.uidlist=c,Promise.resolve().then((function(){if(h.length)return n.debug((()=>["onSyncUpdate for deleted uids in "+t+": "+h])),s.onSyncUpdate({type:"deleted",path:t,list:h})})).then((function(){if(f.length)return n.debug((()=>["onSyncUpdate for new uids in "+t+": "+f])),s.onSyncUpdate({type:"new",path:t,list:f})})).then((function(){if(!r)return n.debug((()=>["no changes in message count in "+t+". exists: "+a.exists+", uidNext: "+a.uidNext])),s._checkFlags({path:t,highestModseq:a.highestModseq,noModseq:a.noModseq,client:e}).catch((function(e){n.error((()=>["error checking modseq: "+e+"\n"+e.stack]))}))}))}))}return n.debug((()=>["no changes in message count in "+t+". exists: "+a.exists+", uidNext: "+a.uidNext])),s._checkFlags({path:t,highestModseq:a.highestModseq,noModseq:a.noModseq,client:e}).catch((function(e){n.error((()=>["error checking modseq: "+e+"\n"+e.stack]))}))}},i.prototype._onUpdate=function(e,t,a,i){var s=this,r=s.mailboxCache[t];if(s.onSyncUpdate&&r)if("expunge"===a){n.debug((()=>["expunge notice received for "+t+" with sequence number: "+i]));var c=r.uidlist[i-1];r.uidlist.splice(i-1,1),c&&(n.debug((()=>["deleted uid in "+t+": "+c])),s.onSyncUpdate({type:"deleted",path:t,list:[c]}))}else"exists"===a?(n.debug((()=>["exists notice received for "+t+", checking for updates"])),r.exists=i,s.search({path:t,uid:r.uidNext+":*",client:e}).then((function(e){!e.length||1===e.length&&r.uidlist.indexOf(e[0])>=0||(e.sort(o),n.debug((()=>["new uids in "+t+": "+e])),r.uidlist=r.uidlist.concat(e),r.uidNext=r.uidlist[r.uidlist.length-1]+1,n.debug((()=>["new uids in "+t+": "+e])),s.onSyncUpdate({type:"new",path:t,list:e}))})).catch((function(e){n.error((()=>["error handling exists notice: "+e+"\n"+e.stack]))}))):"fetch"===a&&(n.debug((()=>["fetch notice received for "+t])),s.onSyncUpdate({type:"messages",path:t,list:[i].map((function(e){return!e.uid&&r.uidlist&&(e.uid=r.uidlist[e["#"]-1]),e}))}))},i.prototype._checkFlags=function(e){var t=this,a=e.highestModseq,i=e.noModseq,s=e.client||t._client,r=e.path;if(i)return n.info((()=>["can not check MODSEQ, mailbox has NOMODSEQ directive"])),new Promise((function(e){e([])}));if(!s.hasCapability("CONDSTORE")||!a||!r)return n.info((()=>["can not check MODSEQ, server does not support CONDSTORE extension"])),new Promise((function(e){e([])}));var o=t.mailboxCache[r];if(!o||!o.highestModseq||o.highestModseq===a)return new Promise((function(e){e([])}));var c=o.uidNext>1?o.uidNext-1:1;return n.debug((()=>["listing changes since MODSEQ "+a+" for "+r])),s.listMessages(r,"1:"+c,["uid","flags","modseq"],{byUid:!0,changedSince:o.highestModseq}).then((function(e){return o.highestModseq=a,e&&e.length?(n.debug((()=>["changes since MODSEQ "+a+" for "+r+" available!"])),t.onSyncUpdate({type:"messages",path:r,list:e})):[]})).catch((function(e){n.error((()=>["error handling exists notice: "+e+"\n"+e.stack]))}))},i.prototype.onSyncUpdate=!1,i.prototype.login=function(){var e=this;return e._loggedIn||e._loggingIn?(n.debug((()=>["refusing login while logged/logging in!"])),Promise.resolve()):(e._loggingIn=!0,e._client.connect().then((function(){if(n.debug((()=>["login completed, ready to roll!"])),e._loggedIn=!0,e._shouldLogOut)return e.logout()})).finally((function(){e._loggingIn=!1})))},i.prototype.logout=function(){var e=this;return e._loggingIn?(n.debug((()=>["currently logging in, will log right back out!"])),e._shouldLogOut=!0,Promise.resolve()):e._loggedIn?(e._loggedIn=!1,e._shouldLogOut=!1,e._client.close().then((function(){n.debug((()=>["logout completed, kthxbye!"]))}))):(n.debug((()=>["refusing logout while already logged out!"])),Promise.resolve())},i.prototype.selectMailbox=function(e){return n.debug((()=>["selecting mailbox "+e.path])),this._client.selectMailbox(e.path)},i.prototype.subscribeMailbox=function(e){return n.debug((()=>["subscribing to mailbox "+e.path])),this._client.subscribeMailbox(e.path)},i.prototype.unsubscribeMailbox=function(e){return n.debug((()=>["unsubscribing to mailbox "+e.path])),this._client.unsubscribeMailbox(e.path)},i.prototype.listWellKnownFolders=function(){var e=this,t={Inbox:[],Drafts:[],All:[],Flagged:[],Sent:[],Trash:[],Junk:[],Archive:[],Other:[]};n.debug((()=>["listing folders"]));var a=[];return e._checkOnline().then((function(){return e._client.listMailboxes()})).then((function(e){return a=e.children?.filter((e=>!!e.specialUseFlag)).map((e=>e.specialUseFlag)),n.debug((()=>["folder list received!"])),s(e),t})).catch((function(e){throw n.error((()=>["error listing folders: "+e+"\n"+e.stack])),e}));function i(e){return e.specialUseFlag||e.specialUse&&!a.includes(e.specialUse)}function s(a){if(a.path&&-1===(a.flags||[]).indexOf("\\Noselect")){n.debug((()=>["name: "+a.name+", path: "+a.path+(a.flags?", flags: "+a.flags:"")+(a.specialUse?", special use: "+a.specialUse:"")]));var r={name:a.name||a.path,path:a.path,subscribed:a.subscribed,delimiter:a.delimiter};"INBOX"===r.name.toUpperCase()?(r.type="Inbox",e._delimiter=a.delimiter,t.Inbox.push(r)):"\\Drafts"===a.specialUse&&i(a)?(r.type="Drafts",t.Drafts.push(r)):"\\All"===a.specialUse&&i(a)?(r.type="All",t.All.push(r)):"\\Flagged"===a.specialUse&&i(a)?(r.type="Flagged",t.Flagged.push(r)):"\\Sent"===a.specialUse&&i(a)?(r.type="Sent",t.Sent.push(r)):"\\Trash"===a.specialUse&&i(a)?(r.type="Trash",t.Trash.push(r)):"\\Junk"===a.specialUse&&i(a)?(r.type="Junk",t.Junk.push(r)):"\\Archive"===a.specialUse&&i(a)?(r.type="Archive",t.Archive.push(r)):(r.type="Other",t.Other.push(r))}a.children&&a.children.forEach(s)}},i.prototype.deleteFolder=function(e){var t=this;return t._checkOnline().then((function(){return t._client.deleteMailbox(e.path)})).catch((function(t){throw n.error((()=>["error deleting folder"+e.path+": "+t+"\n"+t.stack])),t}))},i.prototype.createFolder=function(e){var t,a=this,i=e.path;return Array.isArray(i)||(i=[i]),a._checkOnline().then((function(){if(void 0===a._delimiter||void 0===a._prefix)return a._client.listNamespaces().then((function(e){return e&&e.personal&&e.personal[0]?(a._delimiter=e.personal[0].delimiter,void(a._prefix=e.personal[0].prefix.split(a._delimiter).shift())):(a._prefix="",a._delimiter?void 0:a._client.listMailboxes().then((function(e){s(e)})))}))})).then((function(){if(!a._delimiter)throw new Error("Could not determine delimiter for mailbox hierarchy");return a._prefix&&i.unshift(a._prefix),t=i.join(a._delimiter),a._client.createMailbox(t)})).then((function(){return t})).catch((function(t){throw n.error((()=>["error creating folder "+e.path+": "+t+"\n"+t.stack])),t}));function s(e){"INBOX"!==(e.path||"").toUpperCase()?e.children&&e.children.forEach(s):a._delimiter=e.delimiter}},i.prototype.search=function(e){var t=e.client||this._client,a={},i={byUid:!0};return a.all=!0,!0===e.unread?a.unseen=!0:!1===e.unread&&(a.seen=!0),!0===e.answered?a.answered=!0:!1===e.answered&&(a.unanswered=!0),e.header&&(a.header=e.header),e.uid&&(a.uid=e.uid),n.debug((()=>["searching in "+e.path+" for "+Object.keys(a).join(",")])),this._checkOnline().then((function(){return t.search(e.path,a,i)})).then((function(t){return n.debug((()=>["searched in "+e.path+" for "+Object.keys(a).join(",")+" ("+t.length+" uids)"])),t})).catch((function(t){throw n.error((()=>["error searching "+e.path+": "+t+"\n"+t.stack])),t}))},i.prototype.listMessages=function(e){var t,a=this,i=["uid","bodystructure","flags","envelope","body.peek[header.fields (references list-id x-microsoft-original-message-id from list-post)]"],o={byUid:!0};this._client.hasCapability("X-GM-EXT-1")&&i.push("x-gm-msgid"),this._client.hasCapability("PREVIEW")&&i.push("preview"),t=e.uids?e.uids.join(","):e.sequence?e.sequence:(e.firstUid||1)+":"+(e.lastUid||"*");let c=a.mailboxCache[e.path];const l=c&&c.noModseq;return this._client.hasCapability("CONDSTORE")&&!l&&i.push("modseq"),n.debug((()=>["listing messages in "+e.path+" for interval "+t])),a._checkOnline().then((function(){return a._client.listMessages(e.path,t,i,o)})).then((function(e){var t=[];return e.forEach((function(e){if(!e.envelope||!e.uid)return void n.debug((()=>["message is malformed: "+JSON.stringify(e)]));var i=e["body[header.fields (references list-id x-microsoft-original-message-id from list-post)]"];i&&(i=i.replace(/\r?\n([ \t])/g,"$1"));var o=/References:\s*((?:<\S+>\s*)+)/.exec(i),c=/list-id *: *(.*(?:\r?\n[\t ].+)*)/i.exec(i),l=/list-post *: *(.*(?:\r?\n[\t ].+)*)/i.exec(i),d=/X-Microsoft-Original-Message-ID:\s*\S*\s<(\S+)>/.exec(i);const u=e.envelope.from||[];a._addFromHeaderAddresses(u,i);var h=Date.now(),f=Date.parse(e.envelope.date)||h;f>h&&(f=h);let p="";Array.isArray(e.preview)?p=e.preview[1].value:"string"==typeof e.preview?p=e.preview:e.preview&&n.debug("Message preview of unexpected type:",e.preview,typeof e.preview);var g={uid:e.uid,messageId:(e.envelope["message-id"]||"").replace(/[<>]/g,"").trim(),originalMessageId:d?d[1]:"",listId:c?c[1]:"",listPost:l?l[1]:"",gmailId:e["x-gm-msgid"]||"",from:u,replyTo:e.envelope["reply-to"]||[],to:e.envelope.to||[],cc:e.envelope.cc||[],bcc:e.envelope.bcc||[],modseq:e.modseq||"0",subject:e.envelope.subject||"(no subject)",preview:p,inReplyTo:(e.envelope["in-reply-to"]||"").replace(/[<>]/g,"").trim(),references:o?o[1].split(/\s+/).filter((function(e){return""!==e})).map((function(e){return e.replace(/[<>]/g,"")})):[],sentDate:f,flags:e.flags||[],attachment:0,size:0};const m=e.bodystructure||{};r(m,g,s(m)),n.debug((()=>["listing message: [uid: "+g.uid+"]"])),t.push(g)})),t})).catch((function(t){throw n.error((()=>["error listing messages in "+e.path+": "+t+"\n"+t.stack])),t}))},i.prototype.getMessages=function(e){var t=this,a=["body.peek[]"],i={byUid:!0,valueAsString:!1},s=e.uids.join(",");return n.debug((()=>["retrieving body parts for uid(s) "+s+" in folder "+e.path+": "+a])),t._checkOnline().then((function(){return t._client.listMessages(e.path,s,a,i)})).then((function(e){const t={};return e.forEach((function(e){t[e.uid]=e["body[]"]})),t})).catch((function(t){throw n.error((()=>["error fetching message for uid(s) "+s+" in folder "+e.path+": "+t+"\n"+t.stack])),t}))},i.prototype.updateFlags=function(e){const t=e.uids.sort(o);let a=t[0],i=[];function s(e){e===a?i.push(a):i.push(a+":"+e)}for(let e=1;e<t.length;e++)t[e]-t[e-1]!=1&&(s(t[e-1]),a=t[e]);s(t[t.length-1]);const r=i.join(",");var c=this,l={byUid:!0},d=e.add||[],u=e.remove||[];return n.debug((()=>["updating flags for uids "+r+" in folder "+e.path+": "+(u.length>0?" removing "+u:"")+(d.length>0?" adding "+d:"")])),c._checkOnline().then((function(){if(d.length>0)return c._client.setFlags(e.path,r,{add:d},l)})).then((function(){if(u.length>0)return c._client.setFlags(e.path,r,{remove:u},l)})).then((function(){n.debug((()=>["successfully updated flags for uids "+r+" in folder "+e.path+": added "+d+" and removed "+u]))})).catch((function(t){throw n.error((()=>["error updating flags for uids "+r+" in folder "+e.path+" : "+t+"\n"+t.stack])),t}))},i.prototype.copyMessages=function(e){var t=this;return n.debug((()=>["copying uids "+e.uids+" from "+e.path+" to "+e.destination])),t._checkOnline().then((function(){var n=e.uids.join(",");return t._client.copyMessages(e.path,n,e.destination,{byUid:!0})})).then((function(t){return n.debug((()=>["successfully copied uids "+e.uids+" from "+e.path+" to "+e.destination])),t})).catch((function(t){throw n.error((()=>["error copying uids "+e.uids+" from "+e.path+" to "+e.destination+" : "+t+"\n"+t.stack])),t}))},i.prototype.moveMessages=function(e){var t=this;return n.debug((()=>["moving uids "+e.uids+" from "+e.path+" to "+e.destination])),t._checkOnline().then((function(){var n=e.uids.join(",");return t._client.moveMessages(e.path,n,e.destination,{byUid:!0})})).then((function(){n.debug((()=>["successfully moved uids "+e.uids+" from "+e.path+" to "+e.destination]))})).catch((function(t){throw n.error((()=>["error moving uids "+e.uids+" from "+e.path+" to "+e.destination+" : "+t+"\n"+t.stack])),t}))},i.prototype.uploadMessage=function(e){var t=this,a=e.message instanceof Uint8Array?function(e){const t=10240,n=[];for(var a=0;a<e.length;a+=t){const i=a,s=Math.min(a+t,e.length);n.push(String.fromCharCode.apply(null,e.subarray(i,s)))}return n.join("")}(e.message):e.message,i=Array.isArray(e.flags)&&e.flags.length>0?{flags:e.flags}:{};return n.debug((()=>["uploading a message of "+a.length+" bytes to "+e.path])),t._checkOnline().then((function(){return t._client.upload(e.path,a,i)})).then((function(t){return n.debug((()=>["successfully uploaded message to "+e.path])),t})).catch((function(t){throw n.error((()=>["error uploading <"+a.length+"> bytes to "+e.path+" : "+t+"\n"+t.stack])),t}))},i.prototype.deleteMessages=function(e){var t=this;return n.debug((()=>["deleting uid "+e.uid+" from "+e.path])),t._checkOnline().then((function(){var n=e.uids.join(",");return t._client.deleteMessages(e.path,n,{byUid:!0})})).then((function(){n.debug((()=>["successfully deleted uid "+e.uid+" from "+e.path]))})).catch((function(t){throw n.error((()=>["error deleting uid "+e.uid+" from "+e.path+" : "+t+"\n"+t.stack])),t}))},i.prototype._addFromHeaderAddresses=function(e,n){if(n)for(const a of n.matchAll(/from\s*:\s*([^\n\r]+)/gi))if(a.length>1&&a[1]){const n=t(a[1])||[];for(const t of n){const n=e.find((e=>e.address===t.address));n?n.name||(n.name=t.name):e.push(t)}}},i.prototype._checkOnline=function(){var e=this;return new Promise((function(t){if(!e._loggedIn)throw new Error("Not logged in!");t()}))},i}))},24236:(e,t)=>{"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function a(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var i in n)a(n,i)&&(e[i]=n[i])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var i={arraySet:function(e,t,n,a,i){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+a),i);else for(var s=0;s<a;s++)e[i+s]=t[n+s]},flattenChunks:function(e){var t,n,a,i,s,r;for(a=0,t=0,n=e.length;t<n;t++)a+=e[t].length;for(r=new Uint8Array(a),i=0,t=0,n=e.length;t<n;t++)s=e[t],r.set(s,i),i+=s.length;return r}},s={arraySet:function(e,t,n,a,i){for(var s=0;s<a;s++)e[i+s]=t[n+s]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,i)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,s))},t.setTyped(n)},66069:e=>{"use strict";e.exports=function(e,t,n,a){for(var i=65535&e|0,s=e>>>16&65535|0,r=0;0!==n;){n-=r=n>2e3?2e3:n;do{s=s+(i=i+t[a++]|0)|0}while(--r);i%=65521,s%=65521}return i|s<<16|0}},71619:e=>{"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},2869:e=>{"use strict";var t=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var a=0;a<8;a++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();e.exports=function(e,n,a,i){var s=t,r=i+a;e^=-1;for(var o=i;o<r;o++)e=e>>>8^s[255&(e^n[o])];return-1^e}},30405:(e,t,n)=>{"use strict";var a,i=n(24236),s=n(10342),r=n(66069),o=n(2869),c=n(48898),l=-2,d=258,u=262,h=103,f=113,p=666;function g(e,t){return e.msg=c[t],t}function m(e){return(e<<1)-(e>4?9:0)}function w(e){for(var t=e.length;--t>=0;)e[t]=0}function _(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(i.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function b(e,t){s._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,_(e.strm)}function y(e,t){e.pending_buf[e.pending++]=t}function v(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function I(e,t){var n,a,i=e.max_chain_length,s=e.strstart,r=e.prev_length,o=e.nice_match,c=e.strstart>e.w_size-u?e.strstart-(e.w_size-u):0,l=e.window,h=e.w_mask,f=e.prev,p=e.strstart+d,g=l[s+r-1],m=l[s+r];e.prev_length>=e.good_match&&(i>>=2),o>e.lookahead&&(o=e.lookahead);do{if(l[(n=t)+r]===m&&l[n+r-1]===g&&l[n]===l[s]&&l[++n]===l[s+1]){s+=2,n++;do{}while(l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&l[++s]===l[++n]&&s<p);if(a=d-(p-s),s=p-d,a>r){if(e.match_start=t,r=a,a>=o)break;g=l[s+r-1],m=l[s+r]}}}while((t=f[t&h])>c&&0!=--i);return r<=e.lookahead?r:e.lookahead}function E(e){var t,n,a,s,c,l,d,h,f,p,g=e.w_size;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=g+(g-u)){i.arraySet(e.window,e.window,g,g,0),e.match_start-=g,e.strstart-=g,e.block_start-=g,t=n=e.hash_size;do{a=e.head[--t],e.head[t]=a>=g?a-g:0}while(--n);t=n=g;do{a=e.prev[--t],e.prev[t]=a>=g?a-g:0}while(--n);s+=g}if(0===e.strm.avail_in)break;if(l=e.strm,d=e.window,h=e.strstart+e.lookahead,f=s,p=void 0,(p=l.avail_in)>f&&(p=f),n=0===p?0:(l.avail_in-=p,i.arraySet(d,l.input,l.next_in,p,h),1===l.state.wrap?l.adler=r(l.adler,d,p,h):2===l.state.wrap&&(l.adler=o(l.adler,d,p,h)),l.next_in+=p,l.total_in+=p,p),e.lookahead+=n,e.lookahead+e.insert>=3)for(c=e.strstart-e.insert,e.ins_h=e.window[c],e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+3-1])&e.hash_mask,e.prev[c&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=c,c++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<u&&0!==e.strm.avail_in)}function k(e,t){for(var n,a;;){if(e.lookahead<u){if(E(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n)),e.match_length>=3)if(a=s._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else a=s._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(a&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function x(e,t){for(var n,a,i;;){if(e.lookahead<u){if(E(e),e.lookahead<u&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-u&&(e.match_length=I(e,n),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-3,a=s._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=i&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,a&&(b(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((a=s._tr_tally(e,0,e.window[e.strstart-1]))&&b(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(a=s._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}function A(e,t,n,a,i){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=a,this.func=i}function S(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(1146),this.dyn_dtree=new i.Buf16(122),this.bl_tree=new i.Buf16(78),w(this.dyn_ltree),w(this.dyn_dtree),w(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(16),this.heap=new i.Buf16(573),w(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(573),w(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function M(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:f,e.adler=2===t.wrap?0:1,t.last_flush=0,s._tr_init(t),0):g(e,l)}function O(e){var t,n=M(e);return 0===n&&((t=e.state).window_size=2*t.w_size,w(t.head),t.max_lazy_match=a[t.level].max_lazy,t.good_match=a[t.level].good_length,t.nice_match=a[t.level].nice_length,t.max_chain_length=a[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),n}function N(e,t,n,a,s,r){if(!e)return l;var o=1;if(-1===t&&(t=6),a<0?(o=0,a=-a):a>15&&(o=2,a-=16),s<1||s>9||8!==n||a<8||a>15||t<0||t>9||r<0||r>4)return g(e,l);8===a&&(a=9);var c=new S;return e.state=c,c.strm=e,c.wrap=o,c.gzhead=null,c.w_bits=a,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=s+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+3-1)/3),c.window=new i.Buf8(2*c.w_size),c.head=new i.Buf16(c.hash_size),c.prev=new i.Buf16(c.w_size),c.lit_bufsize=1<<s+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new i.Buf8(c.pending_buf_size),c.d_buf=1*c.lit_bufsize,c.l_buf=3*c.lit_bufsize,c.level=t,c.strategy=r,c.method=n,O(e)}a=[new A(0,0,0,0,(function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(E(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var a=e.block_start+n;if((0===e.strstart||e.strstart>=a)&&(e.lookahead=e.strstart-a,e.strstart=a,b(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-u&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(b(e,!1),e.strm.avail_out),1)})),new A(4,4,8,4,k),new A(4,5,16,8,k),new A(4,6,32,32,k),new A(4,4,16,16,x),new A(8,16,32,32,x),new A(8,16,128,128,x),new A(8,32,128,256,x),new A(32,128,258,1024,x),new A(32,258,258,4096,x)],t.Ue=N,t.Wt=function(e,t){var n,i,r,c;if(!e||!e.state||t>5||t<0)return e?g(e,l):l;if(i=e.state,!e.output||!e.input&&0!==e.avail_in||i.status===p&&4!==t)return g(e,0===e.avail_out?-5:l);if(i.strm=e,n=i.last_flush,i.last_flush=t,42===i.status)if(2===i.wrap)e.adler=0,y(i,31),y(i,139),y(i,8),i.gzhead?(y(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),y(i,255&i.gzhead.time),y(i,i.gzhead.time>>8&255),y(i,i.gzhead.time>>16&255),y(i,i.gzhead.time>>24&255),y(i,9===i.level?2:i.strategy>=2||i.level<2?4:0),y(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(y(i,255&i.gzhead.extra.length),y(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=o(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69):(y(i,0),y(i,0),y(i,0),y(i,0),y(i,0),y(i,9===i.level?2:i.strategy>=2||i.level<2?4:0),y(i,3),i.status=f);else{var u=8+(i.w_bits-8<<4)<<8;u|=(i.strategy>=2||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(u|=32),u+=31-u%31,i.status=f,v(i,u),0!==i.strstart&&(v(i,e.adler>>>16),v(i,65535&e.adler)),e.adler=1}if(69===i.status)if(i.gzhead.extra){for(r=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),_(e),r=i.pending,i.pending!==i.pending_buf_size));)y(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=73)}else i.status=73;if(73===i.status)if(i.gzhead.name){r=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),_(e),r=i.pending,i.pending===i.pending_buf_size)){c=1;break}c=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,y(i,c)}while(0!==c);i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),0===c&&(i.gzindex=0,i.status=91)}else i.status=91;if(91===i.status)if(i.gzhead.comment){r=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),_(e),r=i.pending,i.pending===i.pending_buf_size)){c=1;break}c=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,y(i,c)}while(0!==c);i.gzhead.hcrc&&i.pending>r&&(e.adler=o(e.adler,i.pending_buf,i.pending-r,r)),0===c&&(i.status=h)}else i.status=h;if(i.status===h&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&_(e),i.pending+2<=i.pending_buf_size&&(y(i,255&e.adler),y(i,e.adler>>8&255),e.adler=0,i.status=f)):i.status=f),0!==i.pending){if(_(e),0===e.avail_out)return i.last_flush=-1,0}else if(0===e.avail_in&&m(t)<=m(n)&&4!==t)return g(e,-5);if(i.status===p&&0!==e.avail_in)return g(e,-5);if(0!==e.avail_in||0!==i.lookahead||0!==t&&i.status!==p){var I=2===i.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(E(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,n=s._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(i,t):3===i.strategy?function(e,t){for(var n,a,i,r,o=e.window;;){if(e.lookahead<=d){if(E(e),e.lookahead<=d&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(a=o[i=e.strstart-1])===o[++i]&&a===o[++i]&&a===o[++i]){r=e.strstart+d;do{}while(a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&a===o[++i]&&i<r);e.match_length=d-(r-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=s._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=s._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(b(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(b(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(b(e,!1),0===e.strm.avail_out)?1:2}(i,t):a[i.level].func(i,t);if(3!==I&&4!==I||(i.status=p),1===I||3===I)return 0===e.avail_out&&(i.last_flush=-1),0;if(2===I&&(1===t?s._tr_align(i):5!==t&&(s._tr_stored_block(i,0,0,!1),3===t&&(w(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),_(e),0===e.avail_out))return i.last_flush=-1,0}return 4!==t?0:i.wrap<=0?1:(2===i.wrap?(y(i,255&e.adler),y(i,e.adler>>8&255),y(i,e.adler>>16&255),y(i,e.adler>>24&255),y(i,255&e.total_in),y(i,e.total_in>>8&255),y(i,e.total_in>>16&255),y(i,e.total_in>>24&255)):(v(i,e.adler>>>16),v(i,65535&e.adler)),_(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?0:1)}},94264:e=>{"use strict";e.exports=function(e,t){var n,a,i,s,r,o,c,l,d,u,h,f,p,g,m,w,_,b,y,v,I,E,k,x,A;n=e.state,a=e.next_in,x=e.input,i=a+(e.avail_in-5),s=e.next_out,A=e.output,r=s-(t-e.avail_out),o=s+(e.avail_out-257),c=n.dmax,l=n.wsize,d=n.whave,u=n.wnext,h=n.window,f=n.hold,p=n.bits,g=n.lencode,m=n.distcode,w=(1<<n.lenbits)-1,_=(1<<n.distbits)-1;e:do{p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=g[f&w];t:for(;;){if(f>>>=y=b>>>24,p-=y,0===(y=b>>>16&255))A[s++]=65535&b;else{if(!(16&y)){if(0==(64&y)){b=g[(65535&b)+(f&(1<<y)-1)];continue t}if(32&y){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}v=65535&b,(y&=15)&&(p<y&&(f+=x[a++]<<p,p+=8),v+=f&(1<<y)-1,f>>>=y,p-=y),p<15&&(f+=x[a++]<<p,p+=8,f+=x[a++]<<p,p+=8),b=m[f&_];n:for(;;){if(f>>>=y=b>>>24,p-=y,!(16&(y=b>>>16&255))){if(0==(64&y)){b=m[(65535&b)+(f&(1<<y)-1)];continue n}e.msg="invalid distance code",n.mode=30;break e}if(I=65535&b,p<(y&=15)&&(f+=x[a++]<<p,(p+=8)<y&&(f+=x[a++]<<p,p+=8)),(I+=f&(1<<y)-1)>c){e.msg="invalid distance too far back",n.mode=30;break e}if(f>>>=y,p-=y,I>(y=s-r)){if((y=I-y)>d&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(E=0,k=h,0===u){if(E+=l-y,y<v){v-=y;do{A[s++]=h[E++]}while(--y);E=s-I,k=A}}else if(u<y){if(E+=l+u-y,(y-=u)<v){v-=y;do{A[s++]=h[E++]}while(--y);if(E=0,u<v){v-=y=u;do{A[s++]=h[E++]}while(--y);E=s-I,k=A}}}else if(E+=u-y,y<v){v-=y;do{A[s++]=h[E++]}while(--y);E=s-I,k=A}for(;v>2;)A[s++]=k[E++],A[s++]=k[E++],A[s++]=k[E++],v-=3;v&&(A[s++]=k[E++],v>1&&(A[s++]=k[E++]))}else{E=s-I;do{A[s++]=A[E++],A[s++]=A[E++],A[s++]=A[E++],v-=3}while(v>2);v&&(A[s++]=A[E++],v>1&&(A[s++]=A[E++]))}break}}break}}while(a<i&&s<o);a-=v=p>>3,f&=(1<<(p-=v<<3))-1,e.next_in=a,e.next_out=s,e.avail_in=a<i?i-a+5:5-(a-i),e.avail_out=s<o?o-s+257:257-(s-o),n.hold=f,n.bits=p}},27948:(e,t,n)=>{"use strict";var a=n(24236),i=n(66069),s=n(2869),r=n(94264),o=n(9241),c=-2,l=12,d=30;function u(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function h(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new a.Buf16(320),this.work=new a.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function f(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new a.Buf32(852),t.distcode=t.distdyn=new a.Buf32(592),t.sane=1,t.back=-1,0):c}function p(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,f(e)):c}function g(e,t){var n,a;return e&&e.state?(a=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?c:(null!==a.window&&a.wbits!==t&&(a.window=null),a.wrap=n,a.wbits=t,p(e))):c}function m(e,t){var n,a;return e?(a=new h,e.state=a,a.window=null,0!==(n=g(e,t))&&(e.state=null),n):c}var w,_,b=!0;function y(e){if(b){var t;for(w=new a.Buf32(512),_=new a.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(1,e.lens,0,288,w,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(2,e.lens,0,32,_,0,e.work,{bits:5}),b=!1}e.lencode=w,e.lenbits=9,e.distcode=_,e.distbits=5}function v(e,t,n,i){var s,r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new a.Buf8(r.wsize)),i>=r.wsize?(a.arraySet(r.window,t,n-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):((s=r.wsize-r.wnext)>i&&(s=i),a.arraySet(r.window,t,n-i,s,r.wnext),(i-=s)?(a.arraySet(r.window,t,n-i,i,0),r.wnext=i,r.whave=r.wsize):(r.wnext+=s,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=s))),0}t.Ul=m,t.rr=function(e,t){var n,h,f,p,g,m,w,_,b,I,E,k,x,A,S,M,O,N,L,T,Z,R,C,P,U=0,F=new a.Buf8(4),D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return c;(n=e.state).mode===l&&(n.mode=13),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,I=m,E=w,R=0;e:for(;;)switch(n.mode){case 1:if(0===n.wrap){n.mode=13;break}for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(2&n.wrap&&35615===_){n.check=0,F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0),_=0,b=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&_)<<8)+(_>>8))%31){e.msg="incorrect header check",n.mode=d;break}if(8!=(15&_)){e.msg="unknown compression method",n.mode=d;break}if(b-=4,Z=8+(15&(_>>>=4)),0===n.wbits)n.wbits=Z;else if(Z>n.wbits){e.msg="invalid window size",n.mode=d;break}n.dmax=1<<Z,e.adler=n.check=1,n.mode=512&_?10:l,_=0,b=0;break;case 2:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.flags=_,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=d;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=d;break}n.head&&(n.head.text=_>>8&1),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0)),_=0,b=0,n.mode=3;case 3:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.time=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,F[2]=_>>>16&255,F[3]=_>>>24&255,n.check=s(n.check,F,4,0)),_=0,b=0,n.mode=4;case 4:for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.head&&(n.head.xflags=255&_,n.head.os=_>>8),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0)),_=0,b=0,n.mode=5;case 5:if(1024&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length=_,n.head&&(n.head.extra_len=_),512&n.flags&&(F[0]=255&_,F[1]=_>>>8&255,n.check=s(n.check,F,2,0)),_=0,b=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((k=n.length)>m&&(k=m),k&&(n.head&&(Z=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),a.arraySet(n.head.extra,h,p,k,Z)),512&n.flags&&(n.check=s(n.check,h,k,p)),m-=k,p+=k,n.length-=k),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===m)break e;k=0;do{Z=h[p+k++],n.head&&Z&&n.length<65536&&(n.head.name+=String.fromCharCode(Z))}while(Z&&k<m);if(512&n.flags&&(n.check=s(n.check,h,k,p)),m-=k,p+=k,Z)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===m)break e;k=0;do{Z=h[p+k++],n.head&&Z&&n.length<65536&&(n.head.comment+=String.fromCharCode(Z))}while(Z&&k<m);if(512&n.flags&&(n.check=s(n.check,h,k,p)),m-=k,p+=k,Z)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;b<16;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(65535&n.check)){e.msg="header crc mismatch",n.mode=d;break}_=0,b=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=l;break;case 10:for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}e.adler=n.check=u(_),_=0,b=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,2;e.adler=n.check=1,n.mode=l;case l:if(5===t||6===t)break e;case 13:if(n.last){_>>>=7&b,b-=7&b,n.mode=27;break}for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}switch(n.last=1&_,b-=1,3&(_>>>=1)){case 0:n.mode=14;break;case 1:if(y(n),n.mode=20,6===t){_>>>=2,b-=2;break e}break;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=d}_>>>=2,b-=2;break;case 14:for(_>>>=7&b,b-=7&b;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if((65535&_)!=(_>>>16^65535)){e.msg="invalid stored block lengths",n.mode=d;break}if(n.length=65535&_,_=0,b=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(k=n.length){if(k>m&&(k=m),k>w&&(k=w),0===k)break e;a.arraySet(f,h,p,k,g),m-=k,p+=k,w-=k,g+=k,n.length-=k;break}n.mode=l;break;case 17:for(;b<14;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(n.nlen=257+(31&_),_>>>=5,b-=5,n.ndist=1+(31&_),_>>>=5,b-=5,n.ncode=4+(15&_),_>>>=4,b-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=d;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;b<3;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.lens[D[n.have++]]=7&_,_>>>=3,b-=3}for(;n.have<19;)n.lens[D[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,C={bits:n.lenbits},R=o(0,n.lens,0,19,n.lencode,0,n.work,C),n.lenbits=C.bits,R){e.msg="invalid code lengths set",n.mode=d;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(O<16)_>>>=S,b-=S,n.lens[n.have++]=O;else{if(16===O){for(P=S+2;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_>>>=S,b-=S,0===n.have){e.msg="invalid bit length repeat",n.mode=d;break}Z=n.lens[n.have-1],k=3+(3&_),_>>>=2,b-=2}else if(17===O){for(P=S+3;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,Z=0,k=3+(7&(_>>>=S)),_>>>=3,b-=3}else{for(P=S+7;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}b-=S,Z=0,k=11+(127&(_>>>=S)),_>>>=7,b-=7}if(n.have+k>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=d;break}for(;k--;)n.lens[n.have++]=Z}}if(n.mode===d)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=d;break}if(n.lenbits=9,C={bits:n.lenbits},R=o(1,n.lens,0,n.nlen,n.lencode,0,n.work,C),n.lenbits=C.bits,R){e.msg="invalid literal/lengths set",n.mode=d;break}if(n.distbits=6,n.distcode=n.distdyn,C={bits:n.distbits},R=o(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,C),n.distbits=C.bits,R){e.msg="invalid distances set",n.mode=d;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(m>=6&&w>=258){e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,r(e,E),g=e.next_out,f=e.output,w=e.avail_out,p=e.next_in,h=e.input,m=e.avail_in,_=n.hold,b=n.bits,n.mode===l&&(n.back=-1);break}for(n.back=0;M=(U=n.lencode[_&(1<<n.lenbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(M&&0==(240&M)){for(N=S,L=M,T=O;M=(U=n.lencode[T+((_&(1<<N+L)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,n.length=O,0===M){n.mode=26;break}if(32&M){n.back=-1,n.mode=l;break}if(64&M){e.msg="invalid literal/length code",n.mode=d;break}n.extra=15&M,n.mode=22;case 22:if(n.extra){for(P=n.extra;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.length+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;M=(U=n.distcode[_&(1<<n.distbits)-1])>>>16&255,O=65535&U,!((S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(0==(240&M)){for(N=S,L=M,T=O;M=(U=n.distcode[T+((_&(1<<N+L)-1)>>N)])>>>16&255,O=65535&U,!(N+(S=U>>>24)<=b);){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}_>>>=N,b-=N,n.back+=N}if(_>>>=S,b-=S,n.back+=S,64&M){e.msg="invalid distance code",n.mode=d;break}n.offset=O,n.extra=15&M,n.mode=24;case 24:if(n.extra){for(P=n.extra;b<P;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}n.offset+=_&(1<<n.extra)-1,_>>>=n.extra,b-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=d;break}n.mode=25;case 25:if(0===w)break e;if(k=E-w,n.offset>k){if((k=n.offset-k)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=d;break}k>n.wnext?(k-=n.wnext,x=n.wsize-k):x=n.wnext-k,k>n.length&&(k=n.length),A=n.window}else A=f,x=g-n.offset,k=n.length;k>w&&(k=w),w-=k,n.length-=k;do{f[g++]=A[x++]}while(--k);0===n.length&&(n.mode=21);break;case 26:if(0===w)break e;f[g++]=n.length,w--,n.mode=21;break;case 27:if(n.wrap){for(;b<32;){if(0===m)break e;m--,_|=h[p++]<<b,b+=8}if(E-=w,e.total_out+=E,n.total+=E,E&&(e.adler=n.check=n.flags?s(n.check,f,E,g-E):i(n.check,f,E,g-E)),E=w,(n.flags?_:u(_))!==n.check){e.msg="incorrect data check",n.mode=d;break}_=0,b=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;b<32;){if(0===m)break e;m--,_+=h[p++]<<b,b+=8}if(_!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=d;break}_=0,b=0}n.mode=29;case 29:R=1;break e;case d:R=-3;break e;case 31:return-4;default:return c}return e.next_out=g,e.avail_out=w,e.next_in=p,e.avail_in=m,n.hold=_,n.bits=b,(n.wsize||E!==e.avail_out&&n.mode<d&&(n.mode<27||4!==t))&&v(e,e.output,e.next_out,E-e.avail_out)?(n.mode=31,-4):(I-=e.avail_in,E-=e.avail_out,e.total_in+=I,e.total_out+=E,n.total+=E,n.wrap&&E&&(e.adler=n.check=n.flags?s(n.check,f,E,e.next_out-E):i(n.check,f,E,e.next_out-E)),e.data_type=n.bits+(n.last?64:0)+(n.mode===l?128:0)+(20===n.mode||15===n.mode?256:0),(0===I&&0===E||4===t)&&0===R&&(R=-5),R)}},9241:(e,t,n)=>{"use strict";var a=n(24236),i=15,s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],c=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(e,t,n,l,d,u,h,f){var p,g,m,w,_,b,y,v,I,E=f.bits,k=0,x=0,A=0,S=0,M=0,O=0,N=0,L=0,T=0,Z=0,R=null,C=0,P=new a.Buf16(16),U=new a.Buf16(16),F=null,D=0;for(k=0;k<=i;k++)P[k]=0;for(x=0;x<l;x++)P[t[n+x]]++;for(M=E,S=i;S>=1&&0===P[S];S--);if(M>S&&(M=S),0===S)return d[u++]=20971520,d[u++]=20971520,f.bits=1,0;for(A=1;A<S&&0===P[A];A++);for(M<A&&(M=A),L=1,k=1;k<=i;k++)if(L<<=1,(L-=P[k])<0)return-1;if(L>0&&(0===e||1!==S))return-1;for(U[1]=0,k=1;k<i;k++)U[k+1]=U[k]+P[k];for(x=0;x<l;x++)0!==t[n+x]&&(h[U[t[n+x]]++]=x);if(0===e?(R=F=h,b=19):1===e?(R=s,C-=257,F=r,D-=257,b=256):(R=o,F=c,b=-1),Z=0,x=0,k=A,_=u,O=M,N=0,m=-1,w=(T=1<<M)-1,1===e&&T>852||2===e&&T>592)return 1;for(;;){y=k-N,h[x]<b?(v=0,I=h[x]):h[x]>b?(v=F[D+h[x]],I=R[C+h[x]]):(v=96,I=0),p=1<<k-N,A=g=1<<O;do{d[_+(Z>>N)+(g-=p)]=y<<24|v<<16|I|0}while(0!==g);for(p=1<<k-1;Z&p;)p>>=1;if(0!==p?(Z&=p-1,Z+=p):Z=0,x++,0==--P[k]){if(k===S)break;k=t[n+h[x]]}if(k>M&&(Z&w)!==m){for(0===N&&(N=M),_+=A,L=1<<(O=k-N);O+N<S&&!((L-=P[O+N])<=0);)O++,L<<=1;if(T+=1<<O,1===e&&T>852||2===e&&T>592)return 1;d[m=Z&w]=M<<24|O<<16|_-u|0}}return 0!==Z&&(d[_+Z]=k-N<<24|64<<16|0),f.bits=M,0}},48898:e=>{"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},10342:(e,t,n)=>{"use strict";var a=n(24236);function i(e){for(var t=e.length;--t>=0;)e[t]=0}var s=256,r=286,o=30,c=15,l=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],d=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],h=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],f=new Array(576);i(f);var p=new Array(60);i(p);var g=new Array(512);i(g);var m=new Array(256);i(m);var w=new Array(29);i(w);var _,b,y,v=new Array(o);function I(e,t,n,a,i){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=a,this.max_length=i,this.has_stree=e&&e.length}function E(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function k(e){return e<256?g[e]:g[256+(e>>>7)]}function x(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function A(e,t,n){e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,x(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function S(e,t,n){A(e,n[2*t],n[2*t+1])}function M(e,t){var n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}function O(e,t,n){var a,i,s=new Array(16),r=0;for(a=1;a<=c;a++)s[a]=r=r+n[a-1]<<1;for(i=0;i<=t;i++){var o=e[2*i+1];0!==o&&(e[2*i]=M(s[o]++,o))}}function N(e){var t;for(t=0;t<r;t++)e.dyn_ltree[2*t]=0;for(t=0;t<o;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function L(e){e.bi_valid>8?x(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function T(e,t,n,a){var i=2*t,s=2*n;return e[i]<e[s]||e[i]===e[s]&&a[t]<=a[n]}function Z(e,t,n){for(var a=e.heap[n],i=n<<1;i<=e.heap_len&&(i<e.heap_len&&T(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!T(t,a,e.heap[i],e.depth));)e.heap[n]=e.heap[i],n=i,i<<=1;e.heap[n]=a}function R(e,t,n){var a,i,r,o,c=0;if(0!==e.last_lit)do{a=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],i=e.pending_buf[e.l_buf+c],c++,0===a?S(e,i,t):(S(e,(r=m[i])+s+1,t),0!==(o=l[r])&&A(e,i-=w[r],o),S(e,r=k(--a),n),0!==(o=d[r])&&A(e,a-=v[r],o))}while(c<e.last_lit);S(e,256,t)}function C(e,t){var n,a,i,s=t.dyn_tree,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,d=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<l;n++)0!==s[2*n]?(e.heap[++e.heap_len]=d=n,e.depth[n]=0):s[2*n+1]=0;for(;e.heap_len<2;)s[2*(i=e.heap[++e.heap_len]=d<2?++d:0)]=1,e.depth[i]=0,e.opt_len--,o&&(e.static_len-=r[2*i+1]);for(t.max_code=d,n=e.heap_len>>1;n>=1;n--)Z(e,s,n);i=l;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Z(e,s,1),a=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=a,s[2*i]=s[2*n]+s[2*a],e.depth[i]=(e.depth[n]>=e.depth[a]?e.depth[n]:e.depth[a])+1,s[2*n+1]=s[2*a+1]=i,e.heap[1]=i++,Z(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var n,a,i,s,r,o,l=t.dyn_tree,d=t.max_code,u=t.stat_desc.static_tree,h=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,g=t.stat_desc.max_length,m=0;for(s=0;s<=c;s++)e.bl_count[s]=0;for(l[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<573;n++)(s=l[2*l[2*(a=e.heap[n])+1]+1]+1)>g&&(s=g,m++),l[2*a+1]=s,a>d||(e.bl_count[s]++,r=0,a>=p&&(r=f[a-p]),o=l[2*a],e.opt_len+=o*(s+r),h&&(e.static_len+=o*(u[2*a+1]+r)));if(0!==m){do{for(s=g-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[g]--,m-=2}while(m>0);for(s=g;0!==s;s--)for(a=e.bl_count[s];0!==a;)(i=e.heap[--n])>d||(l[2*i+1]!==s&&(e.opt_len+=(s-l[2*i+1])*l[2*i],l[2*i+1]=s),a--)}}(e,t),O(s,d,e.bl_count)}function P(e,t,n){var a,i,s=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),t[2*(n+1)+1]=65535,a=0;a<=n;a++)i=r,r=t[2*(a+1)+1],++o<c&&i===r||(o<l?e.bl_tree[2*i]+=o:0!==i?(i!==s&&e.bl_tree[2*i]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,s=i,0===r?(c=138,l=3):i===r?(c=6,l=3):(c=7,l=4))}function U(e,t,n){var a,i,s=-1,r=t[1],o=0,c=7,l=4;for(0===r&&(c=138,l=3),a=0;a<=n;a++)if(i=r,r=t[2*(a+1)+1],!(++o<c&&i===r)){if(o<l)do{S(e,i,e.bl_tree)}while(0!=--o);else 0!==i?(i!==s&&(S(e,i,e.bl_tree),o--),S(e,16,e.bl_tree),A(e,o-3,2)):o<=10?(S(e,17,e.bl_tree),A(e,o-3,3)):(S(e,18,e.bl_tree),A(e,o-11,7));o=0,s=i,0===r?(c=138,l=3):i===r?(c=6,l=3):(c=7,l=4)}}i(v);var F=!1;function D(e,t,n,i){A(e,0+(i?1:0),3),function(e,t,n,i){L(e),i&&(x(e,n),x(e,~n)),a.arraySet(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}(e,t,n,!0)}t._tr_init=function(e){F||(!function(){var e,t,n,a,i,s=new Array(16);for(n=0,a=0;a<28;a++)for(w[a]=n,e=0;e<1<<l[a];e++)m[n++]=a;for(m[n-1]=a,i=0,a=0;a<16;a++)for(v[a]=i,e=0;e<1<<d[a];e++)g[i++]=a;for(i>>=7;a<o;a++)for(v[a]=i<<7,e=0;e<1<<d[a]-7;e++)g[256+i++]=a;for(t=0;t<=c;t++)s[t]=0;for(e=0;e<=143;)f[2*e+1]=8,e++,s[8]++;for(;e<=255;)f[2*e+1]=9,e++,s[9]++;for(;e<=279;)f[2*e+1]=7,e++,s[7]++;for(;e<=287;)f[2*e+1]=8,e++,s[8]++;for(O(f,287,s),e=0;e<o;e++)p[2*e+1]=5,p[2*e]=M(e,5);_=new I(f,l,257,r,c),b=new I(p,d,0,o,c),y=new I(new Array(0),u,0,19,7)}(),F=!0),e.l_desc=new E(e.dyn_ltree,_),e.d_desc=new E(e.dyn_dtree,b),e.bl_desc=new E(e.bl_tree,y),e.bi_buf=0,e.bi_valid=0,N(e)},t._tr_stored_block=D,t._tr_flush_block=function(e,t,n,a){var i,r,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<s;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),C(e,e.l_desc),C(e,e.d_desc),o=function(e){var t;for(P(e,e.dyn_ltree,e.l_desc.max_code),P(e,e.dyn_dtree,e.d_desc.max_code),C(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*h[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),i=e.opt_len+3+7>>>3,(r=e.static_len+3+7>>>3)<=i&&(i=r)):i=r=n+5,n+4<=i&&-1!==t?D(e,t,n,a):4===e.strategy||r===i?(A(e,2+(a?1:0),3),R(e,f,p)):(A(e,4+(a?1:0),3),function(e,t,n,a){var i;for(A(e,t-257,5),A(e,n-1,5),A(e,a-4,4),i=0;i<a;i++)A(e,e.bl_tree[2*h[i]+1],3);U(e,e.dyn_ltree,t-1),U(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),R(e,e.dyn_ltree,e.dyn_dtree)),N(e),a&&L(e)},t._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(m[n]+s+1)]++,e.dyn_dtree[2*k(t)]++),e.last_lit===e.lit_bufsize-1},t._tr_align=function(e){A(e,2,3),S(e,256,f),function(e){16===e.bi_valid?(x(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},62292:e=>{"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},14153:e=>{const t=/^[-+]?0x[a-fA-F0-9]+$/,n=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/;!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt),!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat);const a={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};e.exports=function(e,i={}){if(i=Object.assign({},a,i),!e||"string"!=typeof e)return e;let s=e.trim();if(void 0!==i.skipLike&&i.skipLike.test(s))return e;if(i.hex&&t.test(s))return Number.parseInt(s,16);{const t=n.exec(s);if(t){const n=t[1],a=t[2];let r=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(t[3]);const o=t[4]||t[6];if(!i.leadingZeros&&a.length>0&&n&&"."!==s[2])return e;if(!i.leadingZeros&&a.length>0&&!n&&"."!==s[1])return e;{const t=Number(s),c=""+t;return-1!==c.search(/[eE]/)||o?i.eNotation?t:e:-1!==s.indexOf(".")?"0"===c&&""===r||c===r||n&&c==="-"+r?t:e:a?r===c||n+r===c?t:e:s===c||s===n+c?t:e}}return e}}}},n={};function a(e){var i=n[e];if(void 0!==i)return i.exports;var s=n[e]={id:e,loaded:!1,exports:{}};return t[e].call(s.exports,s,s.exports,a),s.loaded=!0,s.exports}a.m=t,e=[],a.O=(t,n,i,s)=>{if(!n){var r=1/0;for(d=0;d<e.length;d++){for(var[n,i,s]=e[d],o=!0,c=0;c<n.length;c++)(!1&s||r>=s)&&Object.keys(a.O).every((e=>a.O[e](n[c])))?n.splice(c--,1):(o=!1,s<r&&(r=s));if(o){e.splice(d--,1);var l=i();void 0!==l&&(t=l)}}return t}s=s||0;for(var d=e.length;d>0&&e[d-1][2]>s;d--)e[d]=e[d-1];e[d]=[n,i,s]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),a.j=670,(()=>{var e={670:0};a.O.j=t=>0===e[t];var t=(t,n)=>{var i,s,[r,o,c]=n,l=0;if(r.some((t=>0!==e[t]))){for(i in o)a.o(o,i)&&(a.m[i]=o[i]);if(c)var d=c(a)}for(t&&t(n);l<r.length;l++)s=r[l],a.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return a.O(d)},n=self.webpackChunkgapp_browser_react=self.webpackChunkgapp_browser_react||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var i=a.O(void 0,[739],(()=>a(15528)));i=a.O(i)})();